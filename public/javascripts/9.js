(window.webpackJsonp=window.webpackJsonp||[]).push([[9,4,8,14,15,16],{328:function(t,e,i){"use strict";i.r(e),i.d(e,"GlobalVar",function(){return r}),i.d(e,"$gv",function(){return o});i(353),i(333),i(335);var s=i(332),n=i(375);class r{constructor(){this.m_is_run=!0,this.MAX_FPS=60,this.FRAME_ELAPSED=1e3/60,this.CANVAS_SCALE=32,this.m_editor_mode=!1,this.m_display_foothold=!1,this.m_display_physics_debug=!1,this.m_display_debug_info=!1,this.m_debugDraw=new n.a,this.m_display_selected_object=!1,this.m_selected_object=null,this.m_hover_object=null,this.m_viewRect=new s.Rectangle(0,-384,1366,768),this.m_is_rendering_map=!0,this.m_display_back=!0,this.m_display_front=!0,this.m_display_mapobj=!0,this.m_display_maptile=!0,this.m_display_particle_system=!0,this.m_display_skeletal_anim=!0,this.m_display_portal=!0,this.m_display_player=!0,this.m_display_other_player=!0,this.m_display_life=!0,this.m_display_npc=!0,this.m_display_mob=!0,this.ChatBalloon_default_style=0,this.ChatBalloon_display_duration=5e3,this.input_keyDown={},this.input_keyUp={},this.mouse_move=0,this.mouse_x=0,this.mouse_y=0,this.mouse_dl=0,this.mouse_ul=0,this.mouse_dm=0,this.mouse_um=0,this.mouse_dr=0,this.mouse_ur=0;{let t={layeredObjects:[]};for(let e=0;e<12;++e){let i=t.layeredObjects[e]={};Object.defineProperty(i,"length",{enumerable:!1,writable:!0,value:0})}t.Update=function(e){for(let i=0;i<t.layeredObjects.length;++i){const s=t.layeredObjects[i];for(let t in s){s[t].update(e)}}},t.RenderLayer=function(e,i){const s=t.layeredObjects[i];for(let t in s){s[t].render(e)}},t.addToScene=function(e,i){if(!(Number.isSafeInteger(e)&&e in t.layeredObjects))throw new TypeError("layer");{const s=t.layeredObjects[e];i.$layer=e,i.$objectid=s.length,s[i.$objectid]=i,s.length++}},t.destroy=function(e){const i=e.$layer,s=e.$objectid,n=t.layeredObjects[i];e.destroy(),delete n[s]},this.SceneObjectMgr=t}}}const o=new r;window.$gv=o},334:function(t,e,i){"use strict";i.r(e),i.d(e,"AnimationBase",function(){return r}),i.d(e,"Animation",function(){return o});i(332),i(333);var s=i(351);window.m_draw_animation_texture_info=!1;class n{constructor(t,e){this._raw=t,this._url=e,this.frame=0,this.time=0,this.delta=0,this.textures=[],this.is_loop=!0,this.is_end=!1,this._url}getTotalTime(){return this.textures.reduce((t,e)=>t+e.delay,0)}clone(){let t=new this.constructor(this._raw,this._url);return t.textures=this.textures,t}load(){throw new Error("Not implement")}update(t){throw new Error("Not implement")}_resetFrame(){this.frame=0,this.time=0}reset(){this.frame=0,this.time=0,this.is_end=!1}get texture(){throw new Error("Not implement")}destroy(){this.is_loop=!1,this.is_end=!0}}class r extends n{constructor(t,e){super(t,e)}async load(){for(let t=0;t in this._raw;++t){let e=this._url+"/"+t,i=new s.a(this._raw[t]);i._url=e,this.textures[t]=i}this.textures[0]&&(this.textures[0].isLoaded()||this.textures[0].__loadTexture())}isEnd(){return this.is_end}_update(t){const e=this.textures.length;e>0&&(this.time=this.time+t,this.time>this.texture.delay&&(this.frame=++this.frame%e,this.time=0)),this.delta+=t}update(t){const e=this.textures.length;if(e>0&&(this.time=this.time+t,this.time>this.texture.delay)){if(this.frame=this.frame+1,this.frame>=e){if(!this.is_loop)return this.frame=e-1,void(this.is_end=!0);this.reset()}this.time=0}this.delta+=t}draw(t,e,i,s,n){let r=this.texture;t.drawRotaGraph(r,e,i,s,n)}get texture(){return this.textures[this.frame]}}class o extends r{constructor(t,e){super(t,e),this.draw=this._draw_and_preload}_draw_and_preload(t,e,i,s,n){let r;for(r=this.frame;r>=0;--r){let o=this.textures[r];if(o.isLoaded()){t.drawRotaGraph(o,e,i,s,n);break}}let o=this.textures[++r];o?o.isLoaded()||o.__loadTexture():delete this.draw}}},337:function(t,e,i){"use strict";i.r(e),i.d(e,"CharacterAnimationBase",function(){return V}),i.d(e,"CharacterRenderer",function(){return M});var s=i(353),n=i(338),r=i(334),o=(i(335),i(333)),a=i(351),l=i(332),h=i(369);let _={},c={};class m extends a.b{constructor(t,e){super(t,e),this._raw.origin&&(this._raw.origin.__proto__=l.Vec2.prototype);for(let t in this._raw.map)this._raw.map[t].__proto__=l.Vec2.prototype;this.relative=new l.Vec2(0,0),this.calcRelative=this._calcRelative,this.filter=new o.ImageFilter,this.opacity=1,this._slot=null,this._place=null,this.classList=null}get z(){return _[this._raw.z]||1}set z(t){console.warn("Not implement")}get order(){return this.z}set order(t){console.warn(new Error("Not implement").stack)}get origin(){return this._raw.origin||l.Vec2.empty}isHasAnchor(){return!!this._raw.map}get brow(){return this._raw.map.brow}isAnchorBrow(){return!!this._raw.map.brow}get neck(){return this._raw.map.neck}isAnchorNeck(){return!!this._raw.map.neck}get navel(){return this._raw.map.navel}isAnchorNavel(){return!!this._raw.map.navel}get hand(){return this._raw.map.hand}isAnchorHand(){return!!this._raw.map.hand}get handMove(){return this._raw.map.handMove}isAnchorHandMove(){return!!this._raw.map.handMove}get _earBelowHead(){return this._raw.map.earBelowHead}isAnchor_EarBelowHead(){return!!this._raw.map.earBelowHead}get _earOverHead(){return this._raw.map.earOverHead}isAnchor_EarOverHead(){return!!this._raw.map.earOverHead}_anchor(t,e,i){return e[i].sub(t[i]).add(e.origin.sub(t.origin))}_calcRelative(t){return this.calcRelative=this._getRelativeFunction(t),this.calcRelative(t)}_getRelativeFunction(t){return this.isHasAnchor()?this.isAnchorNeck()?this._calcRelative_neck:this.isAnchorBrow()?this._calcRelative_brow:this.isAnchorNavel()?this==t.slots.body?this._getOrigin:this._calcRelative_navel:this.isAnchorHand()?this._calcRelative_hand:this.isAnchorHandMove()?this._url.lastIndexOf("lHand")>0?this._calcRelative_handMove_lHand:this._calcRelative_handMove:void 0:this._calcRelativeEmpty}_calcRelativeEmpty(t){return l.Vec2.empty}_getOrigin(){return this.origin}_calcRelative_neck(t){const e=t.slots.body.fragments.body.getTexture(t);return this._anchor(this,e,"neck").sub(e.origin)}_calcRelative_brow(t){const e=t.slots.body.fragments.body.getTexture(t),i=t.slots.head.fragments.head.getTexture(t);return this._anchor(this,i,"brow").add(this._anchor(i,e,"neck")).sub(e.origin)}_calcRelative_navel(t){return t.slots.body.fragments.body.getTexture(t).navel.sub(this.navel,this.origin)}_calcRelative_hand(t){const e=t.slots.body.fragments.body.getTexture(t),i=t.slots.body.fragments.arm.getTexture(t);return null==i?l.Vec2.empty.sub(this.hand).sub(this.origin).sub(e.origin):this._anchor(this,i,"hand").sub(this._anchor(e,i,"navel")).sub(e.origin)}_calcRelative_handMove(t){return l.Vec2.empty.sub(this.origin).sub(this.handMove)}_calcRelative_handMove_lHand(t){return l.Vec2.empty.sub(this.origin)}update(t){this.relative=this.calcRelative(t)}render(t,e){if(!this.relative)return;const i=this.relative.x,s=this.relative.y;t.globalAlpha=this.opacity||1,this.filter.isEmpty?t.drawGraph2(this,i,s):(t.ctx.filter=this.filter.toString(),t.drawGraph2(this,i,s),t.ctx.filter="none")}}class u extends m{constructor(...t){super(...t),this.graph2=null,this.graph3=null}update(t){this.relative=this.calcRelative(t),this.graph2&&(this.graph2.relative=this.relative),this.graph3&&(this.graph3.relative=this.relative)}render(t,e){this.relative&&(t.globalAlpha=this.opacity||1,this.filter.isEmpty?this._render(t):(t.ctx.filter=this.filter.toString(),this._render(t),t.ctx.filter="none"))}_render(t){const e=this.relative.x,i=this.relative.y;t.drawGraph2(this,e,i),this.graph2&&this.graph2.opacity&&(t.globalAlpha=this.graph2.opacity,t.drawGraph2(this.graph2,e,i)),this.graph3&&this.graph3.opacity&&(t.globalAlpha=this.graph3.opacity,t.drawGraph2(this.graph3,e,i))}}class d extends r.Animation{constructor(t,e){super(t,e),Object.defineProperty(this,"_raw",{value:t}),this.__getAttr("z",-1),this.__getAttr("pos",1),super.load()}__getAttr(t,e){t in this._raw?this[t]=this._raw[t]:this[t]=e}render(t,e,i,s){if(e)this.draw(t,0,0,-i,s);else{const e=.25*-this.texture.height;this.draw(t,0,e,0,s)}}}class p{constructor(){this._url=null,this._raw=null,this.animation={},this.action=null,this.time=0,this.frame=0,this.fixed=0,this.z=-2,this.action=1,this.actionExceptRotation=0}static async Init(){try{let t=p._list,e=$get.list("/Effect/ItemEff");t.clear(),e.forEach(e=>{t.add(parseInt(e,10))})}catch(t){return!1}}static async load(t){let e=new p;return await e.load(t),e}async load(t){const e=Number(t),i=`/Effect/ItemEff/${e}/effect`;if(!p._list.has(e))return null;let s=await $get.data(i);return s?await this._load(t,i,s):null}update(t,e){e in this.animation?this.action=e:this.action="default",this.animation[this.action]&&this.animation[this.action].update(t)}render(t,e){this.animation&&this.animation[this.action]&&this.animation[this.action].render(t,this.actionExceptRotation,e.angle,e.front>0)}async _load(t,e,i){this.id=t,Object.defineProperty(this,"_raw",{value:i}),this.__construct()}__construct(){this.__getAttr("fixed",0),this.__getAttr("z",-1),this.__getAttr("action",1),this.__getAttr("actionExceptRotation",0);for(let t in this._raw)this._raw[t]&&"object"==typeof this._raw[t]&&"0"in this._raw[t]&&(this.animation[t]=new d(this._raw[t],[this._url,t].join("/")))}__getAttr(t,e){t in this._raw?this[t]=this._raw[t]:this[t]=e}}p._list=new Set;class f{constructor(t){this.textures=t}getTexture(t,e){throw new Error("Not implement")}}class y extends f{constructor(t){super(t)}getTexture(t){return this.getFrameTexture(t,t.action_frame)}getFrameTexture(t,e){if(!(t.action in this.textures))return null;let i=this.textures[t.action][e];return i||null}}class A extends f{constructor(t){super(t)}getTexture(t){return this.getFrameTexture(t,t.emotion_frame)}getFrameTexture(t,e){if(!(t.emotion in this.textures))return null;return this.textures[t.emotion][e]}}class g{constructor(t){this.equip=t}get hue(){const t=this.equip;for(let e in t.fragments)for(let i in t.fragments[e].textures)for(let s=0;s<t.fragments[e].textures[i].length;++s){let n=t.fragments[e].textures[i][s];if(n)return n.filter.hue}}set hue(t){const e=this.equip;for(let i in e.fragments)for(let s in e.fragments[i].textures)for(let n=0;n<e.fragments[i].textures[s].length;++n){let r=e.fragments[i].textures[s][n];r&&(r.filter.hue=t)}}get sat(){const t=this.equip;for(let e in t.fragments)for(let i in t.fragments[e].textures)for(let s=0;s<t.fragments[e].textures[i].length;++s){let n=t.fragments[e].textures[i][s];if(n)return n.filter.sat}}set sat(t){const e=this.equip;for(let i in e.fragments)for(let s in e.fragments[i].textures)for(let n=0;n<e.fragments[i].textures[s].length;++n){let r=e.fragments[i].textures[s][n];r&&(r.filter.sat=t)}}get bri(){const t=this.equip;for(let e in t.fragments)for(let i in t.fragments[e].textures)for(let s=0;s<t.fragments[e].textures[i].length;++s){let n=t.fragments[e].textures[i][s];if(n)return n.filter.bri}}set bri(t){const e=this.equip;for(let i in e.fragments)for(let s in e.fragments[i].textures)for(let n=0;n<e.fragments[i].textures[s].length;++n){let r=e.fragments[i].textures[s][n];r&&(r.filter.bri=t)}}get contrast(){const t=this.equip;for(let e in t.fragments)for(let i in t.fragments[e].textures)for(let s=0;s<t.fragments[e].textures[i].length;++s){let n=t.fragments[e].textures[i][s];if(n)return n.filter.contrast}}set contrast(t){const e=this.equip;for(let i in e.fragments)for(let s in e.fragments[i].textures)for(let n=0;n<e.fragments[i].textures[s].length;++n){let r=e.fragments[i].textures[s][n];r&&(r.filter.contrast=t)}}toJSON(){return{hue:this.hue,sat:this.sat,bri:this.bri,contrast:this.contrast}}}class x{constructor(){}get _animation_type(){throw new Error("Not Implement")}isLoaded(){return!1}_unload(){}getFrameCount(t){return 0}getDelay(t){return 0}toJSON(){return{id:-1}}}class w extends x{constructor(){super(),this._raw=null,this.effect=null,this.fragments=null,this._onload=null,this.id=null,this.categoryInfo=null,this.slot_order=0,this.islot={},this.vslot={},this.filter=new g(this)}toJSON(){return{id:this.id,filter:this.filter.toJSON()}}isLoaded(){return null!=this.fragments}get _onload(){return this.__onload}set _onload(t){this.__onload=t,this.isLoaded()&&this.__onload.call(this,this)}async load(t,e,i,s){let n,r;return this.id=e,this.categoryInfo=i,n=this.__load(t,e,i),i.path&&(r=$get.data(`/String/Eqp/Eqp/${i.path}/${Number(e)}`).then(t=>{t&&(this.name=t.name,this.desc=t.desc)},t=>{this.name="["+e+"]",this.desc=""})),new Promise(function(t){Promise.all([n,r]).then(function(e){t(e[0])})})}async __load(t,e,i){let n;try{s.d.isEquipExist(e,i)&&(n=await $get.data(t))}catch(t){}try{!n&&load_extern_item_data&&(n=await load_extern_item_data(e))}catch(t){if(!n)return!1}return Object.defineProperty(this,"_raw",{value:n}),this.__load_slot(),this.__load_fragments(),this._onload&&this._onload.call(this,this),p.load(this.id).then(t=>this.effect=t),!0}__load_fragments(){const t=this.fragmentConstructor;let e=Object.keys(this._raw_textures),i={};for(let t of e)if("0"in this._raw_textures[t]){let e=this._base_path+t;i[t]=this.__load_frame_textures(this._raw_textures[t],e)}let s={};for(let t in i)for(let e in i[t])for(let n in i[t][e])n in s||(s[n]={}),t in s[n]||(s[n][t]=[]),s[n][t][e]=i[t][e][n];let n={};for(let e in s)n[e]=new t(s[e]);this.fragments=n}__load_frame_textures(t,e){let i=[];for(let s=0;s in t;++s){let n=`${e}/${s}`;i[s]=this.__load_place_textures(t[s],n)}return i}__load_place_textures(t,e){let i={};for(let s in t){let n=`${e}/${s}`,r=t[s];if(r){const t=this.FragmentTextureType;let e;""==r[""]?(e._url=n,i[s]=e):"string"==typeof r[""]?(e=new t(r),i[s]=e):"hairShade"==s&&(e=new t(r[0]),i[s]=e),e&&(e._slot=this.categoryInfo.slot,e._place=s,e.classList=[e._slot,"item"+this.id,e._place,e._raw.z,"z"+e.z].join(" "))}}return i}get FragmentTextureType(){return m}__load_slot(){if(!this._raw.info.islot)return;let t=this._raw.info.islot.match(/([A-Z][a-z0-9])/g);for(let e in t){const i=t[e],s=_[i];this.islot[i]=s,s>this.slot_order&&(this.slot_order=s)}let e=this._raw.info.vslot.match(/([A-Z][a-z0-9])/g);for(let t in e){const i=e[t];this.vslot[i]=i}}_unload(){this.fragments=null,this.effect}get opacity(){for(let t in this.fragments)for(let e in this.fragments[t].textures)for(let i=0;i<this.fragments[t].textures[e].length;++i){let s=this.fragments[t].textures[e][i];if(s)return s.opacity}}set opacity(t){for(let e in this.fragments)for(let i in this.fragments[e].textures)for(let s=0;s<this.fragments[e].textures[i].length;++s){let n=this.fragments[e].textures[i][s];n&&(n.opacity=t)}}setFilter(t,e,i){for(let s in this.fragments)for(let n in this.fragments[s].textures)for(let r=0;r<this.fragments[s].textures[n].length;++r){let o=this.fragments[s].textures[n][r];o&&(o.filter.hue=t,o.filter.sat=e,o.filter.bri=i)}}getIconUrl(){return s.c.getIconUrl(this.id)}getIconRawUrl(){return s.c.getIconRawUrl(this.id)}get _raw_textures(){return this._raw}get _base_path(){return this._url}}class b extends w{constructor(){super()}get _animation_type(){return"action"}getFrameCount(t){try{return t.slots.body.fragments.body.textures[t.action].length}catch(t){return 0}}getDelay(t){try{const e=this._raw[t.action][t.action_frame].delay;if(null!=e)return!isNaN(e)&&isFinite(e),e}catch(t){}return 120}get fragmentConstructor(){return y}}class S extends b{constructor(){super()}get FragmentTextureType(){return u}}class v extends w{constructor(){super()}get _animation_type(){return"emotion"}getFrameCount(t){try{return t.slots.face.fragments.face.textures[t.emotion].length}catch(t){return 0}}getDelay(t){try{const e=this._raw[t.emotion][t.emotion_frame].delay;if(null!=e)//!isNaN(d) && isFinite(d)
return e}catch(t){}return 60}get fragmentConstructor(){return A}}s.c._info["0000"].fragmentType=class extends b{constructor(){super()}},s.c._info["0001"].fragmentType=class extends b{constructor(){super(),this.elfEarFragment=null,this.lefEarFragment=null,this.highlefEarFragment=null}__load_fragments(){super.__load_fragments(),this.fragments&&(this.fragments.ear&&(this.elfEarFragment=this.fragments.ear,delete this.fragments.ear),this.fragments.lefEar&&(this.lefEarFragment=this.fragments.lefEar,delete this.fragments.lefEar),this.fragments.highlefEar&&(this.highlefEarFragment=this.fragments.highlefEar,delete this.fragments.highlefEar))}get elfEar(){return null!=this.fragments.ear}set elfEar(t){this.elfEarFragment&&(t?this.fragments.ear=this.elfEarFragment:delete this.fragments.ear)}get lefEar(){return null!=this.fragments.lefEar}set lefEar(t){this.lefEarFragment&&(t?this.fragments.lefEar=this.lefEarFragment:delete this.fragments.lefEar)}get highlefEar(){return null!=this.fragments.highlefEar}set highlefEar(t){this.highlefEarFragment&&(t?this.fragments.highlefEar=this.highlefEarFragment:delete this.fragments.highlefEar)}},s.c._info["0002"].fragmentType=class extends v{constructor(){super()}},s.c._info["0003"].fragmentType=S,s.c._info["0004"].fragmentType=S,s.c._info["0100"].fragmentType=b,s.c._info["0101"].fragmentType=v,s.c._info["0102"].fragmentType=b,s.c._info["0103"].fragmentType=b,s.c._info["0104"].fragmentType=b,s.c._info["0105"].fragmentType=b,s.c._info["0106"].fragmentType=b,s.c._info["0107"].fragmentType=b,s.c._info["0108"].fragmentType=b,s.c._info["0109"].fragmentType=b,s.c._info["0110"].fragmentType=b,s.c._info["0170"].fragmentType=class extends b{constructor(){super(),this.use_category=null}async load(t,e,i,s){if(s||""==s)return this.use_category=s.slice(2,4),super.load(t,e,i);console.warn("no use_category")}get _raw_textures(){return this._raw[this.use_category]}get _base_path(){return this._url+this.use_category}};class C{constructor(){this._ordered_slot=[],this._hair=null,this._hair2=null,this._hairMix2=null,this._hair3=null,this._hairMix3=null,this.body=null,this.head=null,this.face=null,this.hair=null,this.cap=null,this.accessoryFace=null,this.accessoryEyes=null,this.accessoryEars=null,this.coat=null,this.longcoat=null,this.pants=null,this.shoes=null,this.glove=null,this.cape=null,this.shield=null,this.weapon=null,Object.defineProperty(this,"_ordered_slot",{configurable:!0,writable:!0,enumerable:!1,value:[]}),Object.defineProperty(this,"_hair",{writable:!0,enumerable:!1,value:null}),Object.defineProperty(this,"_hair2",{writable:!0,enumerable:!1,value:null}),Object.defineProperty(this,"_hairMix2",{writable:!0,enumerable:!1,value:null}),Object.defineProperty(this,"_hair3",{writable:!0,enumerable:!1,value:null}),Object.defineProperty(this,"_hairMix3",{writable:!0,enumerable:!1,value:null})}get hair(){return this._hair}set hair(t){this._hair=t,t&&(this._hair2&&this._hairMix2&&(this.hairColor2=this.hairColor2,this.hairMix2=this.hairMix2),this._hair3&&this._hairMix3&&(this.hairColor3=this.hairColor3,this.hairMix3=this.hairMix3))}async __loadColoredHair(t){const e=s.a.getColorHairID(this.hair.id,t),i=s.c.get(e);if(i){const t=`/Character/${i.path+(i.path?"/":"")+e}`,s=void 0;let n=new S;return await n.load(t,e,i,s),n}}get hairColor2(){if(this._hair2)return Number(s.a.getHairColor(this._hair2.id))}set hairColor2(t){if(!t)return void console.error(new TypeError);let e=s.a.getColorHairID(this.hair.id,t);this._hair2&&e==this._hair2.id||(e==this._hair.id?(this._hair2=null,this.hairMix2=0):(this.hair.$promise_hair2=this.__loadColoredHair(t),this.hair.$promise_hair2.then(t=>{delete this.hair.$promise_hair2,this._hair2=t,this._hair2&&null!=this.hairMix2&&(this.hairMix2=this.hairMix2)})))}get hairMix2(){return this._hairMix2}set hairMix2(t){t=Number(t),Promise.resolve(this.hair.$promise_hair2).then(()=>{let e=this._hair2,i=this.hair;if(e&&i){for(let s in e.fragments)for(let n in e.fragments[s].textures)for(let r=0;r<e.fragments[s].textures[n].length;++r){let o=e.fragments[s].textures[n][r],a=i.fragments[s].textures[n][r];a&&(a.graph2=o,a.graph2.opacity=t)}this._hairMix2=t}})}get hairColor3(){if(this._hair3)return Number(s.a.getHairColor(this._hair3.id))}set hairColor3(t){if(!t)return void console.error(new TypeError);let e=s.a.getColorHairID(this.hair.id,t);this._hair3&&this._hair3.id==e||(this._hair.id==e||this._hair2.id==e?(this._hair3=null,this.hairMix3=0):(this.hair.$promise_hair3=this.__loadColoredHair(t),this.hair.$promise_hair3.then(t=>{delete this.hair.$promise_hair3,this._hair3=t,this._hair3&&null!=this.hairMix3&&(this.hairMix3=this.hairMix3)})))}get hairMix3(){return this._hairMix3}set hairMix3(t){t=Number(t),Promise.resolve(this.hair.$promise_hair3).then(()=>{let e=this._hair3,i=this.hair;if(e&&i){for(let s in e.fragments)for(let n in e.fragments[s].textures)for(let r=0;r<e.fragments[s].textures[n].length;++r){let o=e.fragments[s].textures[n][r],a=i.fragments[s].textures[n][r];a&&(a.graph3=o,a.graph3.opacity=t)}this._hairMix3=t}})}async _use(t,e,i){if(!t)return;const n=s.c.get(t);if(n){let s,r=`/Character/${n.path+(n.path?"/":"")+t}`;if(e instanceof w)alert("CharacterSlots # _use: param loadedEquip ??"),s=e;else{e&&alert("CharacterSlots # _use: param loadedEquip ??"),s=new(n.fragmentType||b)}0,e||await s.load(r,t,n,i)?(this[n.slot]&&this[n.slot]._unload(),this[n.slot]=s,this._ordered_slot[s.slot_order]=s):console.warn("item("+t+") is not exist")}}_unuse(t){if(!t)return;let e,i;if(t instanceof w?(t=(i=t).id,e=i.categoryInfo):e=s.c.get(t),"head"!=e.slot&&"body"!=e.slot&&this[e.slot]&&this[e.slot].id==t){i=this[e.slot];for(let t in i.islot){let e=i.islot[t];this._ordered_slot[e]&&this._ordered_slot[e]._unload(),delete this._ordered_slot[e]}return!0}return!1}_clear(){this.face=null,this.hair=null,this.cap=null,this.accessoryFace=null,this.accessoryEyes=null,this.accessoryEars=null,this.coat=null,this.longcoat=null,this.pants=null,this.shoes=null,this.glove=null,this.cape=null,this.shield=null;let t=this.head,e=this.body;this._ordered_slot=[],t&&(this._ordered_slot[t.slot_order]=t),e&&(this._ordered_slot[e.slot_order]=e)}_stringify(){let t=["c"];if(this.body&&t.push(this.body.id),this.head&&t.push(this.head.id),this.face&&t.push(this.face.id+"|"+this.face.id),this.hair){let e=[];e.push(this.hair.id),this.hairColor2&&this.hairMix2>0&&e.push(this.hairColor2+"%"+Math.trunc(100*this.hairMix2)),this.hairColor3&&this.hairMix3>0&&e.push(this.hairColor3+"%"+Math.trunc(100*this.hairMix3)),t.push(e.join("|"))}return this.cap&&t.push(this.cap.id),this.accessoryFace&&t.push(this.accessoryFace.id),this.accessoryEyes&&t.push(this.accessoryEyes.id),this.accessoryEars&&t.push(this.accessoryEars.id),this.coat&&t.push(this.coat.id),this.longcoat&&t.push(this.longcoat.id),this.pants&&t.push(this.pants.id),this.shoes&&t.push(this.shoes.id),this.glove&&t.push(this.glove.id),this.shield&&t.push(this.shield.id),this.cape&&t.push(this.cape.id),this.weapon&&t.push(this.weapon.id),t.join(",")}toJSON(){let t=[];return this.body&&t.push(this.body.id),this.head&&t.push(this.head.id),this.face&&t.push(this.face.id),this.hair&&t.push(this.hair.id),this.cap&&t.push(this.cap.id),this.accessoryFace&&t.push(this.accessoryFace.id),this.accessoryEyes&&t.push(this.accessoryEyes.id),this.accessoryEars&&t.push(this.accessoryEars.id),this.coat&&t.push(this.coat.id),this.longcoat&&t.push(this.longcoat.id),this.pants&&t.push(this.pants.id),this.shoes&&t.push(this.shoes.id),this.glove&&t.push(this.glove.id),this.shield&&t.push(this.shield.id),this.cape&&t.push(this.cape.id),this.weapon&&t.push(this.weapon.id),t}*enumerate(){this.face&&(yield this.face),this.hair&&(yield this.hair),yield*this.enumerate_equip()}*enumerate_equip(){this.cap&&(yield this.cap),this.accessoryFace&&(yield this.accessoryFace),this.accessoryEyes&&(yield this.accessoryEyes),this.accessoryEars&&(yield this.accessoryEars),this.coat&&(yield this.coat),this.longcoat&&(yield this.longcoat),this.pants&&(yield this.pants),this.shoes&&(yield this.shoes),this.glove&&(yield this.glove),this.shield&&(yield this.shield),this.cape&&(yield this.cape),this.weapon&&(yield this.weapon)}*enumerate_face(){this.face&&(yield this.face),this.accessoryFace&&(yield this.accessoryFace)}}class B{constructor(){this.ear=void 0,this.useEquip=[],this.unuseEquip=[],this.hair2=void 0,this.hairMix2=void 0,this.weapon=void 0,this.weaponType=void 0}clear(){this.ear=void 0,this.useEquip=[],this.unuseEquip=[],this.hair2=void 0,this.hairMix2=void 0,this.weaponType=void 0}}class V{constructor(){this._$dirty=0,this.job=null,this.subJob=null,this.actani=new h.a,this.speed=1,this.fixed_speed=!1,this._action="stand1",this._action_frame=0,this._action_time=0,this._emotion="blink",this._emotion_frame=0,this._emotion_time=0,this._emotion_frame_sequence=[0,1,2,1],this.slots=new C,this.__require_update=!0,this.__frag_list=[],this.$$changeLog=new B}_clone(){alert(this.constructor.name+"::_clone");let t=new this.constructor;if(t){t.speed=0,t.x=this.x,t.y=this.y,t.angle=this.angle,t.action=this.action,t.action_frame=this.action_frame,t.emotion=this._emotion,t.emotion_frame=this.emotion_frame;for(let e in this.slots){this.slots[e]&&(t.slots[e]=this.slots[e])}return t}}_waitFrameTexturesLoaded(){let t=[];for(let e in this.slots){let i=this.slots[e];if(i){"function"!=typeof i.getFrameCount&&alert('typeof item.getFrameCount != "function"');let e=i.getFrameCount(this);for(let s in i.fragments){let n=i.fragments[s];for(let i=0;i<e;++i){let e=n.getFrameTexture(this,i);e&&!e._isLoaded_or_doload()&&t.push(e.$promise)}}}}return Promise.all(t)}initAnimation(){this.action="stand1",this._action_time=0,this._action_frame=0,this.emotion="blink",this._emotion_time=0,this._emotion_frame=0}getSpeed(){return this.fixed_speed?1:this.speed}get elfEar(){if(this.slots.head)return this.slots.head.elfEar}set elfEar(t){this.slots.head&&(this.slots.head.elfEar=t)}get lefEar(){if(this.slots.head)return this.slots.head.lefEar}set lefEar(t){this.slots.head&&(this.slots.head.lefEar=t)}get highlefEar(){if(this.slots.head)return this.slots.head.highlefEar}set highlefEar(t){this.slots.head&&(this.slots.head.highlefEar=t)}get ear(){if(this.slots.head)return this.slots.head.lefEar?"lef":this.slots.head.elfEar?"elf":this.slots.head.highlefEar?"highlef":"human"}set ear(t){this.slots.head?"elf"==t?(this.slots.head.elfEar=!0,this.slots.head.lefEar=!1,this.slots.head.highlefEar=!1,this.$$changeLog.ear=t):"lef"==t?(this.slots.head.lefEar=!0,this.slots.head.elfEar=!1,this.slots.head.highlefEar=!1,this.$$changeLog.ear=t):"highlef"==t?(this.slots.head.elfEar=!1,this.slots.head.lefEar=!1,this.slots.head.highlefEar=!0,this.$$changeLog.ear=t):(this.slots.head.elfEar=!1,this.slots.head.lefEar=!1,this.slots.head.highlefEar=!1,this.$$changeLog.ear="human"):this.$$changeLog.ear=void 0}get action(){return this._action}set action(t){this.actani._action!=t&&this.slots.body&&(this._action=t,this.actani.reload(t),this.__require_update|=!0)}get action_frame(){const t=this.action_frame_count;return t?this._action_frame%t:0}set action_frame(t){this._action_time=0,this._action_frame=t,this.__require_update|=!0}_get_action_next_frame(t){const e=this.action_frame_count;if(e){let i=this._action_frame+t;return i<0?e-1:i%e}return 0}get action_time(){return this._action_time}set action_time(t){this.action_frame_count&&(t<this.action_delay?this._action_time=t:(this._action_time=0,++this._action_frame,this.__require_update|=!0))}get action_delay(){return this.slots.body?this.slots.body.getDelay(this):180}get action_frame_count(){try{if(this.slots.body)return this.slots.body.getFrameCount(this)}catch(t){}return 0}get emotion(){return this._emotion}set emotion(t){this._emotion!=t&&this.slots.face&&this.slots.face._action_list.indexOf(t)>=0&&(this._emotion=t,this._emotion_frame=0,this._emotion_time=0,this._emotion_frame_sequence=[...P(this.emotion_frame_count)],this.__require_update|=!0)}*emotion_frame_sequence_generator(t){for(;;)for(yield*P(t);Math.random()<.5;)yield 0}get emotion_frame(){return this._emotion_frame_sequence[this._emotion_frame%this._emotion_frame_sequence.length]}set emotion_frame(t){this._emotion_frame=t,this._emotion_time=0,this.__require_update|=!0}_get_emotion_next_frame(t){let e=this._emotion_frame+t;return e=e<0?this._emotion_frame_sequence.length-1:e%this._emotion_frame_sequence.length,this._emotion_frame_sequence[e]}get emotion_time(){return this._emotion_time}set emotion_time(t){this.emotion_frame_count&&(t<this.emotion_delay?this._emotion_time=t:(this._emotion_time=0,++this._emotion_frame,this.__require_update|=!0))}get emotion_delay(){return this.slots.face?this.slots.face.getDelay(this):60}get emotion_frame_count(){try{if(this.slots.face)return this.slots.face.getFrameCount(this)}catch(t){}return 0}_update(t){this.actani?(this.actani.isEnd()&&this.actani.loop&&this.actani.reset(),this.actani.update(t,this)):this.action_time+=t,this.emotion_time+=t;for(let e in this.slots){let i=this.slots[e];i&&i.effect&&i.effect.update(t)}}update(t){t*=this.getSpeed(),this._update(t)}__forceUpdate(t){this._$dirty=-Math.random()+3.1415926535897*Math.random(),this._update(0|t),this.__update_frag_list()}_draw(t,e,i,s,n){t.pushGlobalAlpha(),this.__require_update&&(this.__update_frag_list(),this.__require_update=!1),this.__draw_list(t,this.__frag_list,e,i,s,n),t.popGlobalAlpha()}__draw_list(t,e,i,s,n,r){t.pushMatrix(),t.translate(i,s),t.rotate(window.m_a||n),r&&t.scale(-1,1);for(let e in this.slots){let i=this.slots[e];i&&i.effect&&i.effect.render(t,this)}for(let i in e){e[i].render(t,this)}t.popMatrix()}__add_equip_to_frag_list(t,e){if(null!=e&&!(e>0)){for(let i in e.vslot){t[e.vslot[i]]=[]}for(let i in e.fragments){let s=c[i];if(null!=s){let n=e.fragments[i].getTexture(this);n&&(t[s]?t[s].push(n):t[s]=[n])}else if("default"==i){let n=e.fragments[i].getTexture(this);s=e._raw.info.islot,n&&(t[s]?t[s].push(n):t[s]=[n])}else{let t=e.fragments[i].getTexture(this);t&&this.__add_frag_to_list(t)}}}}__update_frag_list(){this.__frag_list=[];let t={};for(let e=2;e<=3;++e){let i=this.slots["_hair"+e];this.__add_equip_to_frag_list(t,i)}for(let e in this.slots._ordered_slot){let i=this.slots._ordered_slot[e];this.__add_equip_to_frag_list(t,i)}let e=!1;for(let i in t){let s=t[i];for(let t in s){let i=s[t];if(e){if(i._place.startsWith("face"))continue}else i._place.startsWith("backHair")&&(e=!0);this.__add_frag_to_list(i)}}{let t=this.__frag_list[114];t&&this.__frag_list.push(t)}this._calcBoundBox()}__add_frag_to_list(t){t.update(this),this.__frag_list[t.z]=t}_calcBoundBox(){let t=0,e=0,i=0,s=0;for(let n in this.__frag_list){let r=this.__frag_list[n];if(r.texture){let n=r.relative.x,o=r.relative.y,a=n+r.width,l=o+r.height;t=Math.min(t,n),e=Math.min(e,o),i=Math.max(i,a),s=Math.max(s,l)}}return this._boundBox=new l.Rectangle(Math.trunc(t),Math.trunc(e),Math.trunc(i-t),Math.trunc(s-e)),this._boundBox}toJSON(){let t={hair2:this.slots._hair2.id,hairMix2:this.slots.hairMix2,slots:this.slots.toJSON()};return this.slots.head.elfEar?t.ear="elf":this.slots.head.lefEar?t.ear="lef":this.slots.head.highlefEar&&(t.ear="highlef"),t}}class M extends V{constructor(){super(),this.x=0,this.y=0,this.z=5,this.tx=0,this.ty=0,this.angle=0,this.front=-1,this.__load_task=[],this.render=function(t){},this._boundBox=null}static async Init(){let t=await Promise.all([$get.data("/zmap"),$get.data("/smap"),p.Init(),h.a.Init()]);_={},Object.keys(t[0]).reverse().forEach((t,e)=>_[t]=e+1),c=t[1]}load(){this.use("00002012"),this.use("00012012");let t=Promise.all([...this.__load_task]);return function(t,e){e.then(function(e){t.initAnimation(),t.render=t._render})}(this,t),t}update(t){this.waitLoaded(),super.update(t)}_render(t){const e=Math.trunc(this.x+this.tx),i=Math.trunc(this.y+this.ty);this._draw(t,e,i,this.angle,this.front>=1)}_setup_test(){this.use("00026509"),this.use("00044041"),this.use("01053169"),this.use("01071077")}async __synchronize(t){this.__forceUpdate(t),await this.waitLoaded(),await this._waitFrameTexturesLoaded()}async waitLoaded(){let t=this.__load_task;t&&t.length&&await Promise.all(t).then(()=>{this.__load_task=[]})}async use(t,e){switch(e||(e=s.c.getJobWeaponCategory(this.job)),t[0]){case"0":s.c.isCashWeapon(t)?this.$$changeLog.weapon=t:this.$$changeLog.useEquip.push(t);let i=this.slots._use(t,null,e);this.__load_task.push(i),await i,this._calcBoundBox()}}unuse(t){if("0"==t[0]){let e=this.slots._unuse(t);return e&&(this.$$changeLog.unuseEquip.push(t),this._calcBoundBox()),e}}_parse(t){if(!t)return;let e=t.split(",");this.slots._clear(),e.forEach((t,e,i)=>{if(t.indexOf("|")>=0){const e=t.split("|"),i=s.c.get(e[0]);let n;if("face"==i.slot)n=e[1],this.$$changeLog.useEquip.push(n),this.use(n);else if("hair"==i.slot){const t=this.slots;let i=e[1],s=e[2];n=e[0],this.$$changeLog.useEquip.push(n),this.use(n).then(()=>{if(i&&i.indexOf("%")>=0){let e=i.split("%");const s=e[0],n=e[1]/100;this.$$changeLog.hair2=s,this.$$changeLog.hairMix2=n,t.hairColor2=s,t.hairMix2=n}if(s&&s.indexOf("%")>=0){let e=s.split("%");const i=e[0],n=e[1]/100;this.$$changeLog.hair3=i,this.$$changeLog.hairMix3=n,t.hairColor3=e[0],t.hairMix4=e[1]/100}})}else"weapon"==i.slot&&(this.$$changeLog.weaponType=e[1],this.$$changeLog.weapon=n,this.use.apply(this,e,e[1]))}else Number.isFinite(parseInt(t,10))&&this.use(t)})}get hairColor(){return this.slots.hair?s.a.getHairColor(this.slots.hair.id):"0"}set hairColor(t){if(this.slots.hair&&t!=this.hairColor){let e=s.a.getColorHairID(this.slots.hair.id,t);this.use(e)}}get faceColor(){return this.slots.face?s.a.getFaceColor(this.slots.face.id):"0"}set faceColor(t){if(this.slots.face&&t!=this.faceColor){let e=s.a.getColorFaceID(this.slots.face.id,t);this.use(e)}}commitChange(t){if(t.ear&&(this.ear=t.ear),this.useEquip)for(let t of this.useEquip)this.use(t);if(this.unuseEquip)for(let t of this.unuseEquip)this.unuse(t);t.hair2&&t.hairMix2&&(this.slots.hairColor2=t.hair2,this.slots.hairMix2=t.hairMix2),t.hair3&&t.hairMix3,t.weapon&&t.weaponType&&this.use(t.weapon,t.weaponType)}_stringify(t){let e=this.slots._stringify();return t?`chara._parse('${e}')`:e}_outlink(){if(this.slots.body&&this.slots.body.id&&this.slots.face&&this.slots.face.id&&this.action&&this.emotion){let t="https://labs.maplestory.io/api/GMS/latest/character/center/"+this.slots.body.id+"/",e=[...this.slots.enumerate()].map(t=>parseInt(t.id,10));return e[0]=this.slots.face.id+":"+this.emotion,t+=e.join(","),t+="/"+this.action+"?showears="+(this.elfEar?"true":"false"),t+="&showLefEars="+(this.lefEar?"true":"false")}console.log("character need body, face, action, emotion")}_download(){window.open(this._outlink())}_save_as_svg(){this.__texture_to_base64().then(t=>{let e=this.id+".svg",i='<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd" >';i+='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink= "http://www.w3.org/1999/xlink">\n',i+='<g transform="translate(32, 96)">',t.forEach(function(t){if(t){let e=t.classList;i+=`\t<image class="${e}" opacity="${t.opacity}" x="${t.relative.x}" y="${t.relative.y}" width="${t.width}" height="${t.height}" xlink:href="${t._url}"></image>\n`}}),i+="</g>",i+='<text x="0" y="122" fill="transparent">'+this._stringify(!1)+"</text>",i+="</svg>",DownloadData(i,"image/svg+xml;utf8",e)})}_save_as_png(t,e){let i=this._calcBoundBox(),s=i.size,n=-i.left,r=i.height;try{t.$swapCanvas()}catch(t){return void console.error(t)}const o=t._ctx2.canvas.width,a=t._ctx2.canvas.height;t.ctx.canvas.width=s.x,t.ctx.canvas.height=s.y;try{this._draw(t,n,r,0,!1)}catch(t){console.error(t)}let l=t.ctx.canvas.toDataURL("image/png");{let t=document.createElement("a"),i=`${e?e+".":""}${this.action}[${this.action_frame}].${this.emotion}[${this.emotion_frame}].png`;t.id=i,t.download=i,t.href=l,document.body.appendChild(t),t.click(),document.body.removeChild(t)}t.ctx.canvas.width=o,t.ctx.canvas.height=a;try{t.$swapCanvas()}catch(t){console.error(t)}return l}async __texture_to_base64(){let t=[];return this.__frag_list.forEach(function(e){if(e){if(e._url.startsWith("data:")?t.push(e):t.push(async function(){return e.texture.$src=e._url,e._url=await I(e._url),e}()),e.graph2){let i=e.graph2._url;i.startsWith("data:")?t.push(e.graph2):t.push(async function(){return e.texture.$src=e._url,e.graph2._url=await I(i),e.graph2}())}if(e.graph3){let i=e.graph3._url;i.startsWith("data:")?t.push(e.graph3):t.push(async function(){return e.texture.$src=e._url,e.graph3._url=await I(i),e.graph3}())}}}),Promise.all(t)}}function*P(t){let e=0;for(;e<t;++e)yield e;for(e-=2;e>0;--e)yield e}function I(t){return new Promise(function(e,i){let s=new XMLHttpRequest;s.onload=function(){let t=new FileReader;t.onloadend=function(){e(t.result)},t.onerror=function(t){i(t)},t.readAsDataURL(s.response)},s.open("GET",t),s.responseType="blob",s.send()})}Object(n.AddInitTask)(M.Init())},338:function(t,e,i){"use strict";i.r(e),i.d(e,"AddInitTask",function(){return h}),i.d(e,"InitAll",function(){return _});var s=i(357),n=i.n(s),r=(i(397),i(398),i(399),i(400),i(401),i(402),i(403),i(404),i(405),i(406),i(407),i(408),i(372),i(339)),o=i.n(r),a=i(336);window.jQuery=n.a,window.$=n.a,o.a.config.productionTip=!1,o.a.use(a.default),window.onwheel||(window.onwheel=function(){});let l=[];function h(t){l.push(t)}function _(){let t=Promise.all(l);return l=[],t}},340:function(t,e,i){"use strict";i.r(e),i.d(e,"ChatBalloon",function(){return n});i(333);var s=i(351);class n{constructor(){this._raw=null}async load(t){const e=[this.constructor._base_path,t].join("/");Object.defineProperty(this,"_raw",{value:await $get.data(e)}),this.nw=new s.a(this._raw.nw),this.n=new s.a(this._raw.n),this.ne=new s.a(this._raw.ne),this.w=new s.a(this._raw.w),this.c=new s.a(this._raw.c),this.e=new s.a(this._raw.e),this.sw=new s.a(this._raw.sw),this.s=new s.a(this._raw.s),this.se=new s.a(this._raw.se),this.arrow=new s.a(this._raw.arrow),n.cache[t]=this}draw(t,e,i,s){let n=[];for(let t=0;t<e.length;t+=12){let i=e.slice(t,t+12);n.push(i)}if(!n.length)return;const r=this.c.height,o=t.ctx;o.font="12px 微軟正黑體",o.textAlign="center",o.textBaseline="top";const a=n.map(t=>o.measureText(t).width+0+0).sort((t,e)=>e-t)[0],l=Math.ceil(a/this.n.width)*this.n.width,h=l/2,_=n.length*r+0+0;i=Math.trunc(i-h),s=Math.trunc(s-_-this.arrow.height),this.nw.draw2(i,s),this.n._drawPattern(i,s,l,this.n.height),this.ne.draw2(i+l,s);const c=this.w.width-this.w.x;this.w._drawPattern(i+c,s,this.w.width,_),this.c._drawPattern(i+c,s,l,_),this.e._drawPattern(i+c+l,s,this.e.width,_);const m=this.arrow.width/2,u=h-m;this.sw.draw2(i,s+_),this.s._drawPattern(i,s+_,u,this.s.height),this.s._drawPattern(i+h+m,s+_,u,this.s.height),this.se.draw2(i+l,s+_),this.arrow.draw2i(i-m+h,s+_);for(let t=0,e=s;t<n.length;++t,e+=r){let s=n[t];o.fillStyle="black",o.fillText(s,i+h+0,e+0)}}static get _base_path(){return"/UI/ChatBalloon"}}n.cache={},window.$images_ChatBalloon=n.cache},343:function(t,e,i){"use strict";i.r(e);i(328),i(332);var s=i(333),n=i(335),r=(i(334),i(363)),o=(i(364),i(365),i(395)),a=i(327);class l{constructor(){this.socket=this._conn(),window.$io=this.socket,this.charaMap={}}_findChara(t,e){let i=this.charaMap[t];i&&e.call(this,i)}_addRemoteCharaPacketListener(t,e){this.socket.on(t,(...t)=>{let i=t[0].id,s=this.charaMap[i];s&&e.call(this,s,...t)})}_conn(){let t;if(null!=window.io){let e=new URL(window.location);e.port=8787;const i=(t=io(e.href)).emit;t.emit=function(e,s){return new Promise(function(n,r){i.call(t,e,s,function(){n.apply(this,arguments)})})}}else t={emit:()=>!0,on:()=>!0,once:()=>!0};return t}get $scene_map(){return window.scene_map}async login(t,e){await this.socket.emit("login",{account:"aaa",password:"aaa"})?console.info("login"):console.info("login failed")}async selectWorld(t,e){await this.socket.emit("selectWorld",{world:0,channel:0})?console.info("selectWorld"):console.info("selectWorld failed")}async selectChara(t){new o.$RequestPacket_SelectChara;let e=await this.socket.emit("selectChara",{id:123});const i=e.charaData,s=e.remoteCharacters;if(i)try{this._CreateMyCharacter(i),this.onEnterRemoteChara(s)}catch(t){alert(err.message),console.error(err)}else alert("selectChara: chara not exist")}async _CreateMyCharacter(t){let e=await a.app.store.dispatch("_createChara",{emplace:{id:t.id,code:t.equips_code}});this.chara=e,this.$scene_map.load(t.mapId),e._$data=e._$data||{guildId:"",partyId:""}}static async _CreateMyCharacter(t){let e=await a.app.store.dispatch("_createChara",{emplace:{id:t.id,code:t.equips_code}});return(e=e)._$data=e._$data||{guildId:"",partyId:""},e}onEnterRemoteChara(t){let e=t.map(t=>a.app.store.dispatch("_createChara",{remote_chara:{id:t.id,code:t.equips_code}}).then(t=>{try{const e=this.$scene_map.controller;let i=t;i.$physics=e.$createRemotePlayer(i,i.$$renderer),this.charaMap[i.id]=i}catch(t){alert(err.message),console.error(err)}}));return Promise.all(e)}onRemoteChat(t,e,i){t.chatCtrl.style=e.style,t.chatCtrl.enter(e.text),app.vue.$refs.statusBar.pushChatHistory(e.type,e.style,e.text)}onRemoteCharaMove(t,e,i){t.$move(e)}onRemoteCharaAnim(t,e,i){t.$anim(e)}onRemoteCharaSkill(t,e,i){t.invokeSkill(e.skillId)}onRemoteAvatarModified(t,e,i){t.renderer.use(e.itemId)}async $test(){this.socket.on("enterRemoteChara",this.onEnterRemoteChara.bind(this)),this._addRemoteCharaPacketListener("remoteChat",this.onRemoteChat),this._addRemoteCharaPacketListener("remoteCharaMove",this.onRemoteCharaMove),this._addRemoteCharaPacketListener("remoteCharaAnim",this.onRemoteCharaAnim),this._addRemoteCharaPacketListener("remoteCharaSkill",this.onRemoteCharaSkill),this._addRemoteCharaPacketListener("remoteAvatarModified",this.onRemoteAvatarModified),await this.login("aaa","aaa"),await this.selectWorld(0,0),await this.selectChara(0)}}class h{constructor(){throw new Error("")}static PushState(t,e){if(!t)return;let i={},s="?map="+t.map_id;i.map_id=t.map_id,e&&e.renderer&&(i.chara=e.renderer._stringify(!1),s+="&chara="+i.chara),history.pushState(i,t._window_title,s),document.title=t._window_title}static PushStateString(t,e){if(!t)return;let i={},s="?map="+t;i.map_id=t,e&&(i.chara=e,s+="&chara="+i.chara),history.pushState(i,scene._window_title,s),document.title=scene._window_title}static async PopState(t){if(t){if(t.chara&&window.chara&&window.chara.renderer){let e=window.chara.renderer._stringify(!1);t.chara!=e&&window.chara.renderer._parse(t.chara)}else l._CreateMyCharacter({id:"chara_1",equips_code:t.chara});scene_map&&scene_map.map_id!=t.map_id&&await scene_map.load(t.map_id)}}}var _=i(374),c=(i(394),i(396));class m{constructor(){this.url=null,this.x=0,this.y=0,this.delay=0}}class u{constructor(){this.frames=[],this.duration=0}async addFrameFromUrl(t){let e=await $get.data(t);return this.addFrame("images"+t,e.origin.x,e.origin.y,e.delay)}addFrame(t,e,i,s){if(!t)throw new TypeError;const n=this.frames.length;let r=new m;return r.url=t,r.x=0|e,r.y=0|i,r.delay=0|s,this.frames.push(r),this.duration+=r.delay,n}async load(t){let e=await $get.data(t);for(let i=0,s=e[i];s;s=e[++i]){this.addFrame(["images",t,i].join("/"),s.origin.x,s.origin.y,s.delay)}}}class d{constructor(){}static createToCSS(t,e,i){const s="Cursor"+Math.trunc(4294967295*Math.random()).toString(16),{frames:n,duration:r}=t;let o=`${e}:hover {\n`;if(o+=`cursor: url(${n[0].url}) ${n[0].x} ${n[0].y}, ${i};\n`,r){o+=`animation-name: ${s}_keyframes;\n`,o+=`animation-duration: ${r}ms;\n`,o+="animation-iteration-count: infinite;\n",o+="}\n";let t=0;o+=`@keyframes ${s}_keyframes {\n`;for(let e=0;e<n.length;++e){const s=n[e];o+=`${Math.trunc(t/r*100)}% { cursor: url(${n[e].url}) ${n[e].x} ${n[e].y}, ${i}; }\n`,t+=s.delay}o+="}\n"}else o+="}";var a=document.createElement("STYLE"),l=document.createTextNode(o);return a.id=s,a.appendChild(l),document.head.appendChild(a),a}}i.d(e,"Game",function(){return p}),window.SCREEN_PRINTLN=function(t,e){2==arguments.length?window._SCREEN_PRINTLN.push({getText:t,getValue:e}):1==arguments.length&&window._SCREEN_PRINTLN.push(arguments[0])},window._SCREEN_PRINTLN=[];window.addEventListener("popstate",function(t){h.PopState(t.state)}),function(){let t=new u,e=t.addFrameFromUrl("/UI/Basic/Cursor/0/0").then(function(e){t.frames[e].delay=200}),i=t.addFrameFromUrl("/UI/Basic/Cursor/12/0").then(function(e){t.frames[e].delay=200});Promise.all([e,i]).then(function(){t.duration=400,d.createToCSS(t,".ui-clickable","pointer")})}(),window.onkeydown=function(t){if(t.target!=document.body)return;let e=t.key;null==e||$gv.input_keyDown[e]||(null!=$gv.input_keyDown[e]?++$gv.input_keyDown[e]:$gv.input_keyDown[e]=1),"Space"==t.code&&$("#m_is_run").click(),"F2"==t.code&&($gv.m_editor_mode=!$gv.m_editor_mode)},window.onkeyup=function(t){if(t.target!=document.body)return;let e=t.key;null!=e&&$gv.input_keyDown[e]&&($gv.input_keyDown[e]=0,$gv.input_keyUp[e]=1)},Object.defineProperty(window,"$m_is_run",{get:function(){return $("#m_is_run").attr("checked")},set:function(t){$("#m_is_run").attr("checked",!t),$("#m_is_run").click()}}),window.onmousedown=function(t){$gv.m_editor_mode&&!t.target.classList.contains("Editor")||(1==t.which?($gv.mouse_dl=1,$gv.mouse_ul=0):2==t.which?($gv.mouse_dm=1,$gv.mouse_um=0):3==t.which&&($gv.mouse_dr=1,$gv.mouse_ur=0),$gv.mouse_x=t.pageX,$gv.mouse_y=t.pageY)},window.onmouseup=function(t){$gv.m_editor_mode&&!t.target.classList.contains("Editor")||(1==t.which?($gv.mouse_dl=0,$gv.mouse_ul=1):2==t.which?($gv.mouse_dm=0,$gv.mouse_um=1):3==t.which&&($gv.mouse_dr=0,$gv.mouse_ur=1),$gv.mouse_x=t.pageX,$gv.mouse_y=t.pageY)},window.onmousemove=function(t){$gv.m_editor_mode&&!t.target.classList.contains("Editor")||($gv.mouse_x=t.pageX,$gv.mouse_y=t.pageY,$gv.mouse_move=1)};class p{constructor(){this.timer=0,this.timer_=0,this._dTimer=0,this.fps_arr=[],this.frame_s_arr=[],this.scene_map=new r.c,window.scene_map=this.scene_map,$gv.scene_map=window,scene_map.onload=function(){h.PushState(this,window.chara)},this._loop=this._loop.bind(this),document.getElementById("m_is_run").onchange=function(t){this.m_is_run=!!t.target.checked,this.m_is_run&&(requestAnimationFrame(this._loop),document.getElementById("Screenshot").innerHTML="")}.bind(this),this._$moveViewportSpeed=10}moveViewport(t){const e=this.scene_map,i=$gv.input_keyDown.z?10*this._$moveViewportSpeed:this._$moveViewportSpeed;$gv.input_keyDown.ArrowLeft>0&&($gv.m_viewRect.left-=i),$gv.input_keyDown.ArrowRight>0&&($gv.m_viewRect.left+=i),$gv.input_keyDown.ArrowUp>0&&($gv.m_viewRect.top-=i),$gv.input_keyDown.ArrowDown>0&&($gv.m_viewRect.top+=i);let{left:s,top:n,right:r,bottom:o}=e.mapBound;t&&($gv.m_viewRect.left<s&&($gv.m_viewRect.left=s),$gv.m_viewRect.right>r&&($gv.m_viewRect.left=r-$gv.m_viewRect.width),$gv.m_viewRect.top<n&&($gv.m_viewRect.top=n),$gv.m_viewRect.bottom>o&&($gv.m_viewRect.top=o-$gv.m_viewRect.height))}async _$startClient(){if(scene_map)if(null!=window.io){let t=new l;a.app.client=t,t.$test()}else{let t,e=function(){let t=decodeURIComponent(window.location.search.substring(1)).split("&"),e={};for(let i=0;i<t.length;++i){let s=t[i].split("=");e[s[0]]=s[1]}return e}();t=e.map||window.DEFAULT_MAP_ID;let i=e.chara||"c,00002012,00012012,00026509|00026509,00034873|00034873,01051429,01072392";h.PopState({map_id:t,chara:i})}}get _isMapReady(){const t=this.scene_map;return t&&t.isLoaded()}async run(){console.log("begin render"),this._loop(0)}async forceUpdateScreen(){const t=this.chara;if(t.renderer.__forceUpdate(0),this.m_is_run)return await t.renderer.waitLoaded(),void(t.renderer.__require_update=!0);await t.renderer.waitLoaded(),await t.renderer._waitFrameTexturesLoaded(),await s.IGraph.waitAllLoaded(),document.getElementById("Screenshot").innerHTML="",t.renderer.__require_update=!0,this._loop(0)}_calcFPS(t){try{if(this.timer-this.timer_>=1e3){if(this.fps_arr.length){let t=this.fps_arr.reduce(function(t,e){return t+e})/this.fps_arr.length;document.getElementById("FPS").innerHTML=t.toFixed(2)}if(this.frame_s_arr.length){let t=this.frame_s_arr.reduce(function(t,e){return t+e})/this.frame_s_arr.length;document.getElementById("frame").innerHTML=t.toFixed(2)}this.frame_s_arr=[],this.fps_arr=[],this.timer_=this.timer}else t>0&&Number.isFinite(t)&&(this.fps_arr.push(1e3/t),this.frame_s_arr.push(t))}catch(t){document.getElementById("FPS").innerHTML="-",document.getElementById("frame").innerHTML="-",this.fps_arr=[],this.frame_s_arr=[]}}_requestNextFrame(){this.m_is_run?requestAnimationFrame(this._loop):setTimeout(function(){let t=new Image;t.src=n.engine._canvas.toDataURL(),n.engine.ctx.clearRect(0,0,n.engine.ctx.width,n.engine.ctx.height),document.getElementById("Screenshot").appendChild(t)},0)}_updateScene(t){this.chara;const e=this.charaList;this._isMapReady&&scene_map.update(t);for(let i=0;i<e.length;++i)e[i].update(t);$gv.SceneObjectMgr.Update(t),_.a.Update(t);{const t=a.app.client;if(t&&t.chara){const e=t.chara;e.$emit(window.$io),e.$recMove()}}c.a.update(t)}_renderScene(){const t=this.chara,e=this.charaList;if(n.engine.beginScene(),n.engine.loadIdentity(),n.engine.clearDrawScreen(),$gv.m_viewRect.size=n.engine.screen_size,!$gv.m_editor_mode)if(t&&t.renderer)$gv.m_viewRect.setCenter(t.renderer.x,t.renderer.y);else if(scene_map.controller.player){const t=scene_map.controller.player.getPosition(),e=Math.trunc(t.x*$gv.CANVAS_SCALE+.5),i=Math.trunc(t.y*$gv.CANVAS_SCALE+.5);$gv.m_viewRect.setCenter(e,i)}if($gv.m_editor_mode&&this._isMapReady&&this.moveViewport(!1),$gv.m_is_rendering_map&&this._isMapReady){scene_map.beginRender(n.engine),scene_map.renderBackground(n.engine);for(let i=0;i<scene_map.layeredObject.length;++i){if(scene_map.renderLayeredObject(n.engine,i),scene_map.renderLayeredTile(n.engine,i),scene_map.applyCamera(n.engine),$gv.m_display_other_player)for(let s=0;s<e.length;++s)e[s]!=t&&e[s].$layer==i&&e[s].render(n.engine);scene_map.renderLife(n.engine,i),$gv.m_display_player&&t&&(null!=t.$layer&&t.$layer!=i||!t.renderer||t.render(n.engine)),$gv.SceneObjectMgr.RenderLayer(n.engine,i)}scene_map.applyCamera(n.engine);for(let t=scene_map.layeredObject.length;t<12;++t)$gv.SceneObjectMgr.RenderLayer(n.engine,t);scene_map.endRender(n.engine)}else if($gv.m_display_other_player||$gv.m_display_player){scene_map.applyCamera(n.engine);for(let i=0;i<e.length;++i)e[i]!=t&&$gv.m_display_other_player&&e[i].render(n.engine);$gv.m_display_player&&t&&t.render(n.engine),_.a.Render(n.engine)}c.a.render(n.engine);for(let t=0;t<e.length;++t)e[t]._$drawName(n.engine);for(let t=0;t<e.length;++t)e[t]._$drawChatBalloon(n.engine);if($gv.m_is_rendering_map&&this._isMapReady&&(scene_map.beginRender(n.engine),scene_map.applyCamera(n.engine),scene_map.renderPortal(n.engine),scene_map.renderFrontground(n.engine),scene_map.endRender(n.engine),scene_map.renderParticle(n.engine),scene_map.applyCamera(n.engine),_.a.Render(n.engine),n.engine.loadIdentity()),scene_map.applyCamera(n.engine),$gv.m_display_debug_info){const t=n.engine.ctx;t.beginPath(),t.fillStyle="white",t.fillRect(0,0,96,50),t.fillStyle="black",t.fillText("map origin",5,14,96),t.fillText("view-x: "+$gv.m_viewRect.x.toFixed(0),5,30,96),t.fillText("view-y: "+$gv.m_viewRect.y.toFixed(0),5,46,96)}scene_map.controller.render(n.engine),n.engine.loadIdentity(),$gv.m_display_debug_info&&this._render_debug_info(),n.engine.endScene()}_render_debug_info(){if(this._isMapReady&&scene_map.controller&&scene_map.controller.player){const t=n.engine.ctx,e=t.textAlign,i=t.textBaseline,s=t.lineWidth;t.textBaseline="top",t.lineWidth=2.5,t.strokeStyle="#000";let r=400,o=5;for(let e of window._SCREEN_PRINTLN){const i=e.getValue(),s=e.getText();if(t.fillStyle="#FFF",t.textAlign="right",t.strokeText(s,r-2,o),t.fillText(s,r-2,o),t.textAlign="center",t.strokeText(":",r,o),t.fillText(":",r,o),t.textAlign="left",t.strokeText(i,r+2,o),t.fillText(i,r+2,o),"_val"in e){let n;e._val!=i?(n=e._val,e.__val=e._val,e._val=i):n=e.__val,n!=i&&(t.fillStyle="#0FF"),t.fillStyle="#FFF",t.textAlign="right",t.strokeText(s,r-2+200,o),t.fillText(s,r-2+200,o),t.textAlign="center",t.strokeText(":",r+200,o),t.fillText(":",r+200,o),t.textAlign="left",t.strokeText(n,r+2+200,o),t.fillText(n,r+2+200,o)}else e.__val=i,e._val=i;o+=16}t.textAlign=e,t.textBaseline=i,t.lineWidth=s}}_loop(t){this.scene_map;let e=t-this.timer;this.timer=t,this._requestNextFrame(),this._calcFPS(e),this._updateScene(e),this._renderScene();for(let t in $gv.input_keyDown)$gv.input_keyDown[t]>0&&++$gv.input_keyDown[t];for(let t in $gv.input_keyUp)$gv.input_keyUp[t]=0}get chara(){return window.chara}get charaList(){return a.app.store.state.charaList}get m_is_run(){return window.m_is_run}set m_is_run(t){window.m_is_run=t}}},344:function(t,e,i){"use strict";function s(t,...e){}i.d(e,"b",function(){return s}),i.d(e,"x",function(){return n}),i.d(e,"r",function(){return r}),i.d(e,"s",function(){return o}),i.d(e,"P",function(){return a}),i.d(e,"z",function(){return l}),i.d(e,"D",function(){return h}),i.d(e,"k",function(){return _}),i.d(e,"l",function(){return c}),i.d(e,"v",function(){return m}),i.d(e,"n",function(){return u}),i.d(e,"Q",function(){return d}),i.d(e,"G",function(){return p}),i.d(e,"H",function(){return f}),i.d(e,"T",function(){return y}),i.d(e,"y",function(){return A}),i.d(e,"w",function(){return g}),i.d(e,"I",function(){return x}),i.d(e,"J",function(){return w}),i.d(e,"E",function(){return b}),i.d(e,"F",function(){return S}),i.d(e,"p",function(){return v}),i.d(e,"S",function(){return C}),i.d(e,"t",function(){return B}),i.d(e,"B",function(){return V}),i.d(e,"O",function(){return M}),i.d(e,"N",function(){return P}),i.d(e,"C",function(){return I}),i.d(e,"A",function(){return D}),i.d(e,"K",function(){return k}),i.d(e,"L",function(){return G}),i.d(e,"M",function(){return R}),i.d(e,"o",function(){return L}),i.d(e,"R",function(){return $}),i.d(e,"u",function(){return T}),i.d(e,"m",function(){return F}),i.d(e,"a",function(){return E}),i.d(e,"c",function(){return j}),i.d(e,"d",function(){return O}),i.d(e,"j",function(){return N}),i.d(e,"U",function(){return z}),i.d(e,"q",function(){return q}),i.d(e,"h",function(){return J}),i.d(e,"i",function(){return W}),i.d(e,"e",function(){return U}),i.d(e,"f",function(){return X}),i.d(e,"g",function(){return H});const n=1e37,r=1e-5,o=r*r,a=3.14159265359,l=2,h=8,_=.1,c=2,m=.008,u=2/180*a,d=2*m,p=8,f=32,y=1,A=.2,g=8/180*a,x=2,w=x*x,b=.5*a,S=b*b,v=.2,C=.75,B=-1,V=2147483647,M=.75,P=1,I=.25,D=.5,k=2,G=k*k,R=256,L=2.5,$=.5,T=.01,F=2/180*a;function E(t){return null}function j(t){}function O(t,...e){}class N{constructor(t=0,e=0,i=0){this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}toString(){return this.major+"."+this.minor+"."+this.revision}}const z=new N(2,3,2),q=313;function J(t){return parseInt(t,10)}function W(t){return Math.abs(parseInt(t,10))}function U(t,e){let i=[];for(let s=0;s<t;++s)i.push(e(s));return i}function X(t){const e=[];for(let i=0;i<t;++i)e.push(null);return e}function H(t,e=0){const i=[];for(let s=0;s<t;++s)i.push(e);return i}},345:function(t,e,i){"use strict";i.d(e,"E",function(){return n}),i.d(e,"D",function(){return r}),i.d(e,"F",function(){return o}),i.d(e,"a",function(){return a}),i.d(e,"n",function(){return l}),i.d(e,"m",function(){return h}),i.d(e,"e",function(){return _}),i.d(e,"x",function(){return c}),i.d(e,"j",function(){return m}),i.d(e,"v",function(){return u}),i.d(e,"h",function(){return d}),i.d(e,"w",function(){return p}),i.d(e,"p",function(){return f}),i.d(e,"g",function(){return y}),i.d(e,"q",function(){return A}),i.d(e,"f",function(){return g}),i.d(e,"u",function(){return x}),i.d(e,"b",function(){return w}),i.d(e,"c",function(){return b}),i.d(e,"d",function(){return S}),i.d(e,"o",function(){return v}),i.d(e,"i",function(){return C}),i.d(e,"r",function(){return B}),i.d(e,"s",function(){return V}),i.d(e,"A",function(){return M}),i.d(e,"B",function(){return P}),i.d(e,"C",function(){return k}),i.d(e,"k",function(){return L}),i.d(e,"l",function(){return $}),i.d(e,"t",function(){return T}),i.d(e,"z",function(){return N}),i.d(e,"y",function(){return z});var s=i(344);const n=s.P/180,r=180/s.P,o=2*s.P,a=Math.abs,l=Math.min,h=Math.max;function _(t,e,i){return t<e?e:t>i?i:t}function c(t,e){const i=t[0];t[0]=e[0],e[0]=i}function m(t){return isFinite(t)}function u(t){return t*t}function d(t){return 1/Math.sqrt(t)}const p=Math.sqrt,f=Math.pow;function y(t){return t*n}function A(t){return t*r}const g=Math.cos,x=Math.sin,w=Math.acos,b=Math.asin,S=Math.atan2;function v(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,(t|=t>>16&65535)+1}function C(t){return t>0&&0==(t&t-1)}function B(){return 2*Math.random()-1}function V(t,e){return(e-t)*Math.random()+t}class M{constructor(t=0,e=0){this.x=t,this.y=e}Clone(){return new M(this.x,this.y)}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return this.x=t.x,this.y=t.y,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this}SelfAddXY(t,e){return this.x+=t,this.y+=e,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this}SelfSubXY(t,e){return this.x-=t,this.y-=e,this}SelfMul(t){return this.x*=t,this.y*=t,this}SelfMulAdd(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SelfMulSub(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const t=this.x,e=this.y;return Math.sqrt(t*t+e*e)}LengthSquared(){const t=this.x,e=this.y;return t*t+e*e}Normalize(){const t=this.Length();if(t>=s.r){const e=1/t;this.x*=e,this.y*=e}return t}SelfNormalize(){const t=this.Length();if(t>=s.r){const e=1/t;this.x*=e,this.y*=e}return this}SelfRotate(t){const e=Math.cos(t),i=Math.sin(t),s=this.x;return this.x=e*s-i*this.y,this.y=i*s+e*this.y,this}IsValid(){return isFinite(this.x)&&isFinite(this.y)}SelfCrossVS(t){const e=this.x;return this.x=t*this.y,this.y=-t*e,this}SelfCrossSV(t){const e=this.x;return this.x=-t*this.y,this.y=t*e,this}SelfMinV(t){return this.x=l(this.x,t.x),this.y=l(this.y,t.y),this}SelfMaxV(t){return this.x=h(this.x,t.x),this.y=h(this.y,t.y),this}SelfAbs(){return this.x=a(this.x),this.y=a(this.y),this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this}SelfSkew(){const t=this.x;return this.x=-this.y,this.y=t,this}static MakeArray(t){return Object(s.e)(t,t=>new M)}static AbsV(t,e){return function(t,e){return e.x=a(t.x),e.y=a(t.y),e}(t,e)}static MinV(t,e,i){return function(t,e,i){return i.x=l(t.x,e.x),i.y=l(t.y,e.y),i}(t,e,i)}static MaxV(t,e,i){return function(t,e,i){return i.x=h(t.x,e.x),i.y=h(t.y,e.y),i}(t,e,i)}static ClampV(t,e,i,s){return function(t,e,i,s){return s.x=_(t.x,e.x,i.x),s.y=_(t.y,e.y,i.y),s}(t,e,i,s)}static RotateV(t,e,i){return function(t,e,i){const s=t.x,n=t.y,r=Math.cos(e),o=Math.sin(e);return i.x=r*s-o*n,i.y=o*s+r*n,i}(t,e,i)}static DotVV(t,e){return function(t,e){return t.x*e.x+t.y*e.y}(t,e)}static CrossVV(t,e){return function(t,e){return t.x*e.y-t.y*e.x}(t,e)}static CrossVS(t,e,i){return function(t,e,i){const s=t.x;return i.x=e*t.y,i.y=-e*s,i}(t,e,i)}static CrossVOne(t,e){return function(t,e){const i=t.x;return e.x=t.y,e.y=-i,e}(t,e)}static CrossSV(t,e,i){return function(t,e,i){const s=e.x;return i.x=-t*e.y,i.y=t*s,i}(t,e,i)}static CrossOneV(t,e){return function(t,e){const i=t.x;return e.x=-t.y,e.y=i,e}(t,e)}static AddVV(t,e,i){return I(t,e,i)}static SubVV(t,e,i){return D(t,e,i)}static MulSV(t,e,i){return function(t,e,i){return i.x=e.x*t,i.y=e.y*t,i}(t,e,i)}static MulVS(t,e,i){return function(t,e,i){return i.x=t.x*e,i.y=t.y*e,i}(t,e,i)}static AddVMulSV(t,e,i,s){return function(t,e,i,s){return s.x=t.x+e*i.x,s.y=t.y+e*i.y,s}(t,e,i,s)}static SubVMulSV(t,e,i,s){return function(t,e,i,s){return s.x=t.x-e*i.x,s.y=t.y-e*i.y,s}(t,e,i,s)}static AddVCrossSV(t,e,i,s){return function(t,e,i,s){const n=i.x;return s.x=t.x-e*i.y,s.y=t.y+e*n,s}(t,e,i,s)}static MidVV(t,e,i){return function(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i}(t,e,i)}static ExtVV(t,e,i){return function(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i}(t,e,i)}static IsEqualToV(t,e){return function(t,e){return t.x===e.x&&t.y===e.y}(t,e)}static DistanceVV(t,e){return function(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}(t,e)}static DistanceSquaredVV(t,e){return function(t,e){const i=t.x-e.x,s=t.y-e.y;return i*i+s*s}(t,e)}static NegV(t,e){return function(t,e){return e.x=-t.x,e.y=-t.y,e}(t,e)}}M.ZERO=new M(0,0),M.UNITX=new M(1,0),M.UNITY=new M(0,1),M.s_t0=new M,M.s_t1=new M,M.s_t2=new M,M.s_t3=new M;const P=new M(0,0);function I(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}function D(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}class k{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}Clone(){return new k(this.x,this.y,this.z)}SetZero(){return this.x=0,this.y=0,this.z=0,this}SetXYZ(t,e,i){return this.x=t,this.y=e,this.z=i,this}Copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}SelfAddXYZ(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}SelfSubXYZ(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}SelfMul(t){return this.x*=t,this.y*=t,this.z*=t,this}static DotV3V3(t,e){return G(t,e)}static CrossV3V3(t,e,i){return R(t,e,i)}}function G(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function R(t,e,i){const s=t.x,n=t.y,r=t.z,o=e.x,a=e.y,l=e.z;return i.x=n*l-r*a,i.y=r*o-s*l,i.z=s*a-n*o,i}k.ZERO=new k(0,0,0),k.s_t0=new k;class L{constructor(){this.ex=new M(1,0),this.ey=new M(0,1)}Clone(){return(new L).Copy(this)}static FromVV(t,e){return(new L).SetVV(t,e)}static FromSSSS(t,e,i,s){return(new L).SetSSSS(t,e,i,s)}static FromAngle(t){return(new L).SetAngle(t)}SetSSSS(t,e,i,s){return this.ex.Set(t,i),this.ey.Set(e,s),this}SetVV(t,e){return this.ex.Copy(t),this.ey.Copy(e),this}SetAngle(t){const e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this}SetIdentity(){return this.ex.Set(1,0),this.ey.Set(0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this}GetAngle(){return Math.atan2(this.ex.y,this.ex.x)}GetInverse(t){const e=this.ex.x,i=this.ey.x,s=this.ex.y,n=this.ey.y;let r=e*n-i*s;return 0!==r&&(r=1/r),t.ex.x=r*n,t.ey.x=-r*i,t.ex.y=-r*s,t.ey.y=r*e,t}Solve(t,e,i){const s=this.ex.x,n=this.ey.x,r=this.ex.y,o=this.ey.y;let a=s*o-n*r;return 0!==a&&(a=1/a),i.x=a*(o*t-n*e),i.y=a*(s*e-r*t),i}SelfAbs(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this}SelfInv(){return this.GetInverse(this)}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this}SelfSubM(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this}static AbsM(t,e){return function(t,e){const i=t.ex,s=t.ey;return e.ex.x=a(i.x),e.ex.y=a(i.y),e.ey.x=a(s.x),e.ey.y=a(s.y),e}(t,e)}static MulMV(t,e,i){return function(t,e,i){const s=t.ex,n=t.ey,r=e.x,o=e.y;return i.x=s.x*r+n.x*o,i.y=s.y*r+n.y*o,i}(t,e,i)}static MulTMV(t,e,i){return function(t,e,i){const s=t.ex,n=t.ey,r=e.x,o=e.y;return i.x=s.x*r+s.y*o,i.y=n.x*r+n.y*o,i}(t,e,i)}static AddMM(t,e,i){return function(t,e,i){const s=t.ex,n=t.ey,r=e.ex,o=e.ey;return i.ex.x=s.x+r.x,i.ex.y=s.y+r.y,i.ey.x=n.x+o.x,i.ey.y=n.y+o.y,i}(t,e,i)}static MulMM(t,e,i){return function(t,e,i){const s=t.ex.x,n=t.ex.y,r=t.ey.x,o=t.ey.y,a=e.ex.x,l=e.ex.y,h=e.ey.x,_=e.ey.y;return i.ex.x=s*a+r*l,i.ex.y=n*a+o*l,i.ey.x=s*h+r*_,i.ey.y=n*h+o*_,i}(t,e,i)}static MulTMM(t,e,i){return function(t,e,i){const s=t.ex.x,n=t.ex.y,r=t.ey.x,o=t.ey.y,a=e.ex.x,l=e.ex.y,h=e.ey.x,_=e.ey.y;return i.ex.x=s*a+n*l,i.ex.y=r*a+o*l,i.ey.x=s*h+n*_,i.ey.y=r*h+o*_,i}(t,e,i)}}L.IDENTITY=new L;class ${constructor(){this.ex=new k(1,0,0),this.ey=new k(0,1,0),this.ez=new k(0,0,1)}Clone(){return(new $).Copy(this)}SetVVV(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this}SetIdentity(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this}Solve33(t,e,i,s){const n=this.ex.x,r=this.ex.y,o=this.ex.z,a=this.ey.x,l=this.ey.y,h=this.ey.z,_=this.ez.x,c=this.ez.y,m=this.ez.z;let u=n*(l*m-h*c)+r*(h*_-a*m)+o*(a*c-l*_);return 0!==u&&(u=1/u),s.x=u*(t*(l*m-h*c)+e*(h*_-a*m)+i*(a*c-l*_)),s.y=u*(n*(e*m-i*c)+r*(i*_-t*m)+o*(t*c-e*_)),s.z=u*(n*(l*i-h*e)+r*(h*t-a*i)+o*(a*e-l*t)),s}Solve22(t,e,i){const s=this.ex.x,n=this.ey.x,r=this.ex.y,o=this.ey.y;let a=s*o-n*r;return 0!==a&&(a=1/a),i.x=a*(o*t-n*e),i.y=a*(s*e-r*t),i}GetInverse22(t){const e=this.ex.x,i=this.ey.x,s=this.ex.y,n=this.ey.y;let r=e*n-i*s;0!==r&&(r=1/r),t.ex.x=r*n,t.ey.x=-r*i,t.ex.z=0,t.ex.y=-r*s,t.ey.y=r*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0}GetSymInverse33(t){let e=G(this.ex,R(this.ey,this.ez,k.s_t0));0!==e&&(e=1/e);const i=this.ex.x,s=this.ey.x,n=this.ez.x,r=this.ey.y,o=this.ez.y,a=this.ez.z;t.ex.x=e*(r*a-o*o),t.ex.y=e*(n*o-s*a),t.ex.z=e*(s*o-n*r),t.ey.x=t.ex.y,t.ey.y=e*(i*a-n*n),t.ey.z=e*(n*s-i*o),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*r-s*s)}static MulM33V3(t,e,i){return function(t,e,i){const s=e.x,n=e.y,r=e.z;return i.x=t.ex.x*s+t.ey.x*n+t.ez.x*r,i.y=t.ex.y*s+t.ey.y*n+t.ez.y*r,i.z=t.ex.z*s+t.ey.z*n+t.ez.z*r,i}(t,e,i)}static MulM33XYZ(t,e,i,s,n){return function(t,e,i,s,n){return n.x=t.ex.x*e+t.ey.x*i+t.ez.x*s,n.y=t.ex.y*e+t.ey.y*i+t.ez.y*s,n.z=t.ex.z*e+t.ey.z*i+t.ez.z*s,n}(t,e,i,s,n)}static MulM33V2(t,e,i){return function(t,e,i){const s=e.x,n=e.y;return i.x=t.ex.x*s+t.ey.x*n,i.y=t.ex.y*s+t.ey.y*n,i}(t,e,i)}static MulM33XY(t,e,i,s){return function(t,e,i,s){return s.x=t.ex.x*e+t.ey.x*i,s.y=t.ex.y*e+t.ey.y*i,s}(t,e,i,s)}}$.IDENTITY=new $;class T{constructor(t=0){this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}Clone(){return(new T).Copy(this)}Copy(t){return this.s=t.s,this.c=t.c,this}SetAngle(t){return this.s=Math.sin(t),this.c=Math.cos(t),this}SetIdentity(){return this.s=0,this.c=1,this}GetAngle(){return Math.atan2(this.s,this.c)}GetXAxis(t){return t.x=this.c,t.y=this.s,t}GetYAxis(t){return t.x=-this.s,t.y=this.c,t}static MulRR(t,e,i){return F(t,e,i)}static MulTRR(t,e,i){return E(t,e,i)}static MulRV(t,e,i){return j(t,e,i)}static MulTRV(t,e,i){return O(t,e,i)}}function F(t,e,i){const s=t.c,n=t.s,r=e.c,o=e.s;return i.s=n*r+s*o,i.c=s*r-n*o,i}function E(t,e,i){const s=t.c,n=t.s,r=e.c,o=e.s;return i.s=s*o-n*r,i.c=s*r+n*o,i}function j(t,e,i){const s=t.c,n=t.s,r=e.x,o=e.y;return i.x=s*r-n*o,i.y=n*r+s*o,i}function O(t,e,i){const s=t.c,n=t.s,r=e.x,o=e.y;return i.x=s*r+n*o,i.y=-n*r+s*o,i}T.IDENTITY=new T;class N{constructor(){this.p=new M,this.q=new T}Clone(){return(new N).Copy(this)}Copy(t){return this.p.Copy(t.p),this.q.Copy(t.q),this}SetIdentity(){return this.p.SetZero(),this.q.SetIdentity(),this}SetPositionRotation(t,e){return this.p.Copy(t),this.q.Copy(e),this}SetPositionAngle(t,e){return this.p.Copy(t),this.q.SetAngle(e),this}SetPosition(t){return this.p.Copy(t),this}SetPositionXY(t,e){return this.p.Set(t,e),this}SetRotation(t){return this.q.Copy(t),this}SetRotationAngle(t){return this.q.SetAngle(t),this}GetPosition(){return this.p}GetRotation(){return this.q}GetRotationAngle(){return this.q.GetAngle()}GetAngle(){return this.q.GetAngle()}static MulXV(t,e,i){return function(t,e,i){const s=t.q.c,n=t.q.s,r=e.x,o=e.y;return i.x=s*r-n*o+t.p.x,i.y=n*r+s*o+t.p.y,i}(t,e,i)}static MulTXV(t,e,i){return function(t,e,i){const s=t.q.c,n=t.q.s,r=e.x-t.p.x,o=e.y-t.p.y;return i.x=s*r+n*o,i.y=-n*r+s*o,i}(t,e,i)}static MulXX(t,e,i){return function(t,e,i){return F(t.q,e.q,i.q),I(j(t.q,e.p,i.p),t.p,i.p),i}(t,e,i)}static MulTXX(t,e,i){return function(t,e,i){return E(t.q,e.q,i.q),O(t.q,D(e.p,t.p,i.p),i.p),i}(t,e,i)}}N.IDENTITY=new N;class z{constructor(){this.localCenter=new M,this.c0=new M,this.c=new M,this.a0=0,this.a=0,this.alpha0=0}Clone(){return(new z).Copy(this)}Copy(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this}GetTransform(t,e){const i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;const s=i*this.a0+e*this.a;return t.q.SetAngle(s),t.p.SelfSub(j(t.q,this.localCenter,M.s_t0)),t}Advance(t){const e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t}Normalize(){const t=o*Math.floor(this.a0/o);this.a0-=t,this.a-=t}}},346:function(t,e,i){"use strict";i.d(e,"e",function(){return s}),i.d(e,"d",function(){return h}),i.d(e,"f",function(){return _}),i.d(e,"i",function(){return c}),i.d(e,"j",function(){return n}),i.d(e,"h",function(){return m}),i.d(e,"p",function(){return u}),i.d(e,"k",function(){return r}),i.d(e,"g",function(){return d}),i.d(e,"c",function(){return p}),i.d(e,"l",function(){return f}),i.d(e,"m",function(){return y}),i.d(e,"a",function(){return A}),i.d(e,"n",function(){return g}),i.d(e,"b",function(){return x}),i.d(e,"o",function(){return v});var s,n,r,o=i(344),a=i(345),l=i(359);!function(t){t[t.e_vertex=0]="e_vertex",t[t.e_face=1]="e_face"}(s||(s={}));class h{constructor(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}get key(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key}set key(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}get indexA(){return this._indexA}set indexA(t){this._indexA=t,this._key_invalid=!0}get indexB(){return this._indexB}set indexB(t){this._indexB=t,this._key_invalid=!0}get typeA(){return this._typeA}set typeA(t){this._typeA=t,this._key_invalid=!0}get typeB(){return this._typeB}set typeB(t){this._typeB=t,this._key_invalid=!0}}class _{constructor(){this.cf=new h}Copy(t){return this.key=t.key,this}Clone(){return(new _).Copy(this)}get key(){return this.cf.key}set key(t){this.cf.key=t}}class c{constructor(){this.localPoint=new a.A,this.normalImpulse=0,this.tangentImpulse=0,this.id=new _}static MakeArray(t){return Object(o.e)(t,t=>new c)}Reset(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}Copy(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this}}!function(t){t[t.e_unknown=-1]="e_unknown",t[t.e_circles=0]="e_circles",t[t.e_faceA=1]="e_faceA",t[t.e_faceB=2]="e_faceB"}(n||(n={}));class m{constructor(){this.points=c.MakeArray(o.z),this.localNormal=new a.A,this.localPoint=new a.A,this.type=n.e_unknown,this.pointCount=0}Reset(){for(let t=0;t<o.z;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=n.e_unknown,this.pointCount=0}Copy(t){this.pointCount=t.pointCount;for(let e=0;e<o.z;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this}Clone(){return(new m).Copy(this)}}class u{constructor(){this.normal=new a.A,this.points=a.A.MakeArray(o.z),this.separations=Object(o.g)(o.z)}Initialize(t,e,i,s,r){if(0!==t.pointCount)switch(t.type){case n.e_circles:{this.normal.Set(1,0);const n=a.z.MulXV(e,t.localPoint,u.Initialize_s_pointA),l=a.z.MulXV(s,t.points[0].localPoint,u.Initialize_s_pointB);a.A.DistanceSquaredVV(n,l)>o.s&&a.A.SubVV(l,n,this.normal).SelfNormalize();const h=a.A.AddVMulSV(n,i,this.normal,u.Initialize_s_cA),_=a.A.SubVMulSV(l,r,this.normal,u.Initialize_s_cB);a.A.MidVV(h,_,this.points[0]),this.separations[0]=a.A.DotVV(a.A.SubVV(_,h,a.A.s_t0),this.normal)}break;case n.e_faceA:{a.t.MulRV(e.q,t.localNormal,this.normal);const n=a.z.MulXV(e,t.localPoint,u.Initialize_s_planePoint);for(let e=0;e<t.pointCount;++e){const o=a.z.MulXV(s,t.points[e].localPoint,u.Initialize_s_clipPoint),l=i-a.A.DotVV(a.A.SubVV(o,n,a.A.s_t0),this.normal),h=a.A.AddVMulSV(o,l,this.normal,u.Initialize_s_cA),_=a.A.SubVMulSV(o,r,this.normal,u.Initialize_s_cB);a.A.MidVV(h,_,this.points[e]),this.separations[e]=a.A.DotVV(a.A.SubVV(_,h,a.A.s_t0),this.normal)}}break;case n.e_faceB:{a.t.MulRV(s.q,t.localNormal,this.normal);const n=a.z.MulXV(s,t.localPoint,u.Initialize_s_planePoint);for(let s=0;s<t.pointCount;++s){const o=a.z.MulXV(e,t.points[s].localPoint,u.Initialize_s_clipPoint),l=r-a.A.DotVV(a.A.SubVV(o,n,a.A.s_t0),this.normal),h=a.A.AddVMulSV(o,l,this.normal,u.Initialize_s_cB),_=a.A.SubVMulSV(o,i,this.normal,u.Initialize_s_cA);a.A.MidVV(_,h,this.points[s]),this.separations[s]=a.A.DotVV(a.A.SubVV(_,h,a.A.s_t0),this.normal)}this.normal.SelfNeg()}}}}function d(t,e,i,s){let n;for(n=0;n<i.pointCount;++n){const e=i.points[n].id.key;t[n]=r.b2_removeState;for(let i=0,o=s.pointCount;i<o;++i)if(s.points[i].id.key===e){t[n]=r.b2_persistState;break}}for(;n<o.z;++n)t[n]=r.b2_nullState;for(n=0;n<s.pointCount;++n){const t=s.points[n].id.key;e[n]=r.b2_addState;for(let s=0,o=i.pointCount;s<o;++s)if(i.points[s].id.key===t){e[n]=r.b2_persistState;break}}for(;n<o.z;++n)e[n]=r.b2_nullState}u.Initialize_s_pointA=new a.A,u.Initialize_s_pointB=new a.A,u.Initialize_s_cA=new a.A,u.Initialize_s_cB=new a.A,u.Initialize_s_planePoint=new a.A,u.Initialize_s_clipPoint=new a.A,function(t){t[t.b2_nullState=0]="b2_nullState",t[t.b2_addState=1]="b2_addState",t[t.b2_persistState=2]="b2_persistState",t[t.b2_removeState=3]="b2_removeState"}(r||(r={}));class p{constructor(){this.v=new a.A,this.id=new _}static MakeArray(t){return Object(o.e)(t,t=>new p)}Copy(t){return this.v.Copy(t.v),this.id.Copy(t.id),this}}class f{constructor(){this.p1=new a.A,this.p2=new a.A,this.maxFraction=1}Copy(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this}}class y{constructor(){this.normal=new a.A,this.fraction=0}Copy(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this}}class A{constructor(){this.lowerBound=new a.A,this.upperBound=new a.A,this.m_cache_center=new a.A,this.m_cache_extent=new a.A}Copy(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this}IsValid(){const t=this.upperBound.x-this.lowerBound.x,e=this.upperBound.y-this.lowerBound.y;let i=t>=0&&e>=0;return i=i&&this.lowerBound.IsValid()&&this.upperBound.IsValid()}GetCenter(){return a.A.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)}GetExtents(){return a.A.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)}GetPerimeter(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))}Combine1(t){return this.lowerBound.x=Object(a.n)(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=Object(a.n)(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=Object(a.m)(this.upperBound.x,t.upperBound.x),this.upperBound.y=Object(a.m)(this.upperBound.y,t.upperBound.y),this}Combine2(t,e){return this.lowerBound.x=Object(a.n)(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=Object(a.n)(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=Object(a.m)(t.upperBound.x,e.upperBound.x),this.upperBound.y=Object(a.m)(t.upperBound.y,e.upperBound.y),this}static Combine(t,e,i){return i.Combine2(t,e),i}Contains(t){let e=!0;return e=(e=(e=(e=e&&this.lowerBound.x<=t.lowerBound.x)&&this.lowerBound.y<=t.lowerBound.y)&&t.upperBound.x<=this.upperBound.x)&&t.upperBound.y<=this.upperBound.y}RayCast(t,e){let i=-o.x,s=o.x;const n=e.p1.x,r=e.p1.y,l=e.p2.x-e.p1.x,h=e.p2.y-e.p1.y,_=Object(a.a)(l),c=Object(a.a)(h),m=t.normal;if(_<o.r){if(n<this.lowerBound.x||this.upperBound.x<n)return!1}else{const t=1/l;let e=(this.lowerBound.x-n)*t,r=(this.upperBound.x-n)*t,o=-1;if(e>r){const t=e;e=r,r=t,o=1}if(e>i&&(m.x=o,m.y=0,i=e),i>(s=Object(a.n)(s,r)))return!1}if(c<o.r){if(r<this.lowerBound.y||this.upperBound.y<r)return!1}else{const t=1/h;let e=(this.lowerBound.y-r)*t,n=(this.upperBound.y-r)*t,o=-1;if(e>n){const t=e;e=n,n=t,o=1}if(e>i&&(m.x=0,m.y=o,i=e),i>(s=Object(a.n)(s,n)))return!1}return!(i<0||e.maxFraction<i)&&(t.fraction=i,!0)}TestOverlap(t){const e=t.lowerBound.x-this.upperBound.x,i=t.lowerBound.y-this.upperBound.y,s=this.lowerBound.x-t.upperBound.x,n=this.lowerBound.y-t.upperBound.y;return!(e>0||i>0)&&!(s>0||n>0)}}function g(t,e){const i=e.lowerBound.x-t.upperBound.x,s=e.lowerBound.y-t.upperBound.y,n=t.lowerBound.x-e.upperBound.x,r=t.lowerBound.y-e.upperBound.y;return!(i>0||s>0)&&!(n>0||r>0)}function x(t,e,i,n,r){let o=0;const l=e[0],h=e[1],_=a.A.DotVV(i,l.v)-n,c=a.A.DotVV(i,h.v)-n;if(_<=0&&t[o++].Copy(l),c<=0&&t[o++].Copy(h),_*c<0){const e=_/(_-c),i=t[o].v;i.x=l.v.x+e*(h.v.x-l.v.x),i.y=l.v.y+e*(h.v.y-l.v.y);const n=t[o].id;n.cf.indexA=r,n.cf.indexB=l.id.cf.indexB,n.cf.typeA=s.e_vertex,n.cf.typeB=s.e_face,++o}return o}const w=new l.b,b=new l.f,S=new l.c;function v(t,e,i,s,n,r){const a=w.Reset();a.proxyA.SetShape(t,e),a.proxyB.SetShape(i,s),a.transformA.Copy(n),a.transformB.Copy(r),a.useRadii=!0;const h=b.Reset();h.count=0;const _=S.Reset();return Object(l.a)(_,h,a),_.distance<10*o.r}},347:function(t,e,i){"use strict";i.d(e,"a",function(){return r}),i.d(e,"c",function(){return s}),i.d(e,"b",function(){return o});var s,n=i(345);class r{constructor(){this.mass=0,this.center=new n.A(0,0),this.I=0}}!function(t){t[t.e_unknown=-1]="e_unknown",t[t.e_circleShape=0]="e_circleShape",t[t.e_edgeShape=1]="e_edgeShape",t[t.e_polygonShape=2]="e_polygonShape",t[t.e_chainShape=3]="e_chainShape",t[t.e_shapeTypeCount=4]="e_shapeTypeCount"}(s||(s={}));class o{constructor(t,e){this.m_type=s.e_unknown,this.m_radius=0,this.m_type=t,this.m_radius=e}Copy(t){return this.m_radius=t.m_radius,this}GetType(){return this.m_type}}},351:function(t,e,i){"use strict";i.d(e,"b",function(){return r}),i.d(e,"a",function(){return o});var s=i(332),n=(i(333),i(335));class r extends n.Graph{constructor(t,e){t?(super(e,{width:t.__w,height:t.__h}),this._raw=t,e?this._url=e:!1!==r.isTexture(t)&&(this._url=t[""])):super()}static isTexture(t){if(t)if(t.hasOwnProperty("")){if("string"==typeof t[""])return!0}else if(!t.__isEmpty)throw console.group("no texture"),console.warn(t),console.groupEnd(),new Error("no texture");return!1}static isTextureHasData(t){return t&&"string"==typeof t[""]&&t[""].startsWith("data:image/")}set z(t){this._order=t}get z(){return this._order}_get(t,e,i){if(this._raw){if(e in this._raw)return i(this._raw[e])}else;return t}draw(){this._engine.drawGraph(this)}draw2(t,e){this._engine.drawGraph2(this,t-this.x,e-this.y)}draw2i(t,e){this._engine.drawGraph2(this,Math.trunc(t-this.x+.5),Math.trunc(e-this.y+.5))}}class o extends r{constructor(t,e){super(t,e);var i=this._get(new s.Vec2(0,0),"origin",s.Vec2.get);this.x=i.x,this.y=i.y,this.z=this._get(0,"z",Number),this.delay=this._get(100,"delay",Number)}drawPattern(t,e,i,s){if(!this.isLoaded())return;const n=this._engine.ctx;n.save();try{n.rect(t,e,i,s),n.clip();let r=t,o=t+i,a=e+s;for(let t=e;t<a;t+=this.height)for(let e=r;e<o;e+=this.width)this.draw2(e,t)}catch(t){console.error(t)}n.restore()}drawHorizontalPattern(t,e,i){if(!this.isLoaded())return;const s=this._engine.ctx;s.save();try{const s=t+i;for(let i=t;i<s;i+=this.width)this.draw2(i,e)}catch(t){console.error(t)}s.restore()}drawVerticalPattern(t,e,i){if(!this.isLoaded())return;const s=this._engine.ctx;s.save();try{const s=e+i;for(let i=e;i<s;i+=this.height)this.draw2(t,i)}catch(t){console.error(t)}s.restore()}_drawPattern(t,e,i,s){if(!this.isLoaded())return;this._engine.ctx;const n=t,r=t+i,o=e+s;for(let t=e;t<o;t+=this.height)for(let e=n;e<r;e+=this.width)this.draw2(e,t)}_drawHorizontalPattern(t,e,i){if(!this.isLoaded())return;this._engine.ctx;const s=t+i;for(let i=t;i<s;i+=this.width)this.draw2(i,e)}_drawVerticalPattern(t,e,i){if(!this.isLoaded())return;this._engine.ctx;const s=e+i;for(let i=e;i<s;i+=this.height)this.draw2(t,i)}drawPattern4i(t,e,i,s){this.drawPattern(Math.trunc(t+.5),Math.trunc(e+.5),Math.trunc(i+.5),Math.trunc(s+.5))}drawHorizontalPattern3i(t,e,i){this.drawHorizontalPattern(Math.trunc(t+.5),Math.trunc(e+.5),Math.trunc(i+.5))}drawVerticalPattern3i(t,e,i){this.drawVerticalPattern(Math.trunc(t+.5),Math.trunc(e+.5),Math.trunc(i+.5))}_drawPattern4i(t,e,i,s){this._drawPattern(Math.trunc(t+.5),Math.trunc(e+.5),Math.trunc(i+.5),Math.trunc(s+.5))}_drawHorizontalPattern3i(t,e,i){this._drawHorizontalPattern(Math.trunc(t+.5),Math.trunc(e+.5),Math.trunc(i+.5))}_drawVerticalPattern3i(t,e,i){this._drawVerticalPattern(Math.trunc(t+.5),Math.trunc(e+.5),Math.trunc(i+.5))}}},352:function(t,e,i){"use strict";i.d(e,"a",function(){return m}),i.d(e,"b",function(){return u});var s=i(355),n=(i(368),i(358),i(365),i(354),i(363),i(376),i(356));const r=Math.PI/180;let o=new s.b2Vec2;const a={width:25/$gv.CANVAS_SCALE,height:48/$gv.CANVAS_SCALE,density:1,get foot_width(){return.5*a.width},get foot_j_width(){return.4*a.width}};window.JUMP_FORCE=555,window.MOVEMENT_VELOCITY=125/$gv.CANVAS_SCALE,window.$LADDER_SPEED=125/$gv.CANVAS_SCALE,window.PLAYER_USE_WHEEL_WALKER=!1,window.FOOT_FRICTION=1,window.MOVEMENT_POWER=14e4,window.MOVEMENT_STOP_POWER=14e4,window.PORTAL_COOLDOWN=1e3;class l{constructor(){this._begin_jump=!1,this.jump=!0,this.jump_count=0,this._drop=!0,this.walk=!1,this.prone=!1,this.dropDown=!1,this._fly=!1,this.brake=!0,this.front=-1,this.ladder=!1,this.ladder_move_dir=0,this.invincible=0,this.freeze=!1,this.invokeSkill=!1,this.portal_cooldown=0,this.knockback=0,this.outOfControl=!1}}class h{constructor(t,e,i){this.foothold=t,this.position=e,this.priority=i}}class _{constructor(){this.disable=!1,this.chara_profile=Object.assign({},a),this.setMovementSpeed(100),this.body=null,this.foot_walk=null,this.walker=null,this.$foothold=null,this.prev_$fh=null,this.leave_$fh=null,this._foothold=null,this._foot_at=new s.b2Vec2,this._foothold_priority=0,this._foot_contact_list=[],this.portal=null,this.ladder=null,this._walker_omega=1,this.jump_force=JUMP_FORCE,this.state=new l}setPosition(t,e,i){const n=e-this.chara_profile.foot_width-.75*this.chara_profile.height*.5,r=e-this.chara_profile.foot_width;this.body.SetPositionXY(t,n);try{if(this.foot_walk&&this.foot_walk.SetPositionXY(t,r),i){const t=new s.b2Vec2(0,0);this.body.ConstantVelocity(t),this.foot_walk&&this.foot_walk.ConstantVelocity(t)}}catch(t){}}getPosition(){const t=this.foot_walk.GetPosition();return new s.b2Vec2(t.x,t.y+this.chara_profile.foot_width)}_usePortal(t){if(!t.enable||this.state.portal_cooldown>0)return!1;const e=t.mapRenderer,i=e.controller,s=t.getMap();if(t.exeScript)t.exeScript(this);else{if(!s)return console.log("portal: $o",t),!1;if(s==e.map_id){const i=t.tn.match(/(^[a-z_]+)(\d+$)/)||t.tn.match(/(^[a-z]+)\d+_\d+$/),s=i[1];if("hp"==s){let i=t.tn,s=e.portalMgr.portals.find(function(t){return i==t.pn});this._gotoPortal(s)}else{if("pt_go"!=s)return console.log(`portal.pn: ${t.pn}, portal.tn: ${t.tn}, %o`,t),!1;{const t=parseInt(i[2],10),s=e.portalMgr.portals[t];this._gotoPortal(s)}}}else i.doAfterStep(function(){e.unload(),e.load(s)})}return this.state.portal_cooldown=PORTAL_COOLDOWN,!0}_gotoPortal(t){t.mapRenderer.controller.doAfterStep(()=>{const e=t.x/$gv.CANVAS_SCALE,i=(t.y-3)/$gv.CANVAS_SCALE;this.setPosition(e,i,!0)})}contactLadder(t){this.ladder=t||null}leaveLadder(){this.body.m_world.onceUnlock(()=>{this._useLadder(!1),this.contactLadder(null,null)})}useLadder(t){this.body.m_world.onceUnlock(()=>{this._useLadder(t)})}_useLadder(t){const e=this.body.m_world;if(t){if(this.ladder&&!this.$ladder_pj){const t=this.ladder.body;(t.GetAngle()||t.GetAngularVelocity())&&(this.body.SetAngle(t.GetAngle()),this.body.SetFixedRotation(!1)),this.state.ladder=!0,this.state.jump=!1,this.state.jump_count=0,this.body.SetAwake(!0),this.body.SetLinearVelocity2(0,0),this.body.m_type=s.b2BodyType.b2_kinematicBody,this.foot_walk.SetAwake(!0),this.foot_walk.SetLinearVelocity2(0,0),this.foot_walk.m_type=s.b2BodyType.b2_kinematicBody,this.walker.SetMotorSpeed(0);let i=this.ladder.calcHeight()/$gv.CANVAS_SCALE;this.setPosition(t.GetPosition().x,this.getPosition().y);let n=new s.b2PrismaticJointDef;n.bodyA=t,n.bodyB=this.foot_walk,n.localAxisA.Set(0,1),n.lowerTranslation=-this.chara_profile.foot_width,n.upperTranslation=i+this.chara_profile.foot_width,n.enableLimit=!0,n.maxMotorForce=1e3*this._getMass();let r=e.CreateJoint(n);this.$ladder_pj=r}}else this.ladder&&this.state.ladder&&(this.state.ladder=!1,this.body.SetAwake(!0),this.body.SetLinearVelocity2(0,0),this.body.m_type=s.b2BodyType.b2_dynamicBody,this.foot_walk.SetAwake(!0),this.foot_walk.SetLinearVelocity2(0,0),this.foot_walk.m_type=s.b2BodyType.b2_dynamicBody),this.$ladder_pj&&(e.DestroyJoint(this.$ladder_pj),delete this.$ladder_pj,this.body.SetAngle(0),this.body.SetFixedRotation(!0))}remove_sticky(){this.$sticky_pj&&(this.body.m_world.DestroyJoint(this.$sticky_pj),this.$sticky_pj=null)}actionJump(){this.state._begin_jump=!0,++this.state.jump_count}actionDropdown(){this.leave_$fh=this.$foothold,this.$foothold=null,this.state.dropDown=!0,this.body.SetAwake(!0)}control(t){if(this._isCanMove())if(this.state.ladder&&this.$ladder_pj){const e=this.ladder.body,i=window.$LADDER_SPEED||1;if(e&&(e.GetAngle()||e.GetAngularVelocity())&&(this.body.SetAngle(e.GetAngle()),this.body.SetFixedRotation(!1)),t.up&&!t.down?(this.state.ladder_move_dir=-1,this.$ladder_pj.EnableMotor(!0),this.$ladder_pj.SetMotorSpeed(-i)):t.down&&!t.up?(this.state.ladder_move_dir=1,this.$ladder_pj.EnableMotor(!0),this.$ladder_pj.SetMotorSpeed(i)):(this.state.ladder_move_dir=0,this.$ladder_pj.EnableMotor(!1),this.body.SetLinearVelocity2(0,0),this.foot_walk.SetLinearVelocity2(0,0)),t.jump){const e=this.body.m_world,s=this._getMass();t.left&&t.right?this.useLadder(!1):t.left?(this.useLadder(!1),e.doAfterStep(()=>{this.body.ApplyLinearImpulseToCenter2(-i*s,0)})):t.right&&(this.useLadder(!1),e.doAfterStep(()=>{this.body.ApplyLinearImpulseToCenter2(i*s,0)}))}}else if(this.$ladder_pj)this.useLadder(!1);else{if(this.state.outOfControl)return void this.walker.EnableMotor(!1);if(this.walker.EnableMotor(!0),this.portal&&t.up){let t=this.portal;if(this._usePortal(t))return void(this.portal=null)}if(this.ladder&&(t.down&&this.$foothold&&this.ladder.body.GetLocalPoint(this.getPosition(),o).y<=0||t.up&&!this.$foothold&&this.ladder.body.GetLocalPoint(this.getPosition(),o).y>0))return this.state.ladder_move_dir=0,void this.useLadder(!0);const e=this._walker_omega,i=this.body.GetLinearVelocity();if(this.state.jump||this.state.dropDown)this.state.prone=!1;else{if(t.down&&t.jump)return void this.actionDropdown();if(t.down)return void(this.state.prone=!0);this.state.prone=!1}if(t.left&&!t.right)this.state.walk=!0,this.state.front=-1,this.walker.SetMotorSpeed(-e),this.walker.SetMaxMotorTorque(MOVEMENT_POWER),this.remove_sticky();else if(t.right&&!t.left)this.state.walk=!0,this.state.front=1,this.walker.SetMotorSpeed(e),this.walker.SetMaxMotorTorque(MOVEMENT_POWER),this.remove_sticky();else{if(this.state.walk=!1,this.state.jump)this.walker.SetMotorSpeed(0);else{let t=i.x;t>50*s.b2_linearSlop?this.walker.SetMotorSpeed(-t*Math.PI/2/Math.PI/this.chara_profile.width/2):t<-50*s.b2_linearSlop?this.walker.SetMotorSpeed(-t*Math.PI/2/Math.PI/this.chara_profile.width/2):this.walker.SetMotorSpeed(0)}this.walker.SetMaxMotorTorque(MOVEMENT_STOP_POWER),this.state.止滑&&this.sticky(this.getPosition())}t.jump&&this._isCanJump()&&(this.remove_sticky(),this.actionJump())}}_isCanJump(){return!this.state.jump&&!this.isDrop()}_isCanMove(){return!this.state.freeze&&!this.state.knockback}setMovementSpeed(t){if(!(Number.isSafeInteger(t)||!Number.isNaN(t)&&Number.isFinite(t)))throw new TypeError("increment_percent must is number");let e=(100+t)/100;e>0?this._setWalkerOmegaFromVelocity(MOVEMENT_VELOCITY*e):this._setWalkerOmegaFromVelocity(0)}setMovementSpeedPixel(t){let e=t/$gv.CANVAS_SCALE;this._walker_omega=e>0?e:0}_setWalkerOmegaFromVelocity(t){this._walker_omega=t/(Math.PI*this.chara_profile.width)*Math.PI}setjumpForce(t){if(!(Number.isSafeInteger(t)||!Number.isNaN(t)&&Number.isFinite(t)))throw new TypeError("increment_percent must is number");let e=(100+t)/100;if(e<=0)this.jump_force=0;else{this.body.GetWorld().GetGravity();this.jump_force=JUMP_FORCE*e}}_getMass(){return this.body.GetMass()+this.foot_walk.GetMass()}setGravityScale(t){this.body.SetGravityScale(t),this.foot_walk.SetGravityScale(t)}get _body_category(){return"body"}_create(t){let e=new s.b2Vec2(1/$gv.CANVAS_SCALE,-2/$gv.CANVAS_SCALE),i=e.y+.75*this.chara_profile.height*.5,o=new s.b2BodyDef,a=new s.b2FixtureDef,l=new s.b2PolygonShape;o.type=s.b2BodyType.b2_dynamicBody,o.bullet=!0,o.position.Set(e.x,e.y),o.userData=this,a.userData=this,this.body=t.CreateBody(o),this.body.SetFixedRotation(!0),this.body.$type="player",a.filter.Copy(n.FilterHelper.get(this._body_category)),l.SetAsBox(.5*this.chara_profile.width,.75*this.chara_profile.height*.5,s.b2Vec2.ZERO,0),a.density=this.chara_profile.density,a.friction=0,a.restitution=0,a.shape=l,this.fixture=this.body.CreateFixture(a),this.fixture.$type="player",a.filter.Copy(n.FilterHelper.get("foot"));{o.type=s.b2BodyType.b2_dynamicBody,o.position.Set(e.x,i),this.foot_walk=t.CreateBody(o);let n=new s.b2CircleShape;n.m_p.Set(0,0),n.m_radius=this.chara_profile.foot_width,a.shape=n,a.density=this.chara_profile.density,a.friction=FOOT_FRICTION,a.restitution=0;let r=this.foot_walk.CreateFixture(a);r.$type="pl_ft_walk",this._set_foot_listener(r)}this.foot_walk.$type="pl_ft_walk";{let n;(n=PLAYER_USE_WHEEL_WALKER?new s.b2WheelJointDef:new s.b2RevoluteJointDef)instanceof s.b2RevoluteJointDef&&n.Initialize(this.body,this.foot_walk,new s.b2Vec2(e.x,i)),n instanceof s.b2WheelJointDef&&n.Initialize(this.body,this.foot_walk,new s.b2Vec2(e.x,i),new s.b2Vec2(0,-1)),n.enableMotor=!0,n.maxMotorTorque=MOVEMENT_POWER,n instanceof s.b2RevoluteJointDef&&(n.enableLimit=!1,n.lowerAngle=0*r,n.upperAngle=-0*r,n.referenceAngle=0),n instanceof s.b2WheelJointDef&&(n.frequencyHz=10,n.dampingRatio=1),this.walker=t.CreateJoint(n)}this.body.addStep(this.Step.bind(this)),this.body.addAfterStep(this.AfterStep.bind(this)),this.setMovementSpeed(0),this.setjumpForce(0)}_destroy(){const t=this.body.m_world;this.body?(t.DestroyBody(this.body),this.body=null):console.log("this already dead"),this.foot_walk&&(t.DestroyBody(this.foot_walk),this.foot_walk=null)}_isFromSelfContact(t,e){let i=t.GetBody().GetUserData(),s=e.GetBody().GetUserData();return!!(i&&s&&i.body&&s.body&&i.body==s.body)}_ignoreSelfContact(t,e,i){return!!this._isFromSelfContact(e,i)&&(t.SetEnabled(!1),!0)}_set_foot_listener(t){t.beginContact=this.__beginContact_walker,t.endContact=this.__endContact_walker,t.preSolve=this.__preSolve_walker}__beginContact_walker(t,e,i){if(this._ignoreSelfContact(t,e,i))return;let s=i.m_body;if(s)switch(s.$type){case"portal":this._beginContactPortal(i.m_userData)}}__endContact_walker(t,e,i){if(this._ignoreSelfContact(t,e,i))return;let s=i.m_body;if(s)switch(s.$type){case"portal":this._endContactPortal(i.m_userData)}}__preSolve_walker(t,e,i,s){this._ignoreSelfContact(t,i,s)||"pl_ft_walk"!=i.$type||"pl_ft_walk"!=s.$type||t.SetEnabled(!1)}_beginContactPortal(t){this.portal=t,t.enable?t.script?console.log("goto map: "+t.getMap()+"; "+t.script):console.log("goto map: "+t.getMap()):console.log("contact portal: %o",t)}_endContactPortal(t){this.portal==t&&(this.portal=null)}__priority_foothold_contact(t,e){return t.is_wall?0:this.$foothold&&this.$foothold.chain!=t.chain&&this.$foothold!=t&&!this.state.dropDown&&this._foot_at&&e.y<this._foot_at.y&&!(this.$foothold.prev==t.id&&t.y1<this.$foothold.y1||this.$foothold.next==t.id&&t.y2<this.$foothold.y2)?1:2}_which_foothold_contact(t,e){if(t.is_wall)return!0;let i=this.__priority_foothold_contact(t,e);if(i>0){if(!this._foothold_priority||i>=this._foothold_priority)return this._foothold=t,this._foot_at=e.Clone(),this._foothold_priority=i,!0;{let s=new h(t,e,i);this._foot_contact_list.push(s),this._foot_contact_list.sort((t,e)=>t.priority-e.priority)}}return!1}sticky(t){const e=this.body.m_world;e.onceUnlock(()=>{if(this.$sticky_pj)return;let i=new s.b2PrismaticJointDef;i.Initialize(e.mapBound_body,this.body,t,new s.b2Vec2(0,1)),i.lowerTranslation=0,i.upperTranslation=0,i.enableLimit=!0,i.maxMotorForce=1e3*this._getMass();let n=e.CreateJoint(i);this.$sticky_pj=n})}isDrop(){return this.state.dropDown||this.state._drop}_endContactFoothold(){for(let t=0;t<this._endContactFootholdList.length;++t){let e=this._endContactFootholdList[t];e==this._$fallEdge?this._$fallEdge=null:e==this._foothold&&(this._foothold=null,this._foot_at=null),this.$foothold&&e==this.$foothold&&(this.prev_$fh=this.$foothold,this.$foothold=null),this.leave_$fh&&this.leave_$fh==e&&(this.leave_$fh=null)}this._endContactFootholdList.length=0}Step(t){if(this.state._drop=!1,this._foothold=null,this._foot_at=null,this.state.ladder)this.state.jump=!1,this.state.jump_count=0;else{if(this.state._begin_jump){const t=this._getMass(),e=new s.b2Vec2(0,-t*this.jump_force);this.body.ApplyForceToCenter(e)}this.state.knockback>0&&(this.state.knockback-=t,this.state.knockback>0?(this.state.outOfControl=!0,this.walker.EnableMotor(!1)):(this.state.knockback=0,this.state.outOfControl=!1,this.walker.EnableMotor(!0))),this.state.invincible>0&&(this.state.invincible-=t,this.state.invincible>0||(this.state.invincible=0)),this.state.portal_cooldown&&(this.state.portal_cooldown-=t,this.state.portal_cooldown>0||(this.state.portal_cooldown=0))}}AfterStep(){if(this.state.ladder){if(this.$ladder_pj){const t=this.$ladder_pj.GetUpperLimit(),e=this.$ladder_pj.GetLowerLimit(),i=this.$ladder_pj.GetJointTranslation();this.state.ladder_move_dir>0&&i>t?this.useLadder(!1):this.state.ladder_move_dir<0&&i<e&&this.useLadder(!1)}}else{if(!this.state.dropDown&&(this.body.m_awakeFlag&&this.foot_walk.m_awakeFlag&&(this.$foothold=this._foothold),!this._foothold&&this._foot_contact_list.length)){let t=this._foot_contact_list.pop();this.$foothold=t.foothold,this._foothold=t.foothold,this._foot_at=t.position,this._foothold_priority=t.priority}this.$foothold?(this.state.jump=!1,this.state.jump_count=0,this.$foothold,this._foothold):(this._foot_contact_list.length=0,this.state.jump=!0,this.state._begin_jump=!1,this._foothold)}}getLayer(){let t=this.$foothold?this.$foothold.layer:this.prev_$fh?this.prev_$fh.layer:this.leave_$fh?this.leave_$fh.layer:5;return this.state.ladder?t+1:t}}class c extends _{constructor(){super(...arguments),this.chara=null}forceMove(t,e){const i=this._getMass(),n=new s.b2Vec2(t*i,e*i);this.body.ApplyLinearImpulseToCenter(n)}knockback(t,e,i=1e3){let s,n;s=-t*this.state.front,n=-e,this.forceMove(s,n),this.state.knockback=i,this.state.outOfControl=!0}_create_anchor(t){let e=new s.b2MouseJointDef;return e.bodyA=t.ground.bodies[0],e.bodyB=this.body,e.target.Copy(this.getPosition()),e.maxForce=1e3*this._getMass(),t.CreateJoint(e)}moveTo(t){const e=this.body;if(0==t.elapsed)e.ConstantVelocityWorldCenter2(vx,vy);else{const i=.7,s=1-i;let n,r,o=t.x-pos.x,a=t.y-pos.y,l=o/(t.elapsed/$gv.FRAME_ELAPSED),h=a/(t.elapsed/$gv.FRAME_ELAPSED),_=e.GetLinearVelocity();t.pState.jump?this.setGravityScale(0):(this.setGravityScale(1),t.pState.walk||l?this.walker.EnableMotor(!1):this.walker.EnableMotor(!0)),n=l?t.vx?Math.sign(t.vx)==Math.sign(l)?_.x*s+t.vx*i:_.x*s+l*i:l:0,r=h?t.vy?Math.sign(t.vy)==Math.sign(h)?_.y*s+t.vy*i:_.y*s+h*i:h:0,e.ConstantVelocityWorldCenter2(n,r)}}}class m extends c{constructor(){super(...arguments)}_create(t){super._create(t),window.SCREEN_PRINTLN(()=>"x",()=>this.getPosition().x.toFixed(3)+" * "+$gv.CANVAS_SCALE+" = "+(this.getPosition().x*$gv.CANVAS_SCALE).toFixed(0)),window.SCREEN_PRINTLN(()=>"y",()=>this.getPosition().y.toFixed(3)+" * "+$gv.CANVAS_SCALE+" = "+(this.getPosition().y*$gv.CANVAS_SCALE).toFixed(0)),window.SCREEN_PRINTLN(()=>"jump",()=>this.state.jump),window.SCREEN_PRINTLN(()=>"_drop",()=>this.state._drop),window.SCREEN_PRINTLN(()=>"ddrop",()=>this.state.dropDown),window.SCREEN_PRINTLN(()=>"$fh",()=>this.$foothold?this.$foothold.id:null),window.SCREEN_PRINTLN(()=>"$fh->c",()=>this.$foothold?this.$foothold.chain.id:null),window.SCREEN_PRINTLN(()=>"_fh",()=>this._foothold?this._foothold.id:null),window.SCREEN_PRINTLN(()=>"p$fh",()=>this.prev_$fh?this.prev_$fh.id:null),window.SCREEN_PRINTLN(()=>"leave_$fh",()=>this.leave_$fh?this.leave_$fh.id:null),window.SCREEN_PRINTLN(()=>"(jump && !$fh)",()=>this.state.jump&&!this.$foothold),window.SCREEN_PRINTLN(()=>"vel.x",()=>(this.body.m_linearVelocity.x*$gv.CANVAS_SCALE).toFixed(0)),window.SCREEN_PRINTLN(()=>"vel.y",()=>(this.body.m_linearVelocity.y*$gv.CANVAS_SCALE).toFixed(0))}Step(t){if(super.Step(t),1!=$gv.input_keyDown.B||$gv.mouse_dl){if($gv.input_keyDown.B>0&&$gv.mouse_dl){const t=$gv.m_viewRect.center,e=$gv.m_viewRect.left+$gv.mouse_x-t.x,i=$gv.m_viewRect.top+$gv.mouse_y-t.y;this.body.SetLinearVelocity(new s.b2Vec2(e/$gv.CANVAS_SCALE,i/$gv.CANVAS_SCALE)),this.foot_walk.SetLinearVelocity(new s.b2Vec2(e/$gv.CANVAS_SCALE,i/$gv.CANVAS_SCALE))}else if($gv.mouse_dm&&$gv.mouse_dm%12==1){const t=$gv.m_viewRect.left+$gv.mouse_x,e=$gv.m_viewRect.top+$gv.mouse_y;this.setPosition(t/$gv.CANVAS_SCALE,e/$gv.CANVAS_SCALE,!0)}}else{const t=$gv.m_viewRect.left+$gv.mouse_x,e=$gv.m_viewRect.top+$gv.mouse_y;this.setPosition(t/$gv.CANVAS_SCALE,e/$gv.CANVAS_SCALE,!0)}}get renderer(){return this._$renderer}set renderer(t){this._$renderer=t}}class u extends c{constructor(){super(...arguments),this._anchor=null}_create(t){super._create(t),window.$io?this._anchor=this._create_anchor(t):this.moveTo=super.moveTo}moveTo(t){this._anchor.m_targetA.x=t.x,this._anchor.m_targetA.y=t.y}}},353:function(t,e,i){"use strict";i.d(e,"c",function(){return r}),i.d(e,"d",function(){return o}),i.d(e,"b",function(){return f}),i.d(e,"a",function(){return w});const s=[],n={};window.character_emotion_list=["blink","hit","smile","troubled","cry","angry","bewildered","stunned","vomit","oops","cheers","chu","wink","pain","glitter","despair","love","shine","blaze","hum","bowing","hot","dam","qBlue"],window.character_action_list=["walk1","walk2","stand1","stand2","alert","swingO1","swingO2","swingO3","swingOF","swingT1","swingT2","swingT3","swingTF","swingP1","swingP2","swingPF","stabO1","stabO2","stabOF","stabT1","stabT2","stabTF","shoot1","shoot2","shootF","proneStab","prone","heal","fly","jump","sit","ladder","rope"];class r{constructor(t,e,i,s,n,r="Equip"){5!=arguments.length&&alert("ItemCategoryInfo: "+[...arguments].join(",")),this.id_prefix=t,this.path=e,this.slot=s,this.listPath=i,this.categoryName=n,this.fragmentType=null,this.dataDir=null,this.iconPath=null,this.iconRawPath=null;{let t,i,n;switch(s){case"head":i="stand1/0/head",n="stand1/0/head";break;case"body":i="stand1/0/body",n="stand1/0/body";break;case"hair":i="stand1/0/hair",n="stand1/0/hair";break;case"face":i="blink/0/face",n="blink/0/face";break;default:i="info/icon",n="info/iconRaw"}"Equip"==r?t=`/Character/${e+(e?"/":"")}`:console.error("未完成"),Object.defineProperties(this,{dataDir:{value:t},iconPath:{value:i},iconRawPath:{value:n}})}}static getDataPath(t){const e=r.get(t);if(!e)return null;if("0"==t[0])return e.dataDir+t;throw new Error("未完成")}static getIconRawUrl(t){let e=r.get(t);return e?"0"==t[0]?p.imageUrl(e.dataDir+t+"/"+e.iconRawPath):void 0:null}static getIconUrl(t){let e=r.get(t);return e?"0"==t[0]?p.imageUrl(e.dataDir+t+"/"+e.iconPath):void 0:null}static async loadString(t){let e=r.get(t);if(!e)return null;let i=`/String/Eqp/Eqp/${e.path+(e.path?"/":"")}${Number(t)}`;return await p.data(i)}static get(t){let e;if(null==t||""==t)throw new TypeError;if(4==t.length){if(e=r._info[t])return e}else{if(e=r._info[t.slice(0,4)])return e;if(e=6==t.length?r._info[t]:r._info[t.slice(0,6)])return e}return console.warn("unknow item type, itemId: "+t),null}static getTypeId(){return Math.trunc(_id/1e6)}static getCategory(){return Math.trunc(_id/1e4)}static isItem(t){return 0!=Math.trunc(t/1e6)}static isEquip(t){if(null==t||""==t)return null;let e=Number(t),i=Math.trunc(e/1e4);return i>180&&i<2e3&&console.warn("?? equip: "+t),1==Math.trunc(e/1e6)}static getSubCategory(t){return Math.trunc(t/1e4)}static isCashWeapon(t){return 170==Math.trunc(t/1e4)}static getJobWeaponCategory(t){console.warn("getJobWeaponCategory: 未完成")}}r.type={Equip:"Equip",Consume:"Consume",Etc:"Etc",Install:"Install",Cash:"Cash"},r.typeName={0:"Equip",1:"Consume",2:"Etc",3:"Install",4:"Cash"},r.typeId={Equip:0,Consume:1,Etc:2,Install:3,Cash:4},r._info={"0000":new r("0000","","body","body","<body>"),"0001":new r("0001","","head","head","<head>"),"0002":new r("0002","Face","Face","face","臉型"),"0003":new r("0003","Hair","Hair","hair","髮型"),"0004":new r("0004","Hair","Hair","hair","髮型"),"0100":new r("0100","Cap","Cap","cap","帽子"),"0101":new r("0101","Accessory","accessoryFace","accessoryFace","臉飾"),"0102":new r("0102","Accessory","accessoryEyes","accessoryEyes","眼飾"),"0103":new r("0103","Accessory","accessoryEars","accessoryEars","耳環"),"0104":new r("0104","Coat","Coat","coat","上衣"),"0105":new r("0105","Longcoat","Longcoat","longcoat","套服"),"0106":new r("0106","Pants","Pants","pants","褲子"),"0107":new r("0107","Shoes","Shoes","shoes","鞋子"),"0108":new r("0108","Glove","Glove","glove","手套"),"0109":new r("0109","Shield","Shield","shield","盾牌"),"0110":new r("0110","Cape","Cape","cape","披風"),"0121":new r("0121","Weapon","閃亮克魯","weapon","閃亮克魯"),"0122":new r("0122","Weapon","靈魂射手","weapon","靈魂射手"),"0123":new r("0123","Weapon","魔劍","weapon","魔劍"),"0124":new r("0124","Weapon","能量劍","weapon","能量劍"),"0125":new r("0125","Weapon","幻獸棒","weapon","幻獸棒"),"0126":new r("0126","Weapon","ESP限制器","weapon","ESP限制器"),"0127":new r("0127","Weapon","鎖鏈","weapon","鎖鏈"),"0128":new r("0128","Weapon","魔力護腕","weapon","魔力護腕"),"0130":new r("0130","Weapon","單手劍","weapon","單手劍"),"0131":new r("0131","Weapon","單手斧","weapon","單手斧"),"0132":new r("0132","Weapon","單手錘","weapon","單手錘"),"0133":new r("0133","Weapon","短劍","weapon","短劍"),"0134":new r("0134","Weapon","雙刀","weapon","雙刀"),"013526":new r("013526","Weapon","靈魂之環","weapon","靈魂之環"),"013530":new r("013530","Weapon","控制器","weapon","控制器"),"0136":new r("0136","Weapon","手杖","weapon","手杖"),"0137":new r("0137","Weapon","短杖","weapon","短杖"),"0138":new r("0138","Weapon","長杖","weapon","長杖"),"0140":new r("0140","Weapon","雙手劍","weapon","雙手劍"),"0141":new r("0141","Weapon","雙手斧","weapon","雙手斧"),"0142":new r("0142","Weapon","雙手棍","weapon","雙手棍"),"0143":new r("0143","Weapon","槍","weapon","槍"),"0144":new r("0144","Weapon","矛","weapon","矛"),"0145":new r("0145","Weapon","弓","weapon","弓"),"0146":new r("0146","Weapon","弩","weapon","弩"),"0147":new r("0147","Weapon","拳套","weapon","拳套"),"0148":new r("0148","Weapon","指虎","weapon","指虎"),"0149":new r("0149","Weapon","火槍","weapon","火槍"),"0150":new r("0150","Weapon","鏟","weapon","鏟"),"0151":new r("0151","Weapon","鎬","weapon","鎬"),"0152":new r("0152","Weapon","雙弩槍","weapon","雙弩槍"),"0153":new r("0153","Weapon","加農砲","weapon","加農砲"),"0154":new r("0154","Weapon","太刀","weapon","太刀"),"0155":new r("0155","Weapon","扇子","weapon","扇子"),"0156":new r("0156","Weapon","琉","weapon","琉"),"0157":new r("0157","Weapon","璃","weapon","璃"),"0158":new r("0158","Weapon","重拳槍","weapon","重拳槍"),"0170":new r("0170","Weapon","0170","weapon","點裝武器")},r._categoryList=function(t){let e=[],i=new Set;for(let s in t){let n=t[s],r=n.categoryName||n.listPath;i.has(r)||(i.add(r),e.push({key:r,value:s}))}return e}(r._info);class o{static isEquipExist(t,e){const i=e.listPath,s=o.equip_map[i];return!s||s.has(t)}static async loadArchive(t){a(n,"/",JSON.parse(await o.get(t)))}static get(t){return new Promise(function(e,i){let n=new XMLHttpRequest;n.open("GET",t,!0),n.timeout=6e5,n.onload=function(){404==this.status||500==this.status?(s.push(t),i(this.status+": "+t)):200==this.status?e(this.responseText):this.status},n.ontimeout=function(e){i("timeout: "+t)},n.onabort=function(e){i("abort: "+t)},n.send()})}static get root_path(){return window.$ROOT_PATH}static get archive(){return n}static get failed_urls(){return s}}function a(t,e,i){e.endsWith("/")&&(e=e.slice(0,e.length-1));let s,n=e.split("/"),r=t,o=n.length-1;for(s=0;s<o;++s){let t=n[s];null==r[t]&&(r[t]={}),r=r[t]}let a=r[n[o]];if(a instanceof Promise)delete r[n[o]],r[n[o]]=i;else if(a&&"object"==typeof a)for(let t in i)a[t]=i[t]||a[t];else void 0!==i&&(r[n[o]]=i)}function l(t,e){e.endsWith("/")&&(e=e.slice(0,e.length-1));let i,s=e.split("/"),n=t,r=s.length-1;for(i=0;i<r;++i){let t=s[i];if(!n[t])return;n=n[t]}return n[s[r]]}window.$ResourceManager=o;const h=Symbol("$pack"),_=RegExp.prototype.test.bind(/^(([a-zA-Z^\:]+)(\:.*)$|\/\/)/);function c(t,e,i){return _(t)?void 0:""!=window.$ROOT_PATH&&t.startsWith(window.$ROOT_PATH)?(i&&(e[h]=!0),t=t.slice(window.$ROOT_PATH.length),a(n,t,e)):a(n,t,e)}function m(t,e){let i=u(t);if(i)return l(n,i)}function u(t){if(!_(t)&&""!=window.$ROOT_PATH&&t.startsWith(window.$ROOT_PATH))return t.slice(window.$ROOT_PATH.length)}function d(t,e){e.endsWith("/")&&(e=e.slice(0,e.length-1));let i=l(t,e);if(i)return i instanceof Promise?new Promise(async function(s,n){await i,s(await d(t,e))}):i;{let i,s=e.split("/"),n=t,r=s.length-1;for(i=0;i<r;++i){let r=s[i];if(n[r]instanceof Promise)return new Promise(async function(i,s){await n[r],i(await d(t,e))});if(!n[r])return;n=n[r]}let o=n[s[r]];return o instanceof Promise?new Promise(async function(i,s){await o,i(await d(t,e))}):o}}let p=function(t){return o.get(t)};p.pack=async function(t){let e,i=u(t);if(i&&(e=d(n,i)),e instanceof Promise)return await e;if(e&&e[h])return e;{0;const i=p.packUrl(t);let s=async function(){let s=await o.get(i);return e=JSON.parse(s),c(t,e,!0),e}();return c(t,s,!0),await s}},p.packSync=function(t){let e=m(t);if(e)return e},p.data=async function(t){let e,i=u(t);if(i&&(e=d(n,i)),e instanceof Promise)return await e;if(e)return e;{const i=p.dataUrl(t);let s=async function(){let s=await o.get(i);return e=JSON.parse(s),c(t,e,!1),e}();return c(t,s,!1),await s}},p.dataSync=function(t){let e=m(t);if(e)return e},p.list=async function(t){let e,i=u(t);if(i&&(e=d(n,i)),e instanceof Promise)return await e;if(e)return e;{const i=p.listUrl(t);let s=async function(){let s=await o.get(i);return e=JSON.parse(s),c(t,e,!1),e}();return c(t,s,!1),await s}},p.listSync=function(t){let e=m(t);if(e)return Object.keys(e)},p.dataUrl=function(t){if(_(t))return t;if(!t.startsWith("data"))return`${window.$ROOT_PATH}data${t}.json`;throw new Error("Not game data: "+t)},p.packUrl=function(t){if(_(t))return t;if(!t.startsWith("pack"))return`${window.$ROOT_PATH}pack${t}.json`;throw new Error("Not game pack: "+t)},p.listUrl=function(t){if(_(t))return t;if(!t.startsWith("ls"))return`${window.$ROOT_PATH}ls${t}.json`;throw new Error(t)},p.imageUrl=function(t){if(_(t))return t;if(!t.startsWith("images"))return`${window.$ROOT_PATH}images${t}.png`;throw new Error("Not game images: "+t)},p.soundMp3Url=function(t){if(_(t))return t;if(!t.startsWith("sound"))return`${window.$ROOT_PATH}sound${t}.mp3`;throw new Error("Not game sound: "+t)},p.soundWavUrl=function(t){if(_(t))return t;if(!t.startsWith("sound"))return`${window.$ROOT_PATH}sound${t}.wav`;throw new Error("Not game sound: "+t)},p.assetUrl=function(t){return`${window.$ROOT_PATH}${t}`},p.asset=function(t){return p(p.assetUrl(t))},window.$get=p;class f{static head(t){t.gender=2}static body(t){t.gender=2}static Face(t){const e=Math.trunc(t.id%1e4/1e3);t.gender=1==e||4==e?1:0}static Hair(t){const e=Math.trunc(t.id%1e4/1e3);t.gender=1==e||2==e||4==e||7==e?1:0}static Cap(t){f._equip(t)}static accessoryFace(t){f._equip(t)}static accessoryEyes(t){f._equip(t)}static accessoryEars(t){f._equip(t)}static Coat(t){f._equip(t)}static Longcoat(t){f._equip(t)}static Pants(t){f._equip(t)}static Shoes(t){f._equip(t)}static Glove(t){f._equip(t)}static Shield(t){f._equip(t)}static Cape(t){f._equip(t)}static _equip(t){const e=Math.trunc(t.id%1e4/1e3);t.gender=0==e?0:1==e?1:2}}const y=/(\d{4,7})\d$/,A=/(\d{2,5})\d(\d{2})$/,g=/\d{4,7}(\d)$/,x=/\d{2,5}(\d)\d{2}$/;class w{static*enumHairColor(t){let e=t.match(y);for(let t=0;t<10;++t){yield e[1]+t}}static*enumFaceColor(t){let e=t.match(A);for(let t=0;t<10;++t){yield e[1]+t+e[2]}}static getColorHairID(t,e){return t.match(y)[1]+e%10}static getColorFaceID(t,e){let i=t.match(A);return i[1]+e%10+i[2]}static isHairStyleEqual(t,e){return w.getColorHairID(t,0)==w.getColorHairID(e,0)}static isFaceStyleEqual(t,e){return w.getColorFaceID(t,0)==w.getColorFaceID(e,0)}static getHairColor(t){if(t){let e=(t=String(t)).match(g);if(e)return e[1]}}static getFaceColor(t){if(t){let e=(t=String(t)).match(x);if(e)return e[1]}}}var b={Equip:{Hat:"Cap",Cape:"Cape",Top:"Coat",Overall:"Longcoat",Glove:"Glove",Bottom:"Pants",Shield:"Shield",Shoes:"Shoes","Eye Decoration":"accessoryEyes",Earrings:"accessoryEars","Face Accessory":"accessoryFace",Face:"Face",Hair:"Hair"}};o.external={equip:{}},o.equip_map={};for(let t in b.Equip){let e=b.Equip[t];o.external.equip[e]=[],o.equip_map[e]=null}for(let t=0;t<9;++t){let e="Face"+t;o.external.equip[e]=[],o.equip_map[e]=null}for(let t=0;t<8;++t){let e="Hair"+t;o.external.equip[e]=[],o.equip_map[e]=null}async function S(t){let e;t=t||"/items.json";try{if(!(e=o._external_raw=JSON.parse(await p.asset("equip.json"))))throw Error("'/equip' is empty")}catch(t){if(!(e=o._external_raw=JSON.parse(await p("//labs.maplestory.io/api/gms/latest/item/category/equip"))))return}for(let t=0;t<e.length;++t){const i=e[t],s=String(i.id).padStart(8,"0");try{if(!i.typeInfo||!b[i.typeInfo.overallCategory])continue;let t=i.typeInfo.overallCategory.toLowerCase(),e=b[i.typeInfo.overallCategory][i.typeInfo.subCategory];if(!e)continue;"Face"==e?e+=w.getFaceColor(s):"Hair"==e&&(e+=w.getHairColor(s));let n={id:s,name:i.name,desc:i.desc,cash:i.isCash?1:0,icon:{"":`//labs.maplestory.io/api/gms/latest/item/${i.id}/icon`}};o.external[t][e].push(n)}catch(t){console.error("external resource: id("+s+")"),console.error(t)}}}let v=S();async function C(t,e){await v,B(t,e),concat_external_resource=B}function B(t,e){try{const i=o.external.equip[t];if(!i)return;let s=o.equip_map[t];s||(s=new Map,e.forEach(t=>{s.set(t.id,t)}),o.equip_map[t]=s),i.forEach(t=>{let i=t.id;if(s.has(i)){let e=s.get(i);e._name=t.name||"",e._desc=t.desc||""}else t.$foreign=!0,e.push(t)})}catch(t){console.error(t)}}window.concat_external_resource=C,window.trigger_update_external_equip_list=function(){v=S(),window.concat_external_resource=C},window.load_extern_item_data=async function(t){let e=JSON.parse(await p(`//labs.maplestory.io/api/gms/latest/item/${t}`)),i={},s=e.frameBooks.default?e.frameBooks.default.frames[0]:null;for(let t in e.frameBooks){let n=e.frameBooks[t],r=[];for(let t=0;t<n.frames.length;++t){let e=n.frames[t]||s;if(!e||!e.effects)continue;let i=e.effects,o={};for(let t in i){let e=i[t];e.image&&(o[t]={"":"data:image/png;base64,"+e.image,origin:e.originOrZero||e.origin||e.center,map:e.mapOffset,z:e.position})}r[t]=o}i[t]=r}return i.info={islot:e.metaInfo.equip.islot,vslot:e.metaInfo.equip.vslot,icon:e.metaInfo.icon?"data:image/png;base64,"+e.metaInfo.icon.iconRaw:"",cash:e.metaInfo.cash&&e.metaInfo.cash.cash?1:0},i}},354:function(t,e,i){"use strict";i.d(e,"a",function(){return s});i(333),i(352);class s{constructor(){this.$objectid=null,this.$layer=null,this.$physics=null,Object.defineProperty(this,"$physics",{configurable:!0,enumerable:!1,writable:!0,value:null}),this.renderer=null}create(){}destroy(){}set enablePhysics(t){this.$physics&&(this.$physics.enable=t,this.$physics.state.freeze=!t)}get enablePhysics(){return!!this.$physics&&this.$physics.enable}_applyState(){throw new Error("Not implement")}update(t){this.renderer.update(t)}render(t){this.renderer.render(t)}damage(t,e){console.log(this.$objectid+" 被 "+t.$objectid+" 攻擊，減少 "+e+" HP")}knockback(t,e,i){}__drawName(t,e){const i=t.ctx,s=this.renderer;i.font="12px 微軟正黑體",i.textBaseline="middle",i.textAlign="start";const n=i.measureText(e).width+3,r=Math.trunc(s.x)-.5*n,o=Math.trunc(s.y),a=r+2,l=r,h=o,_=o+2,c=r+n,m=c+2,u=o+2+12+2,d=o+2+12;i.fillStyle="rgba(0,0,0,0.7)",i.strokeStyle="rgba(0,0,0,0.7)",i.beginPath(),i.moveTo(a,h),i.lineTo(c,h),i.arcTo(m,h,m,_,2),i.lineTo(m,d),i.arcTo(m,u,c,u,2),i.lineTo(a,u),i.arcTo(l,u,l,d,2),i.lineTo(l,_),i.arcTo(l,h,a,h,2),i.fill(),i.fillStyle="white",i.strokeStyle="white",i.fillText(e,a,.5*(h+u))}}},355:function(t,e,i){const s=i(367),{FilterHelper:n}=i(356),{b2Vec2:r,b2Body:o,b2Fixture:a,b2Contact:l,b2Manifold:h,b2ContactImpulse:_,b2ContactListener:c}=s;window.$box2d=s;let m=new r;o.prototype.$type=null,o.prototype.Step=function(t){if(this._on_step)for(let e of this._on_step)e(t)},o.prototype.AfterStep=function(t){if(this._on_after_step)for(let e of this._on_after_step)e(t)},o.prototype.addStep=function(t){this._on_step=this._on_step||[],this._on_step.push(t)},o.prototype.addAfterStep=function(t){this._on_after_step=this._on_after_step||[],this._on_after_step.push(t)},o.prototype.SetLinearVelocity2=function(t,e){m.x=t,m.y=e,this.SetLinearVelocity(m,!0)},o.prototype.ApplyForceToCenter2=function(t,e){m.x=t,m.y=e,this.ApplyForceToCenter(m,!0)},o.prototype.ApplyLinearImpulseToCenter2=function(t,e){m.x=t,m.y=e,this.ApplyLinearImpulseToCenter(m,!0)},o.prototype.Acceleration=function(t,e,i){i||(i=this.GetWorldCenter());let s=r.SubVV(t,e,m),n=this.GetMass(),o=n*s.x,a=n*s.y,l=m.Set(o,a);this.ApplyLinearImpulse(l,i,!0)},o.prototype.AccelerationX=function(t,e,i){i||(i=this.GetWorldCenter());let s=t-e.x,n=this.GetMass()*s,r=m.Set(n,0);this.ApplyLinearImpulse(r,i,!0)},o.prototype.AccelerationY=function(t,e,i){i||(i=this.GetWorldCenter());let s=t-e.y,n=this.GetMass()*s,r=m.Set(0,n);this.ApplyLinearImpulse(r,i,!0)},o.prototype.ConstantVelocity=function(t,e){this.Acceleration(t,this.GetLinearVelocity(),e||this.GetWorldCenter())},o.prototype.ConstantVelocity2=function(t,e,i,s){const n=new r(t,e),o=new r(i,s),a=this.GetLinearVelocity(),l=this.GetMass();let h=new r,_=r.SubVV(n,a,h);h.x=l*_.x,h.y=l*_.y,this.ApplyLinearImpulse(h,o,!0)},o.prototype.ConstantVelocityWorldCenter2=function(t,e){const i=new r(t,e),s=this.GetLinearVelocity(),n=this.GetMass();let o=new r,a=r.SubVV(i,s,o);o.x=n*a.x,o.y=n*a.y,this.ApplyLinearImpulseToCenter(o,!0)},o.prototype.ConstantVelocityX=function(t,e){this.AccelerationX(t,this.GetLinearVelocity(),e||this.GetWorldCenter())},o.prototype.ConstantVelocityY=function(t,e){this.AccelerationY(t,this.GetLinearVelocity(),e||this.GetWorldCenter())},a.prototype.beginContact=function(t,e,i){},a.prototype.endContact=function(t,e,i){},a.prototype.preSolve=function(t,e,i,s){},a.prototype.postSolve=function(t,e,i,s){},a.prototype.getOwnerID=function(){let t=this.GetUserData();if(t&&t.owner)return t.owner.id};t.exports=Object.assign(s,{FixtureContactListener:class{beginContact(t,e,i){}endContact(t,e,i){}preSolve(t,e,i,s){}postSolve(t,e,i,s){}},FilterHelper:n})},356:function(t,e,i){"use strict";i.r(e),i.d(e,"FilterHelper",function(){return a});var s=i(360),n=i(367);let r={},o=1;class a extends s.a{ignore(t){let e=r["s_"+t];this.maskBits=(this.maskBits&~e.categoryBits)>>>0,e.maskBits=(e.maskBits&~this.categoryBits)>>>0}addCategory(t){let e=r["s_"+t];this.categoryBits=this.categoryBits|e.categoryBits}static get(t,e){let i=r["s_"+t];if(e){let t=r["s_"+e];console.warn("filter: "+e+"%o",t)}return i}static registerCategory(t){let e=r["s_"+t]=new a;return e.groupIndex=0,e.categoryBits=o,e.maskBits=4294967295,e.name=t,o<<=1,e}static get next_category(){return r}static get filter_preset(){return r}}const l=[[1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,1,1,1,0,1,1,1],[1,0,0,1,0,0,0,0,0,0,0,0],[1,0,1,0,0,0,0,0,1,0,0,1],[1,0,0,0,0,0,1,0,0,0,0,0],[1,1,0,0,0,0,1,0,0,0,0,0],[1,1,0,0,1,1,0,0,0,0,0,0],[1,1,0,0,0,0,0,0,0,0,0,0],[1,0,0,1,0,0,0,0,0,0,0,0],[1,1,0,0,0,0,0,0,0,0,0,0],[1,1,0,0,0,0,0,0,0,0,0,0],[1,1,0,1,0,0,1,0,0,0,0,0]];!function(){let t=[a.registerCategory("default"),a.registerCategory("body"),a.registerCategory("foothold"),a.registerCategory("foot"),a.registerCategory("bullet"),a.registerCategory("pvp_bullet"),a.registerCategory("mob"),a.registerCategory("mob_bullet"),a.registerCategory("portal"),a.registerCategory("ladder"),a.registerCategory("map_obj"),a.registerCategory("map_border")];for(let e=0;e<l.length;++e)for(let i=0;i<l[e].length;++i)l[e][i]||(t[e].maskBits=(t[e].maskBits&~(1<<i))>>>0)}(),function(){let t=new n.b2ContactFilter;function e(t){return{GetFilterData:()=>a.get(t),GetBody:()=>({GetType:()=>2,ShouldCollideConnected:()=>!0})}}t.ShouldCollide(e("body"),e("ladder")),t.ShouldCollide(e("ladder"),e("body")),t.ShouldCollide(e("foot"),e("portal")),t.ShouldCollide(e("portal"),e("foot"))}()},358:function(t,e,i){"use strict";i.d(e,"a",function(){return c});var s=i(355),n=(i(375),i(368)),r=i(376),o=i(352),a=i(377),l=(i(337),i(333),i(356));window.$gravityAcc=2e3,window.$positionIterations=3,window.$velocityIterations=8,window.$particleIterations=1,window.$particleRadius=10;const h=new s.b2Vec2(0,window.$gravityAcc/$gv.CANVAS_SCALE);class _ extends s.b2ContactListener{BeginContact(t){const e=t.m_fixtureA,i=t.m_fixtureB,s=t.m_indexA,n=t.m_indexB;e.beginContact.call(e.m_userData,t,e,i,s,n),i.beginContact.call(i.m_userData,t,i,e,n,s)}EndContact(t){const e=t.m_fixtureA,i=t.m_fixtureB,s=t.m_indexA,n=t.m_indexB;e.endContact.call(e.m_userData,t,e,i,s,n),i.endContact.call(i.m_userData,t,i,e,n,s)}PreSolve(t,e){const i=t.m_fixtureA,s=t.m_fixtureB,n=t.m_indexA,r=t.m_indexB;i.preSolve.call(i.m_userData,t,e,i,s,n,r),s.preSolve.call(s.m_userData,t,e,s,i,r,n)}PostSolve(t,e){const i=t.m_fixtureA,s=t.m_fixtureB,n=t.m_indexA,r=t.m_indexB;i.postSolve.call(i.m_userData,t,e,i,s,n,r),s.postSolve.call(s.m_userData,t,e,s,i,r,n)}}class c extends s.b2World{constructor(){super(h),this.m_debugDraw=$gv.m_debugDraw,this.SetDebugDraw(this.m_debugDraw),this.SetContactListener(new _),this.ground=new n.a,this.ladderRope=[],this.mapBound_body=null,this.stop=!1,this.$_mouseJoint=null,this._onceAfterStep=[],this._destryBodyList=[],this._DestroyBody=this.DestroyBody,this.DestroyBody=(t=>{this.m_locked?this._destryBodyList.push(t):this._DestroyBody(t)}),this.draw_foothold_path_count=1}$test_b2ParticleSystem(){const t=s.b2ParticleFlag.b2_elasticParticle,e=new s.b2ParticleSystemDef;this.m_particleSystem=this.CreateParticleSystem(e),this.m_particleSystem.SetGravityScale(0),this.m_particleSystem.SetRadius(10/$gv.CANVAS_SCALE),this.m_particleSystem.SetDamping(.2);{const e=new s.b2CircleShape;e.m_p.Set(0,2),e.m_radius=3;const i=new s.b2ParticleGroupDef;i.flags=t,i.shape=e;const n=this.m_particleSystem.CreateParticleGroup(i);i.flags&s.b2ParticleFlag.b2_colorMixingParticle&&this.ColorParticleGroup(n,0)}window.m_particleSystem=this.m_particleSystem,this.$vbo_ps=null}async load(t){this.ground.load(t,this),this.ladderRope=r.a.load(t,this)}unload(){this.IsLocked()?console.error("world is locked, world can not unload"):(this.ground.unload(this),this.ladderRope.length=0,this.DestroyBody(this.mapBound_body))}createMob(t){let e=new a.a(t);return e._create(this),e}destroyMob(t){return t.$physics._destroy(this),t.$physics=null,!0}createNpc(t){return null}destroyNpc(t){return!1}createPortal(t){const e=t.compute_rectangle(0);if(e){const i=e.width/2/$gv.CANVAS_SCALE*.4,n=e.height/2/$gv.CANVAS_SCALE*.2;let r,o=new s.b2BodyDef,a=new s.b2FixtureDef;a.filter.Copy(l.FilterHelper.get("portal")),o.userData=t,o.type=s.b2BodyType.b2_staticBody,o.position.Set(t.x/$gv.CANVAS_SCALE,t.y/$gv.CANVAS_SCALE);let h=this.CreateBody(o);h.$type="portal",r=new s.b2PolygonShape,window.MAP_PORTAL_FULL_SIZE?r.SetAsBox(e.width/2/$gv.CANVAS_SCALE,e.height/2/$gv.CANVAS_SCALE,new s.b2Vec2(-t.textures[0].x/$gv.CANVAS_SCALE,-t.textures[0].y/$gv.CANVAS_SCALE),0):r.SetAsBox(i,n,new s.b2Vec2(0,-n),0),a.isSensor=!0,a.shape=r,a.filter=l.FilterHelper.get("portal"),a.userData=t,a.$type="portal";h.CreateFixture(a);return t.body=h,h}}_createMapBound(t){let{left:e,top:i,right:n,bottom:r}=t;e/=$gv.CANVAS_SCALE,n/=$gv.CANVAS_SCALE,i/=$gv.CANVAS_SCALE,r/=$gv.CANVAS_SCALE;let o=new s.b2BodyDef,a=new s.b2FixtureDef,h=new s.b2EdgeShape;a.$type="MapBorder",a.shape=h,a.filter.Copy(l.FilterHelper.get("map_border"));let _=this.CreateBody(o);_.$type="MapBorder",h.m_vertex1.Set(e,i),h.m_vertex2.Set(n,i),_.CreateFixture(a),h.m_vertex1.Set(e,r),h.m_vertex2.Set(n,r),_.CreateFixture(a),h.m_vertex1.Set(e,i),h.m_vertex2.Set(e,r),_.CreateFixture(a),h.m_vertex1.Set(n,i),h.m_vertex2.Set(n,r),_.CreateFixture(a),this.player&&this.player.setPosition(.5*(n+e),.5*(r+i),!0),this.mapBound_body=_}$createPlayer(t,e){t&&e||alert("$createPlayer(sceneObject, renderer)");let i=new o.a;return i._create(this),i.chara=t,i.renderer=e,this.player=i,i}$createRemotePlayer(t,e){t&&e||alert("$createRemotePlayer(sceneObject, renderer)");let i=new o.b;return i._create(this),i.renderer=e,i}onceUnlock(t){this.m_locked?this._onceAfterStep.push(t):t()}doAfterStep(t){this._onceAfterStep.push(t)}$_mouseDown(t){if(null!=this.$_mouseJoint)return;let e=new s.b2AABB,i=new s.b2Vec2;i.Set(.001,.001),s.b2Vec2.SubVV(t,i,e.lowerBound),s.b2Vec2.AddVV(t,i,e.upperBound);let n=null;if(this.QueryAABB(function(e){if(e.GetBody().GetType()!=s.b2BodyType.b2_staticBody){if(e.TestPoint(t))return n=e,!1}return!0},e),n){let e=n.GetBody(),i=new s.b2MouseJointDef;i.bodyA=this.ground.bodies[0],i.bodyB=e,i.target.Copy(t),i.maxForce=1e3*e.GetMass(),this.$_mouseJoint=this.CreateJoint(i),e.SetAwake(!0)}}$_mouseUp(t){this.$_mouseJoint&&(this.DestroyJoint(this.$_mouseJoint),this.$_mouseJoint=null)}$_mouseMove(t){this.$_mouseJoint&&this.$_mouseJoint.SetTarget(t)}$_onMouseEvent(){const t=($gv.m_viewRect.left+$gv.mouse_x)/$gv.CANVAS_SCALE,e=($gv.m_viewRect.top+$gv.mouse_y)/$gv.CANVAS_SCALE,i=new s.b2Vec2(t,e);$gv.mouse_dl&&this.$_mouseDown(i),$gv.mouse_ul&&($gv.mouse_ul=0,this.$_mouseUp(i)),$gv.mouse_move&&($gv.mouse_move=0,this.$_mouseMove(i))}update(t){if(!this.stop){this.$_onMouseEvent();for(let e=this.GetBodyList();e;e=e.m_next)e.Step(t);super.Step(1/$gv.MAX_FPS,window.$velocityIterations,window.$positionIterations,window.$particleIterations);for(let e=this.GetBodyList();e;e=e.m_next)e.AfterStep(t);this._onceAfterStep&&(this._onceAfterStep.forEach(t=>t()),this._onceAfterStep.length=0),this._destryBodyList&&(this._destryBodyList.forEach(t=>this._DestroyBody(t)),this._destryBodyList.length=0)}}render(t){const e=t.ctx,i=window.chara?window.chara.$physics:this.player;if($gv.m_display_physics_debug){const t=this.m_debugDraw;this.m_debugDraw.m_ctx=e;e.canvas.width,e.canvas.height;if(e.save(),e.scale(t.canvasScale,t.canvasScale),e.lineWidth/=t.canvasScale,e.scale(t.viewZoom,t.viewZoom),e.lineWidth/=t.viewZoom,this.DrawDebugData(),i&&i.body){const t=i.getPosition();e.fillStyle="#F00A",i.state.front>0?e.fillRect(t.x,t.y,1,1):i.state.front<0?e.fillRect(t.x-1,t.y,1,1):e.fillRect(t.x-.5,t.y,1,1)}e.restore()}if($gv.m_display_particleSystem)if(t.gl){const t=this.gl;if(this.$vbo_ps){const e=this.m_particleSystem.GetParticleCount(),i=this.m_particleSystem.GetPositionBuffer();let s=new Float32Array(2*e);for(let t=0;t<e;t+=2)s[t+0]=i[t].x,s[t+1]=i[t].y;t.bufferData(t.ARRAY_BUFFER,s,t.STATIC_DRAW)}else{let e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e);const i=this.m_particleSystem.GetParticleCount(),s=this.m_particleSystem.GetPositionBuffer();let n=new Float32Array(2*i);for(let t=0;t<i;t+=2)n[t+0]=s[t].x,n[t+1]=s[t].y;t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW),this.$vbo_ps=e}for(let e=this.m_particleSystem.m_groupList;e;e=e.m_next){let i=e.GetParticleCount(),s=e.GetBufferIndex();t.drawArrays(t.POINTS,s,i)}}else if(e)if($gv.func)$gv.func.call(this,e,t);else{const i=this.m_particleSystem.m_positionBuffer.data;this.m_particleSystem.m_colorBuffer.data,this.m_particleSystem.m_weightBuffer.data;t.pushMatrix();const s=window.$particleRadius,n=2*s;if(!this.$particle_grd){let t=e.createRadialGradient(s,s,0,s,s,n);t.addColorStop(0,"#0744"),t.addColorStop(1,"#07440"),this.$particle_grd=t}for(let r=this.m_particleSystem.m_groupList;r;r=r.m_next)for(let o=r.m_firstIndex;o<r.m_lastIndex;++o){let r=i[o].x*$gv.CANVAS_SCALE-s,a=i[o].y*$gv.CANVAS_SCALE-s;t.setTransform(1,0,0,1,$gv.m_viewRect.left+r,$gv.m_viewRect.top+a),e.beginPath(),e.fillStyle=this.$particle_grd,e.fillRect(s,s,2*n,2*n)}t.popMatrix()}if($gv.m_display_foothold){let s,n;if(e.save(),this.ground.$drawDebugInfo(t),i&&i._foothold&&i._foothold.$drawDebugInfo2(t,"#FF0"),i&&(s=i.$foothold,n=i.ladder),s&&this.draw_foothold_path_count){s.$drawDebugInfo2(t,"#F00");let n=this.draw_foothold_path_count;if(e.lineWidth=2.5,e.strokeStyle="#00FE",i.state.front>0)for(s=this.ground.footholds[s.next];s&&(s._drawLine(e),!(--n<=0));s=this.ground.footholds[s.next]);else if(i.state.front<0)for(s=this.ground.footholds[s.prev];s&&(s._drawLine(e),!(--n<=0));s=this.ground.footholds[s.prev]);}this.ladderRope.forEach(t=>{const i=t.calcWidth();e.beginPath(),e.rect(t.x-.5*i,t.y1,i,t.y2-t.y1),e.fillStyle=t==n?"#E117":"#EB17",e.fill()}),e.restore()}}}},359:function(t,e,i){"use strict";i.d(e,"d",function(){return r}),i.d(e,"f",function(){return o}),i.d(e,"b",function(){return a}),i.d(e,"c",function(){return l}),i.d(e,"h",function(){return h}),i.d(e,"i",function(){return _}),i.d(e,"j",function(){return c}),i.d(e,"k",function(){return m}),i.d(e,"g",function(){return u}),i.d(e,"e",function(){return d}),i.d(e,"a",function(){return S});var s=i(344),n=i(345);class r{constructor(){this.m_buffer=n.A.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}Reset(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}SetShape(t,e){t.SetupDistanceProxy(this,e)}GetSupport(t){let e=0,i=n.A.DotVV(this.m_vertices[0],t);for(let s=1;s<this.m_count;++s){const r=n.A.DotVV(this.m_vertices[s],t);r>i&&(e=s,i=r)}return e}GetSupportVertex(t){let e=0,i=n.A.DotVV(this.m_vertices[0],t);for(let s=1;s<this.m_count;++s){const r=n.A.DotVV(this.m_vertices[s],t);r>i&&(e=s,i=r)}return this.m_vertices[e]}GetVertexCount(){return this.m_count}GetVertex(t){return this.m_vertices[t]}}class o{constructor(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}Reset(){return this.metric=0,this.count=0,this}}class a{constructor(){this.proxyA=new r,this.proxyB=new r,this.transformA=new n.z,this.transformB=new n.z,this.useRadii=!1}Reset(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}class l{constructor(){this.pointA=new n.A,this.pointB=new n.A,this.distance=0,this.iterations=0}Reset(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}let h=0,_=0,c=0;function m(){h=0,_=0,c=0}class u{constructor(){this.wA=new n.A,this.wB=new n.A,this.w=new n.A,this.a=0,this.indexA=0,this.indexB=0}Copy(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this}}class d{constructor(){this.m_v1=new u,this.m_v2=new u,this.m_v3=new u,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}ReadCache(t,e,i,r,o){this.m_count=t.count;const a=this.m_vertices;for(let s=0;s<this.m_count;++s){const l=a[s];l.indexA=t.indexA[s],l.indexB=t.indexB[s];const h=e.GetVertex(l.indexA),_=r.GetVertex(l.indexB);n.z.MulXV(i,h,l.wA),n.z.MulXV(o,_,l.wB),n.A.SubVV(l.wB,l.wA,l.w),l.a=0}if(this.m_count>1){const e=t.metric,i=this.GetMetric();(i<.5*e||2*e<i||i<s.r)&&(this.m_count=0)}if(0===this.m_count){const t=a[0];t.indexA=0,t.indexB=0;const s=e.GetVertex(0),l=r.GetVertex(0);n.z.MulXV(i,s,t.wA),n.z.MulXV(o,l,t.wB),n.A.SubVV(t.wB,t.wA,t.w),t.a=1,this.m_count=1}}WriteCache(t){t.metric=this.GetMetric(),t.count=this.m_count;const e=this.m_vertices;for(let i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB}GetSearchDirection(t){switch(this.m_count){case 1:return n.A.NegV(this.m_v1.w,t);case 2:{const e=n.A.SubVV(this.m_v2.w,this.m_v1.w,t);return n.A.CrossVV(e,n.A.NegV(this.m_v1.w,n.A.s_t0))>0?n.A.CrossOneV(e,t):n.A.CrossVOne(e,t)}default:return t.SetZero()}}GetClosestPoint(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}}GetWitnessPoints(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}}GetMetric(){switch(this.m_count){case 0:case 1:return 0;case 2:return n.A.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return n.A.CrossVV(n.A.SubVV(this.m_v2.w,this.m_v1.w,n.A.s_t0),n.A.SubVV(this.m_v3.w,this.m_v1.w,n.A.s_t1));default:return 0}}Solve2(){const t=this.m_v1.w,e=this.m_v2.w,i=n.A.SubVV(e,t,d.s_e12),s=-n.A.DotVV(t,i);if(s<=0)return this.m_v1.a=1,void(this.m_count=1);const r=n.A.DotVV(e,i);if(r<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);const o=1/(r+s);this.m_v1.a=r*o,this.m_v2.a=s*o,this.m_count=2}Solve3(){const t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,s=n.A.SubVV(e,t,d.s_e12),r=n.A.DotVV(t,s),o=n.A.DotVV(e,s),a=-r,l=n.A.SubVV(i,t,d.s_e13),h=n.A.DotVV(t,l),_=n.A.DotVV(i,l),c=-h,m=n.A.SubVV(i,e,d.s_e23),u=n.A.DotVV(e,m),p=n.A.DotVV(i,m),f=-u,y=n.A.CrossVV(s,l),A=y*n.A.CrossVV(e,i),g=y*n.A.CrossVV(i,t),x=y*n.A.CrossVV(t,e);if(a<=0&&c<=0)return this.m_v1.a=1,void(this.m_count=1);if(o>0&&a>0&&x<=0){const t=1/(o+a);return this.m_v1.a=o*t,this.m_v2.a=a*t,void(this.m_count=2)}if(_>0&&c>0&&g<=0){const t=1/(_+c);return this.m_v1.a=_*t,this.m_v3.a=c*t,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(o<=0&&f<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(_<=0&&p<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(p>0&&f>0&&A<=0){const t=1/(p+f);return this.m_v2.a=p*t,this.m_v3.a=f*t,this.m_count=2,void this.m_v1.Copy(this.m_v3)}const w=1/(A+g+x);this.m_v1.a=A*w,this.m_v2.a=g*w,this.m_v3.a=x*w,this.m_count=3}}d.s_e12=new n.A,d.s_e13=new n.A,d.s_e23=new n.A;const p=new d,f=[0,0,0],y=[0,0,0],A=new n.A,g=new n.A,x=new n.A,w=new n.A,b=new n.A;function S(t,e,i){++h;const r=i.proxyA,o=i.proxyB,a=i.transformA,l=i.transformB,m=p;m.ReadCache(e,r,a,o,l);const u=m.m_vertices,d=f,S=y;let v=0,C=s.x,B=C,V=0;for(;V<20;){v=m.m_count;for(let t=0;t<v;++t)d[t]=u[t].indexA,S[t]=u[t].indexB;switch(m.m_count){case 1:break;case 2:m.Solve2();break;case 3:m.Solve3()}if(3===m.m_count)break;C=B=m.GetClosestPoint(A).LengthSquared();const t=m.GetSearchDirection(g);if(t.LengthSquared()<s.s)break;const e=u[m.m_count];e.indexA=r.GetSupport(n.t.MulTRV(a.q,n.A.NegV(t,n.A.s_t0),w)),n.z.MulXV(a,r.GetVertex(e.indexA),e.wA),e.indexB=o.GetSupport(n.t.MulTRV(l.q,t,b)),n.z.MulXV(l,o.GetVertex(e.indexB),e.wB),n.A.SubVV(e.wB,e.wA,e.w),++V,++_;let i=!1;for(let t=0;t<v;++t)if(e.indexA===d[t]&&e.indexB===S[t]){i=!0;break}if(i)break;++m.m_count}if(c=Object(n.m)(c,V),m.GetWitnessPoints(t.pointA,t.pointB),t.distance=n.A.DistanceVV(t.pointA,t.pointB),t.iterations=V,m.WriteCache(e),i.useRadii){const e=r.m_radius,i=o.m_radius;if(t.distance>e+i&&t.distance>s.r){t.distance-=e+i;const s=n.A.SubVV(t.pointB,t.pointA,x);s.Normalize(),t.pointA.SelfMulAdd(e,s),t.pointB.SelfMulSub(i,s)}else{const e=n.A.MidVV(t.pointA,t.pointB,A);t.pointA.Copy(e),t.pointB.Copy(e),t.distance=0}}}},360:function(t,e,i){"use strict";i.d(e,"a",function(){return a}),i.d(e,"c",function(){return l}),i.d(e,"d",function(){return h}),i.d(e,"b",function(){return _});var s=i(344),n=i(345),r=i(346),o=i(347);class a{constructor(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}Clone(){return(new a).Copy(this)}Copy(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex,this}}class l{constructor(){this.shape=null,this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new a}}class h{constructor(t){this.aabb=new r.a,this.childIndex=0,this.treeNode=null,this.fixture=t}}class _{constructor(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=null,this.m_proxyCount=0,this.m_filter=new a,this.m_isSensor=!1,this.m_userData=null,this.m_body=e,this.m_shape=t.shape.Clone()}GetType(){return this.m_shape.GetType()}GetShape(){return this.m_shape}SetSensor(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)}IsSensor(){return this.m_isSensor}SetFilterData(t){this.m_filter.Copy(t),this.Refilter()}GetFilterData(){return this.m_filter}Refilter(){if(this.m_body)return;let t=this.m_body.GetContactList();for(;t;){const e=t.contact,i=e.GetFixtureA(),s=e.GetFixtureB();i!==this&&s!==this||e.FlagForFiltering(),t=t.next}const e=this.m_body.GetWorld();if(null===e)return;const i=e.m_contactManager.m_broadPhase;for(let t=0;t<this.m_proxyCount;++t)i.TouchProxy(this.m_proxies[t].treeNode)}GetBody(){return this.m_body}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}TestPoint(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)}ComputeDistance(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)}RayCast(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)}GetMassData(t=new o.a){return this.m_shape.ComputeMass(t,this.m_density),t}SetDensity(t){this.m_density=t}GetDensity(){return this.m_density}GetFriction(){return this.m_friction}SetFriction(t){this.m_friction=t}GetRestitution(){return this.m_restitution}SetRestitution(t){this.m_restitution=t}GetAABB(t){return this.m_proxies[t].aabb}Dump(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)}Create(t){this.m_userData=t.userData,this.m_friction=t.friction,this.m_restitution=t.restitution,this.m_next=null,this.m_filter.Copy(t.filter),this.m_isSensor=t.isSensor,this.m_proxies=Object(s.e)(this.m_shape.GetChildCount(),t=>new h(this)),this.m_proxyCount=0,this.m_density=t.density}Destroy(){}CreateProxies(t,e){this.m_proxyCount=this.m_shape.GetChildCount();for(let i=0;i<this.m_proxyCount;++i){const s=this.m_proxies[i]=new h(this);this.m_shape.ComputeAABB(s.aabb,e,i),s.treeNode=t.CreateProxy(s.aabb,s),s.childIndex=i}}DestroyProxies(t){for(let e=0;e<this.m_proxyCount;++e){const i=this.m_proxies[e];i.treeNode.userData=null,t.DestroyProxy(i.treeNode),i.treeNode=null}this.m_proxyCount=0}Synchronize(t,e,i){if(0!==this.m_proxyCount)for(let s=0;s<this.m_proxyCount;++s){const r=this.m_proxies[s],o=_.Synchronize_s_aabb1,a=_.Synchronize_s_aabb2;this.m_shape.ComputeAABB(o,e,s),this.m_shape.ComputeAABB(a,i,s),r.aabb.Combine2(o,a);const l=n.A.SubVV(i.p,e.p,_.Synchronize_s_displacement);t.MoveProxy(r.treeNode,r.aabb,l)}}}_.Synchronize_s_aabb1=new r.a,_.Synchronize_s_aabb2=new r.a,_.Synchronize_s_displacement=new n.A},362:function(t,e,i){"use strict";i.d(e,"a",function(){return s}),i.d(e,"b",function(){return r}),i.d(e,"c",function(){return o});i(374),i(354);class s{constructor(){this.allAttack=[],this.skill=null}}const n=Symbol("targetObject");class r{constructor(){this[n]=null,this.allDamage=[]}getTargetObject(){return this[n]}setTargetObject(t){this[n]=t}get objectid(){return this[n].$objectid}set objectid(t){if(Number.isSafeInteger(t)){let e=scene_map.lifeMgr.entities[t];this.setTargetObject(e)}}addDamage(t,e){this.allDamage.push(new o(t,e))}}class o{constructor(t,e){this.realDamage=t,this.critical=e}_validating(){return Number.isSafeInteger(this.realDamage)}_draw(t){const e=t.ctx;Number.isSafeInteger(this.realDamage)||(e.filter="gray-scale(1)",e.filter="none")}}},363:function(t,e,i){"use strict";var s=i(338),n=i(332),r=i(333),o=(i(335),i(351)),a=i(366);window.MobAnimationSpeed=1,window.$mob_name={};class l extends a.a{constructor(){super()}static get __info(){return{noFlip:1,level:230,maxHP:"??????",maxMP:1e5,speed:0,PADamage:22e3,PDRate:300,MADamage:24e3,MDRate:30,acc:9999,eva:750,pushed:1e9,fs:10,summonType:1,category:1,elemAttr:"P2H2F2I2S2L2D2",mobType:"3N",firstAttack:1,hideHP:1,boss:1,hpTagColor:1,hpTagBgcolor:5,showNotRemoteDam:1,defaultHP:"측정불가",defaultMP:"측정불가",ignoreMoveImpact:1}}static async loadDescription(t){if(!l._desc[t]){let e=[l._get_desc_base_path(),Number(t)].join("/"),i=await $get.data(e);return l._desc[t]=i,i}return l._desc[t]}async load(t){return await super.load.apply(this,arguments)}isFlyMob(){return!!this._raw.flySpeed}_getFirstAttackName(){return"skill"+this._raw.info.firstAttack}update(t){t*=window.MobAnimationSpeed,super.update(t)}static get _animations(){return['"stand"','"fly"','"move"','"jump"',"`hit${$index}`","`die${$index}`","`skill${$index}`"]}static _get_desc_base_path(){return"/String/Mob"}static get _base_path(){return"/Mob"}}l._desc={},window.NpcAnimationSpeed=1;class h extends a.a{constructor(){super()}static async loadDescription(t){if(!h._desc[t]){let e=[h._get_desc_base_path(),Number(t)].join("/"),i=await $get.data(e);return h._desc[t]=i,i}return h._desc[t]}update(t){t*=window.NpcAnimationSpeed,super.update(t)}static get _animations(){return['"stand"']}static _get_desc_base_path(){return"/String/Npc"}static get _base_path(){return"/Npc"}}function _(t,e){return t-e+Math.random()*e*2}function c(t,e){const i=r.ColorRGB.fromInt24(t),s=r.ColorRGB.fromInt24(e),n=Math.max(0,Math.min(_(i.r,s.r),255)),o=Math.max(0,Math.min(_(i.g,s.g),255)),a=Math.max(0,Math.min(_(i.b,s.b),255));return new r.ColorRGB(n,o,a)}h._desc={};class m{constructor(t){this._initParam(t),this.life=0,this.pos=new n.Vec2(0,0),this.opacity=1,this.scale=this.startScale,this.color=new r.ColorRGB(255,255,255)}_initParam(t){this.lifeMax=_(t.life,t.lifeVar);const e=_(t.angle,t.angleVar)*Math.PI/180;this.startColor=c(t.startColor,t.startColorVar),this.color_d=c(t.endColor,t.endColorVar).selfSub(this.startColor);const i=Math.max(1,t.texture.width),s=Math.max(1,t.texture.height),r=1==i?s:1==s?1:Math.min(i,s);this.startScale=_(t.startSize,t.startSizeVar)/r;const o=_(t.endSize,t.endSizeVar)/r;if(this.scale_d=o-this.startScale,this.startX=_(t.posX,t.posVarX),this.startY=_(t.posY,t.posVarY),this.emitterMode=t.emitterType?1:0,this.emitterMode)1==this.emitterMode&&alert("Particle.EMITTER_MODE.RADIUS");else{this.gravity=new n.Vec2(t.GRAVITY.x,t.GRAVITY.y);const i=_(t.GRAVITY.speed,t.GRAVITY.speedVar);this.dir=new n.Vec2(Math.cos(e)*i,-Math.sin(e)*i),this.radialAccel=_(t.GRAVITY.radialAccel||0,t.GRAVITY.radialAccelVar||0),this.tangentialAccel=_(t.GRAVITY.tangentialAccel||0,t.GRAVITY.tangentialAccelVar||0),this.rotationIsDir=!!t.GRAVITY.rotationIsDir}}update(t){const e=t/1e3,i=Math.max(0,Math.min(this.life/this.lifeMax,1));{let t,i=(t=this.pos.x||this.pos.y?new n.Vec2(this.pos.x,this.pos.y).normalize():new n.Vec2(0,0)).clone();t=t.mul(this.radialAccel);let s=i.x;i.x=-i.y,i.y=s,i=i.mul(this.tangentialAccel);let r=t.add(i);r=(r=r.add(this.gravity)).mul(e),this.dir=this.dir.add(r);let o=this.dir.mul(e);this.pos=this.pos.add(o)}this.scale=Math.max(0,this.startScale+this.scale_d*i),this.color=r.ColorRGB.add(this.startColor,r.ColorRGB.scale(this.color_d,i)),this.opacity=1-i,this.life+=t}isEnd(){return this.life>=this.lifeMax}draw(t,e,i,s){const n=this.scale,r=this.startX+this.pos.x+i,o=this.startY+this.pos.y+s;t.globalAlpha=this.opacity;let a=this.color.toHSV();t.drawColoredGraph2(e,r,o,n,n,a)}}class u{constructor(){this.GRAVITY=new n.Vec2,this.life=0,this.lifeVar=0,this.duration=0,this.totalParticle=0}}class d extends u{constructor(){super(),this.x=0,this.y=0,this.particles=[],this.time=0,this.delta=0,this.delay=1/0,this.duration=-1}clone(){let t=new d;return Object.assign(t,this),t.particles=[],t.time=0,t.delta=0,t}evaluate(){let t=this.totalParticle*this.delay;for(let e=0;e<this.totalParticle;++e){const i=new m(this),s=t-e*this.delay;i.life+=s,i.update(s),i.life=s,this.particles.push(i)}}async load(t){this.particleName=t;let e=await $get.data(this._particle_path);if(Object.assign(this,e),this.GRAVITY.x=e.GRAVITY.x,this.GRAVITY.y=e.GRAVITY.y,this.life=1e3*e.life,this.lifeVar=1e3*e.lifeVar,this.duration=1e3*e.duration,this.delay=this.life/this.totalParticle,_experimental_particle){const t=this;return new Promise(function(i,s){let n=new Image;n.onload=function(){let s=new o.a(e.texture);!0===_experimental_particle?s._url=function(t){let e=new r.ImageDataHelper,i=e.imageToImagedata(t);for(let t=0;t<i.height;++t)for(let e=0;e<4*i.width;++e)i.data[t*i.width*4+4*e+1]=0,i.data[t*i.width*4+4*e+2]=0;return e.imagedataToDataURL(i)}(this):s._url="data:image/svg+xml;utf-8,"+encodeURIComponent(`\n<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${this.naturalWidth}" height="${this.naturalHeight}">\n\t<defs>\n\t\t<mask id="Mask">\n\t\t\t<image xlink:href="${new URL("images"+t._texture_base_path,window.location).href}"/>\n\t\t</mask>\n\t</defs>\n\t<g>\n\t\t<rect width="${this.naturalWidth}" height="${this.naturalHeight}" fill="red" mask="url(#Mask)"/>\n\t</g>\n</svg>`),t.texture=s,i()},n.src="images"+t._texture_base_path})}this.texture=new o.a(e.texture),this.texture._url="images"+this._texture_base_path}update(t){this.particles.length<this.totalParticle&&(!this.time||this.time>this.delay)&&(this.particles.push(new m(this)),this.time=0);for(let e=0;e<this.particles.length;++e){const i=this.particles[e];i.isEnd()?this.particles.splice(e,1):i.update(t)}this.time+=t,this.delta+=t}isEnd(){return this.delta>this.duration&&-1!=this.duration}render(t,e,i,s){const n=t.ctx;t.ctx.setTransform(1,0,0,1,Math.trunc(-$gv.m_viewRect.x),Math.trunc(-$gv.m_viewRect.y)),6==this.blendFuncDst&&5==this.blendFuncSrc||(n.globalCompositeOperation="lighter");for(let n=0;n<this.particles.length;++n){const r=this.particles[n],o=this.x+i,a=this.y+s,l=this.texture.width*r.scale,h=this.texture.height*r.scale;e&&!e.collide4f2(o+r.startX+r.pos.x,a+r.startY+r.pos.y,l,h)||r.draw(t,this.texture,o,a)}n.globalCompositeOperation="source-over",t.globalAlpha=1}get _particle_path(){return["/Effect/particle",this.particleName].join("/")}get _texture_base_path(){return[this._particle_path,"texture"].join("/")}}var p=i(358),f=(i(368),i(377),i(354));i.d(e,"a",function(){return D}),i.d(e,"b",function(){return k}),i.d(e,"c",function(){return T}),window.enable_skeletal_anim=!0;const y={Back:{},Obj:{},Tile:{}};async function A(t,e){if(!y[t][e]){let i=`/Map/${t}/${e}`;y[t][e]=await $get.data(i),null==y[t][e]&&console.warn("Empty package: "+i)}if(y[t][e])return y[t][e]}window.$map_sprite=y,$gv.allQuest={};class g extends o.a{constructor(t,e,i){super(t,e),i=i||g.raw_default,this.a0=this._get(-1,"a0",Number),this.a1=this._get(-1,"a1",Number),this.movetype=this._get(i.movetype,"moveType",Number),this.movew=this._get(i.movew,"moveW",Number),this.moveh=this._get(i.moveh,"moveH",Number),this.movep=this._get(i.movep,"moveP",Number),this.mover=this._get(i.mover,"moveR",Number)}draw(t,e,i,s,n,r){let o=n/this.delay,a=0<=this.a0||0<=this.a1?(0>this.a0?0:this.a0)*(1-o)+(0>this.a1?0:this.a1)*o:255,l=0;switch(this.movetype){case 1:i+=this.movew*Math.sin(0==this.movep?r/1e3:2*r*Math.PI/this.movep);break;case 2:s+=this.moveh*Math.sin(0==this.movep?r/1e3:2*r*Math.PI/this.movep);break;case 3:0!=this.mover&&(l=r/this.mover)}t.ctx;t.loadIdentity(),t.translate(Math.trunc(.5-$gv.m_viewRect.x),Math.trunc(.5-$gv.m_viewRect.y)),t.globalAlpha=Math.max(0,Math.min(a/255,1)),t._drawRotaGraph(this,i,s,l,e)}}g.raw_default={a0:-1,a1:-1,movetype:0,movew:0,moveh:0,movep:0,mover:0};class x{constructor(t){null==t&&console.error(t),this._raw=t,this.textures=[],this.frame=0,this.time=0,this.delta=0,this.quest=t.quest;for(let e in t.quest)$gv.allQuest[e]||($gv.allQuest[e]=new Set),$gv.allQuest[e].add(t.quest[e]);this._load_object_info(),this._load_back_info(),this._load_tile_info(),this.aabb=null,this.display_aabb=!1,this.aabb_color=null}_load_object_info(){this.type=this._get(0,"sign",Number),this.x=this._get(0,"x",Number),this.y=this._get(0,"y",Number),this.z=this._get(0,"z",Number),this.zM=this._get(0,"zM",Number),this.f=this._get(0,"f",Number),this.name=this._raw.name,this._url=null}_load_back_info(){this.typeb=this._get(0,"type",Number),(this.typeb<0||this.typeb>7)&&(alert("MapBackBase.typeb: "+this.typeb),console.warn("MapBackBase.typeb: "+this.typeb)),this.a=this._get(0,"a",Number),this.rx=this._get(0,"rx",Number),this.ry=this._get(0,"ry",Number),this.cx=this._get(0,"cx",Number),this.cy=this._get(0,"cy",Number),this.backTags=this._raw.backTags}_load_tile_info(){this.flow=this._get(0,"flow",Number),1&this.flow&&!this.cx&&(this.cx=1e3),2&this.flow&&!this.cy&&(this.cy=1e3)}load(){let t=this._load_texture(0,null);this.textures[0]=t;for(let e=1;e in this._texture_raw;++e)this.textures[e]=this._load_texture(e,t);this.__calc_aabb()}_load_texture(){}unload(){this.textures=[]}__calc_aabb(){if(this.textures.length>=1){let t=0;for(let e=0;e<this.textures.length;++e){t|=this.textures[e].mover}const e=this.compute_max_rectangle();if(t){const t=Math.round(Math.sqrt(e.width**2+e.height**2)),i=Math.round(.5*t);this.aabb=new n.Rectangle(this.x-i,this.y-i,t,t)}else this.aabb=e}}_get(t,e,i){return e in this._raw?i?i(this._raw[e]):this._raw[e]:t}update(t){const e=this.textures.length;e>1&&(this.time=this.time+t,this.time>this.textures[this.frame].delay&&(this.frame=++this.frame,this.time=0,this.frame>=e&&(this.frame=0))),this.delta+=t,$gv.m_editor_mode&&this.aabb&&this.$editor_mouse()}_update_and_preload(t){const e=this.textures.length;if(e>1){const i=this.textures[this.frame];this.time=this.time+t,i.isLoaded()||i.__loadTexture(),this.time>i.delay&&(this.frame=++this.frame,this.time=0,this.frame>=e&&(this.frame=0,delete this.update));const s=this.textures[this.frame+1];s&&!s.isLoaded()&&s.__loadTexture()}this.delta+=t,$gv.m_editor_mode&&this.aabb&&this.$editor_mouse()}$editor_mouse(){$gv.m_viewRect;const t=$gv.m_viewRect.left+$gv.mouse_x,e=$gv.m_viewRect.top+$gv.mouse_y;0==this.typeb&&this.aabb.collide4f2(t,e,1,1)?(this.display_aabb=!0,1!=$gv.mouse_dl||window.m_selected_object==this&&null!=window.m_selected_object?null==window.m_hover_object?(window.m_hover_object=this,this.aabb_color="rgba(0,255,0,0.25)"):this.aabb_color="rgba(0,0,255,0.25)":this.$select()):this.$unselect(),window.m_selected_object==this&&(this.display_aabb=!0,this.aabb_color="rgba(255,0,0,0.5)")}$select(){window.m_selected_object&&window.m_selected_object.$unselect(),window.m_selected_object=this,window.m_hover_object=null,$gv.mouse_dl=0}$unselect(){this.display_aabb=!1}$isRepeatX(){return 1==this.typeb||4==this.typeb}$isRepeatY(){return 2==this.typeb||5==this.typeb}compute_rectangle(t){const e=this.textures[t];if(e){const t=e.width,i=e.height;return new n.Rectangle(this.x-(this.f?-e.x+t:e.x),this.y-e.y,t,i)}}compute_max_rectangle(){if(this.textures.length>0){let{left:t,top:e,right:i,bottom:s}=this.compute_rectangle(0);for(let n=1;n<this.textures.length;++n){let r=this.compute_rectangle(n);t=Math.min(t,r.left),e=Math.min(e,r.top),i=Math.max(i,r.right),s=Math.max(s,r.bottom)}return n.Rectangle.parse(t,e,i,s)}return null}__draw_texture(t,e,i,s,n){if(0!=this.typeb||!this.aabb||this.aabb.collide(n)){let n=this.textures[e];if(e&&!n.isLoaded())for(let t=e-1;t>=0&&!(n=this.textures[e]).isLoaded();--t);n.draw(t,this.f,this.x+i,this.y+s,this.time,this.delta)}if($gv.m_display_selected_object&&$gv.m_editor_mode&&this.aabb&&this.display_aabb){const e=t.ctx,i=Math.trunc(.5-n.left+this.aabb.left),s=Math.trunc(.5-n.top+this.aabb.top);t.loadIdentity(),t.globalAlpha=1,e.beginPath(),e.rect(i,s,this.aabb.width,this.aabb.height),e.fillStyle=this.aabb_color||"rgba(20,255,20,0.5)",e.fill(),e.lineWidth=3,e.setLineDash([3,3]),e.lineDashOffset=0,e.strokeStyle="rgba(0,0,0,0.5)",e.stroke(),e.setLineDash([3,3]),e.lineDashOffset=3,e.strokeStyle="rgba(255,255,255,0.5)",e.stroke(),e.setLineDash([]),e.lineWidth=1}}__draw(t,e,i,s){this.__draw_texture(t,this.frame,e,i,s)}_draw(t,e,i,s,n,r){let o=this.textures[this.frame];if(null==o)return;let{left:a,top:l,right:h,bottom:_}=r,c=this.x-(this.f?-o.x+o.width:o.x),m=this.y-o.y,u=0==this.cx?o.width:this.cx,d=0==this.cy?o.height:this.cy,p=a-(u+(a-s-c)%u),f=l-(d+(l-n-m)%d),y=h+(u-(h-s-c)%u),A=_+(d-(_-n-m)%d);if(e)if(i)for(let e=f;e<A;e+=d)for(let i=p;i<y;i+=u)this.__draw(t,i-c,e-m,r);else for(let e=p;e<y;e+=u)this.__draw(t,e-c,n,r);else if(i)for(let e=f;e<A;e+=d)this.__draw(t,s,e-m,r);else this.__draw(t,s,n,r)}draw(t,e,i){if(!this.textures.length)return;let s=(this.rx+100)*e.x/100,n=(this.ry+100)*e.y/100;switch(this.typeb){case 0:this._draw(t,!1,!1,s,n,i);break;case 1:this._draw(t,!0,!1,s,n,i);break;case 2:this._draw(t,!1,!0,s,n,i);break;case 3:this._draw(t,!0,!0,s,n,i);break;case 4:this._draw(t,!0,!1,Math.trunc(this.delta/200*this.rx),n,i);break;case 5:this._draw(t,!1,!0,s,Math.trunc(this.delta/200*this.ry),i);break;case 6:this._draw(t,!0,!0,Math.trunc(this.delta/200*this.rx),n,i);break;case 7:this._draw(t,!0,!0,s,Math.trunc(this.delta/200*this.ry),i)}}get _texture_base_path(){throw new Error("Not implement")}}class w extends x{constructor(t){super(t),null==this._raw.cx||this._raw.ry&&-100!=this._raw.ry||(this._raw.rx?//!= null && != 0
null!=this._raw.cy?this.typeb=6:this.typeb=4:this.typeb=1),null==this._raw.cy||this._raw.rx&&-100!=this._raw.rx||(this._raw.ry?//!= null && != 0
null!=this._raw.cx?this.typeb=7:this.typeb=5:this.typeb=2),this.update=this._update_and_preload}_load_texture(t,e){let i=["/Map","Obj",this._texture_base_path,t].join("/"),s=new g(this._texture_raw[t],void 0,e);return s._url=i,s}get _texture_base_path(){return[this._raw.oS,this._raw.l0,this._raw.l1,this._raw.l2].join("/")}get _texture_raw(){try{return y.Obj[this._raw.oS][this._raw.l0][this._raw.l1][this._raw.l2]}catch(t){}return null}}class b extends w{constructor(t){super(t),this.groups=[]}async load(t){let e=new d;await e.load(t);let i=Object.keys(this._raw).map(e=>{let i=parseInt(e,10);return Number.isSafeInteger(i)?i:(console.warn("MapParticle."+t+".id: "+e),null)}).filter(t=>null!=t);for(let t of i)this.groups[t]=e.clone(),this.groups[t].x=this._raw[t].x,this.groups[t].y=this._raw[t].y,this.groups[t].evaluate()}update(t){for(let e=0;e<this.groups.length;++e){this.groups[e].update(t)}}draw(t,e,i){for(let s=0;s<this.groups.length;++s){const n=this.groups[s];let r=(this.rx+100)*e.x/100,o=(this.ry+100)*e.y/100;n.render(t,i,r,o)}}static construct(t,e){let i=[],s=[];for(let e in t.particle){let n=t.particle[e],r=new b(n);i.push(r.load(e)),s.push(r)}return e.particleList=s,i}}class S extends w{constructor(t,e){super(t),this.ssanim=null,this._fname=null}get _folder(){const t=this._raw;return`/Map/Obj/${t.oS}/${t.l0}/${t.l1}/${t.l2}`}async load(){if(!SSAnim)return null;{const t=this._raw;let e;e=new SSAnim;try{await e.load(this._folder),e.update(0)}catch(t){return void console.error(t)}if(t.spineRandomStart){let t=e.anim_length*Math.random();e.setAnimTime(t)}const i=Math.round(Math.sqrt(e.width**2+e.height**2)),s=Math.round(.5*i);this.aabb=new n.Rectangle(this.x-s,this.y-s,i,i),this.ssanim=e}}unload(){this.ssanim&&(this.ssanim.unload(),this.ssanim=null)}update(t){this.delta+=t,this.ssanim&&window.enable_skeletal_anim&&this.ssanim.update(t)}draw(t,e,i){if($gv.m_display_skeletal_anim){const e=Math.trunc(.5-$gv.m_viewRect.x+this.x),i=Math.trunc(.5-$gv.m_viewRect.y+this.y);if(t.ctx.setTransform(1,0,0,-1,e,i),this.ssanim&&this.ssanim.render(),this.display_aabb){const e=t.ctx;t.ctx.setTransform(1,0,0,1,Math.trunc(.5-$gv.m_viewRect.x),Math.trunc(.5-$gv.m_viewRect.y)),e.beginPath(),e.rect(this.x-.5*this.ssanim.width,this.y-this.ssanim.height,this.ssanim.width,this.ssanim.height),e.fillStyle="rgba(20,255,20,0.5)",e.fill()}}}}class v extends w{constructor(t,e){super(t),this._info=e,this.update=this._update_and_preload}load(){let t=new g(this._texture_raw);this.textures[0]=t,this.textures[0]._url=["/Map","Tile",this._info.tS,this._raw.u,this._raw.no].join("/"),this.__calc_aabb()}get _texture_raw(){try{return y.Tile[this._info.tS][this._raw.u][this._raw.no]}catch(t){}return null}get _texture_base_path(){return[this._info.tS,this._raw.u,this._raw.no].join("/")}}class C extends w{constructor(t,e){super(t),this.mapRenderer=e,this.tm=null,this.tn=null,this.pn=null,this.script=null,this.enable=null,this.state=null,this.states=null,this.skin=null,this.update=this._update_and_preload}load(){this.tm=this._get("","tm",String).padStart(9,"0"),this.tn=this._get("","tn",String),this.pn=this._get("","pn",String),this.script=this._get(null,"script",String),this.enable=""!=this.tm&&"999999999"!=this.tm,this._loadTexture()}unload(){this.body&&(this.body.GetWorld().DestroyBody(this.body),this.body=null)}getMap(){if(this.enable)return this.tm}draw(t,e,i){this.enable?super.draw(t,e,i):this.__display_mode&&super.draw(t,e,i)}_loadTexture(){"game"==this.__display_mode?this.type="p":this.type="q";const t=C._portals_raw;this.textures.length=0;const e=C._type_map[this._raw.pt];if("editor"==this.__display_mode){let i=new g(t.editor[e]);i._url=[this._texture_base_path,this.__display_mode,e].join("/"),this.textures[0]=i}else if(t.game[e]){let i=null!=this.skin?this.skin:"default";if("0"in t.game[e][i]){let s=t.game[e][i];for(let t in s){let n=new g(s[t]);n._url=[this._texture_base_path,this.__display_mode,e,i,t].join("/"),this.textures.push(n)}}else{this.states=Object.keys(t.game[e][i]),this.state=this.states[1%this.states.length];let s=t.game[e][i][this.state];for(let t in s){let n=new g(s[t]);n._url=[this._texture_base_path,this.__display_mode,e,i,this.state,t].join("/"),this.textures.push(n)}}}this.delta=0,this.time=0,this.frame=0}get _texture_base_path(){return"/Map/MapHelper/portal"}get _getTexturePath(){return this.__display_mode,["/Map/MapHelper/portal",this.__display_mode].join("/")}get __display_mode(){return $gv.m_editor_mode?"editor":"game"}static async Init(){C._portals_raw=await $get.data("/Map/MapHelper/portal"),C._type_map=Object.keys(C._portals_raw.editor)}}C._portals_raw={},C._type_map={},C._script={};class B{constructor(){this.portals=null,this.__display_mode=this.__display_mode}async load(t,e){let i=[];for(let s=0;s in t.portal;++s){let n=t.portal[s],r=new C(n,e);r.load(),e.controller.createPortal(r),i.push(r)}this.portals=i}unload(){for(let t=0;t<this.portals.length;++t){this.portals[t].unload()}}update(t){if(this.__display_mode!=$gv.m_editor_mode){this.__display_mode=$gv.m_editor_mode;for(let e=0;e<this.portals.length;++e){let i=this.portals[e];i._loadTexture(),i.update(t)}}else for(let e=0;e<this.portals.length;++e){this.portals[e].update(t)}}draw(t,e,i){for(let s=0;s<this.portals.length;++s){this.portals[s].draw(t,e,i)}}}class V extends x{constructor(t){super(t)}}class M extends V{constructor(t){super(t),this.update=this._update_and_preload}load(){let t=["/Map","Back",this._texture_base_path].join("/");if(this._raw.bS){this._texture_raw&&(this.textures[0]=new g(this._texture_raw),this.textures[0]._url=t)}else console.warn("MapBack path ?: "+t)}get _texture_base_path(){return[this._raw.bS,"back",this._raw.no].join("/")}get _texture_raw(){return this._raw.bS&&this._raw.no?y.Back[this._raw.bS].back[this._raw.no]:null}}class P extends V{constructor(t){super(t),this.update=this._update_and_preload}_load_texture(t,e){let i=["/Map","Back",this._texture_base_path,t].join("/"),s=new g(this._texture_raw[t]);return s._url=i,s}get _texture_base_path(){return[this._raw.bS,"ani",this._raw.no].join("/")}get _texture_raw(){try{return y.Back[this._raw.bS].ani[this._raw.no]}catch(t){}return null}}class I extends V{constructor(t){super(t),this.ssanim=null}get _folder(){const t=this._raw;return`/Map/Back/${t.bS}/spine/${t.no}`}async load(){if(!SSAnim)return null;{let t=new SSAnim;try{await t.load(this._folder),t.update(0)}catch(t){return void console.error(t)}this.ssanim=t}}unload(){this.ssanim&&(this.ssanim.unload(),this.ssanim=null)}update(t){this.ssanim&&window.enable_skeletal_anim&&this.ssanim.update(t)}draw(t,e,i){if($gv.m_display_skeletal_anim&&this.ssanim){const e=Math.trunc(.5-$gv.m_viewRect.x+this.x),i=Math.trunc(.5-$gv.m_viewRect.y+this.y);t.ctx.setTransform(1,0,0,-1,e,i),this.ssanim.render()}}}class D{constructor(t,e){Object.assign(this,t),this.spawnId=e,this.time=0,this.count=0,t instanceof D||(this.fh=t.fh-1)}increaseLife(){++this.count,this.time=0}decreaseLife(){--this.count,this.time=0}getTimeElapsedAfterLifeSpawn(){return this.time}getNowCountOfLifeWasSpawn(){return this.count}clone(){return new this.constructor(this)}}class k extends f.a{constructor(t,e){super();this.renderer=null,this.is_dead=!1,this.spawn=t,this.x=t.x,this.y=t.cy,this.z=5,this.angle=0,this.front=Number(t.f)?1:-1,this.opacity=Number(t.hide)?.5:1,this.lifeId=e}static Create(t,e,i){let s;if("m"==t.type)s=new G(t,i);else{if("n"!=t.type)return void alert("map life type: "+t.type);s=new R(t,i)}return s&&s.load(t.id,e),s}static async loadLifeDesc(t){let e,i=t.id;switch(t.type){case"m":e=l.loadDescription(i);break;case"n":e=h.loadDescription(i);break;default:return void alert("map life type: "+t.type)}return e}async load(t,e){this.renderer?await this.renderer.load(t):alert("Unknow type of life in map")}_destroy(t){throw new Error("Not implement")}die(t){throw new Error("Not implement")}update(t){this.renderer.update(t)}draw(t){t.globalAlpha=Math.max(0,Math.min(this.opacity,1)),this.renderer.draw(t,this.x,this.y,this.angle,this.front<0)}}class G extends k{constructor(t,e){super(t,e),this.renderer=new l,this.$physics=null,this.skills={},this.hp=1e5}async load(t,e){await super.load(t),this.$physics=e.createMob(this),this.$physics._loadAction(this.renderer.actions),await this._load_skill_by_mob_id(t);try{this._load_skill_info();const t=this.renderer._raw.info.attack[this.renderer._raw.info.firstAttack].info;if(this.skill_map[t]){const e=this.skill_map[t].skill_list[0];this.invokeSkill(e.skill,e.level)}}catch(t){}}damage(t,e){this.is_dead||(this.hp-=e,console.log(`Mob(${this.$objectid}) 被 ${t.$objectid} 攻擊，減少 ${e} HP，剩下 ${this.hp}`),this.hp<=0&&this.die())}knockback(t,e,i){}_applyState(t){t.jump?this.renderer.action="jump":t.walk?this.renderer.action="move":this.renderer.action="stand"}update(t){this.$physics&&(this.is_dead?this.$physics.stop():this._applyState(this.$physics.state)),this.renderer.update(t)}draw(t){$gv.m_display_mob&&super.draw(t)}_load_skill_info(){const t=this.renderer._raw;let e=t.info.attack;t.info.skill;e[1].info,t.info.skill[0].info,e[1].info,t.skill1.info;var i={};for(let e,s=1;(e="skill"+s)in t;++s){let s=t[e];s.info&&(i[s.info]={anim:e,skill_list:[]})}var s={};for(let e in t.info.skill){let n=t.info.skill[e];s[n.skill+"."+n.level]=n,i[n.info]&&(s[n.skill+"."+n.level].$anim=i[n.info].anim,i[n.info].skill_list.push(n))}this.skill_map=i,this.skill_info=s}_load_skill_by_mob_id(t){let e=[];switch(t){case"8880140":case"8880141":{const t=i(409).FlowerTrap,e=i(394).FairyDust;this.skills={1:new t,2:new t,3:new t,4:new e(null,null),5:{load(){},invoke:function(t){console.info("invoke LaserRain")}},6:{load(){},invoke:function(t){console.info("invoke ForcedTelepor")}},7:{load(){},invoke:function(t){console.info("invoke Dragon")}},8:{load(){},invoke:function(t){console.info("invoke Rush")}},9:{load(){},invoke:function(t){console.info("invoke WelcomeBarrage")}},10:new e(null,null)},this.skill_map_action=[];for(let t=1;t<=10;++t)switch(t){case 1:case 2:case 3:break;case 4:case 10:this.skill_map_action[t]="skill1";break;case 5:break;case 6:this.skill_map_action[t]="skill4";break;case 7:this.skill_map_action[t]="skill2"}}}for(let t in this.skills){const i=this.skills[t];e.push(i.load(t))}return Promise.all(e)}invokeSkill(t,e){const i=this.skills[e];if(i){const t=this.skill_map_action[e];t&&(this.renderer.action=t),i.invoke(e)}else console.warn({"unknow skill":t,level:e})}_destroy(t){let e=this.spawn;e instanceof D&&e.decreaseLife(),t.destroyMob(this),this.renderer=null}die(t=1){this.renderer.action="die"+t,this.is_dead=!0}}class R extends k{constructor(t,e){super(t,e),this.renderer=new h}draw(t){$gv.m_display_npc&&super.draw(t)}_destroy(t){this.spawn.decreaseLife(),t.destroyNpc(this),this.renderer=null}die(t){this.is_dead=!0}}let L=1;class ${constructor(t){this._raw=null,this.spawnPoints=[],this.entities=[],this.mapController=t}load(t){let e=[];this._raw=t.life;let i=Object.keys(this._raw).map(t=>{let e=parseInt(t,10);return Number.isSafeInteger(e)?e:(console.warn("MapLife.spawnId: "+t),null)}).filter(t=>null!=t);for(let t of i){let i=new D(this._raw[t],t);e.push(k.loadLifeDesc(i)),this.spawnPoints.push(i)}return Promise.all(e)}unload(){for(let t=0;t<this.entities.length;++t){const e=this.entities[t];"m"==e.spawn.type&&e.$physics._destroy(this.mapController)}this.spawnPoints=[],this.entities=[]}update(t){for(let e=0;e<this.spawnPoints.length;++e){let i=this.spawnPoints[e];i.time+=t,i.time>=1e3&&i.count<L&&(i.increaseLife(),this.spawn(i))}for(let e=0;e<this.entities.length;++e){let i=this.entities[e];if(i){if(i.renderer.action&&i.renderer.action.startsWith("die")){const t=i.renderer.actions[i.renderer.action];if(t&&t.isEnd()){this.destroyLife(i);continue}}i.update(t)}}}spawn(t){let e=0;for(;e<this.entities.length&&this.entities[e];++e);let i=k.Create(t,this.mapController,e);e<this.entities.length?this.entities[e]=i:this.entities.push(i)}spawnNpc(t,e,i,s=!1,n=0){let r=new D({type:"n",x:0|e,y:0|i,cy:0|i,id:t,fh:n,is_dummy:!0});this.spawn(r)}spawnMob(t,e,i,s=!1,n=0){let r=new D({type:"m",x:0|e,y:0|i,cy:0|i,id:t,fh:n,is_dummy:!0});this.spawn(r)}destroyLife(t){t instanceof k||(alert("MapLifeManager.killLife: can't kill non life"),console.error("MapLifeManager.killLife: can't kill non life")),t._destroy(this.mapController),delete this.entities[t.lifeId]}destroyAll(){this.entities.forEach(t=>this.destroyLife(t))}draw(t,e,i,s){for(let e=0;e<this.entities.length;++e){let i=this.entities[e];i&&(null!=i.z&&i.z==s||null==s)&&i.draw(t)}}}class T{constructor(){this.stamp=0,this.background=[],this.frontground=[],this.layeredObject=[],this.layeredTile=[],this.backTags={},this.namedObject={},this.controller=new p.a,this.lifeMgr=new $(this.controller),this.portalMgr=new B,this.particleList=null,this.mapBound=null,this.quest={},this._url=null,this.$load_tasks=[],this.$promise=null,this.$loading_status="loading",this.onload=null}static async _Init(){let t=null,e={};t=await $get.data("/String/Map");for(let i in t)for(let s in t[i])e[s]=t[i][s],e[s].$region=i;T._map_names=e,window.$MapNames=T._map_names}static Init(){return Promise.all([this._Init(),C.Init()])}isActivated(t){if(t)for(let e in t)if(this.quest[e]!=t[e])return!1;return!0}get $map_sprite(){return window.$map_sprite}async _constructBack(t){if(!("back"in t))return;let e=new Map;for(let i=0;i in t.back;++i){let s=t.back[i];const n=this._url+`back/${i}`;let r;if(0==s.ani)r=new M(s);else if(1==s.ani)r=new P(s);else{if(2!=s.ani)throw new Error("ob.ani: "+s.ani);r=new I(s)}if(r._url=n,null!=r.backTags&&(this.backTags[r.backTags]=r),2!=s.ani)if(r._raw.bS){let t="Back/"+r._raw.bS;e.has(t)||e.set(t,A("Back",r._raw.bS))}else console.warn("MapBack: map.back["+i+"].bS = "+r._raw.bS);0!=s.front?this.frontground.push(r):this.background.push(r)}await Promise.all([...e.values()]);for(let t=0;t<this.frontground.length;++t){this.frontground[t].load()}for(let t=0;t<this.background.length;++t){this.background[t].load()}}async _constructLayeredObject(t){let e=new Map;for(let i=0,s=t[i];!F(s);s=t[++i]){let t=this.__constructLayeredObject_obj(i,s,e),n=this.__constructLayeredObject_tile(i,s,e);n.sort((t,e)=>t.z-e.z),t.sort((t,e)=>t.z-e.z),this.layeredObject[i]=t,this.layeredTile[i]=n}await Promise.all([...e.values()]);for(let t=0;t<this.layeredObject.length;++t){const e=this.layeredObject[t];for(let t=0;t<e.length;++t){e[t].load()}}for(let t=0;t<this.layeredTile.length;++t){const e=this.layeredTile[t];for(let t=0;t<e.length;++t){e[t].load()}}}__constructLayeredObject_tile(t,e,i){const s=e.info;let n=[];if(s.tS){let t="Tile/"+s.tS;i.has(t)||i.set(t,A("Tile",s.tS))}else Object.keys(e.tile).length&&console.warn("["+t+"].tile = "+JSON.stringify(e.tile));for(let i=0,r=e.tile[i];!F(r);i++,r=e.tile[i]){let e=new v(r,s);e._url=this._url+`${t}/tile/${i}`,n.push(e)}return n}__constructLayeredObject_obj(t,e,i){let s=[];for(let n=0,r=e.obj[n];!F(r);n++,r=e.obj[n]){let e;if(r.spineAni){switch(r.spineAni){case"animation":break;case"idle":console.warn("spine animation: idle ??");break;default:console.groupCollapsed("unknow spine:"+r.spineAni),console.warn(`LayeredObject[${t}][${n}]`),console.warn(r),console.groupEnd()}e=new S(r)}else{let t="Obj/"+(e=new w(r))._raw.oS;i.has(t)||i.set(t,A("Obj",e._raw.oS))}e._url=this._url+`${t}/obj/${n}`,null!=e.name&&(this.namedObject[e.name]=e),s.push(e)}return s}__compute_top_bottom_border(t){let e=null,i=null;for(let s=0;s<t.length;++s){const n=t[s];for(let t=0;t<n.length;++t){let s=n[t].compute_max_rectangle();s&&null!=e&&null!=i?(e=Math.min(e,s.top),i=Math.max(i,s.bottom)):(e=s.top,i=s.bottom)}}return{top:e,bottom:i}}_compute_top_bottom_border(){let t=this.__compute_top_bottom_border(this.layeredObject),e=this.__compute_top_bottom_border(this.layeredTile);return{top:Math.min(t.top,e.top),bottom:Math.max(t.bottom,e.bottom)}}_compute_map_bound(t){if(this.mapBound&&!t)return this.mapBound;const e=this._raw.info;let i,s;if(null!=e.VRLeft&&null!=e.VRTop&&null!=e.VRRight&&null!=e.VRBottom)i=e.VRTop,s=e.VRBottom;else{let t=this._compute_top_bottom_border();i=t.top,s=t.bottom}const r=this.controller.ground._compute_left_right_border();let o=n.Rectangle.parse(r.left,i,r.right,s);return this.mapBound=o,o}get _window_title(){return this.mapName?`${[this.mapName,this.streetName].join("·")} (${this.map_id})`:`${this.map_id}`}_get_map_data_url(t){return`/Map/Map/Map${t.slice(0,1)}/${t}`}async load(t,e){if(!e&&null!=t&&this.map_id==t&&null!=this._raw)return this.isLoaded()&&this.unload(),void this._load(this._raw);const i=this._get_map_data_url(t);let s=await $get.data(i);if(s){if(s.info&&s.info.link){const t=this._get_map_data_url(s.info.link);if(!(s=await $get.data(t)))return void alert("map-link not exit")}this.isLoaded()&&this.unload(),this._url=i,this.map_id=t,this._load(s)}else alert("map not exit")}_load(t){const e=this.map_id;this.$loading_status="loading",$gv.allQuest={},this.controller.stop=!0,T._map_names[e]&&(this.mapName=T._map_names[e].mapName,this.streetName=T._map_names[e].streetName),this.$load_tasks=[],this._loadBgm(t),this.$load_tasks.push(this._constructBack(t,this)),this.$load_tasks.push(this._constructLayeredObject(t,this).then(t=>{})),this.$load_tasks.push(this.portalMgr.load(t,this).then(t=>{})),this.$load_tasks.push(this.__constructMiniMap(t,this)),this.$load_tasks.push(this.controller.load(t,this)),this.$load_tasks.push(this.lifeMgr.load(t,this)),this.$load_tasks.push(b.construct(t,this)),this.$promise=Promise.all(this.$load_tasks),this.$promise.then(t=>{const e=this._compute_map_bound(),i=e.center;$gv.m_viewRect.setCenter(i.x,i.y),this.controller._createMapBound(e),this.controller.stop=!1,this.$load_tasks=[],this.$promise=null,delete this.$loading_status,console.log("completed scene_map.waitLoaded: [...]")}),this._raw=t,this._script(),this.onload&&this.onload.call(this),console.log("End scene_map.load")}_script(){switch(this.map_id){case"450004150":case"450004450":case"450004750":this.lifeMgr.spawnMob("8880166",1e3,47,!1,0),this.lifeMgr.spawnMob("8880140",1e3,47,!1,0)}}reload(){this.unload(),this._load(this._raw)}unload(){this.$loading_status="loading";for(let t=0;t<this.background.length;++t)this.background[t].unload();this.background=[];for(let t=0;t<this.frontground.length;++t)this.frontground[t].unload();this.frontground=[];for(let t=0;t<this.layeredObject.length;++t){let e=this.layeredObject[t];for(let t=0;t<e.length;++t)e[t].unload()}this.layeredObject=[];for(let t=0;t<this.layeredTile.length;++t){let e=this.layeredTile[t];for(let t=0;t<e.length;++t)e[t].unload()}this.layeredTile=[],this.backTags={},this.particleList=null,this.controller.unload(),this.lifeMgr.unload(),this.portalMgr.unload(),y.Back={},y.Obj={},y.Tile={}}_getBgmPath(t){let e=t.info.bgm,i=e.indexOf("/");return["","Sound",e.slice(0,i)+e.slice(i)].join("/")}_loadBgm(t){const e=document.getElementById("bgm");if(e){const i=this._getBgmPath(t);this._bgm_path=i;const s=$get.soundMp3Url(i);e.innerHTML=`<source src="${s}" type="audio/mpeg">`,e.autoplay=!0}else console.error(new TypeError("#bgm"))}playBgm(){document.getElementById("bgm").play()}pauseBgm(){document.getElementById("bgm").pause()}__constructMiniMap(t){t.miniMap?(this.width=t.miniMap.width,this.height=t.miniMap.height,this.centerX=t.miniMap.centerX,this.centerY=t.miniMap.centerY):(this.width=0,this.height=0,this.centerX=0,this.centerY=0)}_miniMap_src(){return this._url+"miniMap/canvas"}async waitLoaded(){await this.$promise}isLoaded(){return(!this.$load_tasks||!this.$load_tasks.length)&&this._raw&&!this.$loading_status}update(t){window.m_hover_object=null,($gv.mouse_dm||$gv.mouse_dr)&&(window.m_selected_object=null),null!=t&&(this.stamp=t,this.lifeMgr.update(t),this.isLoaded()&&this.controller.update(t))}_addChara(t){try{let e=this.portalMgr.portals.filter(t=>"sp"==t.pn),i=e[Math.trunc(100*Math.random())%e.length];const s=t.$physics,n=i.x/$gv.CANVAS_SCALE,r=i.y/$gv.CANVAS_SCALE;s.setPosition(n,r),s.body.SetAwake(!0)}catch(t){console.error(t)}}addChara(t){this.$promise?this.$promise.then(()=>{this._addChara(t)}):this._addChara(t)}applyCamera(t){t.ctx.setTransform(1,0,0,1,Math.trunc(-$gv.m_viewRect.x),Math.trunc(-$gv.m_viewRect.y))}beginRender(t){t.pushGlobalAlpha()}endRender(t){t.popGlobalAlpha()}renderLife(t,e){if(!$gv.m_display_life)return;const i=n.Vec2.empty,s=$gv.m_viewRect;this.lifeMgr.draw(t,i,s,e)}renderPortal(t){if(!$gv.m_display_portal)return;const e=n.Vec2.empty,i=$gv.m_viewRect;this.portalMgr.update(this.stamp),this.portalMgr.draw(t,e,i)}renderFrontground(t){if(!$gv.m_display_front)return;const e=$gv.m_viewRect.center,i=$gv.m_viewRect;for(let s=0;s<this.frontground.length;++s){let n=this.frontground[s];this.isActivated(n.quest)&&(n.update(this.stamp),n.draw(t,e,i))}}renderLayeredObject(t,e){if(!$gv.m_display_mapobj)return;const i=n.Vec2.empty,s=$gv.m_viewRect,r=this.layeredObject[e];for(let e=0;e<r.length;++e){let n=r[e];this.isActivated(n.quest)&&(n.update(this.stamp),n.draw(t,i,s))}}renderLayeredTile(t,e){if(!$gv.m_display_maptile)return;const i=n.Vec2.empty,s=$gv.m_viewRect,r=this.layeredTile[e];for(let e=0;e<r.length;++e){let n=r[e];this.isActivated(n.quest)&&(n.update(this.stamp),n.draw(t,i,s))}}renderBackground(t){if(!$gv.m_display_back)return;const e=$gv.m_viewRect.center,i=$gv.m_viewRect;for(let s=0;s<this.background.length;++s){let n=this.background[s];this.isActivated(n.quest)&&(n.update(this.stamp),n.draw(t,e,i))}}renderParticle(t){if(!$gv.m_display_particle_system)return;const e=$gv.m_viewRect.center,i=$gv.m_viewRect;for(let s=0;s<this.particleList.length;++s){let n=this.particleList[s];this.isActivated(n.quest)&&(n.update(this.stamp),n.draw(t,e,i))}}}function F(t){if("object"==typeof t&&null==t)throw new Error;return void 0===t||null==t}Object(s.AddInitTask)(T.Init())},364:function(t,e,i){"use strict";var s=i(353),n=(i(333),i(354)),r=i(337),o=i(340),a=(i(352),i(370)),l=i(374),h=i(371),_=(i(365),i(395)),c=i(362),m=i(379);class u{constructor(t,e){this.type=t,this.data=e}}class d extends m.a{constructor(t){super(),this.action=t}}class p extends m.a{constructor(t){super(),this.skill_id=t}}i(363);var f=i(396);i.d(e,"a",function(){return g}),i.d(e,"b",function(){return x}),i.d(e,"c",function(){return w});window.$addItem_repeatEquip=!1;class y{constructor(){this.style=0,this.text="",this.$outputText=null,this.elapsed=0,this._isDisplay=!1}enter(t){this.text=String(t),this.$outputText=null,this.isDisplay=!0}update(t){const e=this.displayDuration;this.elapsed>e?this.isDisplay=!1:this.elapsed+=t}async draw(t,e){if(this._isDisplay){const i=this.style||$gv.ChatBalloon_default_style;let s=o.ChatBalloon.cache[i];s||(s=new o.ChatBalloon,await s.load(i));const n=this.colon,r=e.renderer,a=r._boundBox;this.$outputText||(this.$outputText=e.id+n+this.text),s.draw(t,this.$outputText,r.x,r.y-a.height)}}get isDisplay(){return this._isDisplay}set isDisplay(t){this._isDisplay=!!t,this.elapsed=0}get colon(){return" : "}get $maxLength(){return 70}get displayDuration(){return $gv.ChatBalloon_display_duration}}const A=[{ArrowUp:new u("Action",new d("up")),ArrowLeft:new u("Action",new d("left")),ArrowDown:new u("Action",new d("down")),ArrowRight:new u("Action",new d("right")),z:new u("Skill",new p("23001002")),x:new u("Skill",new p("1001005")),c:new u("Skill",new p("64120000")),v:new u("Skill",new p("23121000"))},{w:new u("Action",new d("up")),a:new u("Action",new d("left")),s:new u("Action",new d("down")),d:new u("Action",new d("right")),q:new u("Action",new d("jump")),f:new u("Skill",new p("23001002")),x:new u("Skill",new p("1001005")),c:new u("Skill",new p("64120000")),v:new u("Skill",new p("23121000"))}];class g extends n.a{constructor(){super(),this.renderer=null,this.$layer=5,this.name=null,this.stat=new h.CharacterStat,this.activeSkills=new Map,this.chatCtrl=new y,this.$inPacket={},this.$inPacket.move=null,this.$outPacket={},this.$outPacket.move=null}get id(){return this.name}set id(t){this.name=t}get $objectid(){return this.name}set $objectid(t){this.name=t}damage(t,e){console.log("Player("+this.$objectid+") 被 "+t.$objectid+" 攻擊，減少 "+e+" HP")}knockback(t,e,i){this.$physics.knockback(e,i,1e3)}$move(t){let e=t||this.$inPacket.move;this.$inPacket.move=e}_remote_control(){let t=this.$inPacket.move;if(t&&t.path&&t.path.length){const e=this.renderer;let i=t.path.shift();i.isAwake&&(this.$physics.moveTo(i),this.$physics.state=i.pState,e.front=i.pState.front),i.action&&(e.action=i.action),i.emotion&&(e.emotion=i.emotion)}}$moveItem(t,e,i){}invokeSkill(t){let e=new l.b;return e.load(t,this),this.activeSkills.set(t,e),e}update(t){const e=this.renderer;if(this.chatCtrl.update(t),this.activeSkills.forEach(e=>{e&&(e.isEnd()?this.activeSkills.delete(e.skillId):e.update(t,this),this._handleAttack(),e.attackInfo.allAttack.length=0)}),this._player_control(),$gv.m_editor_mode?e.speed>0&&this.$physics&&this.enablePhysics&&this._applyState({front:this.$physics.state.front}):this.$physics&&this._applyState(this.$physics.state),this.$physics&&e&&this.enablePhysics){const t=this.$physics.getPosition(),i=Math.trunc(t.x*$gv.CANVAS_SCALE+.5),s=Math.trunc(t.y*$gv.CANVAS_SCALE+.5);e.x=i,e.y=s,this.$physics.body.GetAngle()||this.$physics.body.GetAngularVelocity()?e.angle=this.$physics.body.GetAngle():e.angle=0,this.$layer=this.$physics.getLayer()}e.update(t)}_$drawName(t){const e=this.id;this.__drawName(t,e)}_$drawChatBalloon(t){this.chatCtrl.draw(t,this)}_player_control(){}_applyState(t){const e=this.renderer,i=this.$physics.state;if(!i.invokeSkill){const{front:s,jump:n,walk:r,prone:o,fly:a,ladder:l}=t,h=chara.enablePhysics;null!=s&&(e.front=s),l?h&&this.$physics.ladder&&(this.$physics.ladder.isLadder()?e.action="ladder":e.action="rope",i.ladder_move_dir?chara.renderer.actani.isEnd()&&(chara.renderer.actani.reset(),e.actani.loop=!1):e.actani._is_end=!0):n?(e.action="jump",e.actani.loop=!1):r?(e.action="walk1",e.actani.loop=!0):o?(e.action="prone",e.actani.loop=!1):a?(e.action="fly",e.actani.loop=!0):(e.action="stand1",e.actani.loop=!0);for(let t=0;t<=9;++t)if($gv.input_keyDown[t]){let i=["blink","hit","smile","troubled","cry","angry","bewildered","stunned","vomit","oops"],s=i[t%i.length];e.emotion=s}}}_handleAttack(){if(window.$io)throw new Error("未完成");this.activeSkills.forEach(t=>{const e=t.attackInfo;for(let t=0;t<e.allAttack.length;++t){const i=e.allAttack[t],s=i.getTargetObject();for(let t=0;t<i.allDamage.length;++t){let e,n=this.stat.getCurrentMaxBaseDamage()-this.stat.getCurrentMinBaseDamage(),r=this.stat.getCurrentMinBaseDamage()+Math.random()*n,o=i.allDamage[t]=new c.c;Math.trunc(100*Math.random())<this.stat.critRate&&(r*=1+this.stat.critDamage/100,o.critical=!0),r=Math.trunc(r),o.realDamage=r,s.damage(this,r),e=o.critical?"NoCri":"NoRed",f.a.addDamagePair(this.m_damageSkin||"default",e,o,s.x+(i.allDamage.length>1?25-25*(1-t&1):0),s.y,100*t)}s.knockback(this,16,16)}})}}class x extends g{constructor(t){super(),this.renderer=new r.CharacterRenderer,this.$physics=t.controller.$createPlayer(this,this.renderer),this.$layer=5,this.id=null,this.items=new Array(5);for(let t=0;t<5;++t){this.items[t]=new Array(128);for(let e=0;e<128;++e)this.items[t][e]=new a.b(e,null,null,0)}this.stat.onJobChange(this._onJobChange.bind(this))}_onJobChange(){const t=this.stat.job;console.log("Player("+this.$objectid+") change job: "+t)}_applyState(t){super._applyState(t),this.$recMove()}_player_control(){if(!this.$physics)return;const t=A[$gv.m_editor_mode?1:0];let e={},i=0==this.activeSkills.size;for(let i in t){const s=t[i];if(!s)continue;const n=$gv.input_keyDown[i];$gv.input_keyUp[i];switch(s.type){case"Command":break;case"Action":if(n){e[s.data.action]=n}break;case"Item":if(n){const t=s.data;this.useItem(t.data.id)}}}for(let s in t){const n=t[s];if(!n)continue;const r=$gv.input_keyDown[s],o=$gv.input_keyUp[s];if("Skill"==n.type){const t=n.data,s=t.skill_id;let a=this.activeSkills.get(s);r&&i&&(a=this.invokeSkill(t.skill_id)),a&&a.control(e,r,o)}}this.$physics.control(e)}addItem(t,e){if(window.$io)throw new Error("未完成");{let i={incDEXr:Math.trunc(3*Math.random()),timeLimited:Date()};Object(a.a)(t,i).then(t=>{this._addItem(t,e)})}}_addItem(t,e){let i,s=t.id;switch(s[0]){case"0":i=0;break;default:return console.info(`~give ${this.id}: ${s} * ${e}`),!1}for(let n=0;n<this.items[i].length;++n)if(this.items[i][n].isEmpty()){if(window.$addItem_repeatEquip)return this.items[i][n].assign(n,123,t,i?e:1),console.info(`give ${this.id}: ${s} * ${e}`),!0;if(0!=i)return this.items[i][n].assign(n,123,t,e),console.info(`give ${this.id}: ${s} * ${e}`),!0;if(this.items[i][n].assign(n,123,t,1),0==--e)return console.info(`repeat give ${this.id}: ${s}`),!0}return!1}async removeItem(t,e){if(window.$io)throw new Error("未完成");return this._removeItem(t,e)}_removeItem(t,e){this.items[t][e]._clear()}moveItemToSlot(t,e){}findItem(t){for(let e=0;e<this.items.length;++e)for(let i=0;i<this.items[e].length;++i){let n=this.items[e][i];if(n&&n.data&&n.data.id==t)return{typeName:s.c.typeName[e],itemSlot:n}}return{typeName:null,itemSlot:null}}useItem(t){if(window.$io)window.$io.emit("useItem",{itemId:t});else{function e(){this.renderer.use(t)}this.findItem(t).itemSlot?($gv.m_editor_mode?console.log(`使用道具：${t}。`):(console.log(`消耗道具：${t}。未完成`),this._consume(t,1)),e.call(this)):$gv.m_editor_mode?(this.addItem(t,1),e.call(this)):console.log("無法使用不存在的道具。")}}async say(t){if(window.$io){let e=await window.$io.emit("chat",{$style:this.chatCtrl.style,text:t});return e&&this.chatCtrl.enter(t),e}return this.chatCtrl.enter(t),!0}$emit(t){if(this.$outPacket.move)t.emit("charaMove",this.$outPacket.move),this.$outPacket.move=null;else{let e=new _.$Packet_CharacterMove;e.capture(this),t.emit("charaMove",e)}this.$outPacket.move=null}$recMove(){let t=this.$outPacket.move||new _.$Packet_CharacterMove;t.capture(this),this.$outPacket.move=t}}class w extends g{constructor(t){super(),this.renderer=new r.CharacterRenderer,this.$physics=t.controller.$createPlayer(this,this.renderer)}get $remote(){return!0}_player_control(){this._remote_control()}}},365:function(t,e,i){"use strict";i.d(e,"a",function(){return n});i(352);class s{constructor(){this.x=null,this.y=null,this.vx=void 0,this.vy=void 0,this.fx=void 0,this.fy=void 0,this.pState=null,this.elapsed=0,this.isAwake=void 0,this.action=void 0,this.action_frame=void 0,this.emotion=void 0,this.emotion_frame=void 0}}class n extends s{}},366:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",function(){return LifeRenderer});var _Sprite_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(351),_Animation_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(334);class LifeRenderer{constructor(){this._url="",this.id=null,this.actions={},this._action="stand",this._raw=null}get name(){return this.constructor._desc[this.id].name}getDefaultAction(){return this.actions.stand?"stand":this.actions.fly?"fly":(alert(this.constructor.name+" ("+this.id+") default must is 'stand' or 'fly'"),new Error(this.constructor.name+" ("+this.id+") default must is 'stand' or 'fly'"))}get action(){return this._action}set action(t){this._action!=t&&(this._action=t,this.actions[t]&&this.actions[t].reset())}async load(t){let e=[],i=this;if(this.id=t,this._url=[this.constructor._base_path,this.id].join("/"),!this.constructor._desc[t]){let i=this.constructor.loadDescription(t);e.push(i)}let s=$get.data(this._url).then(async function(t){i._raw=t,i._raw&&(await i._construct_actions(),i._action=i.getDefaultAction())});return e.push(s),Promise.all(e)}async _construct_actions(){for(var tasks=[],i=0;i<this.constructor._animations.length;++i)for(var t=this.constructor._animations[i],$index=1;;++$index){let action;var name=eval(t);if(!(name in this._raw))break;if(action=new _Animation_js__WEBPACK_IMPORTED_MODULE_1__.Animation(this._raw[name],[this._url,name].join("/")),action.is_loop=!1,tasks.push(action.load()),this.actions[name]=action,!name.endsWith($index))break}await Promise.all(tasks)}update(t){if(this.actions[this.action]){this.actions[this.action].update(t)}}draw(t,e,i,s,n){if(this.actions[this.action]){this.actions[this.action].draw(t,e,i,s,n)}}paint(t){alert("Not Implement"),render(t)}static async loadDescription(t){alert("Not Implement")}static get _animations(){throw new Error("Not implement")}static _get_desc_base_path(){throw new Error("Not implement")}static get _base_path(){throw new Error("Not implement")}}},367:function(t,e,i){"use strict";i.r(e);var s,n=i(344),r=i(345);class o{constructor(t=.5,e=.5,i=.5,s=1){this.r=t,this.g=e,this.b=i,this.a=s}Clone(){return(new o).Copy(this)}Copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a}GetColor(t){return t.Copy(this),t}SetColor(t){this.Copy(t)}Set(t,e,i,s=1){t instanceof o?this.Copy(t):this.SetRGBA(t,e,i,s)}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,s){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=s/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=s,this}SelfAdd(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Add(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e}SelfSub(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Sub(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e}SelfMul_0_1(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mul_0_1(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,this}Mix(t,e){o.MixColors(this,t,e)}static MixColors(t,e,i){const s=i*(e.r-t.r),n=i*(e.g-t.g),r=i*(e.b-t.b),o=i*(e.a-t.a);t.r+=s,t.g+=n,t.b+=r,t.a+=o,e.r-=s,e.g-=n,e.b-=r,e.a-=o}MakeStyleString(t=this.a){return o.MakeStyleString(this.r,this.g,this.b,t)}static MakeStyleString(t,e,i,s=1){return t*=255,e*=255,i*=255,s<1?`rgba(${t},${e},${i},${s})`:`rgb(${t},${e},${i})`}}o.RED=new o(1,0,0),o.GREEN=new o(0,1,0),o.BLUE=new o(0,0,1),function(t){t[t.e_none=0]="e_none",t[t.e_shapeBit=1]="e_shapeBit",t[t.e_jointBit=2]="e_jointBit",t[t.e_aabbBit=4]="e_aabbBit",t[t.e_pairBit=8]="e_pairBit",t[t.e_centerOfMassBit=16]="e_centerOfMassBit",t[t.e_particleBit=32]="e_particleBit",t[t.e_controllerBit=64]="e_controllerBit",t[t.e_all=63]="e_all"}(s||(s={}));class a{constructor(){this.m_drawFlags=0}SetFlags(t){this.m_drawFlags=t}GetFlags(){return this.m_drawFlags}AppendFlags(t){this.m_drawFlags|=t}ClearFlags(t){this.m_drawFlags&=~t}PushTransform(t){}PopTransform(t){}DrawPolygon(t,e,i){}DrawSolidPolygon(t,e,i){}DrawCircle(t,e,i){}DrawSolidCircle(t,e,i,s){}DrawParticles(t,e,i,s){}DrawSegment(t,e,i){}DrawTransform(t){}}class l{constructor(){this.m_start=Date.now()}Reset(){return this.m_start=Date.now(),this}GetMilliseconds(){return Date.now()-this.m_start}}class h{constructor(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}GetCount(){return this.m_count}GetMinCount(){return this.m_min_count}GetMaxCount(){return this.m_max_count}ResetCount(){const t=this.m_count;return this.m_count=0,t}ResetMinCount(){this.m_min_count=0}ResetMaxCount(){this.m_max_count=0}Increment(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)}Decrement(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)}}class _{constructor(t){this.m_stack=[],this.m_count=0,this.m_stack=[],this.m_count=0}Reset(){return this.m_count=0,this}Push(t){this.m_stack[this.m_count]=t,this.m_count++}Pop(){this.m_count--;const t=this.m_stack[this.m_count];return this.m_stack[this.m_count]=null,t}GetCount(){return this.m_count}}class c{}class m{}var u=i(346),d=i(359);function p(t){if(null===t)throw new Error;return t}class f{constructor(t=0){this.m_id=0,this.aabb=new u.a,this.userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}IsLeaf(){return null===this.child1}}class y{constructor(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0}GetUserData(t){return t.userData}GetFatAABB(t){return t.aabb}Query(t,e){if(null===this.m_root)return;const i=y.s_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const s=i.Pop();if(null!==s&&s.aabb.TestOverlap(e))if(s.IsLeaf()){if(!t(s))return}else i.Push(s.child1),i.Push(s.child2)}}RayCast(t,e){if(null===this.m_root)return;const i=e.p1,s=e.p2,n=r.A.SubVV(s,i,y.s_r);n.Normalize();const o=r.A.CrossOneV(n,y.s_v),a=r.A.AbsV(o,y.s_abs_v);let l=e.maxFraction;const h=y.s_segmentAABB;let _=i.x+l*(s.x-i.x),c=i.y+l*(s.y-i.y);h.lowerBound.x=Object(r.n)(i.x,_),h.lowerBound.y=Object(r.n)(i.y,c),h.upperBound.x=Object(r.m)(i.x,_),h.upperBound.y=Object(r.m)(i.y,c);const m=y.s_stack.Reset();for(m.Push(this.m_root);m.GetCount()>0;){const n=m.Pop();if(null===n)continue;if(!Object(u.n)(n.aabb,h))continue;const d=n.aabb.GetCenter(),p=n.aabb.GetExtents();if(!(Object(r.a)(r.A.DotVV(o,r.A.SubVV(i,d,r.A.s_t0)))-r.A.DotVV(a,p)>0))if(n.IsLeaf()){const o=y.s_subInput;o.p1.Copy(e.p1),o.p2.Copy(e.p2),o.maxFraction=l;const a=t(o,n);if(0===a)return;a>0&&(l=a,_=i.x+l*(s.x-i.x),c=i.y+l*(s.y-i.y),h.lowerBound.x=Object(r.n)(i.x,_),h.lowerBound.y=Object(r.n)(i.y,c),h.upperBound.x=Object(r.m)(i.x,_),h.upperBound.y=Object(r.m)(i.y,c))}else m.Push(n.child1),m.Push(n.child2)}}AllocateNode(){if(this.m_freeList){const t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t.userData=null,t}return new f(y.s_node_id++)}FreeNode(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.userData=null,this.m_freeList=t}CreateProxy(t,e){const i=this.AllocateNode(),s=n.k,r=n.k;return i.aabb.lowerBound.x=t.lowerBound.x-s,i.aabb.lowerBound.y=t.lowerBound.y-r,i.aabb.upperBound.x=t.upperBound.x+s,i.aabb.upperBound.y=t.upperBound.y+r,i.userData=e,i.height=0,this.InsertLeaf(i),i}DestroyProxy(t){this.RemoveLeaf(t),this.FreeNode(t)}MoveProxy(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);const s=n.k+n.l*(i.x>0?i.x:-i.x),r=n.k+n.l*(i.y>0?i.y:-i.y);return t.aabb.lowerBound.x=e.lowerBound.x-s,t.aabb.lowerBound.y=e.lowerBound.y-r,t.aabb.upperBound.x=e.upperBound.x+s,t.aabb.upperBound.y=e.upperBound.y+r,this.InsertLeaf(t),!0}InsertLeaf(t){if(++this.m_insertionCount,null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);const e=t.aabb;let i,s,n=this.m_root;for(;!n.IsLeaf();){i=n.child1,s=n.child2;const t=n.aabb.GetPerimeter(),r=y.s_combinedAABB;r.Combine2(n.aabb,e);const o=r.GetPerimeter(),a=2*o,l=2*(o-t);let h;const _=y.s_aabb;let c,m,u;if(i.IsLeaf()?(_.Combine2(e,i.aabb),h=_.GetPerimeter()+l):(_.Combine2(e,i.aabb),c=i.aabb.GetPerimeter(),h=(m=_.GetPerimeter())-c+l),s.IsLeaf()?(_.Combine2(e,s.aabb),u=_.GetPerimeter()+l):(_.Combine2(e,s.aabb),c=s.aabb.GetPerimeter(),u=(m=_.GetPerimeter())-c+l),a<h&&a<u)break;n=h<u?i:s}const o=n,a=o.parent,l=this.AllocateNode();for(l.parent=a,l.userData=null,l.aabb.Combine2(e,o.aabb),l.height=o.height+1,a?(a.child1===o?a.child1=l:a.child2=l,l.child1=o,l.child2=t,o.parent=l,t.parent=l):(l.child1=o,l.child2=t,o.parent=l,t.parent=l,this.m_root=l),n=t.parent;null!==n;)i=(n=this.Balance(n)).child1,s=n.child2,n.height=1+Object(r.m)(i.height,s.height),n.aabb.Combine2(i.aabb,s.aabb),n=n.parent}RemoveLeaf(t){if(t===this.m_root)return void(this.m_root=null);const e=t.parent,i=e&&e.parent;let s;if(s=e.child1===t?e.child2:e.child1,i){i.child1===e?i.child1=s:i.child2=s,s.parent=i,this.FreeNode(e);let t=i;for(;t;){const e=(t=this.Balance(t)).child1,i=t.child2;t.aabb.Combine2(e.aabb,i.aabb),t.height=1+Object(r.m)(e.height,i.height),t=t.parent}}else this.m_root=s,s.parent=null,this.FreeNode(e)}Balance(t){if(t.IsLeaf()||t.height<2)return t;const e=p(t.child1),i=p(t.child2),s=i.height-e.height;if(s>1){const s=p(i.child1),n=p(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,s.height>n.height?(i.child2=s,t.child2=n,n.parent=t,t.aabb.Combine2(e.aabb,n.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+Object(r.m)(e.height,n.height),i.height=1+Object(r.m)(t.height,s.height)):(i.child2=n,t.child2=s,s.parent=t,t.aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,n.aabb),t.height=1+Object(r.m)(e.height,s.height),i.height=1+Object(r.m)(t.height,n.height)),i}if(s<-1){const s=p(e.child1),n=p(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,s.height>n.height?(e.child2=s,t.child1=n,n.parent=t,t.aabb.Combine2(i.aabb,n.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+Object(r.m)(i.height,n.height),e.height=1+Object(r.m)(t.height,s.height)):(e.child2=n,t.child1=s,s.parent=t,t.aabb.Combine2(i.aabb,s.aabb),e.aabb.Combine2(t.aabb,n.aabb),t.height=1+Object(r.m)(i.height,s.height),e.height=1+Object(r.m)(t.height,n.height)),e}return t}GetHeight(){return null===this.m_root?0:this.m_root.height}static GetAreaNode(t){if(null===t)return 0;if(t.IsLeaf())return 0;let e=t.aabb.GetPerimeter();return e+=y.GetAreaNode(t.child1),e+=y.GetAreaNode(t.child2)}GetAreaRatio(){if(null===this.m_root)return 0;const t=this.m_root.aabb.GetPerimeter();return y.GetAreaNode(this.m_root)/t}ComputeHeightNode(t){if(t.IsLeaf())return 0;const e=this.ComputeHeightNode(t.child1),i=this.ComputeHeightNode(t.child2);return 1+Object(r.m)(e,i)}ComputeHeight(){return this.ComputeHeightNode(this.m_root)}ValidateStructure(t){if(null===t)return;this.m_root;const e=t,i=e.child1,s=e.child2;e.IsLeaf()||(this.ValidateStructure(i),this.ValidateStructure(s))}ValidateMetrics(t){if(null===t)return;const e=t,i=e.child1,s=e.child2;e.IsLeaf()||(y.s_aabb.Combine2(i.aabb,s.aabb),this.ValidateMetrics(i),this.ValidateMetrics(s))}Validate(){this.ValidateStructure(this.m_root),this.ValidateMetrics(this.m_root);let t=this.m_freeList;for(;null!==t;)t=t.parent}static GetMaxBalanceNode(t,e){if(null===t)return e;if(t.height<=1)return e;const i=t.child1,s=t.child2,n=Object(r.a)(s.height-i.height);return Object(r.m)(e,n)}GetMaxBalance(){return y.GetMaxBalanceNode(this.m_root,0)}RebuildBottomUp(){this.Validate()}static ShiftOriginNode(t,e){if(null===t)return;if(t.height<=1)return;const i=t.child1,s=t.child2;y.ShiftOriginNode(i,e),y.ShiftOriginNode(s,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)}ShiftOrigin(t){y.ShiftOriginNode(this.m_root,t)}}y.s_stack=new _(256),y.s_r=new r.A,y.s_v=new r.A,y.s_abs_v=new r.A,y.s_segmentAABB=new u.a,y.s_subInput=new u.l,y.s_combinedAABB=new u.a,y.s_aabb=new u.a,y.s_node_id=0;class A{constructor(){this.proxyA=null,this.proxyB=null}}class g{constructor(){this.m_tree=new y,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}CreateProxy(t,e){const i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i}DestroyProxy(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)}MoveProxy(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)}TouchProxy(t){this.BufferMove(t)}GetFatAABB(t){return this.m_tree.GetFatAABB(t)}GetUserData(t){return this.m_tree.GetUserData(t)}TestOverlap(t,e){const i=this.m_tree.GetFatAABB(t),s=this.m_tree.GetFatAABB(e);return Object(u.n)(i,s)}GetProxyCount(){return this.m_proxyCount}UpdatePairs(t){this.m_pairCount=0;for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];if(null===e)continue;const i=t=>{if(t.m_id===e.m_id)return!0;this.m_pairCount===this.m_pairBuffer.length&&(this.m_pairBuffer[this.m_pairCount]=new A);const i=this.m_pairBuffer[this.m_pairCount];return t.m_id<e.m_id?(i.proxyA=t,i.proxyB=e):(i.proxyA=e,i.proxyB=t),++this.m_pairCount,!0},s=this.m_tree.GetFatAABB(e);this.m_tree.Query(i,s)}this.m_moveCount=0,this.m_pairBuffer.length=this.m_pairCount,this.m_pairBuffer.sort(x);let e=0;for(;e<this.m_pairCount;){const i=this.m_pairBuffer[e],s=this.m_tree.GetUserData(i.proxyA),n=this.m_tree.GetUserData(i.proxyB);for(t.AddPair(s,n),++e;e<this.m_pairCount;){const t=this.m_pairBuffer[e];if(t.proxyA.m_id!==i.proxyA.m_id||t.proxyB.m_id!==i.proxyB.m_id)break;++e}}}Query(t,e){this.m_tree.Query(t,e)}RayCast(t,e){this.m_tree.RayCast(t,e)}GetTreeHeight(){return this.m_tree.GetHeight()}GetTreeBalance(){return this.m_tree.GetMaxBalance()}GetTreeQuality(){return this.m_tree.GetAreaRatio()}ShiftOrigin(t){this.m_tree.ShiftOrigin(t)}BufferMove(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount}UnBufferMove(t){const e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null}}function x(t,e){return t.proxyA.m_id===e.proxyA.m_id?t.proxyB.m_id-e.proxyB.m_id:t.proxyA.m_id-e.proxyA.m_id}let w=0,b=0,S=0,v=0,C=0,B=0,V=0;function M(){w=0,b=0,S=0,v=0,C=0,B=0,V=0}const P=new r.z,I=new r.z,D=new r.A,k=new r.A,G=new r.A,R=new r.A,L=new r.A;class ${constructor(){this.proxyA=new d.d,this.proxyB=new d.d,this.sweepA=new r.y,this.sweepB=new r.y,this.tMax=0}}var T,F;!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_failed=1]="e_failed",t[t.e_overlapped=2]="e_overlapped",t[t.e_touching=3]="e_touching",t[t.e_separated=4]="e_separated"}(T||(T={}));class E{constructor(){this.state=T.e_unknown,this.t=0}}!function(t){t[t.e_unknown=-1]="e_unknown",t[t.e_points=0]="e_points",t[t.e_faceA=1]="e_faceA",t[t.e_faceB=2]="e_faceB"}(F||(F={}));class j{constructor(){this.m_sweepA=new r.y,this.m_sweepB=new r.y,this.m_type=F.e_unknown,this.m_localPoint=new r.A,this.m_axis=new r.A}Initialize(t,e,i,s,n,o){this.m_proxyA=e,this.m_proxyB=s;const a=t.count;this.m_sweepA.Copy(i),this.m_sweepB.Copy(n);const l=P,h=I;if(this.m_sweepA.GetTransform(l,o),this.m_sweepB.GetTransform(h,o),1===a){this.m_type=F.e_points;const e=this.m_proxyA.GetVertex(t.indexA[0]),i=this.m_proxyB.GetVertex(t.indexB[0]),s=r.z.MulXV(l,e,D),n=r.z.MulXV(h,i,k);r.A.SubVV(n,s,this.m_axis);const o=this.m_axis.Normalize();return this.m_localPoint.SetZero(),o}if(t.indexA[0]===t.indexA[1]){this.m_type=F.e_faceB;const e=this.m_proxyB.GetVertex(t.indexB[0]),i=this.m_proxyB.GetVertex(t.indexB[1]);r.A.CrossVOne(r.A.SubVV(i,e,r.A.s_t0),this.m_axis).SelfNormalize();const s=r.t.MulRV(h.q,this.m_axis,G);r.A.MidVV(e,i,this.m_localPoint);const n=r.z.MulXV(h,this.m_localPoint,k),o=this.m_proxyA.GetVertex(t.indexA[0]),a=r.z.MulXV(l,o,D);let _=r.A.DotVV(r.A.SubVV(a,n,r.A.s_t0),s);return _<0&&(this.m_axis.SelfNeg(),_=-_),_}{this.m_type=F.e_faceA;const e=this.m_proxyA.GetVertex(t.indexA[0]),i=this.m_proxyA.GetVertex(t.indexA[1]);r.A.CrossVOne(r.A.SubVV(i,e,r.A.s_t0),this.m_axis).SelfNormalize();const s=r.t.MulRV(l.q,this.m_axis,G);r.A.MidVV(e,i,this.m_localPoint);const n=r.z.MulXV(l,this.m_localPoint,D),o=this.m_proxyB.GetVertex(t.indexB[0]),a=r.z.MulXV(h,o,k);let _=r.A.DotVV(r.A.SubVV(a,n,r.A.s_t0),s);return _<0&&(this.m_axis.SelfNeg(),_=-_),_}}FindMinSeparation(t,e,i){const s=P,n=I;switch(this.m_sweepA.GetTransform(s,i),this.m_sweepB.GetTransform(n,i),this.m_type){case F.e_points:{const i=r.t.MulTRV(s.q,this.m_axis,R),o=r.t.MulTRV(n.q,r.A.NegV(this.m_axis,r.A.s_t0),L);t[0]=this.m_proxyA.GetSupport(i),e[0]=this.m_proxyB.GetSupport(o);const a=this.m_proxyA.GetVertex(t[0]),l=this.m_proxyB.GetVertex(e[0]),h=r.z.MulXV(s,a,D),_=r.z.MulXV(n,l,k);return r.A.DotVV(r.A.SubVV(_,h,r.A.s_t0),this.m_axis)}case F.e_faceA:{const i=r.t.MulRV(s.q,this.m_axis,G),o=r.z.MulXV(s,this.m_localPoint,D),a=r.t.MulTRV(n.q,r.A.NegV(i,r.A.s_t0),L);t[0]=-1,e[0]=this.m_proxyB.GetSupport(a);const l=this.m_proxyB.GetVertex(e[0]),h=r.z.MulXV(n,l,k);return r.A.DotVV(r.A.SubVV(h,o,r.A.s_t0),i)}case F.e_faceB:{const i=r.t.MulRV(n.q,this.m_axis,G),o=r.z.MulXV(n,this.m_localPoint,k),a=r.t.MulTRV(s.q,r.A.NegV(i,r.A.s_t0),R);e[0]=-1,t[0]=this.m_proxyA.GetSupport(a);const l=this.m_proxyA.GetVertex(t[0]),h=r.z.MulXV(s,l,D);return r.A.DotVV(r.A.SubVV(h,o,r.A.s_t0),i)}default:return t[0]=-1,e[0]=-1,0}}Evaluate(t,e,i){const s=P,n=I;switch(this.m_sweepA.GetTransform(s,i),this.m_sweepB.GetTransform(n,i),this.m_type){case F.e_points:{const i=this.m_proxyA.GetVertex(t),o=this.m_proxyB.GetVertex(e),a=r.z.MulXV(s,i,D),l=r.z.MulXV(n,o,k);return r.A.DotVV(r.A.SubVV(l,a,r.A.s_t0),this.m_axis)}case F.e_faceA:{const t=r.t.MulRV(s.q,this.m_axis,G),i=r.z.MulXV(s,this.m_localPoint,D),o=this.m_proxyB.GetVertex(e),a=r.z.MulXV(n,o,k);return r.A.DotVV(r.A.SubVV(a,i,r.A.s_t0),t)}case F.e_faceB:{const e=r.t.MulRV(n.q,this.m_axis,G),i=r.z.MulXV(n,this.m_localPoint,k),o=this.m_proxyA.GetVertex(t),a=r.z.MulXV(s,o,D);return r.A.DotVV(r.A.SubVV(a,i,r.A.s_t0),e)}default:return 0}}}const O=new l,N=new d.f,z=new d.b,q=new d.c,J=new j,W=[0],U=[0],X=new r.y,H=new r.y;function Z(t,e){const i=O.Reset();++S,t.state=T.e_unknown,t.t=e.tMax;const s=e.proxyA,o=e.proxyB,a=X.Copy(e.sweepA),l=H.Copy(e.sweepB);a.Normalize(),l.Normalize();const h=e.tMax,_=s.m_radius+o.m_radius,c=Object(r.m)(n.v,_-3*n.v),m=.25*n.v;let u=0;let p=0;const f=N;f.count=0;const y=z;for(y.proxyA=e.proxyA,y.proxyB=e.proxyB,y.useRadii=!1;;){const e=P,i=I;a.GetTransform(e,u),l.GetTransform(i,u),y.transformA.Copy(e),y.transformB.Copy(i);const _=q;if(Object(d.a)(_,f,y),_.distance<=0){t.state=T.e_overlapped,t.t=0;break}if(_.distance<c+m){t.state=T.e_touching,t.t=u;break}const A=J;A.Initialize(f,s,a,o,l,u);let g=!1,x=h,w=0;for(;;){const e=W,i=U;let s=A.FindMinSeparation(e,i,x);if(s>c+m){t.state=T.e_separated,t.t=h,g=!0;break}if(s>c-m){u=x;break}let o=A.Evaluate(e[0],i[0],u);if(o<c-m){t.state=T.e_failed,t.t=u,g=!0;break}if(o<=c+m){t.state=T.e_touching,t.t=u,g=!0;break}let a=0,l=u,_=x;for(;;){let t=0;t=1&a?l+(c-o)*(_-l)/(s-o):.5*(l+_),++a,++B;const n=A.Evaluate(e[0],i[0],t);if(Object(r.a)(n-c)<m){x=t;break}if(n>c?(l=t,o=n):(_=t,s=n),50===a)break}if(V=Object(r.m)(V,a),++w===n.D)break}if(++p,++v,g)break;if(20===p){t.state=T.e_failed,t.t=u;break}}C=Object(r.m)(C,p);const A=i.GetMilliseconds();b=Object(r.m)(b,A),w+=A}const Y=new r.A,Q=new r.A;function K(t,e,i,s,n){t.pointCount=0;const o=r.z.MulXV(i,e.m_p,Y),a=r.z.MulXV(n,s.m_p,Q),l=r.A.DistanceSquaredVV(o,a),h=e.m_radius+s.m_radius;l>h*h||(t.type=u.j.e_circles,t.localPoint.Copy(e.m_p),t.localNormal.SetZero(),t.pointCount=1,t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0)}const tt=new r.A,et=new r.A,it=new r.A;function st(t,e,i,s,o){t.pointCount=0;const a=r.z.MulXV(o,s.m_p,tt),l=r.z.MulTXV(i,a,et);let h=0,_=-n.x;const c=e.m_radius+s.m_radius,m=e.m_count,d=e.m_vertices,p=e.m_normals;for(let t=0;t<m;++t){const e=r.A.DotVV(p[t],r.A.SubVV(l,d[t],r.A.s_t0));if(e>c)return;e>_&&(_=e,h=t)}const f=h,y=(f+1)%m,A=d[f],g=d[y];if(_<n.r)return t.pointCount=1,t.type=u.j.e_faceA,t.localNormal.Copy(p[h]),r.A.MidVV(A,g,t.localPoint),t.points[0].localPoint.Copy(s.m_p),void(t.points[0].id.key=0);const x=r.A.DotVV(r.A.SubVV(l,A,r.A.s_t0),r.A.SubVV(g,A,r.A.s_t1)),w=r.A.DotVV(r.A.SubVV(l,g,r.A.s_t0),r.A.SubVV(A,g,r.A.s_t1));if(x<=0){if(r.A.DistanceSquaredVV(l,A)>c*c)return;t.pointCount=1,t.type=u.j.e_faceA,r.A.SubVV(l,A,t.localNormal).SelfNormalize(),t.localPoint.Copy(A),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}else if(w<=0){if(r.A.DistanceSquaredVV(l,g)>c*c)return;t.pointCount=1,t.type=u.j.e_faceA,r.A.SubVV(l,g,t.localNormal).SelfNormalize(),t.localPoint.Copy(g),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}else{const e=r.A.MidVV(A,g,it);if((_=r.A.DotVV(r.A.SubVV(l,e,r.A.s_t1),p[f]))>c)return;t.pointCount=1,t.type=u.j.e_faceA,t.localNormal.Copy(p[f]).SelfNormalize(),t.localPoint.Copy(e),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}}const nt=new r.A,rt=new r.A,ot=new r.A,at=new r.A;function lt(t,e,i,s,o){const a=t.m_vertices,l=t.m_normals,h=s.m_count,_=s.m_vertices,c=r.t.MulRV(e.q,l[i],nt),m=r.t.MulTRV(o.q,c,rt);let u=0,d=n.x;for(let t=0;t<h;++t){const e=r.A.DotVV(_[t],m);e<d&&(d=e,u=t)}const p=r.z.MulXV(e,a[i],ot),f=r.z.MulXV(o,_[u],at);return r.A.DotVV(r.A.SubVV(f,p,r.A.s_t0),c)}const ht=new r.A,_t=new r.A;function ct(t,e,i,s,o){const a=e.m_count,l=e.m_normals,h=r.A.SubVV(r.z.MulXV(o,s.m_centroid,r.A.s_t0),r.z.MulXV(i,e.m_centroid,r.A.s_t1),ht),_=r.t.MulTRV(i.q,h,_t);let c=0,m=-n.x;for(let t=0;t<a;++t){const e=r.A.DotVV(l[t],_);e>m&&(m=e,c=t)}let u=lt(e,i,c,s,o);const d=(c+a-1)%a,p=lt(e,i,d,s,o),f=(c+1)%a,y=lt(e,i,f,s,o);let A=0,g=0,x=0;if(p>u&&p>y)x=-1,A=d,g=p;else{if(!(y>u))return t[0]=c,u;x=1,A=f,g=y}for(;(u=lt(e,i,c=-1===x?(A+a-1)%a:(A+1)%a,s,o))>g;)A=c,g=u;return t[0]=A,g}const mt=new r.A;const ut=u.c.MakeArray(2),dt=u.c.MakeArray(2),pt=u.c.MakeArray(2),ft=[0],yt=[0],At=new r.A,gt=new r.A,xt=new r.A,wt=new r.A,bt=new r.A,St=new r.A,vt=new r.A,Ct=new r.A;function Bt(t,e,i,s,o){t.pointCount=0;const a=e.m_radius+s.m_radius,l=ft;l[0]=0;const h=ct(l,e,i,s,o);if(h>a)return;const _=yt;_[0]=0;const c=ct(_,s,o,e,i);if(c>a)return;let m,d,p,f,y=0,A=0;c>.98*h+.001?(m=s,d=e,p=o,f=i,y=_[0],t.type=u.j.e_faceB,A=1):(m=e,d=s,p=i,f=o,y=l[0],t.type=u.j.e_faceA,A=0);const g=ut;!function(t,e,i,s,o,a){const l=e.m_normals,h=o.m_count,_=o.m_vertices,c=o.m_normals,m=r.t.MulTRV(a.q,r.t.MulRV(i.q,l[s],r.A.s_t0),mt);let d=0,p=n.x;for(let t=0;t<h;++t){const e=r.A.DotVV(m,c[t]);e<p&&(p=e,d=t)}const f=d,y=(f+1)%h,A=t[0];r.z.MulXV(a,_[f],A.v);const g=A.id.cf;g.indexA=s,g.indexB=f,g.typeA=u.e.e_face,g.typeB=u.e.e_vertex;const x=t[1];r.z.MulXV(a,_[y],x.v);const w=x.id.cf;w.indexA=s,w.indexB=y,w.typeA=u.e.e_face,w.typeB=u.e.e_vertex}(g,m,p,y,d,f);const x=m.m_count,w=m.m_vertices,b=y,S=(y+1)%x,v=w[b],C=w[S],B=r.A.SubVV(C,v,At);B.Normalize();const V=r.A.CrossVOne(B,gt),M=r.A.MidVV(v,C,xt),P=r.t.MulRV(p.q,B,bt),I=r.A.CrossVOne(P,wt),D=r.z.MulXV(p,v,vt),k=r.z.MulXV(p,C,Ct),G=r.A.DotVV(I,D),R=-r.A.DotVV(P,D)+a,L=r.A.DotVV(P,k)+a,$=dt,T=pt;let F;const E=r.A.NegV(P,St);if((F=Object(u.b)($,g,E,R,b))<2)return;if((F=Object(u.b)(T,$,P,L,S))<2)return;t.localNormal.Copy(V),t.localPoint.Copy(M);let j=0;for(let e=0;e<n.z;++e){const i=T[e];if(r.A.DotVV(I,i.v)-G<=a){const e=t.points[j];if(r.z.MulTXV(f,i.v,e.localPoint),e.id.Copy(i.id),A){const t=e.id.cf;e.id.cf.indexA=t.indexB,e.id.cf.indexB=t.indexA,e.id.cf.typeA=t.typeB,e.id.cf.typeB=t.typeA}++j}}t.pointCount=j}const Vt=new r.A,Mt=new r.A,Pt=new r.A,It=new r.A,Dt=new r.A,kt=new r.A,Gt=new r.A,Rt=new u.f;function Lt(t,e,i,s,n){t.pointCount=0;const o=r.z.MulTXV(i,r.z.MulXV(n,s.m_p,r.A.s_t0),Vt),a=e.m_vertex1,l=e.m_vertex2,h=r.A.SubVV(l,a,Mt),_=r.A.DotVV(h,r.A.SubVV(l,o,r.A.s_t0)),c=r.A.DotVV(h,r.A.SubVV(o,a,r.A.s_t0)),m=e.m_radius+s.m_radius,d=Rt;if(d.cf.indexB=0,d.cf.typeB=u.e.e_vertex,c<=0){const i=a,n=r.A.SubVV(o,i,Pt);if(r.A.DotVV(n,n)>m*m)return;if(e.m_hasVertex0){const t=e.m_vertex0,i=a,s=r.A.SubVV(i,t,It);if(r.A.DotVV(s,r.A.SubVV(i,o,r.A.s_t0))>0)return}return d.cf.indexA=0,d.cf.typeA=u.e.e_vertex,t.pointCount=1,t.type=u.j.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(i),t.points[0].id.Copy(d),void t.points[0].localPoint.Copy(s.m_p)}if(_<=0){const i=l,n=r.A.SubVV(o,i,Pt);if(r.A.DotVV(n,n)>m*m)return;if(e.m_hasVertex3){const t=e.m_vertex3,i=l,s=r.A.SubVV(t,i,Dt);if(r.A.DotVV(s,r.A.SubVV(o,i,r.A.s_t0))>0)return}return d.cf.indexA=1,d.cf.typeA=u.e.e_vertex,t.pointCount=1,t.type=u.j.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(i),t.points[0].id.Copy(d),void t.points[0].localPoint.Copy(s.m_p)}const p=r.A.DotVV(h,h),f=kt;f.x=1/p*(_*a.x+c*l.x),f.y=1/p*(_*a.y+c*l.y);const y=r.A.SubVV(o,f,Pt);if(r.A.DotVV(y,y)>m*m)return;const A=Gt.Set(-h.y,h.x);r.A.DotVV(A,r.A.SubVV(o,a,r.A.s_t0))<0&&A.Set(-A.x,-A.y),A.Normalize(),d.cf.indexA=0,d.cf.typeA=u.e.e_face,t.pointCount=1,t.type=u.j.e_faceA,t.localNormal.Copy(A),t.localPoint.Copy(a),t.points[0].id.Copy(d),t.points[0].localPoint.Copy(s.m_p)}class $t{constructor(){this.type=0,this.index=0,this.separation=0}}class Tt{constructor(){this.vertices=r.A.MakeArray(n.D),this.normals=r.A.MakeArray(n.D),this.count=0}}class Ft{constructor(){this.m_polygonB=new Tt,this.m_xf=new r.z,this.m_centroidB=new r.A,this.m_v0=new r.A,this.m_v1=new r.A,this.m_v2=new r.A,this.m_v3=new r.A,this.m_normal0=new r.A,this.m_normal1=new r.A,this.m_normal2=new r.A,this.m_normal=new r.A,this.m_type1=0,this.m_type2=0,this.m_lowerLimit=new r.A,this.m_upperLimit=new r.A,this.m_radius=0,this.m_front=!1}Collide(t,e,i,s,o){r.z.MulTXX(i,o,this.m_xf),r.z.MulXV(this.m_xf,s.m_centroid,this.m_centroidB),this.m_v0.Copy(e.m_vertex0),this.m_v1.Copy(e.m_vertex1),this.m_v2.Copy(e.m_vertex2),this.m_v3.Copy(e.m_vertex3);const a=e.m_hasVertex0,l=e.m_hasVertex3,h=r.A.SubVV(this.m_v2,this.m_v1,Ft.s_edge1);h.Normalize(),this.m_normal1.Set(h.y,-h.x);const _=r.A.DotVV(this.m_normal1,r.A.SubVV(this.m_centroidB,this.m_v1,r.A.s_t0));let c=0,m=0,d=!1,p=!1;if(a){const t=r.A.SubVV(this.m_v1,this.m_v0,Ft.s_edge0);t.Normalize(),this.m_normal0.Set(t.y,-t.x),d=r.A.CrossVV(t,h)>=0,c=r.A.DotVV(this.m_normal0,r.A.SubVV(this.m_centroidB,this.m_v0,r.A.s_t0))}if(l){const t=r.A.SubVV(this.m_v3,this.m_v2,Ft.s_edge2);t.Normalize(),this.m_normal2.Set(t.y,-t.x),p=r.A.CrossVV(h,t)>0,m=r.A.DotVV(this.m_normal2,r.A.SubVV(this.m_centroidB,this.m_v2,r.A.s_t0))}a&&l?d&&p?(this.m_front=c>=0||_>=0||m>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):d?(this.m_front=c>=0||_>=0&&m>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):p?(this.m_front=m>=0||c>=0&&_>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=c>=0&&_>=0&&m>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):a?d?(this.m_front=c>=0||_>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=c>=0&&_>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):l?p?(this.m_front=_>=0||m>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=_>=0&&m>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=_>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=s.m_count;for(let t=0;t<s.m_count;++t)r.z.MulXV(this.m_xf,s.m_vertices[t],this.m_polygonB.vertices[t]),r.t.MulRV(this.m_xf.q,s.m_normals[t],this.m_polygonB.normals[t]);this.m_radius=2*n.Q,t.pointCount=0;const f=this.ComputeEdgeSeparation(Ft.s_edgeAxis);if(0===f.type)return;if(f.separation>this.m_radius)return;const y=this.ComputePolygonSeparation(Ft.s_polygonAxis);if(0!==y.type&&y.separation>this.m_radius)return;let A;A=0===y.type?f:y.separation>.98*f.separation+.001?y:f;const g=Ft.s_ie,x=Ft.s_rf;if(1===A.type){t.type=u.j.e_faceA;let e=0,i=r.A.DotVV(this.m_normal,this.m_polygonB.normals[0]);for(let t=1;t<this.m_polygonB.count;++t){const s=r.A.DotVV(this.m_normal,this.m_polygonB.normals[t]);s<i&&(i=s,e=t)}const s=e,n=(s+1)%this.m_polygonB.count,o=g[0];o.v.Copy(this.m_polygonB.vertices[s]),o.id.cf.indexA=0,o.id.cf.indexB=s,o.id.cf.typeA=u.e.e_face,o.id.cf.typeB=u.e.e_vertex;const a=g[1];a.v.Copy(this.m_polygonB.vertices[n]),a.id.cf.indexA=0,a.id.cf.indexB=n,a.id.cf.typeA=u.e.e_face,a.id.cf.typeB=u.e.e_vertex,this.m_front?(x.i1=0,x.i2=1,x.v1.Copy(this.m_v1),x.v2.Copy(this.m_v2),x.normal.Copy(this.m_normal1)):(x.i1=1,x.i2=0,x.v1.Copy(this.m_v2),x.v2.Copy(this.m_v1),x.normal.Copy(this.m_normal1).SelfNeg())}else{t.type=u.j.e_faceB;const e=g[0];e.v.Copy(this.m_v1),e.id.cf.indexA=0,e.id.cf.indexB=A.index,e.id.cf.typeA=u.e.e_vertex,e.id.cf.typeB=u.e.e_face;const i=g[1];i.v.Copy(this.m_v2),i.id.cf.indexA=0,i.id.cf.indexB=A.index,i.id.cf.typeA=u.e.e_vertex,i.id.cf.typeB=u.e.e_face,x.i1=A.index,x.i2=(x.i1+1)%this.m_polygonB.count,x.v1.Copy(this.m_polygonB.vertices[x.i1]),x.v2.Copy(this.m_polygonB.vertices[x.i2]),x.normal.Copy(this.m_polygonB.normals[x.i1])}x.sideNormal1.Set(x.normal.y,-x.normal.x),x.sideNormal2.Copy(x.sideNormal1).SelfNeg(),x.sideOffset1=r.A.DotVV(x.sideNormal1,x.v1),x.sideOffset2=r.A.DotVV(x.sideNormal2,x.v2);const w=Ft.s_clipPoints1,b=Ft.s_clipPoints2;let S=0;if((S=Object(u.b)(w,g,x.sideNormal1,x.sideOffset1,x.i1))<n.z)return;if((S=Object(u.b)(b,w,x.sideNormal2,x.sideOffset2,x.i2))<n.z)return;1===A.type?(t.localNormal.Copy(x.normal),t.localPoint.Copy(x.v1)):(t.localNormal.Copy(s.m_normals[x.i1]),t.localPoint.Copy(s.m_vertices[x.i1]));let v=0;for(let e=0;e<n.z;++e){let i;if((i=r.A.DotVV(x.normal,r.A.SubVV(b[e].v,x.v1,r.A.s_t0)))<=this.m_radius){const i=t.points[v];1===A.type?(r.z.MulTXV(this.m_xf,b[e].v,i.localPoint),i.id=b[e].id):(i.localPoint.Copy(b[e].v),i.id.cf.typeA=b[e].id.cf.typeB,i.id.cf.typeB=b[e].id.cf.typeA,i.id.cf.indexA=b[e].id.cf.indexB,i.id.cf.indexB=b[e].id.cf.indexA),++v}}t.pointCount=v}ComputeEdgeSeparation(t){const e=t;e.type=1,e.index=this.m_front?0:1,e.separation=n.x;for(let t=0;t<this.m_polygonB.count;++t){const i=r.A.DotVV(this.m_normal,r.A.SubVV(this.m_polygonB.vertices[t],this.m_v1,r.A.s_t0));i<e.separation&&(e.separation=i)}return e}ComputePolygonSeparation(t){const e=t;e.type=0,e.index=-1,e.separation=-n.x;const i=Ft.s_perp.Set(-this.m_normal.y,this.m_normal.x);for(let t=0;t<this.m_polygonB.count;++t){const s=r.A.NegV(this.m_polygonB.normals[t],Ft.s_n),o=r.A.DotVV(s,r.A.SubVV(this.m_polygonB.vertices[t],this.m_v1,r.A.s_t0)),a=r.A.DotVV(s,r.A.SubVV(this.m_polygonB.vertices[t],this.m_v2,r.A.s_t0)),l=Object(r.n)(o,a);if(l>this.m_radius)return e.type=2,e.index=t,e.separation=l,e;if(r.A.DotVV(s,i)>=0){if(r.A.DotVV(r.A.SubVV(s,this.m_upperLimit,r.A.s_t0),this.m_normal)<-n.n)continue}else if(r.A.DotVV(r.A.SubVV(s,this.m_lowerLimit,r.A.s_t0),this.m_normal)<-n.n)continue;l>e.separation&&(e.type=2,e.index=t,e.separation=l)}return e}}Ft.s_edge1=new r.A,Ft.s_edge0=new r.A,Ft.s_edge2=new r.A,Ft.s_ie=u.c.MakeArray(2),Ft.s_rf=new class{constructor(){this.i1=0,this.i2=0,this.v1=new r.A,this.v2=new r.A,this.normal=new r.A,this.sideNormal1=new r.A,this.sideOffset1=0,this.sideNormal2=new r.A,this.sideOffset2=0}},Ft.s_clipPoints1=u.c.MakeArray(2),Ft.s_clipPoints2=u.c.MakeArray(2),Ft.s_edgeAxis=new $t,Ft.s_polygonAxis=new $t,Ft.s_n=new r.A,Ft.s_perp=new r.A;const Et=new Ft;function jt(t,e,i,s,n){Et.Collide(t,e,i,s,n)}var Ot=i(347);class Nt extends Ot.b{constructor(t=0){super(Ot.c.e_circleShape,t),this.m_p=new r.A}Clone(){return(new Nt).Copy(this)}Copy(t){return super.Copy(t),this.m_p.Copy(t.m_p),this}GetChildCount(){return 1}TestPoint(t,e){const i=r.z.MulXV(t,this.m_p,Nt.TestPoint_s_center),s=r.A.SubVV(e,i,Nt.TestPoint_s_d);return r.A.DotVV(s,s)<=Object(r.v)(this.m_radius)}ComputeDistance(t,e,i,s){const n=r.z.MulXV(t,this.m_p,Nt.ComputeDistance_s_center);return r.A.SubVV(e,n,i),i.Normalize()-this.m_radius}RayCast(t,e,i,s){const o=r.z.MulXV(i,this.m_p,Nt.RayCast_s_position),a=r.A.SubVV(e.p1,o,Nt.RayCast_s_s),l=r.A.DotVV(a,a)-Object(r.v)(this.m_radius),h=r.A.SubVV(e.p2,e.p1,Nt.RayCast_s_r),_=r.A.DotVV(a,h),c=r.A.DotVV(h,h),m=_*_-c*l;if(m<0||c<n.r)return!1;let u=-(_+Object(r.w)(m));return 0<=u&&u<=e.maxFraction*c&&(u/=c,t.fraction=u,r.A.AddVMulSV(a,u,h,t.normal).SelfNormalize(),!0)}ComputeAABB(t,e,i){const s=r.z.MulXV(e,this.m_p,Nt.ComputeAABB_s_p);t.lowerBound.Set(s.x-this.m_radius,s.y-this.m_radius),t.upperBound.Set(s.x+this.m_radius,s.y+this.m_radius)}ComputeMass(t,e){const i=Object(r.v)(this.m_radius);t.mass=e*n.P*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+r.A.DotVV(this.m_p,this.m_p))}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,s){const o=r.z.MulXV(i,this.m_p,new r.A),a=-(r.A.DotVV(t,o)-e);if(a<-this.m_radius+n.r)return 0;if(a>this.m_radius)return s.Copy(o),n.P*this.m_radius*this.m_radius;const l=this.m_radius*this.m_radius,h=a*a,_=l*(Object(r.c)(a/this.m_radius)+n.P/2)+a*Object(r.w)(l-h),c=-2/3*Object(r.p)(l-h,1.5)/_;return s.x=o.x+t.x*c,s.y=o.y+t.y*c,_}Dump(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)}}Nt.TestPoint_s_center=new r.A,Nt.TestPoint_s_d=new r.A,Nt.ComputeDistance_s_center=new r.A,Nt.RayCast_s_position=new r.A,Nt.RayCast_s_s=new r.A,Nt.RayCast_s_r=new r.A,Nt.ComputeAABB_s_p=new r.A;class zt extends Ot.b{constructor(){super(Ot.c.e_polygonShape,n.Q),this.m_centroid=new r.A(0,0),this.m_vertices=r.A.MakeArray(n.D),this.m_normals=r.A.MakeArray(n.D),this.m_count=0}Clone(){return(new zt).Copy(this)}Copy(t){super.Copy(t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count;for(let e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this}GetChildCount(){return 1}Set(t,e=t.length,i=0){if(e<3)return this.SetAsBox(1,1);let s=Object(r.n)(e,n.D);const o=zt.Set_s_ps;let a=0;for(let e=0;e<s;++e){const s=t[i+e];let l=!0;for(let t=0;t<a;++t)if(r.A.DistanceSquaredVV(s,o[t])<.5*n.v*(.5*n.v)){l=!1;break}l&&o[a++].Copy(s)}if((s=a)<3)return this.SetAsBox(1,1);let l=0,h=o[0].x;for(let t=1;t<s;++t){const e=o[t].x;(e>h||e===h&&o[t].y<o[l].y)&&(l=t,h=e)}const _=zt.Set_s_hull;let c=0,m=l;for(;;){_[c]=m;let t=0;for(let e=1;e<s;++e){if(t===m){t=e;continue}const i=r.A.SubVV(o[t],o[_[c]],zt.Set_s_r),s=r.A.SubVV(o[e],o[_[c]],zt.Set_s_v),n=r.A.CrossVV(i,s);n<0&&(t=e),0===n&&s.LengthSquared()>i.LengthSquared()&&(t=e)}if(++c,m=t,t===l)break}this.m_count=c;for(let t=0;t<c;++t)this.m_vertices[t].Copy(o[_[t]]);for(let t=0;t<c;++t){const e=this.m_vertices[t],i=this.m_vertices[(t+1)%c],s=r.A.SubVV(i,e,r.A.s_t0);r.A.CrossVOne(s,this.m_normals[t]).SelfNormalize()}return zt.ComputeCentroid(this.m_vertices,c,this.m_centroid),this}SetAsArray(t,e=t.length){return this.Set(t,e)}SetAsBox(t,e,i,s=0){if(this.m_count=4,this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i instanceof r.A){this.m_centroid.Copy(i);const t=new r.z;t.SetPosition(i),t.SetRotationAngle(s);for(let e=0;e<this.m_count;++e)r.z.MulXV(t,this.m_vertices[e],this.m_vertices[e]),r.t.MulRV(t.q,this.m_normals[e],this.m_normals[e])}return this}TestPoint(t,e){const i=r.z.MulTXV(t,e,zt.TestPoint_s_pLocal);for(let t=0;t<this.m_count;++t){if(r.A.DotVV(this.m_normals[t],r.A.SubVV(i,this.m_vertices[t],r.A.s_t0))>0)return!1}return!0}ComputeDistance(t,e,i,s){const o=r.z.MulTXV(t,e,zt.ComputeDistance_s_pLocal);let a=-n.x;const l=zt.ComputeDistance_s_normalForMaxDistance.Copy(o);for(let t=0;t<this.m_count;++t){const e=r.A.DotVV(this.m_normals[t],r.A.SubVV(o,this.m_vertices[t],r.A.s_t0));e>a&&(a=e,l.Copy(this.m_normals[t]))}if(a>0){const e=zt.ComputeDistance_s_minDistance.Copy(l);let s=a*a;for(let t=0;t<this.m_count;++t){const i=r.A.SubVV(o,this.m_vertices[t],zt.ComputeDistance_s_distance),n=i.LengthSquared();s>n&&(e.Copy(i),s=n)}return r.t.MulRV(t.q,e,i),i.Normalize(),Math.sqrt(s)}return r.t.MulRV(t.q,l,i),a}RayCast(t,e,i,s){const n=r.z.MulTXV(i,e.p1,zt.RayCast_s_p1),o=r.z.MulTXV(i,e.p2,zt.RayCast_s_p2),a=r.A.SubVV(o,n,zt.RayCast_s_d);let l=0,h=e.maxFraction,_=-1;for(let t=0;t<this.m_count;++t){const e=r.A.DotVV(this.m_normals[t],r.A.SubVV(this.m_vertices[t],n,r.A.s_t0)),i=r.A.DotVV(this.m_normals[t],a);if(0===i){if(e<0)return!1}else i<0&&e<l*i?(l=e/i,_=t):i>0&&e<h*i&&(h=e/i);if(h<l)return!1}return _>=0&&(t.fraction=l,r.t.MulRV(i.q,this.m_normals[_],t.normal),!0)}ComputeAABB(t,e,i){const s=r.z.MulXV(e,this.m_vertices[0],t.lowerBound),n=t.upperBound.Copy(s);for(let t=0;t<this.m_count;++t){const i=r.z.MulXV(e,this.m_vertices[t],zt.ComputeAABB_s_v);r.A.MinV(i,s,s),r.A.MaxV(i,n,n)}const o=this.m_radius;s.SelfSubXY(o,o),n.SelfAddXY(o,o)}ComputeMass(t,e){const i=zt.ComputeMass_s_center.SetZero();let s=0,n=0;const o=zt.ComputeMass_s_s.SetZero();for(let t=0;t<this.m_count;++t)o.SelfAdd(this.m_vertices[t]);o.SelfMul(1/this.m_count);for(let t=0;t<this.m_count;++t){const e=r.A.SubVV(this.m_vertices[t],o,zt.ComputeMass_s_e1),a=r.A.SubVV(this.m_vertices[(t+1)%this.m_count],o,zt.ComputeMass_s_e2),l=r.A.CrossVV(e,a),h=.5*l;s+=h,i.SelfAdd(r.A.MulSV(h*(1/3),r.A.AddVV(e,a,r.A.s_t0),r.A.s_t1));const _=e.x,c=e.y,m=a.x,u=a.y;n+=1/3*.25*l*(_*_+m*_+m*m+(c*c+u*c+u*u))}t.mass=e*s,i.SelfMul(1/s),r.A.AddVV(i,o,t.center),t.I=e*n,t.I+=t.mass*(r.A.DotVV(t.center,t.center)-r.A.DotVV(i,i))}Validate(){for(let t=0;t<this.m_count;++t){const e=t,i=(t+1)%this.m_count,s=this.m_vertices[e],n=r.A.SubVV(this.m_vertices[i],s,zt.Validate_s_e);for(let t=0;t<this.m_count;++t){if(t===e||t===i)continue;const o=r.A.SubVV(this.m_vertices[t],s,zt.Validate_s_v);if(r.A.CrossVV(n,o)<0)return!1}}return!0}SetupDistanceProxy(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,s){const o=r.t.MulTRV(i.q,t,zt.ComputeSubmergedArea_s_normalL),a=e-r.A.DotVV(t,i.p),l=zt.ComputeSubmergedArea_s_depths;let h=0,_=-1,c=-1,m=!1;for(let t=0;t<this.m_count;++t){l[t]=r.A.DotVV(o,this.m_vertices[t])-a;const e=l[t]<-n.r;t>0&&(e?m||(_=t-1,h++):m&&(c=t-1,h++)),m=e}switch(h){case 0:if(m){const t=zt.ComputeSubmergedArea_s_md;return this.ComputeMass(t,1),r.z.MulXV(i,t.center,s),t.mass}return 0;case 1:-1===_?_=this.m_count-1:c=this.m_count-1}const u=(_+1)%this.m_count,d=(c+1)%this.m_count,p=(0-l[_])/(l[u]-l[_]),f=(0-l[c])/(l[d]-l[c]),y=zt.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[_].x*(1-p)+this.m_vertices[u].x*p,this.m_vertices[_].y*(1-p)+this.m_vertices[u].y*p),A=zt.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[c].x*(1-f)+this.m_vertices[d].x*f,this.m_vertices[c].y*(1-f)+this.m_vertices[d].y*f);let g=0;const x=zt.ComputeSubmergedArea_s_center.SetZero();let w,b=this.m_vertices[u],S=u;for(;S!==d;){w=(S=(S+1)%this.m_count)===d?A:this.m_vertices[S];const t=.5*((b.x-y.x)*(w.y-y.y)-(b.y-y.y)*(w.x-y.x));g+=t,x.x+=t*(y.x+b.x+w.x)/3,x.y+=t*(y.y+b.y+w.y)/3,b=w}return x.SelfMul(1/g),r.z.MulXV(i,x,s),g}Dump(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = b2Vec2.MakeArray(%d);\n",n.D);for(let e=0;e<this.m_count;++e)t("    vs[%d].Set(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)}static ComputeCentroid(t,e,i){const s=i;s.SetZero();let n=0;const o=zt.ComputeCentroid_s_pRef.SetZero();for(let i=0;i<e;++i){const a=o,l=t[i],h=t[(i+1)%e],_=r.A.SubVV(l,a,zt.ComputeCentroid_s_e1),c=r.A.SubVV(h,a,zt.ComputeCentroid_s_e2),m=.5*r.A.CrossVV(_,c);n+=m,s.x+=m*(1/3)*(a.x+l.x+h.x),s.y+=m*(1/3)*(a.y+l.y+h.y)}return s.SelfMul(1/n),s}}zt.Set_s_ps=r.A.MakeArray(n.D),zt.Set_s_hull=Object(n.g)(n.D),zt.Set_s_r=new r.A,zt.Set_s_v=new r.A,zt.TestPoint_s_pLocal=new r.A,zt.ComputeDistance_s_pLocal=new r.A,zt.ComputeDistance_s_normalForMaxDistance=new r.A,zt.ComputeDistance_s_minDistance=new r.A,zt.ComputeDistance_s_distance=new r.A,zt.RayCast_s_p1=new r.A,zt.RayCast_s_p2=new r.A,zt.RayCast_s_d=new r.A,zt.ComputeAABB_s_v=new r.A,zt.ComputeMass_s_center=new r.A,zt.ComputeMass_s_s=new r.A,zt.ComputeMass_s_e1=new r.A,zt.ComputeMass_s_e2=new r.A,zt.Validate_s_e=new r.A,zt.Validate_s_v=new r.A,zt.ComputeSubmergedArea_s_normalL=new r.A,zt.ComputeSubmergedArea_s_depths=Object(n.g)(n.D),zt.ComputeSubmergedArea_s_md=new Ot.a,zt.ComputeSubmergedArea_s_intoVec=new r.A,zt.ComputeSubmergedArea_s_outoVec=new r.A,zt.ComputeSubmergedArea_s_center=new r.A,zt.ComputeCentroid_s_pRef=new r.A,zt.ComputeCentroid_s_e1=new r.A,zt.ComputeCentroid_s_e2=new r.A;class qt extends Ot.b{constructor(){super(Ot.c.e_edgeShape,n.Q),this.m_vertex1=new r.A,this.m_vertex2=new r.A,this.m_vertex0=new r.A,this.m_vertex3=new r.A,this.m_hasVertex0=!1,this.m_hasVertex3=!1}Set(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this}Clone(){return(new qt).Copy(this)}Copy(t){return super.Copy(t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this}GetChildCount(){return 1}TestPoint(t,e){return!1}ComputeDistance(t,e,i,s){const n=r.z.MulXV(t,this.m_vertex1,qt.ComputeDistance_s_v1),o=r.z.MulXV(t,this.m_vertex2,qt.ComputeDistance_s_v2),a=r.A.SubVV(e,n,qt.ComputeDistance_s_d),l=r.A.SubVV(o,n,qt.ComputeDistance_s_s),h=r.A.DotVV(a,l);if(h>0){const t=r.A.DotVV(l,l);h>t?r.A.SubVV(e,o,a):a.SelfMulSub(h/t,l)}return i.Copy(a),i.Normalize()}RayCast(t,e,i,s){const n=r.z.MulTXV(i,e.p1,qt.RayCast_s_p1),o=r.z.MulTXV(i,e.p2,qt.RayCast_s_p2),a=r.A.SubVV(o,n,qt.RayCast_s_d),l=this.m_vertex1,h=this.m_vertex2,_=r.A.SubVV(h,l,qt.RayCast_s_e),c=t.normal.Set(_.y,-_.x).SelfNormalize(),m=r.A.DotVV(c,r.A.SubVV(l,n,r.A.s_t0)),u=r.A.DotVV(c,a);if(0===u)return!1;const d=m/u;if(d<0||e.maxFraction<d)return!1;const p=r.A.AddVMulSV(n,d,a,qt.RayCast_s_q),f=r.A.SubVV(h,l,qt.RayCast_s_r),y=r.A.DotVV(f,f);if(0===y)return!1;const A=r.A.DotVV(r.A.SubVV(p,l,r.A.s_t0),f)/y;return!(A<0||1<A)&&(t.fraction=d,r.t.MulRV(i.q,t.normal,t.normal),m>0&&t.normal.SelfNeg(),!0)}ComputeAABB(t,e,i){const s=r.z.MulXV(e,this.m_vertex1,qt.ComputeAABB_s_v1),n=r.z.MulXV(e,this.m_vertex2,qt.ComputeAABB_s_v2);r.A.MinV(s,n,t.lowerBound),r.A.MaxV(s,n,t.upperBound);const o=this.m_radius;t.lowerBound.SelfSubXY(o,o),t.upperBound.SelfAddXY(o,o)}ComputeMass(t,e){t.mass=0,r.A.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,s){return s.SetZero(),0}Dump(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)}}qt.ComputeDistance_s_v1=new r.A,qt.ComputeDistance_s_v2=new r.A,qt.ComputeDistance_s_d=new r.A,qt.ComputeDistance_s_s=new r.A,qt.RayCast_s_p1=new r.A,qt.RayCast_s_p2=new r.A,qt.RayCast_s_d=new r.A,qt.RayCast_s_e=new r.A,qt.RayCast_s_q=new r.A,qt.RayCast_s_r=new r.A,qt.ComputeAABB_s_v1=new r.A,qt.ComputeAABB_s_v2=new r.A;class Jt extends Ot.b{constructor(){super(Ot.c.e_chainShape,n.Q),this.m_count=0,this.m_prevVertex=new r.A,this.m_nextVertex=new r.A,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1}CreateLoop(t,e=t.length){this.m_count=e+1,this.m_vertices=r.A.MakeArray(this.m_count);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t[i]);return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}CreateChain(t,e=t.length){this.m_count=e,this.m_vertices=r.A.MakeArray(e);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t[i]);return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this}SetPrevVertex(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this}SetNextVertex(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this}Clone(){return(new Jt).Copy(this)}Copy(t){return super.Copy(t),this.CreateChain(t.m_vertices,t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this}GetChildCount(){return this.m_count-1}GetChildEdge(t,e){t.m_type=Ot.c.e_edgeShape,t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)}TestPoint(t,e){return!1}ComputeDistance(t,e,i,s){const n=Jt.ComputeDistance_s_edgeShape;return this.GetChildEdge(n,s),n.ComputeDistance(t,e,i,0)}RayCast(t,e,i,s){const n=Jt.RayCast_s_edgeShape;return n.m_vertex1.Copy(this.m_vertices[s]),n.m_vertex2.Copy(this.m_vertices[(s+1)%this.m_count]),n.RayCast(t,e,i,0)}ComputeAABB(t,e,i){const s=this.m_vertices[i],n=this.m_vertices[(i+1)%this.m_count],o=r.z.MulXV(e,s,Jt.ComputeAABB_s_v1),a=r.z.MulXV(e,n,Jt.ComputeAABB_s_v2);r.A.MinV(o,a,t.lowerBound),r.A.MaxV(o,a,t.upperBound)}ComputeMass(t,e){t.mass=0,t.center.SetZero(),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,s){return s.SetZero(),0}Dump(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = b2Vec2.MakeArray(%d);\n",n.D);for(let e=0;e<this.m_count;++e)t("    vs[%d].Set(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")}}Jt.ComputeDistance_s_edgeShape=new qt,Jt.RayCast_s_edgeShape=new qt,Jt.ComputeAABB_s_v1=new r.A,Jt.ComputeAABB_s_v2=new r.A;var Wt,Ut,Xt,Ht=i(360);!function(t){t[t.b2_unknown=-1]="b2_unknown",t[t.b2_staticBody=0]="b2_staticBody",t[t.b2_kinematicBody=1]="b2_kinematicBody",t[t.b2_dynamicBody=2]="b2_dynamicBody"}(Wt||(Wt={}));class Zt{constructor(){this.type=Wt.b2_staticBody,this.position=new r.A(0,0),this.angle=0,this.linearVelocity=new r.A(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1}}class Yt{constructor(t,e){this.m_type=Wt.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new r.z,this.m_xf0=new r.z,this.m_sweep=new r.y,this.m_linearVelocity=new r.A,this.m_angularVelocity=0,this.m_force=new r.A,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,t.bullet&&(this.m_bulletFlag=!0),t.fixedRotation&&(this.m_fixedRotationFlag=!0),t.allowSleep&&(this.m_autoSleepFlag=!0),t.awake&&(this.m_awakeFlag=!0),t.active&&(this.m_activeFlag=!0),this.m_world=e,this.m_xf.p.Copy(t.position),this.m_xf.q.SetAngle(t.angle),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=t.angle,this.m_sweep.a=t.angle,this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(t.linearVelocity),this.m_angularVelocity=t.angularVelocity,this.m_linearDamping=t.linearDamping,this.m_angularDamping=t.angularDamping,this.m_gravityScale=t.gravityScale,this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=t.type,t.type===Wt.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}CreateFixture(t,e){if(t instanceof Ht.c)return this.CreateFixtureDef(t);if(t instanceof Ot.b&&"number"==typeof e)return this.CreateFixtureShapeDensity(t,e);throw new Error}CreateFixtureDef(t){if(this.m_world.IsLocked())return null;const e=new Ht.b(t,this);if(e.Create(t),this.m_activeFlag){const t=this.m_world.m_contactManager.m_broadPhase;e.CreateProxies(t,this.m_xf)}return e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e}CreateFixtureShapeDensity(t,e=0){const i=Yt.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)}DestroyFixture(t){if(this.m_world.IsLocked())return;let e=this.m_fixtureList,i=null;for(;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}let s=this.m_contactList;for(;s;){const e=s.contact;s=s.next;const i=e.GetFixtureA(),n=e.GetFixtureB();t!==i&&t!==n||this.m_world.m_contactManager.Destroy(e)}if(this.m_activeFlag){const e=this.m_world.m_contactManager.m_broadPhase;t.DestroyProxies(e)}t.Destroy(),t.m_next=null,--this.m_fixtureCount,this.ResetMassData()}SetTransformVec(t,e){this.SetTransformXY(t.x,t.y,e)}SetTransformXY(t,e,i){if(this.m_world.IsLocked())return;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),r.z.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;const s=this.m_world.m_contactManager.m_broadPhase;for(let t=this.m_fixtureList;t;t=t.m_next)t.Synchronize(s,this.m_xf,this.m_xf);this.m_world.m_contactManager.FindNewContacts()}SetTransform(t){this.SetTransformVec(t.p,t.GetAngle())}GetTransform(){return this.m_xf}GetPosition(){return this.m_xf.p}SetPosition(t){this.SetTransformVec(t,this.GetAngle())}SetPositionXY(t,e){this.SetTransformXY(t,e,this.GetAngle())}GetAngle(){return this.m_sweep.a}SetAngle(t){this.SetTransformVec(this.GetPosition(),t)}GetWorldCenter(){return this.m_sweep.c}GetLocalCenter(){return this.m_sweep.localCenter}SetLinearVelocity(t){this.m_type!==Wt.b2_staticBody&&(r.A.DotVV(t,t)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(t))}GetLinearVelocity(){return this.m_linearVelocity}SetAngularVelocity(t){this.m_type!==Wt.b2_staticBody&&(t*t>0&&this.SetAwake(!0),this.m_angularVelocity=t)}GetAngularVelocity(){return this.m_angularVelocity}GetDefinition(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t}ApplyForce(t,e,i=!0){this.m_type===Wt.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))}ApplyForceToCenter(t,e=!0){this.m_type===Wt.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y))}ApplyTorque(t,e=!0){this.m_type===Wt.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))}ApplyLinearImpulse(t,e,i=!0){this.m_type===Wt.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)))}ApplyLinearImpulseToCenter(t,e=!0){this.m_type===Wt.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y))}ApplyAngularImpulse(t,e=!0){this.m_type===Wt.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))}GetMass(){return this.m_mass}GetInertia(){return this.m_I+this.m_mass*r.A.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)}GetMassData(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*r.A.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t}SetMassData(t){if(this.m_world.IsLocked())return;if(this.m_type!==Wt.b2_dynamicBody)return;this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&!this.m_fixedRotationFlag&&(this.m_I=t.I-this.m_mass*r.A.DotVV(t.center,t.center),this.m_invI=1/this.m_I);const e=Yt.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t.center),r.z.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),r.A.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,r.A.SubVV(this.m_sweep.c,e,r.A.s_t0),this.m_linearVelocity)}ResetMassData(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===Wt.b2_staticBody||this.m_type===Wt.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);const t=Yt.ResetMassData_s_localCenter.SetZero();for(let e=this.m_fixtureList;e;e=e.m_next){if(0===e.m_density)continue;const i=e.GetMassData(Yt.ResetMassData_s_massData);this.m_mass+=i.mass,t.x+=i.center.x*i.mass,t.y+=i.center.y*i.mass,this.m_I+=i.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,t.x*=this.m_invMass,t.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*r.A.DotVV(t,t),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);const e=Yt.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t),r.z.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),r.A.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,r.A.SubVV(this.m_sweep.c,e,r.A.s_t0),this.m_linearVelocity)}GetWorldPoint(t,e){return r.z.MulXV(this.m_xf,t,e)}GetWorldVector(t,e){return r.t.MulRV(this.m_xf.q,t,e)}GetLocalPoint(t,e){return r.z.MulTXV(this.m_xf,t,e)}GetLocalVector(t,e){return r.t.MulTRV(this.m_xf.q,t,e)}GetLinearVelocityFromWorldPoint(t,e){return r.A.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,r.A.SubVV(t,this.m_sweep.c,r.A.s_t0),e)}GetLinearVelocityFromLocalPoint(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)}GetLinearDamping(){return this.m_linearDamping}SetLinearDamping(t){this.m_linearDamping=t}GetAngularDamping(){return this.m_angularDamping}SetAngularDamping(t){this.m_angularDamping=t}GetGravityScale(){return this.m_gravityScale}SetGravityScale(t){this.m_gravityScale=t}SetType(t){if(this.m_world.IsLocked())return;if(this.m_type===t)return;this.m_type=t,this.ResetMassData(),this.m_type===Wt.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;let e=this.m_contactList;for(;e;){const t=e;e=e.next,this.m_world.m_contactManager.Destroy(t.contact)}this.m_contactList=null;const i=this.m_world.m_contactManager.m_broadPhase;for(let t=this.m_fixtureList;t;t=t.m_next){const e=t.m_proxyCount;for(let s=0;s<e;++s)i.TouchProxy(t.m_proxies[s].treeNode)}}GetType(){return this.m_type}SetBullet(t){this.m_bulletFlag=t}IsBullet(){return this.m_bulletFlag}SetSleepingAllowed(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)}IsSleepingAllowed(){return this.m_autoSleepFlag}SetAwake(t){t?this.m_awakeFlag||(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)}IsAwake(){return this.m_awakeFlag}SetActive(t){if(t!==this.IsActive())if(this.m_activeFlag=t,t){const t=this.m_world.m_contactManager.m_broadPhase;for(let e=this.m_fixtureList;e;e=e.m_next)e.CreateProxies(t,this.m_xf)}else{const t=this.m_world.m_contactManager.m_broadPhase;for(let e=this.m_fixtureList;e;e=e.m_next)e.DestroyProxies(t);let e=this.m_contactList;for(;e;){const t=e;e=e.next,this.m_world.m_contactManager.Destroy(t.contact)}this.m_contactList=null}}IsActive(){return this.m_activeFlag}SetFixedRotation(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())}IsFixedRotation(){return this.m_fixedRotationFlag}GetFixtureList(){return this.m_fixtureList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactList}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}GetWorld(){return this.m_world}Dump(t){const e=this.m_islandIndex;t("{\n"),t("  const bd: b2BodyDef = new b2BodyDef();\n");let i="";switch(this.m_type){case Wt.b2_staticBody:i="b2BodyType.b2_staticBody";break;case Wt.b2_kinematicBody:i="b2BodyType.b2_kinematicBody";break;case Wt.b2_dynamicBody:i="b2BodyType.b2_dynamicBody"}t("  bd.type = %s;\n",i),t("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),t("  bd.angle = %.15f;\n",this.m_sweep.a),t("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),t("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),t("  bd.linearDamping = %.15f;\n",this.m_linearDamping),t("  bd.angularDamping = %.15f;\n",this.m_angularDamping),t("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),t("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),t("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),t("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),t("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),t("  bd.gravityScale = %.15f;\n",this.m_gravityScale),t("\n"),t("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),t("\n");for(let i=this.m_fixtureList;i;i=i.m_next)t("  {\n"),i.Dump(t,e),t("  }\n");t("}\n")}SynchronizeFixtures(){const t=Yt.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),r.t.MulRV(t.q,this.m_sweep.localCenter,t.p),r.A.SubVV(this.m_sweep.c0,t.p,t.p);const e=this.m_world.m_contactManager.m_broadPhase;for(let i=this.m_fixtureList;i;i=i.m_next)i.Synchronize(e,t,this.m_xf)}SynchronizeTransform(){this.m_xf.q.SetAngle(this.m_sweep.a),r.t.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),r.A.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}ShouldCollide(t){return(this.m_type!==Wt.b2_staticBody||t.m_type!==Wt.b2_staticBody)&&this.ShouldCollideConnected(t)}ShouldCollideConnected(t){for(let e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0}Advance(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),r.t.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),r.A.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}GetControllerList(){return this.m_controllerList}GetControllerCount(){return this.m_controllerCount}}Yt.CreateFixtureShapeDensity_s_def=new Ht.c,Yt.SetMassData_s_oldCenter=new r.A,Yt.ResetMassData_s_localCenter=new r.A,Yt.ResetMassData_s_oldCenter=new r.A,Yt.ResetMassData_s_massData=new Ot.a,Yt.SynchronizeFixtures_s_xf1=new r.z,function(t){t[t.e_unknownJoint=0]="e_unknownJoint",t[t.e_revoluteJoint=1]="e_revoluteJoint",t[t.e_prismaticJoint=2]="e_prismaticJoint",t[t.e_distanceJoint=3]="e_distanceJoint",t[t.e_pulleyJoint=4]="e_pulleyJoint",t[t.e_mouseJoint=5]="e_mouseJoint",t[t.e_gearJoint=6]="e_gearJoint",t[t.e_wheelJoint=7]="e_wheelJoint",t[t.e_weldJoint=8]="e_weldJoint",t[t.e_frictionJoint=9]="e_frictionJoint",t[t.e_ropeJoint=10]="e_ropeJoint",t[t.e_motorJoint=11]="e_motorJoint",t[t.e_areaJoint=12]="e_areaJoint"}(Ut||(Ut={})),function(t){t[t.e_inactiveLimit=0]="e_inactiveLimit",t[t.e_atLowerLimit=1]="e_atLowerLimit",t[t.e_atUpperLimit=2]="e_atUpperLimit",t[t.e_equalLimits=3]="e_equalLimits"}(Xt||(Xt={}));class Qt{constructor(){this.linear=new r.A,this.angularA=0,this.angularB=0}SetZero(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this}Set(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this}}class Kt{constructor(t,e){this.prev=null,this.next=null,this.joint=t,this.other=e}}class te{constructor(t){this.type=Ut.e_unknownJoint,this.userData=null,this.bodyA=null,this.bodyB=null,this.collideConnected=!1,this.type=t}}class ee{constructor(t){this.m_type=Ut.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=t.type,this.m_edgeA=new Kt(this,t.bodyB),this.m_edgeB=new Kt(this,t.bodyA),this.m_bodyA=t.bodyA,this.m_bodyB=t.bodyB,this.m_collideConnected=t.collideConnected,this.m_userData=t.userData}GetType(){return this.m_type}GetBodyA(){return this.m_bodyA}GetBodyB(){return this.m_bodyB}GetAnchorA(t){return t.SetZero()}GetAnchorB(t){return t.SetZero()}GetReactionForce(t,e){return e.SetZero()}GetReactionTorque(t){return 0}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}IsActive(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()}GetCollideConnected(){return this.m_collideConnected}Dump(t){t("// Dump is not supported for this joint type.\n")}ShiftOrigin(t){}InitVelocityConstraints(t){}SolveVelocityConstraints(t){}SolvePositionConstraints(t){return!1}}class ie extends te{constructor(){super(Ut.e_distanceJoint),this.localAnchorA=new r.A,this.localAnchorB=new r.A,this.length=1,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(s,this.localAnchorB),this.length=r.A.DistanceVV(i,s),this.frequencyHz=0,this.dampingRatio=0}}class se extends ee{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new r.A,this.m_localAnchorB=new r.A,this.m_gamma=0,this.m_impulse=0,this.m_length=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new r.A,this.m_rA=new r.A,this.m_rB=new r.A,this.m_localCenterA=new r.A,this.m_localCenterB=new r.A,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new r.t,this.m_qB=new r.t,this.m_lalcA=new r.A,this.m_lalcB=new r.A,this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_length=t.length}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.Set(t*this.m_impulse*this.m_u.x,t*this.m_impulse*this.m_u.y)}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetLength(t){this.m_length=t}Length(){return this.m_length}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const a=t.positions[this.m_indexB].c,l=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let _=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(l);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),r.t.MulRV(c,this.m_lalcA,this.m_rA),r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),r.t.MulRV(m,this.m_lalcB,this.m_rB),this.m_u.x=a.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=a.y+this.m_rB.y-e.y-this.m_rA.y;const u=this.m_u.Length();u>n.v?this.m_u.SelfMul(1/u):this.m_u.SetZero();const d=r.A.CrossVV(this.m_rA,this.m_u),p=r.A.CrossVV(this.m_rB,this.m_u);let f=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=0!==f?1/f:0,this.m_frequencyHz>0){const e=u-this.m_length,i=2*n.P*this.m_frequencyHz,s=2*this.m_mass*this.m_dampingRatio*i,r=this.m_mass*i*i,o=t.step.dt;this.m_gamma=o*(s+o*r),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=e*o*r*this.m_gamma,f+=this.m_gamma,this.m_mass=0!==f?1/f:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=r.A.MulSV(this.m_impulse,this.m_u,se.InitVelocityConstraints_s_P);s.SelfMulSub(this.m_invMassA,e),o-=this.m_invIA*r.A.CrossVV(this.m_rA,e),h.SelfMulAdd(this.m_invMassB,e),_+=this.m_invIB*r.A.CrossVV(this.m_rB,e)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=_}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=r.A.AddVCrossSV(e,i,this.m_rA,se.SolveVelocityConstraints_s_vpA),a=r.A.AddVCrossSV(s,n,this.m_rB,se.SolveVelocityConstraints_s_vpB),l=r.A.DotVV(this.m_u,r.A.SubVV(a,o,r.A.s_t0)),h=-this.m_mass*(l+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=h;const _=r.A.MulSV(h,this.m_u,se.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,_),i-=this.m_invIA*r.A.CrossVV(this.m_rA,_),s.SelfMulAdd(this.m_invMassB,_),n+=this.m_invIB*r.A.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){if(this.m_frequencyHz>0)return!0;const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;this.m_qA.SetAngle(i),this.m_qB.SetAngle(o);const a=r.t.MulRV(this.m_qA,this.m_lalcA,this.m_rA),l=r.t.MulRV(this.m_qB,this.m_lalcB,this.m_rB),h=this.m_u;h.x=s.x+l.x-e.x-a.x,h.y=s.y+l.y-e.y-a.y;let _=this.m_u.Normalize()-this.m_length;_=Object(r.e)(_,-n.y,n.y);const c=-this.m_mass*_,m=r.A.MulSV(c,h,se.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,m),i-=this.m_invIA*r.A.CrossVV(a,m),s.SelfMulAdd(this.m_invMassB,m),o+=this.m_invIB*r.A.CrossVV(l,m),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,Object(r.a)(_)<n.v}}se.InitVelocityConstraints_s_P=new r.A,se.SolveVelocityConstraints_s_vpA=new r.A,se.SolveVelocityConstraints_s_vpB=new r.A,se.SolveVelocityConstraints_s_P=new r.A,se.SolvePositionConstraints_s_P=new r.A;class ne extends te{constructor(){super(Ut.e_areaJoint),this.world=null,this.bodies=[],this.frequencyHz=0,this.dampingRatio=0}AddBody(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)}}class re extends ee{constructor(t){super(t),this.m_bodies=null,this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_impulse=0,this.m_targetLengths=null,this.m_targetArea=0,this.m_normals=null,this.m_joints=null,this.m_deltas=null,this.m_delta=null,this.m_bodies=t.bodies,this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_targetLengths=Object(n.g)(t.bodies.length),this.m_normals=r.A.MakeArray(t.bodies.length),this.m_joints=Object(n.f)(t.bodies.length),this.m_deltas=r.A.MakeArray(t.bodies.length),this.m_delta=new r.A;const e=new ie;e.frequencyHz=t.frequencyHz,e.dampingRatio=t.dampingRatio,this.m_targetArea=0;for(let i=0;i<this.m_bodies.length;++i){const s=this.m_bodies[i],n=this.m_bodies[(i+1)%this.m_bodies.length],o=s.GetWorldCenter(),a=n.GetWorldCenter();this.m_targetLengths[i]=r.A.DistanceVV(o,a),this.m_targetArea+=r.A.CrossVV(o,a),e.Initialize(s,n,o,a),this.m_joints[i]=t.world.CreateJoint(e)}this.m_targetArea*=.5}GetAnchorA(t){return t.SetZero()}GetAnchorB(t){return t.SetZero()}GetReactionForce(t,e){return e.SetZero()}GetReactionTorque(t){return 0}SetFrequency(t){this.m_frequencyHz=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)}GetDampingRatio(){return this.m_dampingRatio}Dump(t){t("Area joint dumping is not supported.\n")}InitVelocityConstraints(t){for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],s=this.m_bodies[(e+1)%this.m_bodies.length],n=t.positions[i.m_islandIndex].c,o=t.positions[s.m_islandIndex].c,a=this.m_deltas[e];r.A.SubVV(o,n,a)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.velocities[i.m_islandIndex].v,n=this.m_deltas[e];s.x+=i.m_invMass*n.y*.5*this.m_impulse,s.y+=i.m_invMass*-n.x*.5*this.m_impulse}}else this.m_impulse=0}SolveVelocityConstraints(t){let e=0,i=0;for(let s=0;s<this.m_bodies.length;++s){const n=this.m_bodies[s],o=t.velocities[n.m_islandIndex].v,a=this.m_deltas[s];e+=a.LengthSquared()/n.GetMass(),i+=r.A.CrossVV(o,a)}const s=-2*i/e;this.m_impulse+=s;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],n=t.velocities[i.m_islandIndex].v,r=this.m_deltas[e];n.x+=i.m_invMass*r.y*.5*s,n.y+=i.m_invMass*-r.x*.5*s}}SolvePositionConstraints(t){let e=0,i=0;for(let s=0;s<this.m_bodies.length;++s){const o=this.m_bodies[s],a=this.m_bodies[(s+1)%this.m_bodies.length],l=t.positions[o.m_islandIndex].c,h=t.positions[a.m_islandIndex].c,_=r.A.SubVV(h,l,this.m_delta);let c=_.Length();c<n.r&&(c=1),this.m_normals[s].x=_.y/c,this.m_normals[s].y=-_.x/c,e+=c,i+=r.A.CrossVV(l,h)}i*=.5;const s=.5*(this.m_targetArea-i)/e;let o=!0;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],a=t.positions[i.m_islandIndex].c,l=(e+1)%this.m_bodies.length,h=r.A.AddVV(this.m_normals[e],this.m_normals[l],this.m_delta);h.SelfMul(s);const _=h.LengthSquared();_>Object(r.v)(n.y)&&h.SelfMul(n.y/Object(r.w)(_)),_>Object(r.v)(n.v)&&(o=!1),a.x+=h.x,a.y+=h.y}return o}}class oe extends te{constructor(){super(Ut.e_frictionJoint),this.localAnchorA=new r.A,this.localAnchorB=new r.A,this.maxForce=0,this.maxTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)}}class ae extends ee{constructor(t){super(t),this.m_localAnchorA=new r.A,this.m_localAnchorB=new r.A,this.m_linearImpulse=new r.A,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new r.A,this.m_rB=new r.A,this.m_localCenterA=new r.A,this.m_localCenterB=new r.A,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new r.k,this.m_angularMass=0,this.m_qA=new r.t,this.m_qB=new r.t,this.m_lalcA=new r.A,this.m_lalcB=new r.A,this.m_K=new r.k,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_linearImpulse.SetZero(),this.m_maxForce=t.maxForce,this.m_maxTorque=t.maxTorque,this.m_linearMass.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(e),h=this.m_qB.SetAngle(n);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const _=r.t.MulRV(l,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const c=r.t.MulRV(h,this.m_lalcB,this.m_rB),m=this.m_invMassA,u=this.m_invMassB,d=this.m_invIA,p=this.m_invIB,f=this.m_K;if(f.ex.x=m+u+d*_.y*_.y+p*c.y*c.y,f.ex.y=-d*_.x*_.y-p*c.x*c.y,f.ey.x=f.ex.y,f.ey.y=m+u+d*_.x*_.x+p*c.x*c.x,f.GetInverse(this.m_linearMass),this.m_angularMass=d+p,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;i.SelfMulSub(m,e),s-=d*(r.A.CrossVV(this.m_rA,e)+this.m_angularImpulse),o.SelfMulAdd(u,e),a+=p*(r.A.CrossVV(this.m_rB,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB,_=t.step.dt;{const t=n-i;let e=-this.m_angularMass*t;const s=this.m_angularImpulse,o=_*this.m_maxTorque;this.m_angularImpulse=Object(r.e)(this.m_angularImpulse+e,-o,o),i-=l*(e=this.m_angularImpulse-s),n+=h*e}{const t=r.A.SubVV(r.A.AddVCrossSV(s,n,this.m_rB,r.A.s_t0),r.A.AddVCrossSV(e,i,this.m_rA,r.A.s_t1),ae.SolveVelocityConstraints_s_Cdot_v2),c=r.k.MulMV(this.m_linearMass,t,ae.SolveVelocityConstraints_s_impulseV).SelfNeg(),m=ae.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(c);const u=_*this.m_maxForce;this.m_linearImpulse.LengthSquared()>u*u&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(u)),r.A.SubVV(this.m_linearImpulse,m,c),e.SelfMulSub(o,c),i-=l*r.A.CrossVV(this.m_rA,c),s.SelfMulAdd(a,c),n+=h*r.A.CrossVV(this.m_rB,c)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){return!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.Set(t*this.m_linearImpulse.x,t*this.m_linearImpulse.y)}GetReactionTorque(t){return t*this.m_angularImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}ae.SolveVelocityConstraints_s_Cdot_v2=new r.A,ae.SolveVelocityConstraints_s_impulseV=new r.A,ae.SolveVelocityConstraints_s_oldImpulseV=new r.A;class le extends te{constructor(){super(Ut.e_gearJoint),this.joint1=null,this.joint2=null,this.ratio=1}}class he extends ee{constructor(t){let e,i;super(t),this.m_joint1=null,this.m_joint2=null,this.m_typeA=Ut.e_unknownJoint,this.m_typeB=Ut.e_unknownJoint,this.m_bodyC=null,this.m_bodyD=null,this.m_localAnchorA=new r.A,this.m_localAnchorB=new r.A,this.m_localAnchorC=new r.A,this.m_localAnchorD=new r.A,this.m_localAxisC=new r.A,this.m_localAxisD=new r.A,this.m_referenceAngleA=0,this.m_referenceAngleB=0,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_indexC=0,this.m_indexD=0,this.m_lcA=new r.A,this.m_lcB=new r.A,this.m_lcC=new r.A,this.m_lcD=new r.A,this.m_mA=0,this.m_mB=0,this.m_mC=0,this.m_mD=0,this.m_iA=0,this.m_iB=0,this.m_iC=0,this.m_iD=0,this.m_JvAC=new r.A,this.m_JvBD=new r.A,this.m_JwA=0,this.m_JwB=0,this.m_JwC=0,this.m_JwD=0,this.m_mass=0,this.m_qA=new r.t,this.m_qB=new r.t,this.m_qC=new r.t,this.m_qD=new r.t,this.m_lalcA=new r.A,this.m_lalcB=new r.A,this.m_lalcC=new r.A,this.m_lalcD=new r.A,this.m_joint1=t.joint1,this.m_joint2=t.joint2,this.m_typeA=this.m_joint1.GetType(),this.m_typeB=this.m_joint2.GetType(),this.m_bodyC=this.m_joint1.GetBodyA(),this.m_bodyA=this.m_joint1.GetBodyB();const s=this.m_bodyA.m_xf,n=this.m_bodyA.m_sweep.a,o=this.m_bodyC.m_xf,a=this.m_bodyC.m_sweep.a;if(this.m_typeA===Ut.e_revoluteJoint){const i=t.joint1;this.m_localAnchorC.Copy(i.m_localAnchorA),this.m_localAnchorA.Copy(i.m_localAnchorB),this.m_referenceAngleA=i.m_referenceAngle,this.m_localAxisC.SetZero(),e=n-a-this.m_referenceAngleA}else{const i=t.joint1;this.m_localAnchorC.Copy(i.m_localAnchorA),this.m_localAnchorA.Copy(i.m_localAnchorB),this.m_referenceAngleA=i.m_referenceAngle,this.m_localAxisC.Copy(i.m_localXAxisA);const n=this.m_localAnchorC,a=r.t.MulTRV(o.q,r.A.AddVV(r.t.MulRV(s.q,this.m_localAnchorA,r.A.s_t0),r.A.SubVV(s.p,o.p,r.A.s_t1),r.A.s_t0),r.A.s_t0);e=r.A.DotVV(r.A.SubVV(a,n,r.A.s_t0),this.m_localAxisC)}this.m_bodyD=this.m_joint2.GetBodyA(),this.m_bodyB=this.m_joint2.GetBodyB();const l=this.m_bodyB.m_xf,h=this.m_bodyB.m_sweep.a,_=this.m_bodyD.m_xf,c=this.m_bodyD.m_sweep.a;if(this.m_typeB===Ut.e_revoluteJoint){const e=t.joint2;this.m_localAnchorD.Copy(e.m_localAnchorA),this.m_localAnchorB.Copy(e.m_localAnchorB),this.m_referenceAngleB=e.m_referenceAngle,this.m_localAxisD.SetZero(),i=h-c-this.m_referenceAngleB}else{const e=t.joint2;this.m_localAnchorD.Copy(e.m_localAnchorA),this.m_localAnchorB.Copy(e.m_localAnchorB),this.m_referenceAngleB=e.m_referenceAngle,this.m_localAxisD.Copy(e.m_localXAxisA);const s=this.m_localAnchorD,n=r.t.MulTRV(_.q,r.A.AddVV(r.t.MulRV(l.q,this.m_localAnchorB,r.A.s_t0),r.A.SubVV(l.p,_.p,r.A.s_t1),r.A.s_t0),r.A.s_t0);i=r.A.DotVV(r.A.SubVV(n,s,r.A.s_t0),this.m_localAxisD)}this.m_ratio=t.ratio,this.m_constant=e+this.m_ratio*i,this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=t.positions[this.m_indexC].a,h=t.velocities[this.m_indexC].v;let _=t.velocities[this.m_indexC].w;const c=t.positions[this.m_indexD].a,m=t.velocities[this.m_indexD].v;let u=t.velocities[this.m_indexD].w;const d=this.m_qA.SetAngle(e),p=this.m_qB.SetAngle(n),f=this.m_qC.SetAngle(l),y=this.m_qD.SetAngle(c);if(this.m_mass=0,this.m_typeA===Ut.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{const t=r.t.MulRV(f,this.m_localAxisC,he.InitVelocityConstraints_s_u);r.A.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);const e=r.t.MulRV(f,this.m_lalcC,he.InitVelocityConstraints_s_rC);r.A.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);const i=r.t.MulRV(d,this.m_lalcA,he.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(t),this.m_JwC=r.A.CrossVV(e,t),this.m_JwA=r.A.CrossVV(i,t),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===Ut.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{const t=r.t.MulRV(y,this.m_localAxisD,he.InitVelocityConstraints_s_u);r.A.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);const e=r.t.MulRV(y,this.m_lalcD,he.InitVelocityConstraints_s_rD);r.A.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);const i=r.t.MulRV(p,this.m_lalcB,he.InitVelocityConstraints_s_rB);r.A.MulSV(this.m_ratio,t,this.m_JvBD),this.m_JwD=this.m_ratio*r.A.CrossVV(e,t),this.m_JwB=this.m_ratio*r.A.CrossVV(i,t),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,t.step.warmStarting?(i.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),s+=this.m_iA*this.m_impulse*this.m_JwA,o.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),a+=this.m_iB*this.m_impulse*this.m_JwB,h.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),_-=this.m_iC*this.m_impulse*this.m_JwC,m.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),u-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=a,t.velocities[this.m_indexC].w=_,t.velocities[this.m_indexD].w=u}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=t.velocities[this.m_indexC].v;let a=t.velocities[this.m_indexC].w;const l=t.velocities[this.m_indexD].v;let h=t.velocities[this.m_indexD].w,_=r.A.DotVV(this.m_JvAC,r.A.SubVV(e,o,r.A.s_t0))+r.A.DotVV(this.m_JvBD,r.A.SubVV(s,l,r.A.s_t0));_+=this.m_JwA*i-this.m_JwC*a+(this.m_JwB*n-this.m_JwD*h);const c=-this.m_mass*_;this.m_impulse+=c,e.SelfMulAdd(this.m_mA*c,this.m_JvAC),i+=this.m_iA*c*this.m_JwA,s.SelfMulAdd(this.m_mB*c,this.m_JvBD),n+=this.m_iB*c*this.m_JwB,o.SelfMulSub(this.m_mC*c,this.m_JvAC),a-=this.m_iC*c*this.m_JwC,l.SelfMulSub(this.m_mD*c,this.m_JvBD),h-=this.m_iD*c*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n,t.velocities[this.m_indexC].w=a,t.velocities[this.m_indexD].w=h}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const a=t.positions[this.m_indexC].c;let l=t.positions[this.m_indexC].a;const h=t.positions[this.m_indexD].c;let _=t.positions[this.m_indexD].a;const c=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(o),u=this.m_qC.SetAngle(l),d=this.m_qD.SetAngle(_);let p,f;const y=this.m_JvAC,A=this.m_JvBD;let g,x,w,b,S=0;if(this.m_typeA===Ut.e_revoluteJoint)y.SetZero(),g=1,w=1,S+=this.m_iA+this.m_iC,p=i-l-this.m_referenceAngleA;else{const t=r.t.MulRV(u,this.m_localAxisC,he.SolvePositionConstraints_s_u),i=r.t.MulRV(u,this.m_lalcC,he.SolvePositionConstraints_s_rC),s=r.t.MulRV(c,this.m_lalcA,he.SolvePositionConstraints_s_rA);y.Copy(t),w=r.A.CrossVV(i,t),g=r.A.CrossVV(s,t),S+=this.m_mC+this.m_mA+this.m_iC*w*w+this.m_iA*g*g;const n=this.m_lalcC,o=r.t.MulTRV(u,r.A.AddVV(s,r.A.SubVV(e,a,r.A.s_t0),r.A.s_t0),r.A.s_t0);p=r.A.DotVV(r.A.SubVV(o,n,r.A.s_t0),this.m_localAxisC)}if(this.m_typeB===Ut.e_revoluteJoint)A.SetZero(),x=this.m_ratio,b=this.m_ratio,S+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),f=o-_-this.m_referenceAngleB;else{const t=r.t.MulRV(d,this.m_localAxisD,he.SolvePositionConstraints_s_u),e=r.t.MulRV(d,this.m_lalcD,he.SolvePositionConstraints_s_rD),i=r.t.MulRV(m,this.m_lalcB,he.SolvePositionConstraints_s_rB);r.A.MulSV(this.m_ratio,t,A),b=this.m_ratio*r.A.CrossVV(e,t),x=this.m_ratio*r.A.CrossVV(i,t),S+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*b*b+this.m_iB*x*x;const n=this.m_lalcD,o=r.t.MulTRV(d,r.A.AddVV(i,r.A.SubVV(s,h,r.A.s_t0),r.A.s_t0),r.A.s_t0);f=r.A.DotVV(r.A.SubVV(o,n,r.A.s_t0),this.m_localAxisD)}const v=p+this.m_ratio*f-this.m_constant;let C=0;return S>0&&(C=-v/S),e.SelfMulAdd(this.m_mA*C,y),i+=this.m_iA*C*g,s.SelfMulAdd(this.m_mB*C,A),o+=this.m_iB*C*x,a.SelfMulSub(this.m_mC*C,y),l-=this.m_iC*C*w,h.SelfMulSub(this.m_mD*C,A),_-=this.m_iD*C*b,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,t.positions[this.m_indexC].a=l,t.positions[this.m_indexD].a=_,0<n.v}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return r.A.MulSV(t*this.m_impulse,this.m_JvAC,e)}GetReactionTorque(t){return t*this.m_impulse*this.m_JwA}GetJoint1(){return this.m_joint1}GetJoint2(){return this.m_joint2}GetRatio(){return this.m_ratio}SetRatio(t){this.m_ratio=t}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,s=this.m_joint1.m_index,n=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",s),t("  jd.joint2 = joints[%d];\n",n),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}he.InitVelocityConstraints_s_u=new r.A,he.InitVelocityConstraints_s_rA=new r.A,he.InitVelocityConstraints_s_rB=new r.A,he.InitVelocityConstraints_s_rC=new r.A,he.InitVelocityConstraints_s_rD=new r.A,he.SolvePositionConstraints_s_u=new r.A,he.SolvePositionConstraints_s_rA=new r.A,he.SolvePositionConstraints_s_rB=new r.A,he.SolvePositionConstraints_s_rC=new r.A,he.SolvePositionConstraints_s_rD=new r.A;class _e extends te{constructor(){super(Ut.e_motorJoint),this.linearOffset=new r.A(0,0),this.angularOffset=0,this.maxForce=1,this.maxTorque=1,this.correctionFactor=.3}Initialize(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);const i=this.bodyA.GetAngle(),s=this.bodyB.GetAngle();this.angularOffset=s-i}}class ce extends ee{constructor(t){super(t),this.m_linearOffset=new r.A,this.m_angularOffset=0,this.m_linearImpulse=new r.A,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_correctionFactor=.3,this.m_indexA=0,this.m_indexB=0,this.m_rA=new r.A,this.m_rB=new r.A,this.m_localCenterA=new r.A,this.m_localCenterB=new r.A,this.m_linearError=new r.A,this.m_angularError=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new r.k,this.m_angularMass=0,this.m_qA=new r.t,this.m_qB=new r.t,this.m_K=new r.k,this.m_linearOffset.Copy(t.linearOffset),this.m_linearImpulse.SetZero(),this.m_maxForce=t.maxForce,this.m_maxTorque=t.maxTorque,this.m_correctionFactor=t.correctionFactor}GetAnchorA(){return this.m_bodyA.GetPosition()}GetAnchorB(){return this.m_bodyB.GetPosition()}GetReactionForce(t,e){return r.A.MulSV(t,this.m_linearImpulse,e)}GetReactionTorque(t){return t*this.m_angularImpulse}SetLinearOffset(t){r.A.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))}GetLinearOffset(){return this.m_linearOffset}SetAngularOffset(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)}GetAngularOffset(){return this.m_angularOffset}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;const _=this.m_qA.SetAngle(i),c=this.m_qB.SetAngle(a),m=r.t.MulRV(_,r.A.SubVV(this.m_linearOffset,this.m_localCenterA,r.A.s_t0),this.m_rA),u=r.t.MulRV(c,r.A.NegV(this.m_localCenterB,r.A.s_t0),this.m_rB),d=this.m_invMassA,p=this.m_invMassB,f=this.m_invIA,y=this.m_invIB,A=this.m_K;if(A.ex.x=d+p+f*m.y*m.y+y*u.y*u.y,A.ex.y=-f*m.x*m.y-y*u.x*u.y,A.ey.x=A.ex.y,A.ey.y=d+p+f*m.x*m.x+y*u.x*u.x,A.GetInverse(this.m_linearMass),this.m_angularMass=f+y,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),r.A.SubVV(r.A.AddVV(o,u,r.A.s_t0),r.A.AddVV(e,m,r.A.s_t1),this.m_linearError),this.m_angularError=a-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;s.SelfMulSub(d,e),n-=f*(r.A.CrossVV(m,e)+this.m_angularImpulse),l.SelfMulAdd(p,e),h+=y*(r.A.CrossVV(u,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=h}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB,_=t.step.dt,c=t.step.inv_dt;{const t=n-i+c*this.m_correctionFactor*this.m_angularError;let e=-this.m_angularMass*t;const s=this.m_angularImpulse,o=_*this.m_maxTorque;this.m_angularImpulse=Object(r.e)(this.m_angularImpulse+e,-o,o),i-=l*(e=this.m_angularImpulse-s),n+=h*e}{const t=this.m_rA,m=this.m_rB,u=r.A.AddVV(r.A.SubVV(r.A.AddVV(s,r.A.CrossSV(n,m,r.A.s_t0),r.A.s_t0),r.A.AddVV(e,r.A.CrossSV(i,t,r.A.s_t1),r.A.s_t1),r.A.s_t2),r.A.MulSV(c*this.m_correctionFactor,this.m_linearError,r.A.s_t3),ce.SolveVelocityConstraints_s_Cdot_v2),d=r.k.MulMV(this.m_linearMass,u,ce.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),p=ce.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(d);const f=_*this.m_maxForce;this.m_linearImpulse.LengthSquared()>f*f&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(f)),r.A.SubVV(this.m_linearImpulse,p,d),e.SelfMulSub(o,d),i-=l*r.A.CrossVV(t,d),s.SelfMulAdd(a,d),n+=h*r.A.CrossVV(m,d)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){return!0}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}ce.SolveVelocityConstraints_s_Cdot_v2=new r.A,ce.SolveVelocityConstraints_s_impulse_v2=new r.A,ce.SolveVelocityConstraints_s_oldImpulse_v2=new r.A;class me extends te{constructor(){super(Ut.e_mouseJoint),this.target=new r.A,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7}}class ue extends ee{constructor(t){super(t),this.m_localAnchorB=null,this.m_targetA=null,this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_beta=0,this.m_impulse=null,this.m_maxForce=0,this.m_gamma=0,this.m_indexA=0,this.m_indexB=0,this.m_rB=null,this.m_localCenterB=null,this.m_invMassB=0,this.m_invIB=0,this.m_mass=null,this.m_C=null,this.m_qB=null,this.m_lalcB=null,this.m_K=null,this.m_localAnchorB=new r.A,this.m_targetA=new r.A,this.m_impulse=new r.A,this.m_rB=new r.A,this.m_localCenterB=new r.A,this.m_mass=new r.k,this.m_C=new r.A,this.m_qB=new r.t,this.m_lalcB=new r.A,this.m_K=new r.k,this.m_targetA.Copy(t.target),r.z.MulTXV(this.m_bodyB.GetTransform(),this.m_targetA,this.m_localAnchorB),this.m_maxForce=t.maxForce,this.m_impulse.SetZero(),this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_beta=0,this.m_gamma=0}SetTarget(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)}GetTarget(){return this.m_targetA}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const a=this.m_qB.SetAngle(i),l=this.m_bodyB.GetMass(),h=2*n.P*this.m_frequencyHz,_=2*l*this.m_dampingRatio*h,c=l*(h*h),m=t.step.dt;this.m_gamma=m*(_+m*c),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=m*c*this.m_gamma,r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),r.t.MulRV(a,this.m_lalcB,this.m_rB);const u=this.m_K;u.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,u.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,u.ey.x=u.ex.y,u.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,u.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),o*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),s.x+=this.m_invMassB*this.m_impulse.x,s.y+=this.m_invMassB*this.m_impulse.y,o+=this.m_invIB*r.A.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexB].v;let i=t.velocities[this.m_indexB].w;const s=r.A.AddVCrossSV(e,i,this.m_rB,ue.SolveVelocityConstraints_s_Cdot),n=r.k.MulMV(this.m_mass,r.A.AddVV(s,r.A.AddVV(this.m_C,r.A.MulSV(this.m_gamma,this.m_impulse,r.A.s_t0),r.A.s_t0),r.A.s_t0).SelfNeg(),ue.SolveVelocityConstraints_s_impulse),o=ue.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(n);const a=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>a*a&&this.m_impulse.SelfMul(a/this.m_impulse.Length()),r.A.SubVV(this.m_impulse,o,n),e.SelfMulAdd(this.m_invMassB,n),i+=this.m_invIB*r.A.CrossVV(this.m_rB,n),t.velocities[this.m_indexB].w=i}SolvePositionConstraints(t){return!0}GetAnchorA(t){return t.Copy(this.m_targetA)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return r.A.MulSV(t,this.m_impulse,e)}GetReactionTorque(t){return 0}Dump(t){t("Mouse joint dumping is not supported.\n")}ShiftOrigin(t){this.m_targetA.SelfSub(t)}}ue.SolveVelocityConstraints_s_Cdot=new r.A,ue.SolveVelocityConstraints_s_impulse=new r.A,ue.SolveVelocityConstraints_s_oldImpulse=new r.A;class de extends te{constructor(){super(Ut.e_prismaticJoint),this.localAnchorA=null,this.localAnchorB=null,this.localAxisA=null,this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0,this.localAnchorA=new r.A,this.localAnchorB=new r.A,this.localAxisA=new r.A(1,0)}Initialize(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(s,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class pe extends ee{constructor(t){super(t),this.m_localAnchorA=new r.A,this.m_localAnchorB=new r.A,this.m_localXAxisA=new r.A,this.m_localYAxisA=new r.A,this.m_referenceAngle=0,this.m_impulse=new r.C(0,0,0),this.m_motorImpulse=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorForce=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_limitState=Xt.e_inactiveLimit,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new r.A,this.m_localCenterB=new r.A,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_axis=new r.A(0,0),this.m_perp=new r.A(0,0),this.m_s1=0,this.m_s2=0,this.m_a1=0,this.m_a2=0,this.m_K=new r.l,this.m_K3=new r.l,this.m_K2=new r.k,this.m_motorMass=0,this.m_qA=new r.t,this.m_qB=new r.t,this.m_lalcA=new r.A,this.m_lalcB=new r.A,this.m_rA=new r.A,this.m_rB=new r.A,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_localXAxisA.Copy(t.localAxisA).SelfNormalize(),r.A.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_referenceAngle=t.referenceAngle,this.m_lowerTranslation=t.lowerTranslation,this.m_upperTranslation=t.upperTranslation,this.m_maxMotorForce=t.maxMotorForce,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const a=t.positions[this.m_indexB].c,l=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let _=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(l);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const u=r.t.MulRV(c,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const d=r.t.MulRV(m,this.m_lalcB,this.m_rB),p=r.A.AddVV(r.A.SubVV(a,e,r.A.s_t0),r.A.SubVV(d,u,r.A.s_t1),pe.InitVelocityConstraints_s_d),f=this.m_invMassA,y=this.m_invMassB,A=this.m_invIA,g=this.m_invIB;if(r.t.MulRV(c,this.m_localXAxisA,this.m_axis),this.m_a1=r.A.CrossVV(r.A.AddVV(p,u,r.A.s_t0),this.m_axis),this.m_a2=r.A.CrossVV(d,this.m_axis),this.m_motorMass=f+y+A*this.m_a1*this.m_a1+g*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),r.t.MulRV(c,this.m_localYAxisA,this.m_perp),this.m_s1=r.A.CrossVV(r.A.AddVV(p,u,r.A.s_t0),this.m_perp),this.m_s2=r.A.CrossVV(d,this.m_perp),this.m_K.ex.x=f+y+A*this.m_s1*this.m_s1+g*this.m_s2*this.m_s2,this.m_K.ex.y=A*this.m_s1+g*this.m_s2,this.m_K.ex.z=A*this.m_s1*this.m_a1+g*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=A+g,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=A*this.m_a1+g*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=f+y+A*this.m_a1*this.m_a1+g*this.m_a2*this.m_a2,this.m_enableLimit){const t=r.A.DotVV(this.m_axis,p);Object(r.a)(this.m_upperTranslation-this.m_lowerTranslation)<2*n.v?this.m_limitState=Xt.e_equalLimits:t<=this.m_lowerTranslation?this.m_limitState!==Xt.e_atLowerLimit&&(this.m_limitState=Xt.e_atLowerLimit,this.m_impulse.z=0):t>=this.m_upperTranslation?this.m_limitState!==Xt.e_atUpperLimit&&(this.m_limitState=Xt.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=Xt.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=Xt.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;const e=r.A.AddVV(r.A.MulSV(this.m_impulse.x,this.m_perp,r.A.s_t0),r.A.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,r.A.s_t1),pe.InitVelocityConstraints_s_P),i=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,n=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;s.SelfMulSub(f,e),o-=A*i,h.SelfMulAdd(y,e),_+=g*n}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=_}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==Xt.e_equalLimits){const _=r.A.DotVV(this.m_axis,r.A.SubVV(s,e,r.A.s_t0))+this.m_a2*n-this.m_a1*i;let c=this.m_motorMass*(this.m_motorSpeed-_);const m=this.m_motorImpulse,u=t.step.dt*this.m_maxMotorForce;this.m_motorImpulse=Object(r.e)(this.m_motorImpulse+c,-u,u),c=this.m_motorImpulse-m;const d=r.A.MulSV(c,this.m_axis,pe.SolveVelocityConstraints_s_P),p=c*this.m_a1,f=c*this.m_a2;e.SelfMulSub(o,d),i-=l*p,s.SelfMulAdd(a,d),n+=h*f}const _=r.A.DotVV(this.m_perp,r.A.SubVV(s,e,r.A.s_t0))+this.m_s2*n-this.m_s1*i,c=n-i;if(this.m_enableLimit&&this.m_limitState!==Xt.e_inactiveLimit){const t=r.A.DotVV(this.m_axis,r.A.SubVV(s,e,r.A.s_t0))+this.m_a2*n-this.m_a1*i,m=pe.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),u=this.m_K.Solve33(-_,-c,-t,pe.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(u),this.m_limitState===Xt.e_atLowerLimit?this.m_impulse.z=Object(r.m)(this.m_impulse.z,0):this.m_limitState===Xt.e_atUpperLimit&&(this.m_impulse.z=Object(r.n)(this.m_impulse.z,0));const d=-_-(this.m_impulse.z-m.z)*this.m_K.ez.x,p=-c-(this.m_impulse.z-m.z)*this.m_K.ez.y,f=this.m_K.Solve22(d,p,pe.SolveVelocityConstraints_s_f2r);f.x+=m.x,f.y+=m.y,this.m_impulse.x=f.x,this.m_impulse.y=f.y,u.x=this.m_impulse.x-m.x,u.y=this.m_impulse.y-m.y,u.z=this.m_impulse.z-m.z;const y=r.A.AddVV(r.A.MulSV(u.x,this.m_perp,r.A.s_t0),r.A.MulSV(u.z,this.m_axis,r.A.s_t1),pe.SolveVelocityConstraints_s_P),A=u.x*this.m_s1+u.y+u.z*this.m_a1,g=u.x*this.m_s2+u.y+u.z*this.m_a2;e.SelfMulSub(o,y),i-=l*A,s.SelfMulAdd(a,y),n+=h*g}else{const t=this.m_K.Solve22(-_,-c,pe.SolveVelocityConstraints_s_df2);this.m_impulse.x+=t.x,this.m_impulse.y+=t.y;const m=r.A.MulSV(t.x,this.m_perp,pe.SolveVelocityConstraints_s_P),u=t.x*this.m_s1+t.y,d=t.x*this.m_s2+t.y;e.SelfMulSub(o,m),i-=l*u,s.SelfMulAdd(a,m),n+=h*d}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const a=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(o),h=this.m_invMassA,_=this.m_invMassB,c=this.m_invIA,m=this.m_invIB,u=r.t.MulRV(a,this.m_lalcA,this.m_rA),d=r.t.MulRV(l,this.m_lalcB,this.m_rB),p=r.A.SubVV(r.A.AddVV(s,d,r.A.s_t0),r.A.AddVV(e,u,r.A.s_t1),pe.SolvePositionConstraints_s_d),f=r.t.MulRV(a,this.m_localXAxisA,this.m_axis),y=r.A.CrossVV(r.A.AddVV(p,u,r.A.s_t0),f),A=r.A.CrossVV(d,f),g=r.t.MulRV(a,this.m_localYAxisA,this.m_perp),x=r.A.CrossVV(r.A.AddVV(p,u,r.A.s_t0),g),w=r.A.CrossVV(d,g);let b=pe.SolvePositionConstraints_s_impulse;const S=r.A.DotVV(g,p),v=o-i-this.m_referenceAngle;let C=Object(r.a)(S),B=Object(r.a)(v),V=!1,M=0;if(this.m_enableLimit){const t=r.A.DotVV(f,p);Object(r.a)(this.m_upperTranslation-this.m_lowerTranslation)<2*n.v?(M=Object(r.e)(t,-n.y,n.y),C=Object(r.m)(C,Object(r.a)(t)),V=!0):t<=this.m_lowerTranslation?(M=Object(r.e)(t-this.m_lowerTranslation+n.v,-n.y,0),C=Object(r.m)(C,this.m_lowerTranslation-t),V=!0):t>=this.m_upperTranslation&&(M=Object(r.e)(t-this.m_upperTranslation-n.v,0,n.y),C=Object(r.m)(C,t-this.m_upperTranslation),V=!0)}if(V){const t=h+_+c*x*x+m*w*w,e=c*x+m*w,i=c*x*y+m*w*A;let s=c+m;0===s&&(s=1);const n=c*y+m*A,r=h+_+c*y*y+m*A*A,o=this.m_K3;o.ex.SetXYZ(t,e,i),o.ey.SetXYZ(e,s,n),o.ez.SetXYZ(i,n,r),b=o.Solve33(-S,-v,-M,b)}else{const t=h+_+c*x*x+m*w*w,e=c*x+m*w;let i=c+m;0===i&&(i=1);const s=this.m_K2;s.ex.Set(t,e),s.ey.Set(e,i);const n=s.Solve(-S,-v,pe.SolvePositionConstraints_s_impulse1);b.x=n.x,b.y=n.y,b.z=0}const P=r.A.AddVV(r.A.MulSV(b.x,g,r.A.s_t0),r.A.MulSV(b.z,f,r.A.s_t1),pe.SolvePositionConstraints_s_P),I=b.x*x+b.y+b.z*y,D=b.x*w+b.y+b.z*A;return e.SelfMulSub(h,P),i-=c*I,s.SelfMulAdd(_,P),o+=m*D,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,C<=n.v&&B<=n.n}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.Set(t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))}GetReactionTorque(t){return t*this.m_impulse.y}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetReferenceAngle(){return this.m_referenceAngle}GetJointTranslation(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,pe.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,pe.GetJointTranslation_s_pB),i=r.A.SubVV(e,t,pe.GetJointTranslation_s_d),s=this.m_bodyA.GetWorldVector(this.m_localXAxisA,pe.GetJointTranslation_s_axis);return r.A.DotVV(i,s)}GetJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;r.A.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=r.t.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const s=r.t.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),n=r.A.AddVV(t.m_sweep.c,i,r.A.s_t0),o=r.A.AddVV(e.m_sweep.c,s,r.A.s_t1),a=r.A.SubVV(o,n,r.A.s_t2),l=t.GetWorldVector(this.m_localXAxisA,this.m_axis),h=t.m_linearVelocity,_=e.m_linearVelocity,c=t.m_angularVelocity,m=e.m_angularVelocity;return r.A.DotVV(a,r.A.CrossSV(c,l,r.A.s_t0))+r.A.DotVV(l,r.A.SubVV(r.A.AddVCrossSV(_,m,s,r.A.s_t0),r.A.AddVCrossSV(h,c,i,r.A.s_t1),r.A.s_t0))}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t}SetMotorSpeed(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorForce(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t}GetMaxMotorForce(){return this.m_maxMotorForce}GetMotorForce(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}pe.InitVelocityConstraints_s_d=new r.A,pe.InitVelocityConstraints_s_P=new r.A,pe.SolveVelocityConstraints_s_P=new r.A,pe.SolveVelocityConstraints_s_f2r=new r.A,pe.SolveVelocityConstraints_s_f1=new r.C,pe.SolveVelocityConstraints_s_df3=new r.C,pe.SolveVelocityConstraints_s_df2=new r.A,pe.SolvePositionConstraints_s_d=new r.A,pe.SolvePositionConstraints_s_impulse=new r.C,pe.SolvePositionConstraints_s_impulse1=new r.A,pe.SolvePositionConstraints_s_P=new r.A,pe.GetJointTranslation_s_pA=new r.A,pe.GetJointTranslation_s_pB=new r.A,pe.GetJointTranslation_s_d=new r.A,pe.GetJointTranslation_s_axis=new r.A;class fe extends te{constructor(){super(Ut.e_pulleyJoint),this.groundAnchorA=new r.A(-1,1),this.groundAnchorB=new r.A(1,1),this.localAnchorA=new r.A(-1,0),this.localAnchorB=new r.A(1,0),this.lengthA=0,this.lengthB=0,this.ratio=1,this.collideConnected=!0}Initialize(t,e,i,s,n,o,a){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(s),this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(o,this.localAnchorB),this.lengthA=r.A.DistanceVV(n,i),this.lengthB=r.A.DistanceVV(o,s),this.ratio=a}}class ye extends ee{constructor(t){super(t),this.m_groundAnchorA=new r.A,this.m_groundAnchorB=new r.A,this.m_lengthA=0,this.m_lengthB=0,this.m_localAnchorA=new r.A,this.m_localAnchorB=new r.A,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_uA=new r.A,this.m_uB=new r.A,this.m_rA=new r.A,this.m_rB=new r.A,this.m_localCenterA=new r.A,this.m_localCenterB=new r.A,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new r.t,this.m_qB=new r.t,this.m_lalcA=new r.A,this.m_lalcB=new r.A,this.m_groundAnchorA.Copy(t.groundAnchorA),this.m_groundAnchorB.Copy(t.groundAnchorB),this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_lengthA=t.lengthA,this.m_lengthB=t.lengthB,this.m_ratio=t.ratio,this.m_constant=t.lengthA+this.m_ratio*t.lengthB,this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const a=t.positions[this.m_indexB].c,l=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let _=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(l);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),r.t.MulRV(c,this.m_lalcA,this.m_rA),r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),r.t.MulRV(m,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(a).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);const u=this.m_uA.Length(),d=this.m_uB.Length();u>10*n.v?this.m_uA.SelfMul(1/u):this.m_uA.SetZero(),d>10*n.v?this.m_uB.SelfMul(1/d):this.m_uB.SetZero();const p=r.A.CrossVV(this.m_rA,this.m_uA),f=r.A.CrossVV(this.m_rB,this.m_uB),y=this.m_invMassA+this.m_invIA*p*p,A=this.m_invMassB+this.m_invIB*f*f;if(this.m_mass=y+this.m_ratio*this.m_ratio*A,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=r.A.MulSV(-this.m_impulse,this.m_uA,ye.InitVelocityConstraints_s_PA),i=r.A.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,ye.InitVelocityConstraints_s_PB);s.SelfMulAdd(this.m_invMassA,e),o+=this.m_invIA*r.A.CrossVV(this.m_rA,e),h.SelfMulAdd(this.m_invMassB,i),_+=this.m_invIB*r.A.CrossVV(this.m_rB,i)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=_}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=r.A.AddVCrossSV(e,i,this.m_rA,ye.SolveVelocityConstraints_s_vpA),a=r.A.AddVCrossSV(s,n,this.m_rB,ye.SolveVelocityConstraints_s_vpB),l=-r.A.DotVV(this.m_uA,o)-this.m_ratio*r.A.DotVV(this.m_uB,a),h=-this.m_mass*l;this.m_impulse+=h;const _=r.A.MulSV(-h,this.m_uA,ye.SolveVelocityConstraints_s_PA),c=r.A.MulSV(-this.m_ratio*h,this.m_uB,ye.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,_),i+=this.m_invIA*r.A.CrossVV(this.m_rA,_),s.SelfMulAdd(this.m_invMassB,c),n+=this.m_invIB*r.A.CrossVV(this.m_rB,c),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const a=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(o);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const h=r.t.MulRV(a,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const _=r.t.MulRV(l,this.m_lalcB,this.m_rB),c=this.m_uA.Copy(e).SelfAdd(h).SelfSub(this.m_groundAnchorA),m=this.m_uB.Copy(s).SelfAdd(_).SelfSub(this.m_groundAnchorB),u=c.Length(),d=m.Length();u>10*n.v?c.SelfMul(1/u):c.SetZero(),d>10*n.v?m.SelfMul(1/d):m.SetZero();const p=r.A.CrossVV(h,c),f=r.A.CrossVV(_,m),y=this.m_invMassA+this.m_invIA*p*p,A=this.m_invMassB+this.m_invIB*f*f;let g=y+this.m_ratio*this.m_ratio*A;g>0&&(g=1/g);const x=this.m_constant-u-this.m_ratio*d,w=Object(r.a)(x),b=-g*x,S=r.A.MulSV(-b,c,ye.SolvePositionConstraints_s_PA),v=r.A.MulSV(-this.m_ratio*b,m,ye.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,S),i+=this.m_invIA*r.A.CrossVV(h,S),s.SelfMulAdd(this.m_invMassB,v),o+=this.m_invIB*r.A.CrossVV(_,v),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,w<n.v}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.Set(t*this.m_impulse*this.m_uB.x,t*this.m_impulse*this.m_uB.y)}GetReactionTorque(t){return 0}GetGroundAnchorA(){return this.m_groundAnchorA}GetGroundAnchorB(){return this.m_groundAnchorB}GetLengthA(){return this.m_lengthA}GetLengthB(){return this.m_lengthB}GetRatio(){return this.m_ratio}GetCurrentLengthA(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,ye.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return r.A.DistanceVV(t,e)}GetCurrentLengthB(){const t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,ye.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return r.A.DistanceVV(t,e)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}ShiftOrigin(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)}}ye.InitVelocityConstraints_s_PA=new r.A,ye.InitVelocityConstraints_s_PB=new r.A,ye.SolveVelocityConstraints_s_vpA=new r.A,ye.SolveVelocityConstraints_s_vpB=new r.A,ye.SolveVelocityConstraints_s_PA=new r.A,ye.SolveVelocityConstraints_s_PB=new r.A,ye.SolvePositionConstraints_s_PA=new r.A,ye.SolvePositionConstraints_s_PB=new r.A,ye.GetCurrentLengthA_s_p=new r.A,ye.GetCurrentLengthB_s_p=new r.A;class Ae extends te{constructor(){super(Ut.e_revoluteJoint),this.localAnchorA=new r.A(0,0),this.localAnchorB=new r.A(0,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerAngle=0,this.upperAngle=0,this.enableMotor=!1,this.motorSpeed=0,this.maxMotorTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class ge extends ee{constructor(t){super(t),this.m_localAnchorA=new r.A,this.m_localAnchorB=new r.A,this.m_impulse=new r.C,this.m_motorImpulse=0,this.m_enableMotor=!1,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_referenceAngle=0,this.m_lowerAngle=0,this.m_upperAngle=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new r.A,this.m_rB=new r.A,this.m_localCenterA=new r.A,this.m_localCenterB=new r.A,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new r.l,this.m_motorMass=0,this.m_limitState=Xt.e_inactiveLimit,this.m_qA=new r.t,this.m_qB=new r.t,this.m_lalcA=new r.A,this.m_lalcB=new r.A,this.m_K=new r.k,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=t.lowerAngle,this.m_upperAngle=t.upperAngle,this.m_maxMotorTorque=t.maxMotorTorque,this.m_motorSpeed=t.motorSpeed,this.m_enableLimit=t.enableLimit,this.m_enableMotor=t.enableMotor,this.m_limitState=Xt.e_inactiveLimit}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(e),_=this.m_qB.SetAngle(o);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),r.t.MulRV(h,this.m_lalcA,this.m_rA),r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),r.t.MulRV(_,this.m_lalcB,this.m_rB);const c=this.m_invMassA,m=this.m_invMassB,u=this.m_invIA,d=this.m_invIB,p=u+d===0;if(this.m_mass.ex.x=c+m+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*d,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*d,this.m_mass.ez.x=-this.m_rA.y*u-this.m_rB.y*d,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=c+m+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*d,this.m_mass.ez.y=this.m_rA.x*u+this.m_rB.x*d,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=u+d,this.m_motorMass=u+d,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!p||(this.m_motorImpulse=0),this.m_enableLimit&&!p){const t=o-e-this.m_referenceAngle;Object(r.a)(this.m_upperAngle-this.m_lowerAngle)<2*n.n?this.m_limitState=Xt.e_equalLimits:t<=this.m_lowerAngle?(this.m_limitState!==Xt.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=Xt.e_atLowerLimit):t>=this.m_upperAngle?(this.m_limitState!==Xt.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=Xt.e_atUpperLimit):(this.m_limitState=Xt.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=Xt.e_inactiveLimit;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;const e=ge.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(c,e),s-=u*(r.A.CrossVV(this.m_rA,e)+this.m_motorImpulse+this.m_impulse.z),a.SelfMulAdd(m,e),l+=d*(r.A.CrossVV(this.m_rB,e)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB,_=l+h===0;if(this.m_enableMotor&&this.m_limitState!==Xt.e_equalLimits&&!_){const e=n-i-this.m_motorSpeed;let s=-this.m_motorMass*e;const o=this.m_motorImpulse,a=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=Object(r.e)(this.m_motorImpulse+s,-a,a),i-=l*(s=this.m_motorImpulse-o),n+=h*s}if(this.m_enableLimit&&this.m_limitState!==Xt.e_inactiveLimit&&!_){const t=r.A.SubVV(r.A.AddVCrossSV(s,n,this.m_rB,r.A.s_t0),r.A.AddVCrossSV(e,i,this.m_rA,r.A.s_t1),ge.SolveVelocityConstraints_s_Cdot1),_=n-i,c=this.m_mass.Solve33(t.x,t.y,_,ge.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===Xt.e_equalLimits)this.m_impulse.SelfAdd(c);else if(this.m_limitState===Xt.e_atLowerLimit){if(this.m_impulse.z+c.z<0){const e=-t.x+this.m_impulse.z*this.m_mass.ez.x,i=-t.y+this.m_impulse.z*this.m_mass.ez.y,s=this.m_mass.Solve22(e,i,ge.SolveVelocityConstraints_s_reduced_v2);c.x=s.x,c.y=s.y,c.z=-this.m_impulse.z,this.m_impulse.x+=s.x,this.m_impulse.y+=s.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(c)}else if(this.m_limitState===Xt.e_atUpperLimit){if(this.m_impulse.z+c.z>0){const e=-t.x+this.m_impulse.z*this.m_mass.ez.x,i=-t.y+this.m_impulse.z*this.m_mass.ez.y,s=this.m_mass.Solve22(e,i,ge.SolveVelocityConstraints_s_reduced_v2);c.x=s.x,c.y=s.y,c.z=-this.m_impulse.z,this.m_impulse.x+=s.x,this.m_impulse.y+=s.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(c)}const m=ge.SolveVelocityConstraints_s_P.Set(c.x,c.y);e.SelfMulSub(o,m),i-=l*(r.A.CrossVV(this.m_rA,m)+c.z),s.SelfMulAdd(a,m),n+=h*(r.A.CrossVV(this.m_rB,m)+c.z)}else{const t=r.A.SubVV(r.A.AddVCrossSV(s,n,this.m_rB,r.A.s_t0),r.A.AddVCrossSV(e,i,this.m_rA,r.A.s_t1),ge.SolveVelocityConstraints_s_Cdot_v2),_=this.m_mass.Solve22(-t.x,-t.y,ge.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=_.x,this.m_impulse.y+=_.y,e.SelfMulSub(o,_),i-=l*r.A.CrossVV(this.m_rA,_),s.SelfMulAdd(a,_),n+=h*r.A.CrossVV(this.m_rB,_)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const a=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(o);let h=0,_=0;const c=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==Xt.e_inactiveLimit&&!c){const t=o-i-this.m_referenceAngle;let e=0;if(this.m_limitState===Xt.e_equalLimits){const i=Object(r.e)(t-this.m_lowerAngle,-n.w,n.w);e=-this.m_motorMass*i,h=Object(r.a)(i)}else if(this.m_limitState===Xt.e_atLowerLimit){let i=t-this.m_lowerAngle;h=-i,i=Object(r.e)(i+n.n,-n.w,0),e=-this.m_motorMass*i}else if(this.m_limitState===Xt.e_atUpperLimit){let i=t-this.m_upperAngle;h=i,i=Object(r.e)(i-n.n,0,n.w),e=-this.m_motorMass*i}i-=this.m_invIA*e,o+=this.m_invIB*e}{a.SetAngle(i),l.SetAngle(o),r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const t=r.t.MulRV(a,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const n=r.t.MulRV(l,this.m_lalcB,this.m_rB),h=r.A.SubVV(r.A.AddVV(s,n,r.A.s_t0),r.A.AddVV(e,t,r.A.s_t1),ge.SolvePositionConstraints_s_C_v2);_=h.Length();const c=this.m_invMassA,m=this.m_invMassB,u=this.m_invIA,d=this.m_invIB,p=this.m_K;p.ex.x=c+m+u*t.y*t.y+d*n.y*n.y,p.ex.y=-u*t.x*t.y-d*n.x*n.y,p.ey.x=p.ex.y,p.ey.y=c+m+u*t.x*t.x+d*n.x*n.x;const f=p.Solve(h.x,h.y,ge.SolvePositionConstraints_s_impulse).SelfNeg();e.SelfMulSub(c,f),i-=u*r.A.CrossVV(t,f),s.SelfMulAdd(m,f),o+=d*r.A.CrossVV(n,f)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,_<=n.v&&h<=n.n}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.Set(t*this.m_impulse.x,t*this.m_impulse.y)}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}GetJointSpeed(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){this.m_enableMotor!==t&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}GetMotorTorque(t){return t*this.m_motorImpulse}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorTorque(t){this.m_maxMotorTorque=t}GetMaxMotorTorque(){return this.m_maxMotorTorque}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerAngle}GetUpperLimit(){return this.m_upperAngle}SetLimits(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)}SetMotorSpeed(t){this.m_motorSpeed!==t&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}ge.InitVelocityConstraints_s_P=new r.A,ge.SolveVelocityConstraints_s_P=new r.A,ge.SolveVelocityConstraints_s_Cdot_v2=new r.A,ge.SolveVelocityConstraints_s_Cdot1=new r.A,ge.SolveVelocityConstraints_s_impulse_v3=new r.C,ge.SolveVelocityConstraints_s_reduced_v2=new r.A,ge.SolveVelocityConstraints_s_impulse_v2=new r.A,ge.SolvePositionConstraints_s_C_v2=new r.A,ge.SolvePositionConstraints_s_impulse=new r.A;class xe extends te{constructor(){super(Ut.e_ropeJoint),this.localAnchorA=new r.A(-1,0),this.localAnchorB=new r.A(1,0),this.maxLength=0}}class we extends ee{constructor(t){super(t),this.m_localAnchorA=new r.A,this.m_localAnchorB=new r.A,this.m_maxLength=0,this.m_length=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new r.A,this.m_rA=new r.A,this.m_rB=new r.A,this.m_localCenterA=new r.A,this.m_localCenterB=new r.A,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_state=Xt.e_inactiveLimit,this.m_qA=new r.t,this.m_qB=new r.t,this.m_lalcA=new r.A,this.m_lalcB=new r.A,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_maxLength=t.maxLength}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const a=t.positions[this.m_indexB].c,l=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let _=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(l);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),r.t.MulRV(c,this.m_lalcA,this.m_rA),r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),r.t.MulRV(m,this.m_lalcB,this.m_rB),this.m_u.Copy(a).SelfAdd(this.m_rB).SelfSub(e).SelfSub(this.m_rA),this.m_length=this.m_u.Length();const u=this.m_length-this.m_maxLength;if(this.m_state=u>0?Xt.e_atUpperLimit:Xt.e_inactiveLimit,!(this.m_length>n.v))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);const d=r.A.CrossVV(this.m_rA,this.m_u),p=r.A.CrossVV(this.m_rB,this.m_u),f=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=0!==f?1/f:0,t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=r.A.MulSV(this.m_impulse,this.m_u,we.InitVelocityConstraints_s_P);s.SelfMulSub(this.m_invMassA,e),o-=this.m_invIA*r.A.CrossVV(this.m_rA,e),h.SelfMulAdd(this.m_invMassB,e),_+=this.m_invIB*r.A.CrossVV(this.m_rB,e)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=_}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=r.A.AddVCrossSV(e,i,this.m_rA,we.SolveVelocityConstraints_s_vpA),a=r.A.AddVCrossSV(s,n,this.m_rB,we.SolveVelocityConstraints_s_vpB),l=this.m_length-this.m_maxLength;let h=r.A.DotVV(this.m_u,r.A.SubVV(a,o,r.A.s_t0));l<0&&(h+=t.step.inv_dt*l);let _=-this.m_mass*h;const c=this.m_impulse;this.m_impulse=Object(r.n)(0,this.m_impulse+_),_=this.m_impulse-c;const m=r.A.MulSV(_,this.m_u,we.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,m),i-=this.m_invIA*r.A.CrossVV(this.m_rA,m),s.SelfMulAdd(this.m_invMassB,m),n+=this.m_invIB*r.A.CrossVV(this.m_rB,m),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const a=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(o);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const h=r.t.MulRV(a,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const _=r.t.MulRV(l,this.m_lalcB,this.m_rB),c=this.m_u.Copy(s).SelfAdd(_).SelfSub(e).SelfSub(h),m=c.Normalize();let u=m-this.m_maxLength;u=Object(r.e)(u,0,n.y);const d=-this.m_mass*u,p=r.A.MulSV(d,c,we.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*r.A.CrossVV(h,p),s.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*r.A.CrossVV(_,p),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,m-this.m_maxLength<n.v}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return r.A.MulSV(t*this.m_impulse,this.m_u,e)}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxLength(t){this.m_maxLength=t}GetMaxLength(){return this.m_maxLength}GetLimitState(){return this.m_state}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}we.InitVelocityConstraints_s_P=new r.A,we.SolveVelocityConstraints_s_vpA=new r.A,we.SolveVelocityConstraints_s_vpB=new r.A,we.SolveVelocityConstraints_s_P=new r.A,we.SolvePositionConstraints_s_P=new r.A;class be extends te{constructor(){super(Ut.e_weldJoint),this.localAnchorA=new r.A,this.localAnchorB=new r.A,this.referenceAngle=0,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class Se extends ee{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new r.A,this.m_localAnchorB=new r.A,this.m_referenceAngle=0,this.m_gamma=0,this.m_impulse=new r.C(0,0,0),this.m_indexA=0,this.m_indexB=0,this.m_rA=new r.A,this.m_rB=new r.A,this.m_localCenterA=new r.A,this.m_localCenterB=new r.A,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new r.l,this.m_qA=new r.t,this.m_qB=new r.t,this.m_lalcA=new r.A,this.m_lalcB=new r.A,this.m_K=new r.l,this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_referenceAngle=t.referenceAngle,this.m_impulse.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(e),_=this.m_qB.SetAngle(o);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),r.t.MulRV(h,this.m_lalcA,this.m_rA),r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),r.t.MulRV(_,this.m_lalcB,this.m_rB);const c=this.m_invMassA,m=this.m_invMassB,u=this.m_invIA,d=this.m_invIB,p=this.m_K;if(p.ex.x=c+m+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*d,p.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*d,p.ez.x=-this.m_rA.y*u-this.m_rB.y*d,p.ex.y=p.ey.x,p.ey.y=c+m+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*d,p.ez.y=this.m_rA.x*u+this.m_rB.x*d,p.ex.z=p.ez.x,p.ey.z=p.ez.y,p.ez.z=u+d,this.m_frequencyHz>0){p.GetInverse22(this.m_mass);let i=u+d;const s=i>0?1/i:0,r=o-e-this.m_referenceAngle,a=2*n.P*this.m_frequencyHz,l=2*s*this.m_dampingRatio*a,h=s*a*a,_=t.step.dt;this.m_gamma=_*(l+_*h),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=r*_*h*this.m_gamma,i+=this.m_gamma,this.m_mass.ez.z=0!==i?1/i:0}else p.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);const e=Se.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(c,e),s-=u*(r.A.CrossVV(this.m_rA,e)+this.m_impulse.z),a.SelfMulAdd(m,e),l+=d*(r.A.CrossVV(this.m_rB,e)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,h=this.m_invIB;if(this.m_frequencyHz>0){const t=n-i,_=-this.m_mass.ez.z*(t+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=_,i-=l*_,n+=h*_;const c=r.A.SubVV(r.A.AddVCrossSV(s,n,this.m_rB,r.A.s_t0),r.A.AddVCrossSV(e,i,this.m_rA,r.A.s_t1),Se.SolveVelocityConstraints_s_Cdot1),m=r.l.MulM33XY(this.m_mass,c.x,c.y,Se.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=m.x,this.m_impulse.y+=m.y;const u=m;e.SelfMulSub(o,u),i-=l*r.A.CrossVV(this.m_rA,u),s.SelfMulAdd(a,u),n+=h*r.A.CrossVV(this.m_rB,u)}else{const t=r.A.SubVV(r.A.AddVCrossSV(s,n,this.m_rB,r.A.s_t0),r.A.AddVCrossSV(e,i,this.m_rA,r.A.s_t1),Se.SolveVelocityConstraints_s_Cdot1),_=n-i,c=r.l.MulM33XYZ(this.m_mass,t.x,t.y,_,Se.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(c);const m=Se.SolveVelocityConstraints_s_P.Set(c.x,c.y);e.SelfMulSub(o,m),i-=l*(r.A.CrossVV(this.m_rA,m)+c.z),s.SelfMulAdd(a,m),n+=h*(r.A.CrossVV(this.m_rB,m)+c.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const a=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(o),h=this.m_invMassA,_=this.m_invMassB,c=this.m_invIA,m=this.m_invIB;r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const u=r.t.MulRV(a,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const d=r.t.MulRV(l,this.m_lalcB,this.m_rB);let p,f;const y=this.m_K;if(y.ex.x=h+_+u.y*u.y*c+d.y*d.y*m,y.ey.x=-u.y*u.x*c-d.y*d.x*m,y.ez.x=-u.y*c-d.y*m,y.ex.y=y.ey.x,y.ey.y=h+_+u.x*u.x*c+d.x*d.x*m,y.ez.y=u.x*c+d.x*m,y.ex.z=y.ez.x,y.ey.z=y.ez.y,y.ez.z=c+m,this.m_frequencyHz>0){const t=r.A.SubVV(r.A.AddVV(s,d,r.A.s_t0),r.A.AddVV(e,u,r.A.s_t1),Se.SolvePositionConstraints_s_C1);p=t.Length(),f=0;const n=y.Solve22(t.x,t.y,Se.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(h,n),i-=c*r.A.CrossVV(u,n),s.SelfMulAdd(_,n),o+=m*r.A.CrossVV(d,n)}else{const t=r.A.SubVV(r.A.AddVV(s,d,r.A.s_t0),r.A.AddVV(e,u,r.A.s_t1),Se.SolvePositionConstraints_s_C1),n=o-i-this.m_referenceAngle;p=t.Length(),f=Object(r.a)(n);const a=y.Solve33(t.x,t.y,n,Se.SolvePositionConstraints_s_impulse).SelfNeg(),l=Se.SolvePositionConstraints_s_P.Set(a.x,a.y);e.SelfMulSub(h,l),i-=c*(r.A.CrossVV(this.m_rA,l)+a.z),s.SelfMulAdd(_,l),o+=m*(r.A.CrossVV(this.m_rB,l)+a.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,p<=n.v&&f<=n.n}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.Set(t*this.m_impulse.x,t*this.m_impulse.y)}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Se.InitVelocityConstraints_s_P=new r.A,Se.SolveVelocityConstraints_s_Cdot1=new r.A,Se.SolveVelocityConstraints_s_impulse1=new r.A,Se.SolveVelocityConstraints_s_impulse=new r.C,Se.SolveVelocityConstraints_s_P=new r.A,Se.SolvePositionConstraints_s_C1=new r.A,Se.SolvePositionConstraints_s_P=new r.A,Se.SolvePositionConstraints_s_impulse=new r.C;class ve extends te{constructor(){super(Ut.e_wheelJoint),this.localAnchorA=new r.A(0,0),this.localAnchorB=new r.A(0,0),this.localAxisA=new r.A(1,0),this.enableMotor=!1,this.maxMotorTorque=0,this.motorSpeed=0,this.frequencyHz=2,this.dampingRatio=.7}Initialize(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(s,this.localAxisA)}}class Ce extends ee{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_localAnchorA=new r.A,this.m_localAnchorB=new r.A,this.m_localXAxisA=new r.A,this.m_localYAxisA=new r.A,this.m_impulse=0,this.m_motorImpulse=0,this.m_springImpulse=0,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableMotor=!1,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new r.A,this.m_localCenterB=new r.A,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_ax=new r.A,this.m_ay=new r.A,this.m_sAx=0,this.m_sBx=0,this.m_sAy=0,this.m_sBy=0,this.m_mass=0,this.m_motorMass=0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_qA=new r.t,this.m_qB=new r.t,this.m_lalcA=new r.A,this.m_lalcB=new r.A,this.m_rA=new r.A,this.m_rB=new r.A,this.m_frequencyHz=t.frequencyHz,this.m_dampingRatio=t.dampingRatio,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_localXAxisA.Copy(t.localAxisA),r.A.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_maxMotorTorque=t.maxMotorTorque,this.m_motorSpeed=t.motorSpeed,this.m_enableMotor=t.enableMotor,this.m_ax.SetZero(),this.m_ay.SetZero()}GetMotorSpeed(){return this.m_motorSpeed}GetMaxMotorTorque(){return this.m_maxMotorTorque}SetSpringFrequencyHz(t){this.m_frequencyHz=t}GetSpringFrequencyHz(){return this.m_frequencyHz}SetSpringDampingRatio(t){this.m_dampingRatio=t}GetSpringDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,o=this.m_invIB,a=t.positions[this.m_indexA].c,l=t.positions[this.m_indexA].a,h=t.velocities[this.m_indexA].v;let _=t.velocities[this.m_indexA].w;const c=t.positions[this.m_indexB].c,m=t.positions[this.m_indexB].a,u=t.velocities[this.m_indexB].v;let d=t.velocities[this.m_indexB].w;const p=this.m_qA.SetAngle(l),f=this.m_qB.SetAngle(m);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const y=r.t.MulRV(p,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const A=r.t.MulRV(f,this.m_lalcB,this.m_rB),g=r.A.SubVV(r.A.AddVV(c,A,r.A.s_t0),r.A.AddVV(a,y,r.A.s_t1),Ce.InitVelocityConstraints_s_d);if(r.t.MulRV(p,this.m_localYAxisA,this.m_ay),this.m_sAy=r.A.CrossVV(r.A.AddVV(g,y,r.A.s_t0),this.m_ay),this.m_sBy=r.A.CrossVV(A,this.m_ay),this.m_mass=e+i+s*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){r.t.MulRV(p,this.m_localXAxisA,this.m_ax),this.m_sAx=r.A.CrossVV(r.A.AddVV(g,y,r.A.s_t0),this.m_ax),this.m_sBx=r.A.CrossVV(A,this.m_ax);const a=e+i+s*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(a>0){this.m_springMass=1/a;const e=r.A.DotVV(g,this.m_ax),i=2*n.P*this.m_frequencyHz,s=2*this.m_springMass*this.m_dampingRatio*i,o=this.m_springMass*i*i,l=t.step.dt;this.m_gamma=l*(s+l*o),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=e*l*o*this.m_gamma,this.m_springMass=a+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=s+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;const e=r.A.AddVV(r.A.MulSV(this.m_impulse,this.m_ay,r.A.s_t0),r.A.MulSV(this.m_springImpulse,this.m_ax,r.A.s_t1),Ce.InitVelocityConstraints_s_P),i=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,s=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;h.SelfMulSub(this.m_invMassA,e),_-=this.m_invIA*i,u.SelfMulAdd(this.m_invMassB,e),d+=this.m_invIB*s}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=_,t.velocities[this.m_indexB].w=d}SolveVelocityConstraints(t){const e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,n=this.m_invIB,o=t.velocities[this.m_indexA].v;let a=t.velocities[this.m_indexA].w;const l=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;{const t=r.A.DotVV(this.m_ax,r.A.SubVV(l,o,r.A.s_t0))+this.m_sBx*h-this.m_sAx*a,_=-this.m_springMass*(t+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=_;const c=r.A.MulSV(_,this.m_ax,Ce.SolveVelocityConstraints_s_P),m=_*this.m_sAx,u=_*this.m_sBx;o.SelfMulSub(e,c),a-=s*m,l.SelfMulAdd(i,c),h+=n*u}{const e=h-a-this.m_motorSpeed;let i=-this.m_motorMass*e;const o=this.m_motorImpulse,l=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=Object(r.e)(this.m_motorImpulse+i,-l,l),a-=s*(i=this.m_motorImpulse-o),h+=n*i}{const t=r.A.DotVV(this.m_ay,r.A.SubVV(l,o,r.A.s_t0))+this.m_sBy*h-this.m_sAy*a,_=-this.m_mass*t;this.m_impulse+=_;const c=r.A.MulSV(_,this.m_ay,Ce.SolveVelocityConstraints_s_P),m=_*this.m_sAy,u=_*this.m_sBy;o.SelfMulSub(e,c),a-=s*m,l.SelfMulAdd(i,c),h+=n*u}t.velocities[this.m_indexA].w=a,t.velocities[this.m_indexB].w=h}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const a=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(o);r.A.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const h=r.t.MulRV(a,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const _=r.t.MulRV(l,this.m_lalcB,this.m_rB),c=r.A.AddVV(r.A.SubVV(s,e,r.A.s_t0),r.A.SubVV(_,h,r.A.s_t1),Ce.SolvePositionConstraints_s_d),m=r.t.MulRV(a,this.m_localYAxisA,this.m_ay),u=r.A.CrossVV(r.A.AddVV(c,h,r.A.s_t0),m),d=r.A.CrossVV(_,m),p=r.A.DotVV(c,this.m_ay),f=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;let y;y=0!==f?-p/f:0;const A=r.A.MulSV(y,m,Ce.SolvePositionConstraints_s_P),g=y*u,x=y*d;return e.SelfMulSub(this.m_invMassA,A),i-=this.m_invIA*g,s.SelfMulAdd(this.m_invMassB,A),o+=this.m_invIB*x,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,Object(r.a)(p)<=n.v}GetDefinition(t){return t}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e}GetReactionTorque(t){return t*this.m_motorImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetJointTranslation(){return this.GetPrismaticJointTranslation()}GetJointSpeed(){return this.GetRevoluteJointSpeed()}GetPrismaticJointTranslation(){const t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new r.A),s=e.GetWorldPoint(this.m_localAnchorB,new r.A),n=r.A.SubVV(s,i,new r.A),o=t.GetWorldVector(this.m_localXAxisA,new r.A);return r.A.DotVV(n,o)}GetPrismaticJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;r.A.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=r.t.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);r.A.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const s=r.t.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),n=r.A.AddVV(t.m_sweep.c,i,r.A.s_t0),o=r.A.AddVV(e.m_sweep.c,s,r.A.s_t1),a=r.A.SubVV(o,n,r.A.s_t2),l=t.GetWorldVector(this.m_localXAxisA,new r.A),h=t.m_linearVelocity,_=e.m_linearVelocity,c=t.m_angularVelocity,m=e.m_angularVelocity;return r.A.DotVV(a,r.A.CrossSV(c,l,r.A.s_t0))+r.A.DotVV(l,r.A.SubVV(r.A.AddVCrossSV(_,m,s,r.A.s_t0),r.A.AddVCrossSV(h,c,i,r.A.s_t1),r.A.s_t0))}GetRevoluteJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}GetRevoluteJointSpeed(){const t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t}SetMotorSpeed(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t}SetMaxMotorTorque(t){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t}GetMotorTorque(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Ce.InitVelocityConstraints_s_d=new r.A,Ce.InitVelocityConstraints_s_P=new r.A,Ce.SolveVelocityConstraints_s_P=new r.A,Ce.SolvePositionConstraints_s_d=new r.A,Ce.SolvePositionConstraints_s_P=new r.A;class Be{static Create(t,e){let i=null;switch(t.type){case Ut.e_distanceJoint:i=new se(t);break;case Ut.e_mouseJoint:i=new ue(t);break;case Ut.e_prismaticJoint:i=new pe(t);break;case Ut.e_revoluteJoint:i=new ge(t);break;case Ut.e_pulleyJoint:i=new ye(t);break;case Ut.e_gearJoint:i=new he(t);break;case Ut.e_wheelJoint:i=new Ce(t);break;case Ut.e_weldJoint:i=new Se(t);break;case Ut.e_frictionJoint:i=new ae(t);break;case Ut.e_ropeJoint:i=new we(t);break;case Ut.e_motorJoint:i=new ce(t);break;case Ut.e_areaJoint:i=new re(t)}return i}static Destroy(t,e){}}function Ve(t,e){return Object(r.w)(t*e)}function Me(t,e){return t>e?t:e}class Pe{constructor(){this.other=null,this.contact=null,this.prev=null,this.next=null}}class Ie{constructor(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Pe,this.m_nodeB=new Pe,this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=0,this.m_indexB=0,this.m_manifold=new u.h,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new u.h}GetManifold(){return this.m_manifold}GetWorldManifold(t){const e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),s=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape();t.Initialize(this.m_manifold,e.GetTransform(),s.m_radius,i.GetTransform(),n.m_radius)}IsTouching(){return this.m_touchingFlag}SetEnabled(t){this.m_enabledFlag=t}IsEnabled(){return this.m_enabledFlag}GetNext(){return this.m_next}GetFixtureA(){return this.m_fixtureA}GetChildIndexA(){return this.m_indexA}GetFixtureB(){return this.m_fixtureB}GetChildIndexB(){return this.m_indexB}Evaluate(t,e,i){}FlagForFiltering(){this.m_filterFlag=!0}SetFriction(t){this.m_friction=t}GetFriction(){return this.m_friction}ResetFriction(){this.m_friction=Ve(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}SetRestitution(t){this.m_restitution=t}GetRestitution(){return this.m_restitution}ResetRestitution(){this.m_restitution=Me(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}SetTangentSpeed(t){this.m_tangentSpeed=t}GetTangentSpeed(){return this.m_tangentSpeed}Reset(t,e,i,s){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=s,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.contact=null,this.m_nodeA.prev=null,this.m_nodeA.next=null,this.m_nodeA.other=null,this.m_nodeB.contact=null,this.m_nodeB.prev=null,this.m_nodeB.next=null,this.m_nodeB.other=null,this.m_toiCount=0,this.m_friction=Ve(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Me(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}Update(t){const e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;let i=!1;const s=this.m_touchingFlag,n=this.m_fixtureA.IsSensor(),r=this.m_fixtureB.IsSensor(),o=n||r,a=this.m_fixtureA.GetBody(),l=this.m_fixtureB.GetBody(),h=a.GetTransform(),_=l.GetTransform();if(o){const t=this.m_fixtureA.GetShape(),e=this.m_fixtureB.GetShape();i=Object(u.o)(t,this.m_indexA,e,this.m_indexB,h,_),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,h,_),i=this.m_manifold.pointCount>0;for(let t=0;t<this.m_manifold.pointCount;++t){const e=this.m_manifold.points[t];e.normalImpulse=0,e.tangentImpulse=0;const i=e.id;for(let t=0;t<this.m_oldManifold.pointCount;++t){const s=this.m_oldManifold.points[t];if(s.id.key===i.key){e.normalImpulse=s.normalImpulse,e.tangentImpulse=s.tangentImpulse;break}}}i!==s&&(a.SetAwake(!0),l.SetAwake(!0))}this.m_touchingFlag=i,!s&&i&&t&&t.BeginContact(this),s&&!i&&t&&t.EndContact(this),!o&&i&&t&&t.PreSolve(this,this.m_oldManifold)}ComputeTOI(t,e){const i=Ie.ComputeTOI_s_input;i.proxyA.SetShape(this.m_fixtureA.GetShape(),this.m_indexA),i.proxyB.SetShape(this.m_fixtureB.GetShape(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=n.v;const s=Ie.ComputeTOI_s_output;return Z(s,i),s.t}}Ie.ComputeTOI_s_input=new $,Ie.ComputeTOI_s_output=new E;class De extends Ie{constructor(){super()}static Create(t){return new De}static Destroy(t,e){}Reset(t,e,i,s){super.Reset(t,e,i,s)}Evaluate(t,e,i){K(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)}}class ke extends Ie{constructor(){super()}static Create(t){return new ke}static Destroy(t,e){}Reset(t,e,i,s){super.Reset(t,e,i,s)}Evaluate(t,e,i){Bt(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)}}class Ge extends Ie{constructor(){super()}static Create(t){return new Ge}static Destroy(t,e){}Reset(t,e,i,s){super.Reset(t,e,i,s)}Evaluate(t,e,i){st(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)}}class Re extends Ie{constructor(){super()}static Create(t){return new Re}static Destroy(t,e){}Reset(t,e,i,s){super.Reset(t,e,i,s)}Evaluate(t,e,i){Lt(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)}}class Le extends Ie{constructor(){super()}static Create(t){return new Le}static Destroy(t,e){}Reset(t,e,i,s){super.Reset(t,e,i,s)}Evaluate(t,e,i){jt(t,this.m_fixtureA.GetShape(),e,this.m_fixtureB.GetShape(),i)}}class $e extends Ie{constructor(){super()}static Create(t){return new $e}static Destroy(t,e){}Reset(t,e,i,s){super.Reset(t,e,i,s)}Evaluate(t,e,i){const s=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape(),r=s,o=$e.Evaluate_s_edge;r.GetChildEdge(o,this.m_indexA),Lt(t,o,e,n,i)}}$e.Evaluate_s_edge=new qt;class Te extends Ie{constructor(){super()}static Create(t){return new Te}static Destroy(t,e){}Reset(t,e,i,s){super.Reset(t,e,i,s)}Evaluate(t,e,i){const s=this.m_fixtureA.GetShape(),n=this.m_fixtureB.GetShape(),r=s,o=Te.Evaluate_s_edge;r.GetChildEdge(o,this.m_indexA),jt(t,o,e,n,i)}}Te.Evaluate_s_edge=new qt;class Fe{constructor(){this.pool=null,this.createFcn=null,this.destroyFcn=null,this.primary=!1}}class Ee{constructor(t){this.m_allocator=null,this.m_allocator=t,this.InitializeRegisters()}AddType(t,e,i,s){const r=Object(n.e)(256,e=>t(this.m_allocator));function o(e){return r.length>0?r.pop():t(e)}function a(t,e){r.push(t)}this.m_registers[i][s].pool=r,this.m_registers[i][s].createFcn=o,this.m_registers[i][s].destroyFcn=a,this.m_registers[i][s].primary=!0,i!==s&&(this.m_registers[s][i].pool=r,this.m_registers[s][i].createFcn=o,this.m_registers[s][i].destroyFcn=a,this.m_registers[s][i].primary=!1)}InitializeRegisters(){this.m_registers=[];for(let t=0;t<Ot.c.e_shapeTypeCount;t++){this.m_registers[t]=[];for(let e=0;e<Ot.c.e_shapeTypeCount;e++)this.m_registers[t][e]=new Fe}this.AddType(De.Create,De.Destroy,Ot.c.e_circleShape,Ot.c.e_circleShape),this.AddType(Ge.Create,Ge.Destroy,Ot.c.e_polygonShape,Ot.c.e_circleShape),this.AddType(ke.Create,ke.Destroy,Ot.c.e_polygonShape,Ot.c.e_polygonShape),this.AddType(Re.Create,Re.Destroy,Ot.c.e_edgeShape,Ot.c.e_circleShape),this.AddType(Le.Create,Le.Destroy,Ot.c.e_edgeShape,Ot.c.e_polygonShape),this.AddType($e.Create,$e.Destroy,Ot.c.e_chainShape,Ot.c.e_circleShape),this.AddType(Te.Create,Te.Destroy,Ot.c.e_chainShape,Ot.c.e_polygonShape)}Create(t,e,i,s){const n=t.GetType(),r=i.GetType(),o=this.m_registers[n][r];if(o.createFcn){const n=o.createFcn(this.m_allocator);return o.primary?n.Reset(t,e,i,s):n.Reset(i,s,t,e),n}return null}Destroy(t){const e=t.m_fixtureA,i=t.m_fixtureB;t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0));const s=e.GetType(),n=i.GetType();this.m_registers[s][n].destroyFcn(t,this.m_allocator)}}class je{SayGoodbyeJoint(t){}SayGoodbyeFixture(t){}SayGoodbyeParticleGroup(t){}SayGoodbyeParticle(t,e){}}class Oe{ShouldCollide(t,e){const i=t.GetBody(),s=e.GetBody();if(s.GetType()===Wt.b2_staticBody&&i.GetType()===Wt.b2_staticBody)return!1;if(!s.ShouldCollideConnected(i))return!1;const n=t.GetFilterData(),r=e.GetFilterData();return n.groupIndex===r.groupIndex&&0!==n.groupIndex?n.groupIndex>0:0!=(n.maskBits&r.categoryBits)&&0!=(n.categoryBits&r.maskBits)}ShouldCollideFixtureParticle(t,e,i){return!0}ShouldCollideParticleParticle(t,e,i){return!0}}Oe.b2_defaultFilter=new Oe;class Ne{constructor(){this.normalImpulses=Object(n.g)(n.z),this.tangentImpulses=Object(n.g)(n.z),this.count=0}}class ze{BeginContact(t){}EndContact(t){}BeginContactFixtureParticle(t,e){}EndContactFixtureParticle(t,e){}BeginContactParticleParticle(t,e){}EndContactParticleParticle(t,e){}PreSolve(t,e){}PostSolve(t,e){}}ze.b2_defaultListener=new ze;class qe{ReportFixture(t){return!0}ReportParticle(t,e){return!1}ShouldQueryParticleSystem(t){return!0}}class Je{ReportFixture(t,e,i,s){return s}ReportParticle(t,e,i,s,n){return 0}ShouldQueryParticleSystem(t){return!0}}class We{constructor(){this.m_broadPhase=new g,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=Oe.b2_defaultFilter,this.m_contactListener=ze.b2_defaultListener,this.m_allocator=null,this.m_contactFactory=null,this.m_contactFactory=new Ee(this.m_allocator)}AddPair(t,e){let i=t.fixture,s=e.fixture,n=t.childIndex,r=e.childIndex,o=i.GetBody(),a=s.GetBody();if(o===a)return;let l=a.GetContactList();for(;l;){if(l.other===o){const t=l.contact.GetFixtureA(),e=l.contact.GetFixtureB(),o=l.contact.GetChildIndexA(),a=l.contact.GetChildIndexB();if(t===i&&e===s&&o===n&&a===r)return;if(t===s&&e===i&&o===r&&a===n)return}l=l.next}if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,s))return;const h=this.m_contactFactory.Create(i,n,s,r);null!==h&&(i=h.GetFixtureA(),s=h.GetFixtureB(),n=h.GetChildIndexA(),r=h.GetChildIndexB(),o=i.m_body,a=s.m_body,h.m_prev=null,h.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=h),this.m_contactList=h,h.m_nodeA.contact=h,h.m_nodeA.other=a,h.m_nodeA.prev=null,h.m_nodeA.next=o.m_contactList,null!==o.m_contactList&&(o.m_contactList.prev=h.m_nodeA),o.m_contactList=h.m_nodeA,h.m_nodeB.contact=h,h.m_nodeB.other=o,h.m_nodeB.prev=null,h.m_nodeB.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=h.m_nodeB),a.m_contactList=h.m_nodeB,i.IsSensor()||s.IsSensor()||(o.SetAwake(!0),a.SetAwake(!0)),++this.m_contactCount)}FindNewContacts(){this.m_broadPhase.UpdatePairs(this)}Destroy(t){const e=t.GetFixtureA(),i=t.GetFixtureB(),s=e.GetBody(),n=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===s.m_contactList&&(s.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===n.m_contactList&&(n.m_contactList=t.m_nodeB.next),this.m_contactFactory.Destroy(t),--this.m_contactCount}Collide(){let t=this.m_contactList;for(;t;){const e=t.GetFixtureA(),i=t.GetFixtureB(),s=t.GetChildIndexA(),n=t.GetChildIndexB(),r=e.GetBody(),o=i.GetBody();if(t.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(e,i)){const e=t;t=e.m_next,this.Destroy(e);continue}t.m_filterFlag=!1}const a=r.IsAwake()&&r.m_type!==Wt.b2_staticBody,l=o.IsAwake()&&o.m_type!==Wt.b2_staticBody;if(!a&&!l){t=t.m_next;continue}const h=e.m_proxies[s].treeNode,_=i.m_proxies[n].treeNode;if(this.m_broadPhase.TestOverlap(h,_))t.Update(this.m_contactListener),t=t.m_next;else{const e=t;t=e.m_next,this.Destroy(e)}}}}class Ue{constructor(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}Reset(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}class Xe{constructor(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}Copy(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this}}class He{constructor(){this.c=new r.A,this.a=0}static MakeArray(t){return Object(n.e)(t,t=>new He)}}class Ze{constructor(){this.v=new r.A,this.w=0}static MakeArray(t){return Object(n.e)(t,t=>new Ze)}}class Ye{constructor(){this.step=new Xe,this.positions=null,this.velocities=null}}class Qe{constructor(){this.rA=new r.A,this.rB=new r.A,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}static MakeArray(t){return Object(n.e)(t,t=>new Qe)}}class Ke{constructor(){this.points=Qe.MakeArray(n.z),this.normal=new r.A,this.tangent=new r.A,this.normalMass=new r.k,this.K=new r.k,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}static MakeArray(t){return Object(n.e)(t,t=>new Ke)}}class ti{constructor(){this.localPoints=r.A.MakeArray(n.z),this.localNormal=new r.A,this.localPoint=new r.A,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new r.A,this.localCenterB=new r.A,this.invIA=0,this.invIB=0,this.type=u.j.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}static MakeArray(t){return Object(n.e)(t,t=>new ti)}}class ei{constructor(){this.step=new Xe,this.contacts=null,this.count=0,this.positions=null,this.velocities=null,this.allocator=null}}class ii{constructor(){this.normal=new r.A,this.point=new r.A,this.separation=0}Initialize(t,e,i,s){const n=ii.Initialize_s_pointA,o=ii.Initialize_s_pointB,a=ii.Initialize_s_planePoint,l=ii.Initialize_s_clipPoint;switch(t.type){case u.j.e_circles:r.z.MulXV(e,t.localPoint,n),r.z.MulXV(i,t.localPoints[0],o),r.A.SubVV(o,n,this.normal).SelfNormalize(),r.A.MidVV(n,o,this.point),this.separation=r.A.DotVV(r.A.SubVV(o,n,r.A.s_t0),this.normal)-t.radiusA-t.radiusB;break;case u.j.e_faceA:r.t.MulRV(e.q,t.localNormal,this.normal),r.z.MulXV(e,t.localPoint,a),r.z.MulXV(i,t.localPoints[s],l),this.separation=r.A.DotVV(r.A.SubVV(l,a,r.A.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(l);break;case u.j.e_faceB:r.t.MulRV(i.q,t.localNormal,this.normal),r.z.MulXV(i,t.localPoint,a),r.z.MulXV(e,t.localPoints[s],l),this.separation=r.A.DotVV(r.A.SubVV(l,a,r.A.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(l),this.normal.SelfNeg()}}}ii.Initialize_s_pointA=new r.A,ii.Initialize_s_pointB=new r.A,ii.Initialize_s_planePoint=new r.A,ii.Initialize_s_clipPoint=new r.A;class si{constructor(){this.m_step=new Xe,this.m_positions=null,this.m_velocities=null,this.m_allocator=null,this.m_positionConstraints=ti.MakeArray(1024),this.m_velocityConstraints=Ke.MakeArray(1024),this.m_contacts=null,this.m_count=0}Initialize(t){if(this.m_step.Copy(t.step),this.m_allocator=t.allocator,this.m_count=t.count,this.m_positionConstraints.length<this.m_count){const t=Object(r.m)(2*this.m_positionConstraints.length,this.m_count);for(;this.m_positionConstraints.length<t;)this.m_positionConstraints[this.m_positionConstraints.length]=new ti}if(this.m_velocityConstraints.length<this.m_count){const t=Object(r.m)(2*this.m_velocityConstraints.length,this.m_count);for(;this.m_velocityConstraints.length<t;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Ke}this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(let t=0;t<this.m_count;++t){const e=this.m_contacts[t],i=e.m_fixtureA,s=e.m_fixtureB,n=i.GetShape(),r=s.GetShape(),o=n.m_radius,a=r.m_radius,l=i.GetBody(),h=s.GetBody(),_=e.GetManifold(),c=_.pointCount,m=this.m_velocityConstraints[t];m.friction=e.m_friction,m.restitution=e.m_restitution,m.tangentSpeed=e.m_tangentSpeed,m.indexA=l.m_islandIndex,m.indexB=h.m_islandIndex,m.invMassA=l.m_invMass,m.invMassB=h.m_invMass,m.invIA=l.m_invI,m.invIB=h.m_invI,m.contactIndex=t,m.pointCount=c,m.K.SetZero(),m.normalMass.SetZero();const u=this.m_positionConstraints[t];u.indexA=l.m_islandIndex,u.indexB=h.m_islandIndex,u.invMassA=l.m_invMass,u.invMassB=h.m_invMass,u.localCenterA.Copy(l.m_sweep.localCenter),u.localCenterB.Copy(h.m_sweep.localCenter),u.invIA=l.m_invI,u.invIB=h.m_invI,u.localNormal.Copy(_.localNormal),u.localPoint.Copy(_.localPoint),u.pointCount=c,u.radiusA=o,u.radiusB=a,u.type=_.type;for(let t=0;t<c;++t){const e=_.points[t],i=m.points[t];this.m_step.warmStarting?(i.normalImpulse=this.m_step.dtRatio*e.normalImpulse,i.tangentImpulse=this.m_step.dtRatio*e.tangentImpulse):(i.normalImpulse=0,i.tangentImpulse=0),i.rA.SetZero(),i.rB.SetZero(),i.normalMass=0,i.tangentMass=0,i.velocityBias=0,u.localPoints[t].Copy(e.localPoint)}}return this}InitializeVelocityConstraints(){const t=si.InitializeVelocityConstraints_s_xfA,e=si.InitializeVelocityConstraints_s_xfB,i=si.InitializeVelocityConstraints_s_worldManifold;for(let s=0;s<this.m_count;++s){const o=this.m_velocityConstraints[s],a=this.m_positionConstraints[s],l=a.radiusA,h=a.radiusB,_=this.m_contacts[o.contactIndex].GetManifold(),c=o.indexA,m=o.indexB,u=o.invMassA,d=o.invMassB,p=o.invIA,f=o.invIB,y=a.localCenterA,A=a.localCenterB,g=this.m_positions[c].c,x=this.m_positions[c].a,w=this.m_velocities[c].v,b=this.m_velocities[c].w,S=this.m_positions[m].c,v=this.m_positions[m].a,C=this.m_velocities[m].v,B=this.m_velocities[m].w;t.q.SetAngle(x),e.q.SetAngle(v),r.A.SubVV(g,r.t.MulRV(t.q,y,r.A.s_t0),t.p),r.A.SubVV(S,r.t.MulRV(e.q,A,r.A.s_t0),e.p),i.Initialize(_,t,l,e,h),o.normal.Copy(i.normal),r.A.CrossVOne(o.normal,o.tangent);const V=o.pointCount;for(let t=0;t<V;++t){const e=o.points[t];r.A.SubVV(i.points[t],g,e.rA),r.A.SubVV(i.points[t],S,e.rB);const s=r.A.CrossVV(e.rA,o.normal),a=r.A.CrossVV(e.rB,o.normal),l=u+d+p*s*s+f*a*a;e.normalMass=l>0?1/l:0;const h=o.tangent,_=r.A.CrossVV(e.rA,h),c=r.A.CrossVV(e.rB,h),m=u+d+p*_*_+f*c*c;e.tangentMass=m>0?1/m:0,e.velocityBias=0;const y=r.A.DotVV(o.normal,r.A.SubVV(r.A.AddVCrossSV(C,B,e.rB,r.A.s_t0),r.A.AddVCrossSV(w,b,e.rA,r.A.s_t1),r.A.s_t0));y<-n.T&&(e.velocityBias+=-o.restitution*y)}if(2===o.pointCount){const t=o.points[0],e=o.points[1],i=r.A.CrossVV(t.rA,o.normal),s=r.A.CrossVV(t.rB,o.normal),n=r.A.CrossVV(e.rA,o.normal),a=r.A.CrossVV(e.rB,o.normal),l=u+d+p*i*i+f*s*s,h=u+d+p*n*n+f*a*a,_=u+d+p*i*n+f*s*a;l*l<1e3*(l*h-_*_)?(o.K.ex.Set(l,_),o.K.ey.Set(_,h),o.K.GetInverse(o.normalMass)):o.pointCount=1}}}WarmStart(){const t=si.WarmStart_s_P;for(let e=0;e<this.m_count;++e){const i=this.m_velocityConstraints[e],s=i.indexA,n=i.indexB,o=i.invMassA,a=i.invIA,l=i.invMassB,h=i.invIB,_=i.pointCount,c=this.m_velocities[s].v;let m=this.m_velocities[s].w;const u=this.m_velocities[n].v;let d=this.m_velocities[n].w;const p=i.normal,f=i.tangent;for(let e=0;e<_;++e){const s=i.points[e];r.A.AddVV(r.A.MulSV(s.normalImpulse,p,r.A.s_t0),r.A.MulSV(s.tangentImpulse,f,r.A.s_t1),t),m-=a*r.A.CrossVV(s.rA,t),c.SelfMulSub(o,t),d+=h*r.A.CrossVV(s.rB,t),u.SelfMulAdd(l,t)}this.m_velocities[s].w=m,this.m_velocities[n].w=d}}SolveVelocityConstraints(){const t=si.SolveVelocityConstraints_s_dv,e=si.SolveVelocityConstraints_s_dv1,i=si.SolveVelocityConstraints_s_dv2,s=si.SolveVelocityConstraints_s_P,n=si.SolveVelocityConstraints_s_a,o=si.SolveVelocityConstraints_s_b,a=si.SolveVelocityConstraints_s_x,l=si.SolveVelocityConstraints_s_d,h=si.SolveVelocityConstraints_s_P1,_=si.SolveVelocityConstraints_s_P2,c=si.SolveVelocityConstraints_s_P1P2;for(let m=0;m<this.m_count;++m){const u=this.m_velocityConstraints[m],d=u.indexA,p=u.indexB,f=u.invMassA,y=u.invIA,A=u.invMassB,g=u.invIB,x=u.pointCount,w=this.m_velocities[d].v;let b=this.m_velocities[d].w;const S=this.m_velocities[p].v;let v=this.m_velocities[p].w;const C=u.normal,B=u.tangent,V=u.friction;for(let e=0;e<x;++e){const i=u.points[e];r.A.SubVV(r.A.AddVCrossSV(S,v,i.rB,r.A.s_t0),r.A.AddVCrossSV(w,b,i.rA,r.A.s_t1),t);const n=r.A.DotVV(t,B)-u.tangentSpeed;let o=i.tangentMass*-n;const a=V*i.normalImpulse,l=Object(r.e)(i.tangentImpulse+o,-a,a);o=l-i.tangentImpulse,i.tangentImpulse=l,r.A.MulSV(o,B,s),w.SelfMulSub(f,s),b-=y*r.A.CrossVV(i.rA,s),S.SelfMulAdd(A,s),v+=g*r.A.CrossVV(i.rB,s)}if(1===u.pointCount){const e=u.points[0];r.A.SubVV(r.A.AddVCrossSV(S,v,e.rB,r.A.s_t0),r.A.AddVCrossSV(w,b,e.rA,r.A.s_t1),t);const i=r.A.DotVV(t,C);let n=-e.normalMass*(i-e.velocityBias);const o=Object(r.m)(e.normalImpulse+n,0);n=o-e.normalImpulse,e.normalImpulse=o,r.A.MulSV(n,C,s),w.SelfMulSub(f,s),b-=y*r.A.CrossVV(e.rA,s),S.SelfMulAdd(A,s),v+=g*r.A.CrossVV(e.rB,s)}else{const t=u.points[0],s=u.points[1];n.Set(t.normalImpulse,s.normalImpulse),r.A.SubVV(r.A.AddVCrossSV(S,v,t.rB,r.A.s_t0),r.A.AddVCrossSV(w,b,t.rA,r.A.s_t1),e),r.A.SubVV(r.A.AddVCrossSV(S,v,s.rB,r.A.s_t0),r.A.AddVCrossSV(w,b,s.rA,r.A.s_t1),i);let m=r.A.DotVV(e,C),d=r.A.DotVV(i,C);for(o.x=m-t.velocityBias,o.y=d-s.velocityBias,o.SelfSub(r.k.MulMV(u.K,n,r.A.s_t0));;){if(r.k.MulMV(u.normalMass,o,a).SelfNeg(),a.x>=0&&a.y>=0){r.A.SubVV(a,n,l),r.A.MulSV(l.x,C,h),r.A.MulSV(l.y,C,_),r.A.AddVV(h,_,c),w.SelfMulSub(f,c),b-=y*(r.A.CrossVV(t.rA,h)+r.A.CrossVV(s.rA,_)),S.SelfMulAdd(A,c),v+=g*(r.A.CrossVV(t.rB,h)+r.A.CrossVV(s.rB,_)),t.normalImpulse=a.x,s.normalImpulse=a.y;break}if(a.x=-t.normalMass*o.x,a.y=0,m=0,d=u.K.ex.y*a.x+o.y,a.x>=0&&d>=0){r.A.SubVV(a,n,l),r.A.MulSV(l.x,C,h),r.A.MulSV(l.y,C,_),r.A.AddVV(h,_,c),w.SelfMulSub(f,c),b-=y*(r.A.CrossVV(t.rA,h)+r.A.CrossVV(s.rA,_)),S.SelfMulAdd(A,c),v+=g*(r.A.CrossVV(t.rB,h)+r.A.CrossVV(s.rB,_)),t.normalImpulse=a.x,s.normalImpulse=a.y;break}if(a.x=0,a.y=-s.normalMass*o.y,m=u.K.ey.x*a.y+o.x,d=0,a.y>=0&&m>=0){r.A.SubVV(a,n,l),r.A.MulSV(l.x,C,h),r.A.MulSV(l.y,C,_),r.A.AddVV(h,_,c),w.SelfMulSub(f,c),b-=y*(r.A.CrossVV(t.rA,h)+r.A.CrossVV(s.rA,_)),S.SelfMulAdd(A,c),v+=g*(r.A.CrossVV(t.rB,h)+r.A.CrossVV(s.rB,_)),t.normalImpulse=a.x,s.normalImpulse=a.y;break}if(a.x=0,a.y=0,m=o.x,d=o.y,m>=0&&d>=0){r.A.SubVV(a,n,l),r.A.MulSV(l.x,C,h),r.A.MulSV(l.y,C,_),r.A.AddVV(h,_,c),w.SelfMulSub(f,c),b-=y*(r.A.CrossVV(t.rA,h)+r.A.CrossVV(s.rA,_)),S.SelfMulAdd(A,c),v+=g*(r.A.CrossVV(t.rB,h)+r.A.CrossVV(s.rB,_)),t.normalImpulse=a.x,s.normalImpulse=a.y;break}break}}this.m_velocities[d].w=b,this.m_velocities[p].w=v}}StoreImpulses(){for(let t=0;t<this.m_count;++t){let e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold();for(let t=0;t<e.pointCount;++t)i.points[t].normalImpulse=e.points[t].normalImpulse,i.points[t].tangentImpulse=e.points[t].tangentImpulse}}SolvePositionConstraints(){const t=si.SolvePositionConstraints_s_xfA,e=si.SolvePositionConstraints_s_xfB,i=si.SolvePositionConstraints_s_psm,s=si.SolvePositionConstraints_s_rA,o=si.SolvePositionConstraints_s_rB,a=si.SolvePositionConstraints_s_P;let l=0;for(let h=0;h<this.m_count;++h){const _=this.m_positionConstraints[h],c=_.indexA,m=_.indexB,u=_.localCenterA,d=_.invMassA,p=_.invIA,f=_.localCenterB,y=_.invMassB,A=_.invIB,g=_.pointCount,x=this.m_positions[c].c;let w=this.m_positions[c].a;const b=this.m_positions[m].c;let S=this.m_positions[m].a;for(let h=0;h<g;++h){t.q.SetAngle(w),e.q.SetAngle(S),r.A.SubVV(x,r.t.MulRV(t.q,u,r.A.s_t0),t.p),r.A.SubVV(b,r.t.MulRV(e.q,f,r.A.s_t0),e.p),i.Initialize(_,t,e,h);const c=i.normal,m=i.point,g=i.separation;r.A.SubVV(m,x,s),r.A.SubVV(m,b,o),l=Object(r.n)(l,g);const v=Object(r.e)(n.p*(g+n.v),-n.y,0),C=r.A.CrossVV(s,c),B=r.A.CrossVV(o,c),V=d+y+p*C*C+A*B*B,M=V>0?-v/V:0;r.A.MulSV(M,c,a),x.SelfMulSub(d,a),w-=p*r.A.CrossVV(s,a),b.SelfMulAdd(y,a),S+=A*r.A.CrossVV(o,a)}this.m_positions[c].a=w,this.m_positions[m].a=S}return l>-3*n.v}SolveTOIPositionConstraints(t,e){const i=si.SolveTOIPositionConstraints_s_xfA,s=si.SolveTOIPositionConstraints_s_xfB,o=si.SolveTOIPositionConstraints_s_psm,a=si.SolveTOIPositionConstraints_s_rA,l=si.SolveTOIPositionConstraints_s_rB,h=si.SolveTOIPositionConstraints_s_P;let _=0;for(let c=0;c<this.m_count;++c){const m=this.m_positionConstraints[c],u=m.indexA,d=m.indexB,p=m.localCenterA,f=m.localCenterB,y=m.pointCount;let A=0,g=0;u!==t&&u!==e||(A=m.invMassA,g=m.invIA);let x=0,w=0;d!==t&&d!==e||(x=m.invMassB,w=m.invIB);const b=this.m_positions[u].c;let S=this.m_positions[u].a;const v=this.m_positions[d].c;let C=this.m_positions[d].a;for(let t=0;t<y;++t){i.q.SetAngle(S),s.q.SetAngle(C),r.A.SubVV(b,r.t.MulRV(i.q,p,r.A.s_t0),i.p),r.A.SubVV(v,r.t.MulRV(s.q,f,r.A.s_t0),s.p),o.Initialize(m,i,s,t);const e=o.normal,c=o.point,u=o.separation;r.A.SubVV(c,b,a),r.A.SubVV(c,v,l),_=Object(r.n)(_,u);const d=Object(r.e)(n.S*(u+n.v),-n.y,0),y=r.A.CrossVV(a,e),B=r.A.CrossVV(l,e),V=A+x+g*y*y+w*B*B,M=V>0?-d/V:0;r.A.MulSV(M,e,h),b.SelfMulSub(A,h),S-=g*r.A.CrossVV(a,h),v.SelfMulAdd(x,h),C+=w*r.A.CrossVV(l,h)}this.m_positions[u].a=S,this.m_positions[d].a=C}return _>=-1.5*n.v}}si.InitializeVelocityConstraints_s_xfA=new r.z,si.InitializeVelocityConstraints_s_xfB=new r.z,si.InitializeVelocityConstraints_s_worldManifold=new u.p,si.WarmStart_s_P=new r.A,si.SolveVelocityConstraints_s_dv=new r.A,si.SolveVelocityConstraints_s_dv1=new r.A,si.SolveVelocityConstraints_s_dv2=new r.A,si.SolveVelocityConstraints_s_P=new r.A,si.SolveVelocityConstraints_s_a=new r.A,si.SolveVelocityConstraints_s_b=new r.A,si.SolveVelocityConstraints_s_x=new r.A,si.SolveVelocityConstraints_s_d=new r.A,si.SolveVelocityConstraints_s_P1=new r.A,si.SolveVelocityConstraints_s_P2=new r.A,si.SolveVelocityConstraints_s_P1P2=new r.A,si.SolvePositionConstraints_s_xfA=new r.z,si.SolvePositionConstraints_s_xfB=new r.z,si.SolvePositionConstraints_s_psm=new ii,si.SolvePositionConstraints_s_rA=new r.A,si.SolvePositionConstraints_s_rB=new r.A,si.SolvePositionConstraints_s_P=new r.A,si.SolveTOIPositionConstraints_s_xfA=new r.z,si.SolveTOIPositionConstraints_s_xfB=new r.z,si.SolveTOIPositionConstraints_s_psm=new ii,si.SolveTOIPositionConstraints_s_rA=new r.A,si.SolveTOIPositionConstraints_s_rB=new r.A,si.SolveTOIPositionConstraints_s_P=new r.A;class ni{constructor(){this.m_allocator=null,this.m_listener=null,this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=He.MakeArray(1024),this.m_velocities=Ze.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}Initialize(t,e,i,s,n){for(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_allocator=s,this.m_listener=n;this.m_bodies.length<t;)this.m_bodies[this.m_bodies.length]=null;for(;this.m_contacts.length<e;)this.m_contacts[this.m_contacts.length]=null;for(;this.m_joints.length<i;)this.m_joints[this.m_joints.length]=null;if(this.m_positions.length<t){const e=Object(r.m)(2*this.m_positions.length,t);for(;this.m_positions.length<e;)this.m_positions[this.m_positions.length]=new He}if(this.m_velocities.length<t){const e=Object(r.m)(2*this.m_velocities.length,t);for(;this.m_velocities.length<e;)this.m_velocities[this.m_velocities.length]=new Ze}}Clear(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}AddBody(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t}AddContact(t){this.m_contacts[this.m_contactCount++]=t}AddJoint(t){this.m_joints[this.m_jointCount++]=t}Solve(t,e,i,s){const o=ni.s_timer.Reset(),a=e.dt;for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c);const s=e.m_sweep.a,n=this.m_velocities[t].v.Copy(e.m_linearVelocity);let r=e.m_angularVelocity;e.m_sweep.c0.Copy(e.m_sweep.c),e.m_sweep.a0=e.m_sweep.a,e.m_type===Wt.b2_dynamicBody&&(n.x+=a*(e.m_gravityScale*i.x+e.m_invMass*e.m_force.x),n.y+=a*(e.m_gravityScale*i.y+e.m_invMass*e.m_force.y),r+=a*e.m_invI*e.m_torque,n.SelfMul(1/(1+a*e.m_linearDamping)),r*=1/(1+a*e.m_angularDamping)),this.m_positions[t].a=s,this.m_velocities[t].w=r}o.Reset();const l=ni.s_solverData;l.step.Copy(e),l.positions=this.m_positions,l.velocities=this.m_velocities;const h=ni.s_contactSolverDef;h.step.Copy(e),h.contacts=this.m_contacts,h.count=this.m_contactCount,h.positions=this.m_positions,h.velocities=this.m_velocities,h.allocator=this.m_allocator;const _=ni.s_contactSolver.Initialize(h);_.InitializeVelocityConstraints(),e.warmStarting&&_.WarmStart();for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].InitVelocityConstraints(l);t.solveInit=o.GetMilliseconds(),o.Reset();for(let t=0;t<e.velocityIterations;++t){for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].SolveVelocityConstraints(l);_.SolveVelocityConstraints()}_.StoreImpulses(),t.solveVelocity=o.GetMilliseconds();for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const s=this.m_velocities[t].v;let o=this.m_velocities[t].w;const l=r.A.MulSV(a,s,ni.s_translation);if(r.A.DotVV(l,l)>n.J){const t=n.I/l.Length();s.SelfMul(t)}const h=a*o;if(h*h>n.F){o*=n.E/Object(r.a)(h)}e.x+=a*s.x,e.y+=a*s.y,i+=a*o,this.m_positions[t].a=i,this.m_velocities[t].w=o}o.Reset();let c=!1;for(let t=0;t<e.positionIterations;++t){const t=_.SolvePositionConstraints();let e=!0;for(let t=0;t<this.m_jointCount;++t){const i=this.m_joints[t].SolvePositionConstraints(l);e=e&&i}if(t&&e){c=!0;break}}for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];e.m_sweep.c.Copy(this.m_positions[t].c),e.m_sweep.a=this.m_positions[t].a,e.m_linearVelocity.Copy(this.m_velocities[t].v),e.m_angularVelocity=this.m_velocities[t].w,e.SynchronizeTransform()}if(t.solvePosition=o.GetMilliseconds(),this.Report(_.m_velocityConstraints),s){let t=n.x;const e=n.u*n.u,i=n.m*n.m;for(let s=0;s<this.m_bodyCount;++s){const n=this.m_bodies[s];n.GetType()!==Wt.b2_staticBody&&(!n.m_autoSleepFlag||n.m_angularVelocity*n.m_angularVelocity>i||r.A.DotVV(n.m_linearVelocity,n.m_linearVelocity)>e?(n.m_sleepTime=0,t=0):(n.m_sleepTime+=a,t=Object(r.n)(t,n.m_sleepTime)))}if(t>=n.R&&c)for(let t=0;t<this.m_bodyCount;++t){this.m_bodies[t].SetAwake(!1)}}}SolveTOI(t,e,i){for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c),this.m_positions[t].a=e.m_sweep.a,this.m_velocities[t].v.Copy(e.m_linearVelocity),this.m_velocities[t].w=e.m_angularVelocity}const s=ni.s_contactSolverDef;s.contacts=this.m_contacts,s.count=this.m_contactCount,s.allocator=this.m_allocator,s.step.Copy(t),s.positions=this.m_positions,s.velocities=this.m_velocities;const o=ni.s_contactSolver.Initialize(s);for(let s=0;s<t.positionIterations;++s){if(o.SolveTOIPositionConstraints(e,i))break}this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,o.InitializeVelocityConstraints();for(let e=0;e<t.velocityIterations;++e)o.SolveVelocityConstraints();const a=t.dt;for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const s=this.m_velocities[t].v;let o=this.m_velocities[t].w;const l=r.A.MulSV(a,s,ni.s_translation);if(r.A.DotVV(l,l)>n.J){const t=n.I/l.Length();s.SelfMul(t)}const h=a*o;if(h*h>n.F){o*=n.E/Object(r.a)(h)}e.SelfMulAdd(a,s),i+=a*o,this.m_positions[t].a=i,this.m_velocities[t].w=o;const _=this.m_bodies[t];_.m_sweep.c.Copy(e),_.m_sweep.a=i,_.m_linearVelocity.Copy(s),_.m_angularVelocity=o,_.SynchronizeTransform()}this.Report(o.m_velocityConstraints)}Report(t){if(null!==this.m_listener)for(let e=0;e<this.m_contactCount;++e){const i=this.m_contacts[e];if(!i)continue;const s=t[e],n=ni.s_impulse;n.count=s.pointCount;for(let t=0;t<s.pointCount;++t)n.normalImpulses[t]=s.points[t].normalImpulse,n.tangentImpulses[t]=s.points[t].tangentImpulse;this.m_listener.PostSolve(i,n)}}}var ri,oi;ni.s_timer=new l,ni.s_solverData=new Ye,ni.s_contactSolverDef=new ei,ni.s_contactSolver=new si,ni.s_translation=new r.A,ni.s_impulse=new Ne,function(t){t[t.b2_waterParticle=0]="b2_waterParticle",t[t.b2_zombieParticle=2]="b2_zombieParticle",t[t.b2_wallParticle=4]="b2_wallParticle",t[t.b2_springParticle=8]="b2_springParticle",t[t.b2_elasticParticle=16]="b2_elasticParticle",t[t.b2_viscousParticle=32]="b2_viscousParticle",t[t.b2_powderParticle=64]="b2_powderParticle",t[t.b2_tensileParticle=128]="b2_tensileParticle",t[t.b2_colorMixingParticle=256]="b2_colorMixingParticle",t[t.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",t[t.b2_barrierParticle=1024]="b2_barrierParticle",t[t.b2_staticPressureParticle=2048]="b2_staticPressureParticle",t[t.b2_reactiveParticle=4096]="b2_reactiveParticle",t[t.b2_repulsiveParticle=8192]="b2_repulsiveParticle",t[t.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",t[t.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",t[t.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",t[t.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle"}(ri||(ri={}));class ai{constructor(){this.flags=0,this.position=new r.A,this.velocity=new r.A,this.color=new o,this.lifetime=0,this.userData=null,this.group=null}}function li(t,e,i){const s=Math.ceil(Math.sqrt(t/(.01*e))*i);return Object(r.e)(s,1,8)}class hi{constructor(){this.m_index=n.t}GetIndex(){return this.m_index}SetIndex(t){this.m_index=t}}!function(t){t[t.b2_solidParticleGroup=1]="b2_solidParticleGroup",t[t.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",t[t.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",t[t.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",t[t.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",t[t.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask"}(oi||(oi={}));class _i{constructor(){this.flags=0,this.groupFlags=0,this.position=new r.A,this.angle=0,this.linearVelocity=new r.A,this.angularVelocity=0,this.color=new o,this.strength=1,this.shape=null,this.shapes=null,this.shapeCount=0,this.stride=0,this.particleCount=0,this.positionData=null,this.lifetime=0,this.userData=null,this.group=null}}class ci{constructor(t){this.m_system=null,this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new r.A,this.m_linearVelocity=new r.A,this.m_angularVelocity=0,this.m_transform=new r.z,this.m_userData=null,this.m_system=t}GetNext(){return this.m_next}GetParticleSystem(){return this.m_system}GetParticleCount(){return this.m_lastIndex-this.m_firstIndex}GetBufferIndex(){return this.m_firstIndex}ContainsParticle(t){return this.m_firstIndex<=t&&t<this.m_lastIndex}GetAllParticleFlags(){let t=0;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t}GetGroupFlags(){return this.m_groupFlags}SetGroupFlags(t){t|=this.m_groupFlags&oi.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,t)}GetMass(){return this.UpdateStatistics(),this.m_mass}GetInertia(){return this.UpdateStatistics(),this.m_inertia}GetCenter(){return this.UpdateStatistics(),this.m_center}GetLinearVelocity(){return this.UpdateStatistics(),this.m_linearVelocity}GetAngularVelocity(){return this.UpdateStatistics(),this.m_angularVelocity}GetTransform(){return this.m_transform}GetPosition(){return this.m_transform.p}GetAngle(){return this.m_transform.q.GetAngle()}GetLinearVelocityFromWorldPoint(t,e){const i=ci.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),r.A.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,r.A.SubVV(t,this.m_center,i),e)}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}ApplyForce(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)}ApplyLinearImpulse(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)}DestroyParticles(t){if(!this.m_system.m_world.IsLocked())for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)}UpdateStatistics(){const t=new r.A,e=new r.A;if(this.m_timestamp!==this.m_system.m_timestamp){const i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(let t=this.m_firstIndex;t<this.m_lastIndex;t++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[t]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[t]);if(this.m_mass>0){const t=1/this.m_mass;this.m_center.SelfMul(t),this.m_linearVelocity.SelfMul(t)}this.m_inertia=0,this.m_angularVelocity=0;for(let s=this.m_firstIndex;s<this.m_lastIndex;s++)r.A.SubVV(this.m_system.m_positionBuffer.data[s],this.m_center,t),r.A.SubVV(this.m_system.m_velocityBuffer.data[s],this.m_linearVelocity,e),this.m_inertia+=i*r.A.DotVV(t,t),this.m_angularVelocity+=i*r.A.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}}}ci.GetLinearVelocityFromWorldPoint_s_t0=new r.A;class mi{constructor(t){this.m_front=0,this.m_back=0,this.m_capacity=0,this.m_buffer=Object(n.e)(t,t=>null),this.m_capacity=t}Push(t){if(this.m_back>=this.m_capacity){for(let t=this.m_front;t<this.m_back;t++)this.m_buffer[t-this.m_front]=this.m_buffer[t];this.m_back-=this.m_front,this.m_front=0,this.m_back>=this.m_capacity&&(this.m_capacity>0?(this.m_buffer.concat(Object(n.e)(this.m_capacity,t=>null)),this.m_capacity*=2):(this.m_buffer.concat(Object(n.e)(1,t=>null)),this.m_capacity=1))}this.m_buffer[this.m_back]=t,this.m_back++}Pop(){this.m_front,this.m_back,delete this.m_buffer[this.m_front],this.m_front++}Empty(){return this.m_front,this.m_back,this.m_front===this.m_back}Front(){return this.m_buffer[this.m_front]}}class ui{constructor(t){this.m_generatorBuffer=null,this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=null,this.m_generatorBuffer=Object(n.e)(t,t=>new ui.Generator),this.m_generatorCapacity=t}AddGenerator(t,e,i){this.m_generatorCount,this.m_generatorCapacity;let s=this.m_generatorBuffer[this.m_generatorCount++];s.center.Copy(t),s.tag=e,s.necessary=i}Generate(t,e){this.m_diagram;let i=1/t,s=new r.A(+n.x,+n.x),o=new r.A(-n.x,-n.x),a=0;for(let t=0;t<this.m_generatorCount;t++){let e=this.m_generatorBuffer[t];e.necessary&&(r.A.MinV(s,e.center,s),r.A.MaxV(o,e.center,o),++a)}if(0===a)return this.m_countX=0,void(this.m_countY=0);s.x-=e,s.y-=e,o.x+=e,o.y+=e,this.m_countX=1+Math.floor(i*(o.x-s.x)),this.m_countY=1+Math.floor(i*(o.y-s.y)),this.m_diagram=Object(n.e)(this.m_countX*this.m_countY,t=>null);let l=new mi(4*this.m_countX*this.m_countY);for(let t=0;t<this.m_generatorCount;t++){let e=this.m_generatorBuffer[t];e.center.SelfSub(s).SelfMul(i);let n=Math.floor(e.center.x),r=Math.floor(e.center.y);n>=0&&r>=0&&n<this.m_countX&&r<this.m_countY&&l.Push(new ui.Task(n,r,n+r*this.m_countX,e))}for(;!l.Empty();){let t=l.Front(),e=t.m_x,i=t.m_y,s=t.m_i,n=t.m_generator;l.Pop(),this.m_diagram[s]||(this.m_diagram[s]=n,e>0&&l.Push(new ui.Task(e-1,i,s-1,n)),i>0&&l.Push(new ui.Task(e,i-1,s-this.m_countX,n)),e<this.m_countX-1&&l.Push(new ui.Task(e+1,i,s+1,n)),i<this.m_countY-1&&l.Push(new ui.Task(e,i+1,s+this.m_countX,n)))}for(let t=0;t<this.m_countY;t++)for(let e=0;e<this.m_countX-1;e++){let i=e+t*this.m_countX,s=this.m_diagram[i],n=this.m_diagram[i+1];s!==n&&(l.Push(new ui.Task(e,t,i,n)),l.Push(new ui.Task(e+1,t,i+1,s)))}for(let t=0;t<this.m_countY-1;t++)for(let e=0;e<this.m_countX;e++){let i=e+t*this.m_countX,s=this.m_diagram[i],n=this.m_diagram[i+this.m_countX];s!==n&&(l.Push(new ui.Task(e,t,i,n)),l.Push(new ui.Task(e,t+1,i+this.m_countX,s)))}for(;!l.Empty();){let t=l.Front(),e=t.m_x,i=t.m_y,s=t.m_i,n=t.m_generator;l.Pop();let r=this.m_diagram[s],o=n;if(r!==o){let t=r.center.x-e,n=r.center.y-i,a=o.center.x-e,h=o.center.y-i;t*t+n*n>a*a+h*h&&(this.m_diagram[s]=o,e>0&&l.Push(new ui.Task(e-1,i,s-1,o)),i>0&&l.Push(new ui.Task(e,i-1,s-this.m_countX,o)),e<this.m_countX-1&&l.Push(new ui.Task(e+1,i,s+1,o)),i<this.m_countY-1&&l.Push(new ui.Task(e,i+1,s+this.m_countX,o)))}}}GetNodes(t){for(let e=0;e<this.m_countY-1;e++)for(let i=0;i<this.m_countX-1;i++){let s=i+e*this.m_countX,n=this.m_diagram[s],r=this.m_diagram[s+1],o=this.m_diagram[s+this.m_countX],a=this.m_diagram[s+1+this.m_countX];r!==o&&(n!==r&&n!==o&&(n.necessary||r.necessary||o.necessary)&&t(n.tag,r.tag,o.tag),a!==r&&a!==o&&(n.necessary||r.necessary||o.necessary)&&t(r.tag,a.tag,o.tag))}}}function di(t,e,i){const s=t[e];t[e]=t[i],t[i]=s}function pi(t,e){return t<e}function fi(t,e=0,i=t.length-e,s=pi){let n=e,r=[],o=0;for(;;){for(;n+1<i;i++){let e=t[n+Math.floor(Math.random()*(i-n))];r[o++]=i;for(let r=n-1;;){for(;s(t[++r],e););for(;s(e,t[--i]););if(r>=i)break;di(t,r,i)}}if(0===o)break;n=i,i=r[--o]}return t}function yi(t,e=0,i=t.length-e,s=pi){return fi(t,e,i,s)}function Ai(t,e,i=t.length){let s=0;for(let n=0;n<i;++n)e(t[n])||(n!==s?di(t,s++,n):++s);return s}function gi(t,e,i,s,n=pi){let r=i-e;for(;r>0;){let i=Math.floor(r/2),o=e+i;n(t[o],s)?(e=++o,r-=i+1):r=i}return e}function xi(t,e,i,s,n=pi){let r=i-e;for(;r>0;){let i=Math.floor(r/2),o=e+i;n(s,t[o])?r=i:(e=++o,r-=i+1)}return e}function wi(t,e,i,s){let n=i;for(;e!==n;)di(t,e++,n++),n===s?n=i:e===i&&(i=n)}!function(t){t.Generator=class{constructor(){this.center=new r.A,this.tag=0,this.necessary=!1}};t.Task=class{constructor(t,e,i,s){this.m_x=0,this.m_y=0,this.m_i=0,this.m_generator=null,this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=s}}}(ui||(ui={}));class bi{constructor(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}Append(){return this.count>=this.capacity&&this.Grow(),this.count++}Reserve(t){if(!(this.capacity>=t)){this.capacity,this.data.length;for(let e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}}Grow(){let t=this.capacity?2*this.capacity:n.M;this.capacity,this.Reserve(t)}Free(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)}Shorten(t){}Data(){return this.data}GetCount(){return this.count}SetCount(t){this.count=t}GetCapacity(){return this.capacity}RemoveIf(t){for(let e=0;e<this.count;++e)t(this.data[e])||0;this.count=Ai(this.data,t,this.count),this.count}Unique(t){this.count=function(t,e,i,s){if(e===i)return i;let n=e;for(;++e!==i;)s(t[n],t[e])||di(t,++n,e);return++n}(this.data,0,this.count,t)}}class Si extends qe{constructor(t){super(),this.m_system=t}ShouldQueryParticleSystem(t){return!1}ReportFixture(t){if(t.IsSensor())return!0;const e=t.GetShape().GetChildCount();for(let i=0;i<e;i++){const e=t.GetAABB(i),s=this.m_system.GetInsideBoundsEnumerator(e);let n;for(;(n=s.GetNext())>=0;)this.ReportFixtureAndParticle(t,i,n)}return!0}ReportParticle(t,e){return!1}ReportFixtureAndParticle(t,e,i){}}class vi{constructor(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new r.A,this.flags=0}SetIndices(t,e){t<=n.B&&n.B,this.indexA=t,this.indexB=e}SetWeight(t){this.weight=t}SetNormal(t){this.normal.Copy(t)}SetFlags(t){this.flags=t}GetIndexA(){return this.indexA}GetIndexB(){return this.indexB}GetWeight(){return this.weight}GetNormal(){return this.normal}GetFlags(){return this.flags}IsEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y}IsNotEqual(t){return!this.IsEqual(t)}ApproximatelyEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&Object(r.a)(this.weight-t.weight)<.01&&r.A.DistanceSquaredVV(this.normal,t.normal)<1e-4}}class Ci{constructor(){this.index=0,this.body=null,this.fixture=null,this.weight=0,this.normal=new r.A,this.mass=0}}class Bi{constructor(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0}}class Vi{constructor(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new r.A(0,0),this.pb=new r.A(0,0),this.pc=new r.A(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0}}class Mi{constructor(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}Copy(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this}Clone(){return(new Mi).Copy(this)}}class Pi{constructor(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new Pi.UserOverridableBuffer,this.m_flagsBuffer=new Pi.UserOverridableBuffer,this.m_positionBuffer=new Pi.UserOverridableBuffer,this.m_velocityBuffer=new Pi.UserOverridableBuffer,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new Pi.UserOverridableBuffer,this.m_groupBuffer=[],this.m_userDataBuffer=new Pi.UserOverridableBuffer,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new Pi.UserOverridableBuffer,this.m_bodyContactCountBuffer=new Pi.UserOverridableBuffer,this.m_consecutiveContactStepsBuffer=new Pi.UserOverridableBuffer,this.m_stuckParticleBuffer=new bi(()=>0),this.m_proxyBuffer=new bi(()=>new Pi.Proxy),this.m_contactBuffer=new bi(()=>new vi),this.m_bodyContactBuffer=new bi(()=>new Ci),this.m_pairBuffer=new bi(()=>new Bi),this.m_triadBuffer=new bi(()=>new Vi),this.m_expirationTimeBuffer=new Pi.UserOverridableBuffer,this.m_indexByExpirationTimeBuffer=new Pi.UserOverridableBuffer,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new Mi,this.m_prev=null,this.m_next=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),t.lifetimeGranularity,this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}static computeTag(t,e){return(e+Pi.yOffset>>>0<<Pi.yShift)+(Pi.xScale*t+Pi.xOffset>>>0)>>>0}static computeRelativeTag(t,e,i){return t+(i<<Pi.yShift)+(e<<Pi.xShift)>>>0}Drop(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)}CreateParticle(t){if(this.m_world.IsLocked(),this.m_world.IsLocked())return 0;if(this.m_count>=this.m_internalAllocatedCapacity){let t=this.m_count?2*this.m_count:n.M;this.ReallocateInternalAllocatedBuffers(t)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return n.t;this.DestroyOldestParticle(0,!1),this.SolveZombie()}let e=this.m_count++;this.m_flagsBuffer.data[e]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=0),this.m_positionBuffer.data[e]=(this.m_positionBuffer.data[e]||new r.A).Copy(t.position),this.m_velocityBuffer.data[e]=(this.m_velocityBuffer.data[e]||new r.A).Copy(t.velocity),this.m_weightBuffer[e]=0,this.m_forceBuffer[e]=(this.m_forceBuffer[e]||new r.A).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=0),this.m_depthBuffer&&(this.m_depthBuffer[e]=0),!this.m_colorBuffer.data&&t.color.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[e]=(this.m_colorBuffer.data[e]||new o).Copy(t.color)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[e]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[e]=null);let i=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],s=t.lifetime>0;(this.m_expirationTimeBuffer.data||s)&&(this.SetParticleLifetime(e,s?t.lifetime:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[e]=e),i.index=e;let a=t.group;return this.m_groupBuffer[e]=a,a&&(a.m_firstIndex<a.m_lastIndex?(this.RotateBuffer(a.m_firstIndex,a.m_lastIndex,e),a.m_lastIndex,a.m_lastIndex=e+1):(a.m_firstIndex=e,a.m_lastIndex=e+1)),this.SetParticleFlags(e,t.flags),e}GetParticleHandleFromIndex(t){t>=0&&t<this.GetParticleCount()&&n.t,this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);let e=this.m_handleIndexBuffer.data[t];return e||((e=new hi).SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)}DestroyParticle(t,e=!1){let i=ri.b2_zombieParticle;e&&(i|=ri.b2_destructionListenerParticle),this.SetParticleFlags(t,this.m_flagsBuffer.data[t]|i)}DestroyOldestParticle(t,e=!1){const i=this.GetParticleCount();this.m_indexByExpirationTimeBuffer.data;const s=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],n=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[s]>0?s:n,e)}DestroyParticlesInShape(t,e,i=!1){const s=Pi.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked(),this.m_world.IsLocked())return 0;const n=new Pi.DestroyParticlesInShapeCallback(this,t,e,i),r=s;return t.ComputeAABB(r,e,0),this.m_world.QueryAABB(n,r),n.Destroyed()}CreateParticleGroup(t){let e=Pi.CreateParticleGroup_s_transform;if(this.m_world.IsLocked(),this.m_world.IsLocked())return null;let i=e;i.SetPositionAngle(t.position,t.angle);let s=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,i),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,t.shapeCount,t,i),t.particleCount){t.positionData;for(let e=0;e<t.particleCount;e++){let s=t.positionData[e];this.CreateParticleForGroup(t,i,s)}}let n=this.m_count,r=new ci(this);r.m_firstIndex=s,r.m_lastIndex=n,r.m_strength=t.strength,r.m_userData=t.userData,r.m_transform.Copy(i),r.m_prev=null,r.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=r),this.m_groupList=r,++this.m_groupCount;for(let t=s;t<n;t++)this.m_groupBuffer[t]=r;this.SetGroupFlags(r,t.groupFlags);let o=new Pi.ConnectionFilter;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(s,n,o),t.group&&(this.JoinParticleGroups(t.group,r),r=t.group),r}JoinParticleGroups(t,e){if(this.m_world.IsLocked(),this.m_world.IsLocked())return;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),e.m_lastIndex,this.m_count,this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex),t.m_lastIndex,e.m_firstIndex;let i=new Pi.JoinParticleGroupsFilter(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(let i=e.m_firstIndex;i<e.m_lastIndex;i++)this.m_groupBuffer[i]=t;let s=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,s),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)}SplitParticleGroup(t){this.UpdateContacts(!0);let e=t.GetParticleCount(),i=Object(n.e)(e,t=>new Pi.ParticleListNode);Pi.InitializeParticleLists(t,i),this.MergeParticleListsInContact(t,i);let s=Pi.FindLongestParticleList(t,i);this.MergeZombieParticleListNodes(t,i,s),this.CreateParticleGroupsFromParticleList(t,i,s),this.UpdatePairsAndTriadsWithParticleList(t,i)}GetParticleGroupList(){return this.m_groupList}GetParticleGroupCount(){return this.m_groupCount}GetParticleCount(){return this.m_count}GetMaxParticleCount(){return this.m_def.maxCount}SetMaxParticleCount(t){this.m_count,this.m_def.maxCount=t}GetAllParticleFlags(){return this.m_allParticleFlags}GetAllGroupFlags(){return this.m_allGroupFlags}SetPaused(t){this.m_paused=t}GetPaused(){return this.m_paused}SetDensity(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density}GetDensity(){return this.m_def.density}SetGravityScale(t){this.m_def.gravityScale=t}GetGravityScale(){return this.m_def.gravityScale}SetDamping(t){this.m_def.dampingStrength=t}GetDamping(){return this.m_def.dampingStrength}SetStaticPressureIterations(t){this.m_def.staticPressureIterations=t}GetStaticPressureIterations(){return this.m_def.staticPressureIterations}SetRadius(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter}GetRadius(){return this.m_particleDiameter/2}GetPositionBuffer(){return this.m_positionBuffer.data}GetVelocityBuffer(){return this.m_velocityBuffer.data}GetColorBuffer(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data}GetGroupBuffer(){return this.m_groupBuffer}GetWeightBuffer(){return this.m_weightBuffer}GetUserDataBuffer(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data}GetFlagsBuffer(){return this.m_flagsBuffer.data}SetParticleFlags(t,e){this.m_flagsBuffer.data[t]&~e&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&e&&(e&ri.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),e&ri.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=e),this.m_flagsBuffer.data[t]=e}GetParticleFlags(t){return this.m_flagsBuffer.data[t]}SetFlagsBuffer(t,e){this.SetUserOverridableBuffer(this.m_flagsBuffer,t,e)}SetPositionBuffer(t,e){this.SetUserOverridableBuffer(this.m_positionBuffer,t,e)}SetVelocityBuffer(t,e){this.SetUserOverridableBuffer(this.m_velocityBuffer,t,e)}SetColorBuffer(t,e){this.SetUserOverridableBuffer(this.m_colorBuffer,t,e)}SetUserDataBuffer(t,e){this.SetUserOverridableBuffer(this.m_userDataBuffer,t,e)}GetContacts(){return this.m_contactBuffer.data}GetContactCount(){return this.m_contactBuffer.count}GetBodyContacts(){return this.m_bodyContactBuffer.data}GetBodyContactCount(){return this.m_bodyContactBuffer.count}GetPairs(){return this.m_pairBuffer.data}GetPairCount(){return this.m_pairBuffer.count}GetTriads(){return this.m_triadBuffer.data}GetTriadCount(){return this.m_triadBuffer.count}SetStuckThreshold(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))}GetStuckCandidates(){return this.m_stuckParticleBuffer.Data()}GetStuckCandidateCount(){return this.m_stuckParticleBuffer.GetCount()}ComputeCollisionEnergy(){let t=Pi.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data,i=0;for(let s=0;s<this.m_contactBuffer.count;s++){let n=this.m_contactBuffer.data[s],o=n.indexA,a=n.indexB,l=n.normal,h=r.A.SubVV(e[a],e[o],t),_=r.A.DotVV(h,l);_<0&&(i+=_*_)}return.5*this.GetParticleMass()*i}SetStrictContactCheck(t){this.m_def.strictContactCheck=t}GetStrictContactCheck(){return this.m_def.strictContactCheck}SetParticleLifetime(t,e){this.ValidateParticleIndex(t);let i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i){let t=this.GetParticleCount();for(let e=0;e<t;++e)this.m_indexByExpirationTimeBuffer.data[e]=e}let s=e/this.m_def.lifetimeGranularity,n=s>0?this.GetQuantizedTimeElapsed()+s:s;n!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=n,this.m_expirationTimeBufferRequiresSorting=!0)}GetParticleLifetime(t){return this.ValidateParticleIndex(t),this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])}SetDestructionByAge(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t}GetDestructionByAge(){return this.m_def.destroyByAge}GetExpirationTimeBuffer(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data}ExpirationTimeToLifetime(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity}GetIndexByExpirationTimeBuffer(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data}ParticleApplyLinearImpulse(t,e){this.ApplyLinearImpulse(t,t+1,e)}ApplyLinearImpulse(t,e,i){let s=this.m_velocityBuffer.data,n=(e-t)*this.GetParticleMass(),r=i.Clone().SelfMul(1/n);for(let i=t;i<e;i++)s[i].SelfAdd(r)}static IsSignificantForce(t){return 0!==t.x||0!==t.y}ParticleApplyForce(t,e){Pi.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))}ApplyForce(t,e,i){let s=i.Clone().SelfMul(1/(e-t));if(Pi.IsSignificantForce(s)){this.PrepareForceBuffer();for(let i=t;i<e;i++)this.m_forceBuffer[i].SelfAdd(s)}}GetNext(){return this.m_next}QueryAABB(t,e){if(0===this.m_proxyBuffer.count)return;let i=this.m_proxyBuffer.count,s=gi(this.m_proxyBuffer.data,0,i,Pi.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),Pi.Proxy.CompareProxyTag),n=xi(this.m_proxyBuffer.data,s,i,Pi.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),Pi.Proxy.CompareTagProxy),r=this.m_positionBuffer.data;for(let i=s;i<n;++i){let s=this.m_proxyBuffer.data[i].index,n=r[s];if(e.lowerBound.x<n.x&&n.x<e.upperBound.x&&e.lowerBound.y<n.y&&n.y<e.upperBound.y&&!t.ReportParticle(this,s))break}}QueryShapeAABB(t,e,i,s=0){let n=Pi.QueryShapeAABB_s_aabb;e.ComputeAABB(n,i,s),this.QueryAABB(t,n)}QueryPointAABB(t,e,i=n.v){let s=Pi.QueryPointAABB_s_aabb;s.lowerBound.Set(e.x-i,e.y-i),s.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,s)}RayCast(t,e,i){let s=Pi.RayCast_s_aabb,n=Pi.RayCast_s_p,o=Pi.RayCast_s_v,a=Pi.RayCast_s_n,l=Pi.RayCast_s_point;if(0===this.m_proxyBuffer.count)return;let h=this.m_positionBuffer.data,_=s;r.A.MinV(e,i,_.lowerBound),r.A.MaxV(e,i,_.upperBound);let c,m=1,u=r.A.SubVV(i,e,o),d=r.A.DotVV(u,u),p=this.GetInsideBoundsEnumerator(_);for(;(c=p.GetNext())>=0;){let i=r.A.SubVV(e,h[c],n),s=r.A.DotVV(i,u),o=s*s-d*(r.A.DotVV(i,i)-this.m_squaredDiameter);if(o>=0){let n=Object(r.w)(o),h=(-s-n)/d;if(h>m)continue;if(h<0&&((h=(-s+n)/d)<0||h>m))continue;let _=r.A.AddVMulSV(i,h,u,a);_.Normalize();let p=t.ReportParticle(this,c,r.A.AddVMulSV(e,h,u,l),_,h);if((m=Object(r.n)(m,p))<=0)break}}}ComputeAABB(t){let e=this.GetParticleCount();t.lowerBound.x=+n.x,t.lowerBound.y=+n.x,t.upperBound.x=-n.x,t.upperBound.y=-n.x;let i=this.m_positionBuffer.data;for(let s=0;s<e;s++){let e=i[s];r.A.MinV(t.lowerBound,e,t.lowerBound),r.A.MaxV(t.upperBound,e,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter}FreeBuffer(t,e){null!==t&&(t.length=0)}FreeUserOverridableBuffer(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)}ReallocateBuffer3(t,e,i){let s=t?t.slice():[];return s.length=i,s}ReallocateBuffer5(t,e,i,s,n){return n&&!t||e||(t=this.ReallocateBuffer3(t,i,s)),t}ReallocateBuffer4(t,e,i,s){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,s)}RequestBuffer(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(n.M),(t=[]).length=this.m_internalAllocatedCapacity),t}ReallocateHandleBuffers(t){this.m_internalAllocatedCapacity,this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)}ReallocateInternalAllocatedBuffers(t){function e(t,e){return e&&t>e?e:t}if(t=e(t=e(t=e(t=e(t=e(t=e(t,this.m_def.maxCount),this.m_flagsBuffer.userSuppliedCapacity),this.m_positionBuffer.userSuppliedCapacity),this.m_velocityBuffer.userSuppliedCapacity),this.m_colorBuffer.userSuppliedCapacity),this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);let e=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,e),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,e),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,e),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}}CreateParticleForGroup(t,e,i){let s=new ai;s.flags=t.flags,r.z.MulXV(e,i,s.position),r.A.AddVV(t.linearVelocity,r.A.CrossSV(t.angularVelocity,r.A.SubVV(s.position,t.position,r.A.s_t0),r.A.s_t0),s.velocity),s.color.Copy(t.color),s.lifetime=t.lifetime,s.userData=t.userData,this.CreateParticle(s)}CreateParticlesStrokeShapeForGroup(t,e,i){let s=Pi.CreateParticlesStrokeShapeForGroup_s_edge,n=Pi.CreateParticlesStrokeShapeForGroup_s_d,o=Pi.CreateParticlesStrokeShapeForGroup_s_p,a=e.stride;0===a&&(a=this.GetParticleStride());let l=0,h=t.GetChildCount();for(let _=0;_<h;_++){let h=null;t.GetType()===Ot.c.e_edgeShape?h=t:(t.GetType(),Ot.c.e_chainShape,h=s,t.GetChildEdge(h,_));let c=r.A.SubVV(h.m_vertex2,h.m_vertex1,n),m=c.Length();for(;l<m;){let t=r.A.AddVMulSV(h.m_vertex1,l/m,c,o);this.CreateParticleForGroup(e,i,t),l+=a}l-=m}}CreateParticlesFillShapeForGroup(t,e,i){let s=Pi.CreateParticlesFillShapeForGroup_s_aabb,n=Pi.CreateParticlesFillShapeForGroup_s_p,o=e.stride;0===o&&(o=this.GetParticleStride());let a=r.z.IDENTITY,l=s;t.GetChildCount(),t.ComputeAABB(l,a,0);for(let s=Math.floor(l.lowerBound.y/o)*o;s<l.upperBound.y;s+=o)for(let r=Math.floor(l.lowerBound.x/o)*o;r<l.upperBound.x;r+=o){let o=n.Set(r,s);t.TestPoint(a,o)&&this.CreateParticleForGroup(e,i,o)}}CreateParticlesWithShapeForGroup(t,e,i){switch(t.GetType()){case Ot.c.e_edgeShape:case Ot.c.e_chainShape:this.CreateParticlesStrokeShapeForGroup(t,e,i);break;case Ot.c.e_polygonShape:case Ot.c.e_circleShape:this.CreateParticlesFillShapeForGroup(t,e,i)}}CreateParticlesWithShapesForGroup(t,e,i,s){let n=new Pi.CompositeShape(t,e);this.CreateParticlesFillShapeForGroup(n,i,s)}CloneParticle(t,e){let i=new ai;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;let s=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){let e=this.m_handleIndexBuffer.data[t];e&&e.SetIndex(s),this.m_handleIndexBuffer.data[s]=e,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[s]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[s]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[s]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[s].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[s]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[s]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[s]=this.m_expirationTimeBuffer.data[t]),s}DestroyParticlesInGroup(t,e=!1){for(let i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)}DestroyParticleGroup(t){this.m_groupCount,this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(let e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount}static ParticleCanBeConnected(t,e){return 0!=(t&(ri.b2_wallParticle|ri.b2_springParticle|ri.b2_elasticParticle))||null!==e&&0!=(e.GetGroupFlags()&oi.b2_rigidParticleGroup)}UpdatePairsAndTriads(t,e,i){let s=Pi.UpdatePairsAndTriads_s_dab,o=Pi.UpdatePairsAndTriads_s_dbc,a=Pi.UpdatePairsAndTriads_s_dca,l=this.m_positionBuffer.data,h=0;for(let i=t;i<e;i++)h|=this.m_flagsBuffer.data[i];if(h&Pi.k_pairFlags)for(let s=0;s<this.m_contactBuffer.count;s++){let n=this.m_contactBuffer.data[s],o=n.indexA,a=n.indexB,h=this.m_flagsBuffer.data[o],_=this.m_flagsBuffer.data[a],c=this.m_groupBuffer[o],m=this.m_groupBuffer[a];if(o>=t&&o<e&&a>=t&&a<e&&!((h|_)&ri.b2_zombieParticle)&&(h|_)&Pi.k_pairFlags&&(i.IsNecessary(o)||i.IsNecessary(a))&&Pi.ParticleCanBeConnected(h,c)&&Pi.ParticleCanBeConnected(_,m)&&i.ShouldCreatePair(o,a)){let t=this.m_pairBuffer.data[this.m_pairBuffer.Append()];t.indexA=o,t.indexB=a,t.flags=n.flags,t.strength=Object(r.n)(c?c.m_strength:1,m?m.m_strength:1),t.distance=r.A.DistanceVV(l[o],l[a])}yi(this.m_pairBuffer.data,0,this.m_pairBuffer.count,Pi.ComparePairIndices),this.m_pairBuffer.Unique(Pi.MatchPairIndices)}if(h&Pi.k_triadFlags){let h=new ui(e-t);for(let s=t;s<e;s++){let t=this.m_flagsBuffer.data[s],e=this.m_groupBuffer[s];t&ri.b2_zombieParticle||!Pi.ParticleCanBeConnected(t,e)||h.AddGenerator(l[s],s,i.IsNecessary(s))}let _=this.GetParticleStride();h.Generate(_/2,2*_);const c=this;let m=(t,e,h)=>{let _=c.m_flagsBuffer.data[t],m=c.m_flagsBuffer.data[e],u=c.m_flagsBuffer.data[h];if((_|m|u)&Pi.k_triadFlags&&i.ShouldCreateTriad(t,e,h)){let i=l[t],d=l[e],p=l[h],f=r.A.SubVV(i,d,s),y=r.A.SubVV(d,p,o),A=r.A.SubVV(p,i,a),g=n.L*c.m_squaredDiameter;if(r.A.DotVV(f,f)>g||r.A.DotVV(y,y)>g||r.A.DotVV(A,A)>g)return;let x=c.m_groupBuffer[t],w=c.m_groupBuffer[e],b=c.m_groupBuffer[h],S=c.m_triadBuffer.data[c.m_triadBuffer.Append()];S.indexA=t,S.indexB=e,S.indexC=h,S.flags=_|m|u,S.strength=Object(r.n)(Object(r.n)(x?x.m_strength:1,w?w.m_strength:1),b?b.m_strength:1);let v=(i.x+d.x+p.x)/3,C=(i.y+d.y+p.y)/3;S.pa.x=i.x-v,S.pa.y=i.y-C,S.pb.x=d.x-v,S.pb.y=d.y-C,S.pc.x=p.x-v,S.pc.y=p.y-C,S.ka=-r.A.DotVV(A,f),S.kb=-r.A.DotVV(f,y),S.kc=-r.A.DotVV(y,A),S.s=r.A.CrossVV(i,d)+r.A.CrossVV(d,p)+r.A.CrossVV(p,i)}};h.GetNodes(m),yi(this.m_triadBuffer.data,0,this.m_triadBuffer.count,Pi.CompareTriadIndices),this.m_triadBuffer.Unique(Pi.MatchTriadIndices)}}UpdatePairsAndTriadsWithReactiveParticles(){let t=new Pi.ReactiveFilter(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,t);for(let t=0;t<this.m_count;t++)this.m_flagsBuffer.data[t]&=~ri.b2_reactiveParticle;this.m_allParticleFlags&=~ri.b2_reactiveParticle}static ComparePairIndices(t,e){let i=t.indexA-e.indexA;return 0!==i?i<0:t.indexB<e.indexB}static MatchPairIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB}static CompareTriadIndices(t,e){let i=t.indexA-e.indexA;if(0!==i)return i<0;let s=t.indexB-e.indexB;return 0!==s?s<0:t.indexC<e.indexC}static MatchTriadIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC}static InitializeParticleLists(t,e){let i=t.GetBufferIndex(),s=t.GetParticleCount();for(let t=0;t<s;t++){let s=e[t];s.list=s,s.next=null,s.count=1,s.index=t+i}}MergeParticleListsInContact(t,e){let i=t.GetBufferIndex();for(let s=0;s<this.m_contactBuffer.count;s++){let n=this.m_contactBuffer.data[s],r=n.indexA,o=n.indexB;if(!t.ContainsParticle(r)||!t.ContainsParticle(o))continue;let a=e[r-i].list,l=e[o-i].list;if(a!==l){if(a.count<l.count){let t=a;a=l,l=t}a.count,l.count,Pi.MergeParticleLists(a,l)}}}static MergeParticleLists(t,e){for(let i=e;;){i.list=t;let e=i.next;if(!e){i.next=t.next;break}i=e}t.next=e,t.count+=e.count,e.count=0}static FindLongestParticleList(t,e){let i=t.GetParticleCount(),s=e[0];for(let t=0;t<i;t++){let i=e[t];s.count<i.count&&(s=i)}return s}MergeZombieParticleListNodes(t,e,i){let s=t.GetParticleCount();for(let t=0;t<s;t++){let s=e[t];s!==i&&this.m_flagsBuffer.data[s.index]&ri.b2_zombieParticle&&Pi.MergeParticleListAndNode(i,s)}}static MergeParticleListAndNode(t,e){e.list,e.count,e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0}CreateParticleGroupsFromParticleList(t,e,i){let s=t.GetParticleCount(),n=new _i;n.groupFlags=t.GetGroupFlags(),n.userData=t.GetUserData();for(let t=0;t<s;t++){let s=e[t];if(!s.count||s===i)continue;s.list;let r=this.CreateParticleGroup(n);for(let t=s;t;t=t.next){let e=t.index;this.m_flagsBuffer.data[e];ri.b2_zombieParticle;let i=this.CloneParticle(e,r);this.m_flagsBuffer.data[e]|=ri.b2_zombieParticle,t.index=i}}}UpdatePairsAndTriadsWithParticleList(t,e){let i=t.GetBufferIndex();for(let s=0;s<this.m_pairBuffer.count;s++){let n=this.m_pairBuffer.data[s],r=n.indexA,o=n.indexB;t.ContainsParticle(r)&&(n.indexA=e[r-i].index),t.ContainsParticle(o)&&(n.indexB=e[o-i].index)}for(let s=0;s<this.m_triadBuffer.count;s++){let n=this.m_triadBuffer.data[s],r=n.indexA,o=n.indexB,a=n.indexC;t.ContainsParticle(r)&&(n.indexA=e[r-i].index),t.ContainsParticle(o)&&(n.indexB=e[o-i].index),t.ContainsParticle(a)&&(n.indexC=e[a-i].index)}}ComputeDepth(){let t=[],e=0;for(let i=0;i<this.m_contactBuffer.count;i++){let s=this.m_contactBuffer.data[i],n=s.indexA,r=s.indexB,o=this.m_groupBuffer[n],a=this.m_groupBuffer[r];o&&o===a&&o.m_groupFlags&oi.b2_particleGroupNeedsUpdateDepth&&(t[e++]=s)}let i=[],s=0;for(let t=this.m_groupList;t;t=t.GetNext())if(t.m_groupFlags&oi.b2_particleGroupNeedsUpdateDepth){i[s++]=t,this.SetGroupFlags(t,t.m_groupFlags&~oi.b2_particleGroupNeedsUpdateDepth);for(let e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_accumulationBuffer[e]=0}for(let i=0;i<e;i++){let e=t[i],s=e.indexA,n=e.indexB,r=e.weight;this.m_accumulationBuffer[s]+=r,this.m_accumulationBuffer[n]+=r}this.m_depthBuffer;for(let t=0;t<s;t++){let e=i[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++){let e=this.m_accumulationBuffer[t];this.m_depthBuffer[t]=e<.8?0:n.x}}let o=Object(r.w)(this.m_count)>>0;for(let i=0;i<o;i++){let i=!1;for(let s=0;s<e;s++){let e=t[s],n=e.indexA,r=e.indexB,o=1-e.weight,a=this.m_depthBuffer[n],l=this.m_depthBuffer[r],h=l+o,_=a+o;a>h&&(this.m_depthBuffer[n]=h,i=!0),l>_&&(this.m_depthBuffer[r]=_,i=!0)}if(!i)break}for(let t=0;t<s;t++){let e=i[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_depthBuffer[t]<n.x?this.m_depthBuffer[t]*=this.m_particleDiameter:this.m_depthBuffer[t]=0}}GetInsideBoundsEnumerator(t){let e=Pi.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=Pi.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),s=this.m_proxyBuffer.count,n=gi(this.m_proxyBuffer.data,0,s,e,Pi.Proxy.CompareProxyTag),r=xi(this.m_proxyBuffer.data,0,s,i,Pi.Proxy.CompareTagProxy);return new Pi.InsideBoundsEnumerator(this,e,i,n,r)}UpdateAllParticleFlags(){this.m_allParticleFlags=0;for(let t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1}UpdateAllGroupFlags(){this.m_allGroupFlags=0;for(let t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1}AddContact(t,e,i){let s=Pi.AddContact_s_d,n=this.m_positionBuffer.data;this.m_contactBuffer;let o=r.A.SubVV(n[e],n[t],s),a=r.A.DotVV(o,o);if(a<this.m_squaredDiameter){let i=Object(r.h)(a);isFinite(i)||(i=198177537e11);let s=this.m_contactBuffer.data[this.m_contactBuffer.Append()];s.indexA=t,s.indexB=e,s.flags=this.m_flagsBuffer.data[t]|this.m_flagsBuffer.data[e],s.weight=1-a*i*this.m_inverseDiameter,r.A.MulSV(i,o,s.normal)}}FindContacts_Reference(t){this.m_contactBuffer;let e=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(let t=0,i=0;t<e;t++){let s=Pi.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,0);for(let i=t+1;i<e&&!(s<this.m_proxyBuffer.data[i].tag);i++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[i].index,this.m_contactBuffer);let n=Pi.computeRelativeTag(this.m_proxyBuffer.data[t].tag,-1,1);for(;i<e&&!(n<=this.m_proxyBuffer.data[i].tag);i++);let r=Pi.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,1);for(let s=i;s<e&&!(r<this.m_proxyBuffer.data[s].tag);s++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[s].index,this.m_contactBuffer)}}FindContacts(t){this.FindContacts_Reference(t)}UpdateProxies_Reference(t){this.m_proxyBuffer;let e=this.m_positionBuffer.data,i=this.m_inverseDiameter;for(let t=0;t<this.m_proxyBuffer.count;++t){let s=this.m_proxyBuffer.data[t],n=e[s.index];s.tag=Pi.computeTag(i*n.x,i*n.y)}}UpdateProxies(t){this.UpdateProxies_Reference(t)}SortProxies(t){this.m_proxyBuffer,fi(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,Pi.Proxy.CompareProxyProxy)}FilterContacts(t){let e=this.GetParticleContactFilter();if(null===e)return;this.m_contactBuffer;const i=this;this.m_contactBuffer.RemoveIf(t=>t.flags&ri.b2_particleContactFilterParticle&&!e.ShouldCollideParticleParticle(i,t.indexA,t.indexB))}NotifyContactListenerPreContact(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error}NotifyContactListenerPostContact(t){let e=this.GetParticleContactListener();if(null!==e){for(let i=0;i<this.m_contactBuffer.count;++i){let s=this.m_contactBuffer.data[i],n=-1;n>=0?t.Invalidate(n):e.BeginContactParticleParticle(this,s)}throw new Error}}static b2ParticleContactIsZombie(t){return(t.flags&ri.b2_zombieParticle)===ri.b2_zombieParticle}UpdateContacts(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);let e=new Pi.b2ParticlePairSet;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(Pi.b2ParticleContactIsZombie)}NotifyBodyContactListenerPreContact(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error}NotifyBodyContactListenerPostContact(t){let e=this.GetFixtureContactListener();if(null!==e){for(let i=0;i<this.m_bodyContactBuffer.count;i++){let s=this.m_bodyContactBuffer.data[i],n=-1;n>=0?t.Invalidate(n):e.BeginContactFixtureParticle(this,s)}throw new Error}}UpdateBodyContacts(){let t=Pi.UpdateBodyContacts_s_aabb,e=new Pi.FixtureParticleSet;if(this.NotifyBodyContactListenerPreContact(e),this.m_stuckThreshold>0){let t=this.GetParticleCount();for(let e=0;e<t;e++)this.m_bodyContactCountBuffer.data[e]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[e]+1&&(this.m_consecutiveContactStepsBuffer.data[e]=0)}this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);let i=t;this.ComputeAABB(i);let s=new Pi.UpdateBodyContactsCallback(this,this.GetFixtureContactFilter());this.m_world.QueryAABB(s,i),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)}Solve(t){let e=Pi.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(t),this.m_allParticleFlags&ri.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<t.particleIterations;this.m_iterationIndex++){++this.m_timestamp;let i=e.Copy(t);i.dt/=t.particleIterations,i.inv_dt*=t.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&oi.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&ri.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(i),this.m_allParticleFlags&ri.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&ri.b2_repulsiveParticle&&this.SolveRepulsive(i),this.m_allParticleFlags&ri.b2_powderParticle&&this.SolvePowder(i),this.m_allParticleFlags&ri.b2_tensileParticle&&this.SolveTensile(i),this.m_allGroupFlags&oi.b2_solidParticleGroup&&this.SolveSolid(i),this.m_allParticleFlags&ri.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(i),this.m_allParticleFlags&ri.b2_staticPressureParticle&&this.SolveStaticPressure(i),this.SolvePressure(i),this.SolveDamping(i),this.m_allParticleFlags&Pi.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&ri.b2_elasticParticle&&this.SolveElastic(i),this.m_allParticleFlags&ri.b2_springParticle&&this.SolveSpring(i),this.LimitVelocity(i),this.m_allGroupFlags&oi.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&ri.b2_barrierParticle&&this.SolveBarrier(i),this.SolveCollision(i),this.m_allGroupFlags&oi.b2_rigidParticleGroup&&this.SolveRigid(i),this.m_allParticleFlags&ri.b2_wallParticle&&this.SolveWall();for(let t=0;t<this.m_count;t++)this.m_positionBuffer.data[t].SelfMulAdd(i.dt,this.m_velocityBuffer.data[t])}}SolveCollision(t){let e=Pi.SolveCollision_s_aabb,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,o=e;o.lowerBound.x=+n.x,o.lowerBound.y=+n.x,o.upperBound.x=-n.x,o.upperBound.y=-n.x;for(let e=0;e<this.m_count;e++){let n=s[e],a=i[e],l=a.x+t.dt*n.x,h=a.y+t.dt*n.y;o.lowerBound.x=Object(r.n)(o.lowerBound.x,Object(r.n)(a.x,l)),o.lowerBound.y=Object(r.n)(o.lowerBound.y,Object(r.n)(a.y,h)),o.upperBound.x=Object(r.m)(o.upperBound.x,Object(r.m)(a.x,l)),o.upperBound.y=Object(r.m)(o.upperBound.y,Object(r.m)(a.y,h))}let a=new Pi.SolveCollisionCallback(this,t);this.m_world.QueryAABB(a,o)}LimitVelocity(t){let e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t);for(let t=0;t<this.m_count;t++){let s=e[t],n=r.A.DotVV(s,s);n>i&&s.SelfMul(Object(r.w)(i/n))}}SolveGravity(t){let e=Pi.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,s=r.A.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e);for(let t=0;t<this.m_count;t++)i[t].SelfAdd(s)}SolveBarrier(t){let e=Pi.SolveBarrier_s_aabb,i=Pi.SolveBarrier_s_va,s=Pi.SolveBarrier_s_vb,o=Pi.SolveBarrier_s_pba,a=Pi.SolveBarrier_s_vba,l=Pi.SolveBarrier_s_vc,h=Pi.SolveBarrier_s_pca,_=Pi.SolveBarrier_s_vca,c=Pi.SolveBarrier_s_qba,m=Pi.SolveBarrier_s_qca,u=Pi.SolveBarrier_s_dv,d=Pi.SolveBarrier_s_f,p=this.m_positionBuffer.data,f=this.m_velocityBuffer.data;for(let t=0;t<this.m_count;t++){0!=(this.m_flagsBuffer.data[t]&Pi.k_barrierWallFlags)&&f[t].SetZero()}let y=n.o*t.dt,A=this.GetParticleMass();for(let n=0;n<this.m_pairBuffer.count;n++){let g=this.m_pairBuffer.data[n];if(g.flags&ri.b2_barrierParticle){let n=g.indexA,x=g.indexB,w=p[n],b=p[x],S=e;r.A.MinV(w,b,S.lowerBound),r.A.MaxV(w,b,S.upperBound);let v,C=this.m_groupBuffer[n],B=this.m_groupBuffer[x],V=this.GetLinearVelocity(C,n,w,i),M=this.GetLinearVelocity(B,x,b,s),P=r.A.SubVV(b,w,o),I=r.A.SubVV(M,V,a),D=this.GetInsideBoundsEnumerator(S);for(;(v=D.GetNext())>=0;){let e=p[v],i=this.m_groupBuffer[v];if(C!==i&&B!==i){let s,n,o=this.GetLinearVelocity(i,v,e,l),a=r.A.SubVV(e,w,h),p=r.A.SubVV(o,V,_),g=r.A.CrossVV(I,p),x=r.A.CrossVV(P,p)-r.A.CrossVV(a,I),b=r.A.CrossVV(P,a),S=c,C=m;if(0===g){if(0===x)continue;if(!((n=-b/x)>=0&&n<y))continue;if(r.A.AddVMulSV(P,n,I,S),r.A.AddVMulSV(a,n,p,C),!((s=r.A.DotVV(S,C)/r.A.DotVV(S,S))>=0&&s<=1))continue}else{let t=x*x-4*b*g;if(t<0)continue;let e=Object(r.w)(t),i=(-x-e)/(2*g),o=(-x+e)/(2*g);if(i>o){let t=i;i=o,o=t}if(n=i,r.A.AddVMulSV(P,n,I,S),r.A.AddVMulSV(a,n,p,C),s=r.A.DotVV(S,C)/r.A.DotVV(S,S),!(n>=0&&n<y&&s>=0&&s<=1)){if(!((n=o)>=0&&n<y))continue;if(r.A.AddVMulSV(P,n,I,S),r.A.AddVMulSV(a,n,p,C),!((s=r.A.DotVV(S,C)/r.A.DotVV(S,S))>=0&&s<=1))continue}}let B=u;B.x=V.x+s*I.x-o.x,B.y=V.y+s*I.y-o.y;let M=r.A.MulSV(A,B,d);if(this.IsRigidGroup(i)){let t=i.GetMass(),s=i.GetInertia();t>0&&i.m_linearVelocity.SelfMulAdd(1/t,M),s>0&&(i.m_angularVelocity+=r.A.CrossVV(r.A.SubVV(e,i.GetCenter(),r.A.s_t0),M)/s)}else f[v].SelfAdd(B);this.ParticleApplyForce(v,M.SelfMul(-t.inv_dt))}}}}}SolveStaticPressure(t){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);let e=this.GetCriticalPressure(t),i=this.m_def.staticPressureStrength*e,s=n.C*e,o=this.m_def.staticPressureRelaxation;for(let t=0;t<this.m_def.staticPressureIterations;t++){for(let t=0;t<this.m_count;t++)this.m_accumulationBuffer[t]=0;for(let t=0;t<this.m_contactBuffer.count;t++){let e=this.m_contactBuffer.data[t];if(e.flags&ri.b2_staticPressureParticle){let t=e.indexA,i=e.indexB,s=e.weight;this.m_accumulationBuffer[t]+=s*this.m_staticPressureBuffer[i],this.m_accumulationBuffer[i]+=s*this.m_staticPressureBuffer[t]}}for(let t=0;t<this.m_count;t++){let e=this.m_weightBuffer[t];if(this.m_flagsBuffer.data[t]&ri.b2_staticPressureParticle){let a=(this.m_accumulationBuffer[t]+i*(e-n.N))/(e+o);this.m_staticPressureBuffer[t]=Object(r.e)(a,0,s)}else this.m_staticPressureBuffer[t]=0}}}ComputeWeight(){for(let t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(let t=0;t<this.m_bodyContactBuffer.count;t++){let e=this.m_bodyContactBuffer.data[t],i=e.index,s=e.weight;this.m_weightBuffer[i]+=s}for(let t=0;t<this.m_contactBuffer.count;t++){let e=this.m_contactBuffer.data[t],i=e.indexA,s=e.indexB,n=e.weight;this.m_weightBuffer[i]+=n,this.m_weightBuffer[s]+=n}}SolvePressure(t){let e=Pi.SolvePressure_s_f,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,o=this.GetCriticalPressure(t),a=this.m_def.pressureStrength*o,l=n.C*o;for(let t=0;t<this.m_count;t++){let e=this.m_weightBuffer[t],i=a*Object(r.m)(0,e-n.N);this.m_accumulationBuffer[t]=Object(r.n)(i,l)}if(this.m_allParticleFlags&Pi.k_noPressureFlags)for(let t=0;t<this.m_count;t++)this.m_flagsBuffer.data[t]&Pi.k_noPressureFlags&&(this.m_accumulationBuffer[t]=0);if(this.m_allParticleFlags&ri.b2_staticPressureParticle){this.m_staticPressureBuffer;for(let t=0;t<this.m_count;t++)this.m_flagsBuffer.data[t]&ri.b2_staticPressureParticle&&(this.m_accumulationBuffer[t]+=this.m_staticPressureBuffer[t])}let h=t.dt/(this.m_def.density*this.m_particleDiameter),_=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){let n=this.m_bodyContactBuffer.data[t],o=n.index,l=n.body,c=n.weight,m=n.mass,u=n.normal,d=i[o],p=this.m_accumulationBuffer[o]+a*c,f=r.A.MulSV(h*c*m*p,u,e);s[o].SelfMulSub(_,f),l.ApplyLinearImpulse(f,d,!0)}for(let t=0;t<this.m_contactBuffer.count;t++){let i=this.m_contactBuffer.data[t],n=i.indexA,o=i.indexB,a=i.weight,l=i.normal,_=this.m_accumulationBuffer[n]+this.m_accumulationBuffer[o],c=r.A.MulSV(h*a*_,l,e);s[n].SelfSub(c),s[o].SelfAdd(c)}}SolveDamping(t){let e=Pi.SolveDamping_s_v,i=Pi.SolveDamping_s_f,s=this.m_positionBuffer.data,n=this.m_velocityBuffer.data,o=this.m_def.dampingStrength,a=1/this.GetCriticalVelocity(t),l=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){let h=this.m_bodyContactBuffer.data[t],_=h.index,c=h.body,m=h.weight,u=h.mass,d=h.normal,p=s[_],f=r.A.SubVV(c.GetLinearVelocityFromWorldPoint(p,r.A.s_t0),n[_],e),y=r.A.DotVV(f,d);if(y<0){let t=Object(r.m)(o*m,Object(r.n)(-a*y,.5)),e=r.A.MulSV(t*u*y,d,i);n[_].SelfMulAdd(l,e),c.ApplyLinearImpulse(e.SelfNeg(),p,!0)}}for(let t=0;t<this.m_contactBuffer.count;t++){let s=this.m_contactBuffer.data[t],l=s.indexA,h=s.indexB,_=s.weight,c=s.normal,m=r.A.SubVV(n[h],n[l],e),u=r.A.DotVV(m,c);if(u<0){let t=Object(r.m)(o*_,Object(r.n)(-a*u,.5)),e=r.A.MulSV(t*u,c,i);n[l].SelfAdd(e),n[h].SelfSub(e)}}}SolveRigidDamping(){let t=Pi.SolveRigidDamping_s_t0,e=Pi.SolveRigidDamping_s_t1,i=Pi.SolveRigidDamping_s_p,s=Pi.SolveRigidDamping_s_v,n=[0],o=[0],a=[0],l=[0],h=[0],_=[0],c=this.m_positionBuffer.data,m=this.m_def.dampingStrength;for(let i=0;i<this.m_bodyContactBuffer.count;i++){let u=this.m_bodyContactBuffer.data[i],d=u.index,p=this.m_groupBuffer[d];if(this.IsRigidGroup(p)){let i=u.body,f=u.normal,y=u.weight,A=c[d],g=r.A.SubVV(i.GetLinearVelocityFromWorldPoint(A,t),p.GetLinearVelocityFromWorldPoint(A,e),s),x=r.A.DotVV(g,f);if(x<0){this.InitDampingParameterWithRigidGroupOrParticle(n,o,a,!0,p,d,A,f),this.InitDampingParameter(l,h,_,i.GetMass(),i.GetInertia()-i.GetMass()*i.GetLocalCenter().LengthSquared(),i.GetWorldCenter(),A,f);let t=m*Object(r.n)(y,1)*this.ComputeDampingImpulse(n[0],o[0],a[0],l[0],h[0],_[0],x);this.ApplyDamping(n[0],o[0],a[0],!0,p,d,t,f),i.ApplyLinearImpulse(r.A.MulSV(-t,f,r.A.s_t0),A,!0)}}}for(let u=0;u<this.m_contactBuffer.count;u++){let d=this.m_contactBuffer.data[u],p=d.indexA,f=d.indexB,y=d.normal,A=d.weight,g=this.m_groupBuffer[p],x=this.m_groupBuffer[f],w=this.IsRigidGroup(g),b=this.IsRigidGroup(x);if(g!==x&&(w||b)){let u=r.A.MidVV(c[p],c[f],i),d=r.A.SubVV(this.GetLinearVelocity(x,f,u,t),this.GetLinearVelocity(g,p,u,e),s),S=r.A.DotVV(d,y);if(S<0){this.InitDampingParameterWithRigidGroupOrParticle(n,o,a,w,g,p,u,y),this.InitDampingParameterWithRigidGroupOrParticle(l,h,_,b,x,f,u,y);let t=m*A*this.ComputeDampingImpulse(n[0],o[0],a[0],l[0],h[0],_[0],S);this.ApplyDamping(n[0],o[0],a[0],w,g,p,t,y),this.ApplyDamping(l[0],h[0],_[0],b,x,f,-t,y)}}}}SolveExtraDamping(){let t=Pi.SolveExtraDamping_s_v,e=Pi.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,s=this.m_positionBuffer.data,n=this.GetParticleInvMass();for(let o=0;o<this.m_bodyContactBuffer.count;o++){let a=this.m_bodyContactBuffer.data[o],l=a.index;if(this.m_flagsBuffer.data[l]&Pi.k_extraDampingFlags){let o=a.body,h=a.mass,_=a.normal,c=s[l],m=r.A.SubVV(o.GetLinearVelocityFromWorldPoint(c,r.A.s_t0),i[l],t),u=r.A.DotVV(m,_);if(u<0){let t=r.A.MulSV(.5*h*u,_,e);i[l].SelfMulAdd(n,t),o.ApplyLinearImpulse(t.SelfNeg(),c,!0)}}}}SolveWall(){let t=this.m_velocityBuffer.data;for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&ri.b2_wallParticle&&t[e].SetZero()}SolveRigid(t){let e=Pi.SolveRigid_s_position,i=Pi.SolveRigid_s_rotation,s=Pi.SolveRigid_s_transform,n=Pi.SolveRigid_s_velocityTransform,o=this.m_positionBuffer.data,a=this.m_velocityBuffer.data;for(let l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&oi.b2_rigidParticleGroup){l.UpdateStatistics();let h=i;h.SetAngle(t.dt*l.m_angularVelocity);let _=r.A.AddVV(l.m_center,r.A.SubVV(r.A.MulSV(t.dt,l.m_linearVelocity,r.A.s_t0),r.t.MulRV(h,l.m_center,r.A.s_t1),r.A.s_t0),e),c=s;c.SetPositionRotation(_,h),r.z.MulXX(c,l.m_transform,l.m_transform);let m=n;m.p.x=t.inv_dt*c.p.x,m.p.y=t.inv_dt*c.p.y,m.q.s=t.inv_dt*c.q.s,m.q.c=t.inv_dt*(c.q.c-1);for(let t=l.m_firstIndex;t<l.m_lastIndex;t++)r.z.MulXV(m,o[t],a[t])}}SolveElastic(t){let e=Pi.SolveElastic_s_pa,i=Pi.SolveElastic_s_pb,s=Pi.SolveElastic_s_pc,n=Pi.SolveElastic_s_r,o=Pi.SolveElastic_s_t0,a=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,h=t.inv_dt*this.m_def.elasticStrength;for(let _=0;_<this.m_triadBuffer.count;_++){let c=this.m_triadBuffer.data[_];if(c.flags&ri.b2_elasticParticle){let _=c.indexA,m=c.indexB,u=c.indexC,d=c.pa,p=c.pb,f=c.pc,y=e.Copy(a[_]),A=i.Copy(a[m]),g=s.Copy(a[u]),x=l[_],w=l[m],b=l[u];y.SelfMulAdd(t.dt,x),A.SelfMulAdd(t.dt,w),g.SelfMulAdd(t.dt,b);let S=(y.x+A.x+g.x)/3,v=(y.y+A.y+g.y)/3;y.x-=S,y.y-=v,A.x-=S,A.y-=v,g.x-=S,g.y-=v;let C=n;C.s=r.A.CrossVV(d,y)+r.A.CrossVV(p,A)+r.A.CrossVV(f,g),C.c=r.A.DotVV(d,y)+r.A.DotVV(p,A)+r.A.DotVV(f,g);let B=C.s*C.s+C.c*C.c,V=Object(r.h)(B);isFinite(V)||(V=198177537e11),C.s*=V,C.c*=V;let M=h*c.strength;r.t.MulRV(C,d,o),r.A.SubVV(o,y,o),r.A.MulSV(M,o,o),x.SelfAdd(o),r.t.MulRV(C,p,o),r.A.SubVV(o,A,o),r.A.MulSV(M,o,o),w.SelfAdd(o),r.t.MulRV(C,f,o),r.A.SubVV(o,g,o),r.A.MulSV(M,o,o),b.SelfAdd(o)}}}SolveSpring(t){let e=Pi.SolveSpring_s_pa,i=Pi.SolveSpring_s_pb,s=Pi.SolveSpring_s_d,n=Pi.SolveSpring_s_f,o=this.m_positionBuffer.data,a=this.m_velocityBuffer.data,l=t.inv_dt*this.m_def.springStrength;for(let h=0;h<this.m_pairBuffer.count;h++){let _=this.m_pairBuffer.data[h];if(_.flags&ri.b2_springParticle){let h=_.indexA,c=_.indexB,m=e.Copy(o[h]),u=i.Copy(o[c]),d=a[h],p=a[c];m.SelfMulAdd(t.dt,d),u.SelfMulAdd(t.dt,p);let f=r.A.SubVV(u,m,s),y=_.distance,A=f.Length(),g=l*_.strength,x=r.A.MulSV(g*(y-A)/A,f,n);d.SelfSub(x),p.SelfAdd(x)}}}SolveTensile(t){let e=Pi.SolveTensile_s_weightedNormal,i=Pi.SolveTensile_s_s,s=Pi.SolveTensile_s_f,o=this.m_velocityBuffer.data;this.m_accumulation2Buffer;for(let t=0;t<this.m_count;t++)this.m_accumulation2Buffer[t]=new r.A,this.m_accumulation2Buffer[t].SetZero();for(let t=0;t<this.m_contactBuffer.count;t++){let i=this.m_contactBuffer.data[t];if(i.flags&ri.b2_tensileParticle){let t=i.indexA,s=i.indexB,n=i.weight,o=i.normal,a=r.A.MulSV((1-n)*n,o,e);this.m_accumulation2Buffer[t].SelfSub(a),this.m_accumulation2Buffer[s].SelfAdd(a)}}let a=this.GetCriticalVelocity(t),l=this.m_def.surfaceTensionPressureStrength*a,h=this.m_def.surfaceTensionNormalStrength*a,_=n.A*a;for(let t=0;t<this.m_contactBuffer.count;t++){let e=this.m_contactBuffer.data[t];if(e.flags&ri.b2_tensileParticle){let t=e.indexA,n=e.indexB,a=e.weight,c=e.normal,m=this.m_weightBuffer[t]+this.m_weightBuffer[n],u=r.A.SubVV(this.m_accumulation2Buffer[n],this.m_accumulation2Buffer[t],i),d=Object(r.n)(l*(m-2)+h*r.A.DotVV(u,c),_)*a,p=r.A.MulSV(d,c,s);o[t].SelfSub(p),o[n].SelfAdd(p)}}}SolveViscous(){let t=Pi.SolveViscous_s_v,e=Pi.SolveViscous_s_f,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,n=this.m_def.viscousStrength,o=this.GetParticleInvMass();for(let a=0;a<this.m_bodyContactBuffer.count;a++){let l=this.m_bodyContactBuffer.data[a],h=l.index;if(this.m_flagsBuffer.data[h]&ri.b2_viscousParticle){let a=l.body,_=l.weight,c=l.mass,m=i[h],u=r.A.SubVV(a.GetLinearVelocityFromWorldPoint(m,r.A.s_t0),s[h],t),d=r.A.MulSV(n*c*_,u,e);s[h].SelfMulAdd(o,d),a.ApplyLinearImpulse(d.SelfNeg(),m,!0)}}for(let i=0;i<this.m_contactBuffer.count;i++){let o=this.m_contactBuffer.data[i];if(o.flags&ri.b2_viscousParticle){let i=o.indexA,a=o.indexB,l=o.weight,h=r.A.SubVV(s[a],s[i],t),_=r.A.MulSV(n*l,h,e);s[i].SelfAdd(_),s[a].SelfSub(_)}}}SolveRepulsive(t){let e=Pi.SolveRepulsive_s_f,i=this.m_velocityBuffer.data,s=this.m_def.repulsiveStrength*this.GetCriticalVelocity(t);for(let t=0;t<this.m_contactBuffer.count;t++){let n=this.m_contactBuffer.data[t];if(n.flags&ri.b2_repulsiveParticle){let t=n.indexA,o=n.indexB;if(this.m_groupBuffer[t]!==this.m_groupBuffer[o]){let a=n.weight,l=n.normal,h=r.A.MulSV(s*a,l,e);i[t].SelfSub(h),i[o].SelfAdd(h)}}}}SolvePowder(t){let e=Pi.SolvePowder_s_f,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,o=this.m_def.powderStrength*this.GetCriticalVelocity(t),a=1-n.O,l=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){let n=this.m_bodyContactBuffer.data[t],h=n.index;if(this.m_flagsBuffer.data[h]&ri.b2_powderParticle){let t=n.weight;if(t>a){let _=n.body,c=n.mass,m=i[h],u=n.normal,d=r.A.MulSV(o*c*(t-a),u,e);s[h].SelfMulSub(l,d),_.ApplyLinearImpulse(d,m,!0)}}}for(let t=0;t<this.m_contactBuffer.count;t++){let i=this.m_contactBuffer.data[t];if(i.flags&ri.b2_powderParticle){let t=i.weight;if(t>a){let n=i.indexA,l=i.indexB,h=i.normal,_=r.A.MulSV(o*(t-a),h,e);s[n].SelfSub(_),s[l].SelfAdd(_)}}}}SolveSolid(t){let e=Pi.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);let s=t.inv_dt*this.m_def.ejectionStrength;for(let t=0;t<this.m_contactBuffer.count;t++){let n=this.m_contactBuffer.data[t],o=n.indexA,a=n.indexB;if(this.m_groupBuffer[o]!==this.m_groupBuffer[a]){let t=n.weight,l=n.normal,h=this.m_depthBuffer[o]+this.m_depthBuffer[a],_=r.A.MulSV(s*h*t,l,e);i[o].SelfSub(_),i[a].SelfAdd(_)}}}SolveForce(t){let e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass();for(let t=0;t<this.m_count;t++)e[t].SelfMulAdd(i,this.m_forceBuffer[t]);this.m_hasForce=!1}SolveColorMixing(){this.m_colorBuffer.data;const t=.5*this.m_def.colorMixingStrength;if(t)for(let e=0;e<this.m_contactBuffer.count;e++){let i=this.m_contactBuffer.data[e],s=i.indexA,n=i.indexB;if(this.m_flagsBuffer.data[s]&this.m_flagsBuffer.data[n]&ri.b2_colorMixingParticle){let e=this.m_colorBuffer.data[s],i=this.m_colorBuffer.data[n];o.MixColors(e,i,t)}}}SolveZombie(){let t=0,e=[];for(let t=0;t<this.m_count;t++)e[t]=n.t;e.length,this.m_count;let i=0;for(let s=0;s<this.m_count;s++){let r=this.m_flagsBuffer.data[s];if(r&ri.b2_zombieParticle){let t=this.m_world.m_destructionListener;if(r&ri.b2_destructionListenerParticle&&t&&t.SayGoodbyeParticle(this,s),this.m_handleIndexBuffer.data){let t=this.m_handleIndexBuffer.data[s];t&&(t.SetIndex(n.t),this.m_handleIndexBuffer.data[s]=null)}e[s]=n.t}else{if(e[s]=t,s!==t){if(this.m_handleIndexBuffer.data){let e=this.m_handleIndexBuffer.data[s];e&&e.SetIndex(t),this.m_handleIndexBuffer.data[t]=e}this.m_flagsBuffer.data[t]=this.m_flagsBuffer.data[s],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[t]=this.m_lastBodyContactStepBuffer.data[s]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[t]=this.m_bodyContactCountBuffer.data[s]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[t]=this.m_consecutiveContactStepsBuffer.data[s]),this.m_positionBuffer.data[t].Copy(this.m_positionBuffer.data[s]),this.m_velocityBuffer.data[t].Copy(this.m_velocityBuffer.data[s]),this.m_groupBuffer[t]=this.m_groupBuffer[s],this.m_hasForce&&this.m_forceBuffer[t].Copy(this.m_forceBuffer[s]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[t]=this.m_staticPressureBuffer[s]),this.m_depthBuffer&&(this.m_depthBuffer[t]=this.m_depthBuffer[s]),this.m_colorBuffer.data&&this.m_colorBuffer.data[t].Copy(this.m_colorBuffer.data[s]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[t]=this.m_userDataBuffer.data[s]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[t]=this.m_expirationTimeBuffer.data[s])}t++,i|=r}}let s=t=>t.index<0,o=t=>t.indexA<0||t.indexB<0,a=t=>t.index<0,l=t=>t.indexA<0||t.indexB<0,h=t=>t.indexA<0||t.indexB<0||t.indexC<0;for(let t=0;t<this.m_proxyBuffer.count;t++){let i=this.m_proxyBuffer.data[t];i.index=e[i.index]}this.m_proxyBuffer.RemoveIf(s);for(let t=0;t<this.m_contactBuffer.count;t++){let i=this.m_contactBuffer.data[t];i.indexA=e[i.indexA],i.indexB=e[i.indexB]}this.m_contactBuffer.RemoveIf(o);for(let t=0;t<this.m_bodyContactBuffer.count;t++){let i=this.m_bodyContactBuffer.data[t];i.index=e[i.index]}this.m_bodyContactBuffer.RemoveIf(a);for(let t=0;t<this.m_pairBuffer.count;t++){let i=this.m_pairBuffer.data[t];i.indexA=e[i.indexA],i.indexB=e[i.indexB]}this.m_pairBuffer.RemoveIf(l);for(let t=0;t<this.m_triadBuffer.count;t++){let i=this.m_triadBuffer.data[t];i.indexA=e[i.indexA],i.indexB=e[i.indexB],i.indexC=e[i.indexC]}if(this.m_triadBuffer.RemoveIf(h),this.m_indexByExpirationTimeBuffer.data){let t=0;for(let i=0;i<this.m_count;i++){let s=e[this.m_indexByExpirationTimeBuffer.data[i]];s!==n.t&&(this.m_indexByExpirationTimeBuffer.data[t++]=s)}}for(let i=this.m_groupList;i;i=i.GetNext()){let s=t,n=0,o=!1;for(let t=i.m_firstIndex;t<i.m_lastIndex;t++){let i=e[t];i>=0?(s=Object(r.n)(s,i),n=Object(r.m)(n,i+1)):o=!0}s<n?(i.m_firstIndex=s,i.m_lastIndex=n,o&&i.m_groupFlags&oi.b2_solidParticleGroup&&this.SetGroupFlags(i,i.m_groupFlags|oi.b2_particleGroupNeedsUpdateDepth)):(i.m_firstIndex=0,i.m_lastIndex=0,i.m_groupFlags&oi.b2_particleGroupCanBeEmpty||this.SetGroupFlags(i,i.m_groupFlags|oi.b2_particleGroupWillBeDestroyed))}this.m_count=t,this.m_allParticleFlags=i,this.m_needsUpdateAllParticleFlags=!1;for(let t=this.m_groupList;t;){let e=t.GetNext();t.m_groupFlags&oi.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(t),t=e}}SolveLifetimes(t){this.m_expirationTimeBuffer.data,this.m_indexByExpirationTimeBuffer.data,this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);let e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,s=this.m_indexByExpirationTimeBuffer.data,n=this.GetParticleCount();if(this.m_expirationTimeBufferRequiresSorting){fi(s,0,n,(t,e)=>{let s=i[t],n=i[e],r=s<=0;return r===n<=0?s>n:r}),this.m_expirationTimeBufferRequiresSorting=!1}for(let t=n-1;t>=0;--t){let n=s[t],r=i[n];if(e<r||r<=0)break;this.DestroyParticle(n)}}RotateBuffer(t,e,i){if(t!==e&&e!==i){if(wi(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&wi(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&wi(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&wi(this.m_consecutiveContactStepsBuffer.data,t,e,i),wi(this.m_positionBuffer.data,t,e,i),wi(this.m_velocityBuffer.data,t,e,i),wi(this.m_groupBuffer,t,e,i),this.m_hasForce&&wi(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&wi(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&wi(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&wi(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&wi(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){wi(this.m_handleIndexBuffer.data,t,e,i);for(let e=t;e<i;++e){let t=this.m_handleIndexBuffer.data[e];t&&t.SetIndex(s(t.GetIndex()))}}if(this.m_expirationTimeBuffer.data){wi(this.m_expirationTimeBuffer.data,t,e,i);let n=this.GetParticleCount(),r=this.m_indexByExpirationTimeBuffer.data;for(let t=0;t<n;++t)r[t]=s(r[t])}for(let t=0;t<this.m_proxyBuffer.count;t++){let e=this.m_proxyBuffer.data[t];e.index=s(e.index)}for(let t=0;t<this.m_contactBuffer.count;t++){let e=this.m_contactBuffer.data[t];e.indexA=s(e.indexA),e.indexB=s(e.indexB)}for(let t=0;t<this.m_bodyContactBuffer.count;t++){let e=this.m_bodyContactBuffer.data[t];e.index=s(e.index)}for(let t=0;t<this.m_pairBuffer.count;t++){let e=this.m_pairBuffer.data[t];e.indexA=s(e.indexA),e.indexB=s(e.indexB)}for(let t=0;t<this.m_triadBuffer.count;t++){let e=this.m_triadBuffer.data[t];e.indexA=s(e.indexA),e.indexB=s(e.indexB),e.indexC=s(e.indexC)}for(let t=this.m_groupList;t;t=t.GetNext())t.m_firstIndex=s(t.m_firstIndex),t.m_lastIndex=s(t.m_lastIndex-1)+1}function s(s){return s<t?s:s<e?s+i-e:s<i?s+t-e:s}}GetCriticalVelocity(t){return this.m_particleDiameter*t.inv_dt}GetCriticalVelocitySquared(t){let e=this.GetCriticalVelocity(t);return e*e}GetCriticalPressure(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)}GetParticleStride(){return n.O*this.m_particleDiameter}GetParticleMass(){let t=this.GetParticleStride();return this.m_def.density*t*t}GetParticleInvMass(){let t=this.m_inverseDiameter*(1/n.O);return this.m_inverseDensity*t*t}GetFixtureContactFilter(){return this.m_allParticleFlags&ri.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetParticleContactFilter(){return this.m_allParticleFlags&ri.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetFixtureContactListener(){return this.m_allParticleFlags&ri.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}GetParticleContactListener(){return this.m_allParticleFlags&ri.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}SetUserOverridableBuffer(t,e,i){t.data=e,t.userSuppliedCapacity=i}SetGroupFlags(t,e){let i=t.m_groupFlags;(i^e)&oi.b2_solidParticleGroup&&(e|=oi.b2_particleGroupNeedsUpdateDepth),i&~e&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&e&&(e&oi.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=e),t.m_groupFlags=e}static BodyContactCompare(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index}RemoveSpuriousBodyContacts(){fi(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,Pi.BodyContactCompare);let t=Pi.RemoveSpuriousBodyContacts_s_n,e=Pi.RemoveSpuriousBodyContacts_s_pos,i=Pi.RemoveSpuriousBodyContacts_s_normal;const s=this;let o=-1,a=0;this.m_bodyContactBuffer.count=Ai(this.m_bodyContactBuffer.data,l=>{if(l.index!==o&&(a=0,o=l.index),a++>3)return!0;let h=t.Copy(l.normal);h.SelfMul(s.m_particleDiameter*(1-l.weight));let _=r.A.AddVV(s.m_positionBuffer.data[l.index],h,e);if(!l.fixture.TestPoint(_)){let t=l.fixture.GetShape().GetChildCount();for(let e=0;e<t;e++){let t=i;if(l.fixture.ComputeDistance(_,t,e)<n.v)return!1}return!0}return!1},this.m_bodyContactBuffer.count)}DetectStuckParticle(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)}ValidateParticleIndex(t){return t>=0&&t<this.GetParticleCount()&&t!==n.t}GetQuantizedTimeElapsed(){return Math.floor(this.m_timeElapsed/4294967296)}LifetimeToExpirationTime(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)}ForceCanBeApplied(t){return!(t&ri.b2_wallParticle)}PrepareForceBuffer(){if(!this.m_hasForce){for(let t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}}IsRigidGroup(t){return null!==t&&0!=(t.m_groupFlags&oi.b2_rigidParticleGroup)}GetLinearVelocity(t,e,i,s){return this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,s):s.Copy(this.m_velocityBuffer.data[e])}InitDampingParameter(t,e,i,s,n,o,a,l){t[0]=s>0?1/s:0,e[0]=n>0?1/n:0,i[0]=r.A.CrossVV(r.A.SubVV(a,o,r.A.s_t0),l)}InitDampingParameterWithRigidGroupOrParticle(t,e,i,s,n,r,o,a){if(s)this.InitDampingParameter(t,e,i,n.GetMass(),n.GetInertia(),n.GetCenter(),o,a);else{let s=this.m_flagsBuffer.data[r];this.InitDampingParameter(t,e,i,s&ri.b2_wallParticle?0:this.GetParticleMass(),0,o,o,a)}}ComputeDampingImpulse(t,e,i,s,n,r,o){let a=t+e*i*i+s+n*r*r;return a>0?o/a:0}ApplyDamping(t,e,i,s,n,r,o,a){s?(n.m_linearVelocity.SelfMulAdd(o*t,a),n.m_angularVelocity+=o*i*e):this.m_velocityBuffer.data[r].SelfMulAdd(o*t,a)}}Pi.xTruncBits=12,Pi.yTruncBits=12,Pi.tagBits=32,Pi.yOffset=1<<Pi.yTruncBits-1,Pi.yShift=Pi.tagBits-Pi.yTruncBits,Pi.xShift=Pi.tagBits-Pi.yTruncBits-Pi.xTruncBits,Pi.xScale=1<<Pi.xShift,Pi.xOffset=Pi.xScale*(1<<Pi.xTruncBits-1),Pi.yMask=(1<<Pi.yTruncBits)-1<<Pi.yShift,Pi.xMask=~Pi.yMask,Pi.DestroyParticlesInShape_s_aabb=new u.a,Pi.CreateParticleGroup_s_transform=new r.z,Pi.ComputeCollisionEnergy_s_v=new r.A,Pi.QueryShapeAABB_s_aabb=new u.a,Pi.QueryPointAABB_s_aabb=new u.a,Pi.RayCast_s_aabb=new u.a,Pi.RayCast_s_p=new r.A,Pi.RayCast_s_v=new r.A,Pi.RayCast_s_n=new r.A,Pi.RayCast_s_point=new r.A,Pi.k_pairFlags=ri.b2_springParticle,Pi.k_triadFlags=ri.b2_elasticParticle,Pi.k_noPressureFlags=ri.b2_powderParticle|ri.b2_tensileParticle,Pi.k_extraDampingFlags=ri.b2_staticPressureParticle,Pi.k_barrierWallFlags=ri.b2_barrierParticle|ri.b2_wallParticle,Pi.CreateParticlesStrokeShapeForGroup_s_edge=new qt,Pi.CreateParticlesStrokeShapeForGroup_s_d=new r.A,Pi.CreateParticlesStrokeShapeForGroup_s_p=new r.A,Pi.CreateParticlesFillShapeForGroup_s_aabb=new u.a,Pi.CreateParticlesFillShapeForGroup_s_p=new r.A,Pi.UpdatePairsAndTriads_s_dab=new r.A,Pi.UpdatePairsAndTriads_s_dbc=new r.A,Pi.UpdatePairsAndTriads_s_dca=new r.A,Pi.AddContact_s_d=new r.A,Pi.UpdateBodyContacts_s_aabb=new u.a,Pi.Solve_s_subStep=new Xe,Pi.SolveCollision_s_aabb=new u.a,Pi.SolveGravity_s_gravity=new r.A,Pi.SolveBarrier_s_aabb=new u.a,Pi.SolveBarrier_s_va=new r.A,Pi.SolveBarrier_s_vb=new r.A,Pi.SolveBarrier_s_pba=new r.A,Pi.SolveBarrier_s_vba=new r.A,Pi.SolveBarrier_s_vc=new r.A,Pi.SolveBarrier_s_pca=new r.A,Pi.SolveBarrier_s_vca=new r.A,Pi.SolveBarrier_s_qba=new r.A,Pi.SolveBarrier_s_qca=new r.A,Pi.SolveBarrier_s_dv=new r.A,Pi.SolveBarrier_s_f=new r.A,Pi.SolvePressure_s_f=new r.A,Pi.SolveDamping_s_v=new r.A,Pi.SolveDamping_s_f=new r.A,Pi.SolveRigidDamping_s_t0=new r.A,Pi.SolveRigidDamping_s_t1=new r.A,Pi.SolveRigidDamping_s_p=new r.A,Pi.SolveRigidDamping_s_v=new r.A,Pi.SolveExtraDamping_s_v=new r.A,Pi.SolveExtraDamping_s_f=new r.A,Pi.SolveRigid_s_position=new r.A,Pi.SolveRigid_s_rotation=new r.t,Pi.SolveRigid_s_transform=new r.z,Pi.SolveRigid_s_velocityTransform=new r.z,Pi.SolveElastic_s_pa=new r.A,Pi.SolveElastic_s_pb=new r.A,Pi.SolveElastic_s_pc=new r.A,Pi.SolveElastic_s_r=new r.t,Pi.SolveElastic_s_t0=new r.A,Pi.SolveSpring_s_pa=new r.A,Pi.SolveSpring_s_pb=new r.A,Pi.SolveSpring_s_d=new r.A,Pi.SolveSpring_s_f=new r.A,Pi.SolveTensile_s_weightedNormal=new r.A,Pi.SolveTensile_s_s=new r.A,Pi.SolveTensile_s_f=new r.A,Pi.SolveViscous_s_v=new r.A,Pi.SolveViscous_s_f=new r.A,Pi.SolveRepulsive_s_f=new r.A,Pi.SolvePowder_s_f=new r.A,Pi.SolveSolid_s_f=new r.A,Pi.RemoveSpuriousBodyContacts_s_n=new r.A,Pi.RemoveSpuriousBodyContacts_s_pos=new r.A,Pi.RemoveSpuriousBodyContacts_s_normal=new r.A,function(t){t.UserOverridableBuffer=class{constructor(){this.data=null,this.userSuppliedCapacity=0}};t.Proxy=class{constructor(){this.index=n.t,this.tag=0}static CompareProxyProxy(t,e){return t.tag<e.tag}static CompareTagProxy(t,e){return t<e.tag}static CompareProxyTag(t,e){return t.tag<e}};t.InsideBoundsEnumerator=class{constructor(e,i,s,n,r){this.m_system=e,this.m_xLower=(i&t.xMask)>>>0,this.m_xUpper=(s&t.xMask)>>>0,this.m_yLower=(i&t.yMask)>>>0,this.m_yUpper=(s&t.yMask)>>>0,this.m_first=n,this.m_last=r,this.m_first,this.m_last}GetNext(){for(;this.m_first<this.m_last;){let e=(this.m_system.m_proxyBuffer.data[this.m_first].tag&t.xMask)>>>0;if(e>=this.m_xLower&&e<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return n.t}};t.ParticleListNode=class{constructor(){this.list=null,this.next=null,this.count=0,this.index=0}};t.FixedSetAllocator=class{Allocate(t,e){return e}Clear(){}GetCount(){return 0}Invalidate(t){}GetValidBuffer(){return[]}GetBuffer(){return[]}SetCount(t){}};t.FixtureParticle=class{constructor(t,e){this.second=n.t,this.first=t,this.second=e}};t.FixtureParticleSet=class extends t.FixedSetAllocator{Initialize(t,e){}Find(t){return n.t}};t.ParticlePair=class{constructor(t,e){this.first=n.t,this.second=n.t,this.first=t,this.second=e}};t.b2ParticlePairSet=class extends t.FixedSetAllocator{Initialize(t,e){}Find(t){return n.t}};t.ConnectionFilter=class{IsNecessary(t){return!0}ShouldCreatePair(t,e){return!0}ShouldCreateTriad(t,e,i){return!0}};t.DestroyParticlesInShapeCallback=class extends qe{constructor(t,e,i,s){super(),this.m_callDestructionListener=!1,this.m_destroyed=0,this.m_system=t,this.m_shape=e,this.m_xf=i,this.m_callDestructionListener=s,this.m_destroyed=0}ReportFixture(t){return!1}ReportParticle(t,e){return t===this.m_system&&(e>=0&&this.m_system.m_count,this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)}Destroyed(){return this.m_destroyed}};t.JoinParticleGroupsFilter=class extends t.ConnectionFilter{constructor(t){super(),this.m_threshold=0,this.m_threshold=t}ShouldCreatePair(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t}ShouldCreateTriad(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)}};t.CompositeShape=class extends Ot.b{constructor(t,e=t.length){super(Ot.c.e_unknown,0),this.m_shapeCount=0,this.m_shapes=t,this.m_shapeCount=e}Clone(){throw new Error}GetChildCount(){return 1}TestPoint(t,e){for(let i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1}ComputeDistance(t,e,i,s){return 0}RayCast(t,e,i,s){return!1}ComputeAABB(t,e,i){let s=new u.a;t.lowerBound.x=+n.x,t.lowerBound.y=+n.x,t.upperBound.x=-n.x,t.upperBound.y=-n.x;for(let i=0;i<this.m_shapeCount;i++){let n=this.m_shapes[i].GetChildCount();for(let r=0;r<n;r++){let n=s;this.m_shapes[i].ComputeAABB(n,e,r),t.Combine1(n)}}}ComputeMass(t,e){}SetupDistanceProxy(t,e){}ComputeSubmergedArea(t,e,i,s){return 0}Dump(t){}};t.ReactiveFilter=class extends t.ConnectionFilter{constructor(t){super(),this.m_flagsBuffer=t}IsNecessary(t){return 0!=(this.m_flagsBuffer.data[t]&ri.b2_reactiveParticle)}};class e extends Si{constructor(t,e){super(t),this.m_contactFilter=e}ShouldCollideFixtureParticle(t,e,i){if(this.m_contactFilter){if(this.m_system.GetFlagsBuffer()[i]&ri.b2_fixtureContactFilterParticle)return this.m_contactFilter.ShouldCollideFixtureParticle(t,this.m_system,i)}return!0}ReportFixtureAndParticle(e,i,s){let n=t.UpdateBodyContactsCallback.ReportFixtureAndParticle_s_n,o=t.UpdateBodyContactsCallback.ReportFixtureAndParticle_s_rp,a=this.m_system.m_positionBuffer.data[s],l=n,h=e.ComputeDistance(a,l,i);if(h<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(e,this.m_system,s)){let t=e.GetBody(),i=t.GetWorldCenter(),n=t.GetMass(),_=t.GetInertia()-n*t.GetLocalCenter().LengthSquared(),c=n>0?1/n:0,m=_>0?1/_:0,u=this.m_system.m_flagsBuffer.data[s]&ri.b2_wallParticle?0:this.m_system.GetParticleInvMass(),d=r.A.SubVV(a,i,o),p=r.A.CrossVV(d,l),f=u+c+m*p*p,y=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];y.index=s,y.body=t,y.fixture=e,y.weight=1-h*this.m_system.m_inverseDiameter,y.normal.Copy(l.SelfNeg()),y.mass=f>0?1/f:0,this.m_system.DetectStuckParticle(s)}}}e.ReportFixtureAndParticle_s_n=new r.A,e.ReportFixtureAndParticle_s_rp=new r.A,t.UpdateBodyContactsCallback=e;class i extends Si{constructor(t,e){super(t),this.m_step=e}ReportFixtureAndParticle(e,i,s){let o=t.SolveCollisionCallback.ReportFixtureAndParticle_s_p1,a=t.SolveCollisionCallback.ReportFixtureAndParticle_s_output,l=t.SolveCollisionCallback.ReportFixtureAndParticle_s_input,h=t.SolveCollisionCallback.ReportFixtureAndParticle_s_p,_=t.SolveCollisionCallback.ReportFixtureAndParticle_s_v,c=t.SolveCollisionCallback.ReportFixtureAndParticle_s_f,m=e.GetBody(),u=this.m_system.m_positionBuffer.data[s],d=this.m_system.m_velocityBuffer.data[s],p=a,f=l;if(0===this.m_system.m_iterationIndex){let t=r.z.MulTXV(m.m_xf0,u,o);e.GetShape().GetType()===Ot.c.e_circleShape&&(t.SelfSub(m.GetLocalCenter()),r.t.MulRV(m.m_xf0.q,t,t),r.t.MulTRV(m.m_xf.q,t,t),t.SelfAdd(m.GetLocalCenter())),r.z.MulXV(m.m_xf,t,f.p1)}else f.p1.Copy(u);if(r.A.AddVMulSV(u,this.m_step.dt,d,f.p2),f.maxFraction=1,e.RayCast(p,f,i)){let t=p.normal,e=h;e.x=(1-p.fraction)*f.p1.x+p.fraction*f.p2.x+n.v*t.x,e.y=(1-p.fraction)*f.p1.y+p.fraction*f.p2.y+n.v*t.y;let i=_;i.x=this.m_step.inv_dt*(e.x-u.x),i.y=this.m_step.inv_dt*(e.y-u.y),this.m_system.m_velocityBuffer.data[s].Copy(i);let r=c;r.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(d.x-i.x),r.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(d.y-i.y),this.m_system.ParticleApplyForce(s,r)}}ReportParticle(t,e){return!1}}i.ReportFixtureAndParticle_s_p1=new r.A,i.ReportFixtureAndParticle_s_output=new u.m,i.ReportFixtureAndParticle_s_input=new u.l,i.ReportFixtureAndParticle_s_p=new r.A,i.ReportFixtureAndParticle_s_v=new r.A,i.ReportFixtureAndParticle_s_f=new r.A,t.SolveCollisionCallback=i}(Pi||(Pi={}));class Ii{constructor(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new We,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new r.A,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new Ue,this.m_island=new ni,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}SetDestructionListener(t){this.m_destructionListener=t}SetContactFilter(t){this.m_contactManager.m_contactFilter=t}SetContactListener(t){this.m_contactManager.m_contactListener=t}SetDebugDraw(t){this.m_debugDraw=t}CreateBody(t){if(this.IsLocked())return null;const e=new Yt(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e}DestroyBody(t){if(this.IsLocked())return;let e=t.m_jointList;for(;e;){const i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;let i=t.m_controllerList;for(;i;){const e=i;i=i.nextController,e.controller.RemoveBody(t)}let s=t.m_contactList;for(;s;){const t=s;s=s.next,this.m_contactManager.Destroy(t.contact)}t.m_contactList=null;let n=t.m_fixtureList;for(;n;){const e=n;n=n.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(e),e.DestroyProxies(this.m_contactManager.m_broadPhase),e.Destroy(),t.m_fixtureList=n,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}CreateJoint(t){if(this.IsLocked())return null;const e=Be.Create(t,null);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;const i=t.bodyA,s=t.bodyB;if(!t.collideConnected){let t=s.GetContactList();for(;t;)t.other===i&&t.contact.FlagForFiltering(),t=t.next}return e}DestroyJoint(t){if(this.IsLocked())return;const e=t.m_collideConnected;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);const i=t.m_bodyA,s=t.m_bodyB;if(i.SetAwake(!0),s.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===i.m_jointList&&(i.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===s.m_jointList&&(s.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,Be.Destroy(t,null),--this.m_jointCount,!e){let t=s.GetContactList();for(;t;)t.other===i&&t.contact.FlagForFiltering(),t=t.next}}CreateParticleSystem(t){if(this.IsLocked())return null;const e=new Pi(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e}DestroyParticleSystem(t){this.IsLocked()||(t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next))}CalculateReasonableParticleIterations(t){if(null===this.m_particleSystemList)return 1;return li(this.m_gravity.Length(),function(t){let e=n.x;for(let i=t.GetParticleSystemList();null!==i;i=i.m_next)e=Object(r.n)(e,i.GetRadius());return e}(this),t)}Step(t,e,i,s=this.CalculateReasonableParticleIterations(t)){const n=Ii.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;const r=Ii.Step_s_step;r.dt=t,r.velocityIterations=e,r.positionIterations=i,r.particleIterations=s,r.inv_dt=t>0?1/t:0,r.dtRatio=this.m_inv_dt0*t,r.warmStarting=this.m_warmStarting;const o=Ii.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=o.GetMilliseconds(),this.m_stepComplete&&r.dt>0){const t=Ii.Step_s_timer.Reset();for(let t=this.m_particleSystemList;t;t=t.m_next)t.Solve(r);this.Solve(r),this.m_profile.solve=t.GetMilliseconds()}if(this.m_continuousPhysics&&r.dt>0){const t=Ii.Step_s_timer.Reset();this.SolveTOI(r),this.m_profile.solveTOI=t.GetMilliseconds()}r.dt>0&&(this.m_inv_dt0=r.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=n.GetMilliseconds()}ClearForces(){for(let t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0}DrawParticleSystem(t){const e=t.GetParticleCount();if(e){const i=t.GetRadius(),s=t.GetPositionBuffer();if(t.m_colorBuffer.data){const n=t.GetColorBuffer();this.m_debugDraw.DrawParticles(s,i,n,e)}else this.m_debugDraw.DrawParticles(s,i,null,e)}}DrawDebugData(){if(null===this.m_debugDraw)return;const t=this.m_debugDraw.GetFlags(),e=Ii.DrawDebugData_s_color.SetRGB(0,0,0);if(t&s.e_shapeBit)for(let t=this.m_bodyList;t;t=t.m_next){const i=t.m_xf;this.m_debugDraw.PushTransform(i);for(let i=t.GetFixtureList();i;i=i.m_next)t.IsActive()?t.GetType()===Wt.b2_staticBody?(e.SetRGB(.5,.9,.5),this.DrawShape(i,e)):t.GetType()===Wt.b2_kinematicBody?(e.SetRGB(.5,.5,.9),this.DrawShape(i,e)):t.IsAwake()?(e.SetRGB(.9,.7,.7),this.DrawShape(i,e)):(e.SetRGB(.6,.6,.6),this.DrawShape(i,e)):(e.SetRGB(.5,.5,.3),this.DrawShape(i,e));this.m_debugDraw.PopTransform(i)}if(t&s.e_particleBit)for(let t=this.m_particleSystemList;t;t=t.m_next)this.DrawParticleSystem(t);if(t&s.e_jointBit)for(let t=this.m_jointList;t;t=t.m_next)this.DrawJoint(t);if(t&s.e_aabbBit){e.SetRGB(.9,.3,.9);const t=this.m_contactManager.m_broadPhase,i=Ii.DrawDebugData_s_vs;for(let s=this.m_bodyList;s;s=s.m_next)if(s.IsActive())for(let n=s.GetFixtureList();n;n=n.m_next)for(let s=0;s<n.m_proxyCount;++s){const r=n.m_proxies[s],o=t.GetFatAABB(r.treeNode);i[0].Set(o.lowerBound.x,o.lowerBound.y),i[1].Set(o.upperBound.x,o.lowerBound.y),i[2].Set(o.upperBound.x,o.upperBound.y),i[3].Set(o.lowerBound.x,o.upperBound.y),this.m_debugDraw.DrawPolygon(i,4,e)}}if(t&s.e_centerOfMassBit)for(let t=this.m_bodyList;t;t=t.m_next){const e=Ii.DrawDebugData_s_xf;e.q.Copy(t.m_xf.q),e.p.Copy(t.GetWorldCenter()),this.m_debugDraw.DrawTransform(e)}if(t&s.e_controllerBit)for(let t=this.m_controllerList;t;t=t.m_next)t.Draw(this.m_debugDraw)}QueryAABB(t,e){const i=this.m_contactManager.m_broadPhase;if(i.Query(function(e){const s=i.GetUserData(e).fixture;return t instanceof qe?t.ReportFixture(s):t(s)},e),t instanceof qe)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryAABB(t,e)}QueryShape(t,e,i){const s=this.m_contactManager.m_broadPhase;const n=Ii.QueryShape_s_aabb;if(e.ComputeAABB(n,i,0),s.Query(function(n){const r=s.GetUserData(n).fixture;return!Object(u.o)(e,0,r.GetShape(),0,i,r.GetBody().GetTransform())||(t instanceof qe?t.ReportFixture(r):t(r))},n),t instanceof qe)for(let e=this.m_particleSystemList;e;e=e.m_next)t.ShouldQueryParticleSystem(e)&&e.QueryAABB(t,n)}QueryPoint(t,e){const i=this.m_contactManager.m_broadPhase;const s=Ii.QueryPoint_s_aabb;if(s.lowerBound.Set(e.x-n.v,e.y-n.v),s.upperBound.Set(e.x+n.v,e.y+n.v),i.Query(function(s){const n=i.GetUserData(s).fixture;return!n.TestPoint(e)||(t instanceof qe?t.ReportFixture(n):t(n))},s),t instanceof qe)for(let e=this.m_particleSystemList;e;e=e.m_next)t.ShouldQueryParticleSystem(e)&&e.QueryAABB(t,s)}RayCast(t,e,i){const s=this.m_contactManager.m_broadPhase;const n=Ii.RayCast_s_input;if(n.maxFraction=1,n.p1.Copy(e),n.p2.Copy(i),s.RayCast(function(n,r){const o=s.GetUserData(r),a=o.fixture,l=o.childIndex,h=Ii.RayCast_s_output;if(a.RayCast(h,n,l)){const s=h.fraction,n=Ii.RayCast_s_point;return n.Set((1-s)*e.x+s*i.x,(1-s)*e.y+s*i.y),t instanceof Je?t.ReportFixture(a,n,h.normal,s):t(a,n,h.normal,s)}return n.maxFraction},n),t instanceof Je)for(let s=this.m_particleSystemList;s;s=s.m_next)t.ShouldQueryParticleSystem(s)&&s.RayCast(t,e,i)}RayCastOne(t,e){let i=null,s=1;return this.RayCast(function(t,e,n,r){return r<s&&(s=r,i=t),s},t,e),i}RayCastAll(t,e,i=[]){return this.RayCast(function(t,e,s,n){return i.push(t),1},t,e),i}GetBodyList(){return this.m_bodyList}GetJointList(){return this.m_jointList}GetParticleSystemList(){return this.m_particleSystemList}GetContactList(){return this.m_contactManager.m_contactList}SetAllowSleeping(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetAllowSleeping(){return this.m_allowSleep}SetWarmStarting(t){this.m_warmStarting=t}GetWarmStarting(){return this.m_warmStarting}SetContinuousPhysics(t){this.m_continuousPhysics=t}GetContinuousPhysics(){return this.m_continuousPhysics}SetSubStepping(t){this.m_subStepping=t}GetSubStepping(){return this.m_subStepping}GetProxyCount(){return this.m_contactManager.m_broadPhase.GetProxyCount()}GetBodyCount(){return this.m_bodyCount}GetJointCount(){return this.m_jointCount}GetContactCount(){return this.m_contactManager.m_contactCount}GetTreeHeight(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}GetTreeBalance(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}GetTreeQuality(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}SetGravity(t,e=!0){if(!r.A.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetGravity(){return this.m_gravity}IsLocked(){return this.m_locked}SetAutoClearForces(t){this.m_clearForces=t}GetAutoClearForces(){return this.m_clearForces}ShiftOrigin(t){if(!this.IsLocked()){for(let e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(let e=this.m_jointList;e;e=e.m_next)e.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}}GetContactManager(){return this.m_contactManager}GetProfile(){return this.m_profile}Dump(t){if(this.m_locked)return;t("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),t("this.m_world.SetGravity(g);\n"),t("const bodies: b2Body[] = [];\n"),t("const joints: b2Joint[] = [];\n");let e=0;for(let i=this.m_bodyList;i;i=i.m_next)i.m_islandIndex=e,i.Dump(t),++e;e=0;for(let t=this.m_jointList;t;t=t.m_next)t.m_index=e,++e;for(let e=this.m_jointList;e;e=e.m_next)e.m_type!==Ut.e_gearJoint&&(t("{\n"),e.Dump(t),t("}\n"));for(let e=this.m_jointList;e;e=e.m_next)e.m_type===Ut.e_gearJoint&&(t("{\n"),e.Dump(t),t("}\n"))}DrawJoint(t){const e=t.GetBodyA(),i=t.GetBodyB(),s=e.m_xf,n=i.m_xf,r=s.p,o=n.p,a=t.GetAnchorA(Ii.DrawJoint_s_p1),l=t.GetAnchorB(Ii.DrawJoint_s_p2),h=Ii.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(t.m_type){case Ut.e_distanceJoint:this.m_debugDraw.DrawSegment(a,l,h);break;case Ut.e_pulleyJoint:{const e=t,i=e.GetGroundAnchorA(),s=e.GetGroundAnchorB();this.m_debugDraw.DrawSegment(i,a,h),this.m_debugDraw.DrawSegment(s,l,h),this.m_debugDraw.DrawSegment(i,s,h)}break;case Ut.e_mouseJoint:this.m_debugDraw.DrawSegment(a,l,h);break;default:this.m_debugDraw.DrawSegment(r,a,h),this.m_debugDraw.DrawSegment(a,l,h),this.m_debugDraw.DrawSegment(o,l,h)}}DrawShape(t,e){const i=t.GetShape();switch(i.m_type){case Ot.c.e_circleShape:{const t=i,s=t.m_p,n=t.m_radius,o=r.A.UNITX;this.m_debugDraw.DrawSolidCircle(s,n,o,e)}break;case Ot.c.e_edgeShape:{const t=i,s=t.m_vertex1,n=t.m_vertex2;this.m_debugDraw.DrawSegment(s,n,e)}break;case Ot.c.e_chainShape:{const t=i,s=t.m_count,n=t.m_vertices;let r=n[0];this.m_debugDraw.DrawCircle(r,.05,e);for(let t=1;t<s;++t){const i=n[t];this.m_debugDraw.DrawSegment(r,i,e),this.m_debugDraw.DrawCircle(i,.05,e),r=i}}break;case Ot.c.e_polygonShape:{const t=i,s=t.m_count,n=t.m_vertices;this.m_debugDraw.DrawSolidPolygon(n,s,e)}}}Solve(t){for(let t=this.m_bodyList;t;t=t.m_next)t.m_xf0.Copy(t.m_xf);for(let e=this.m_controllerList;e;e=e.m_next)e.Step(t);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;const e=this.m_island;e.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener);for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_jointList;t;t=t.m_next)t.m_islandFlag=!1;const i=this.s_stack;for(let s=this.m_bodyList;s;s=s.m_next){if(s.m_islandFlag)continue;if(!s.IsAwake()||!s.IsActive())continue;if(s.GetType()===Wt.b2_staticBody)continue;e.Clear();let n=0;for(i[n++]=s,s.m_islandFlag=!0;n>0;){const t=i[--n];if(e.AddBody(t),t.SetAwake(!0),t.GetType()!==Wt.b2_staticBody){for(let s=t.m_contactList;s;s=s.next){const t=s.contact;if(t.m_islandFlag)continue;if(!t.IsEnabled()||!t.IsTouching())continue;const r=t.m_fixtureA.m_isSensor,o=t.m_fixtureB.m_isSensor;if(r||o)continue;e.AddContact(t),t.m_islandFlag=!0;const a=s.other;a.m_islandFlag||(i[n++]=a,a.m_islandFlag=!0)}for(let s=t.m_jointList;s;s=s.next){if(s.joint.m_islandFlag)continue;const t=s.other;t.IsActive()&&(e.AddJoint(s.joint),s.joint.m_islandFlag=!0,t.m_islandFlag||(i[n++]=t,t.m_islandFlag=!0))}}}const r=new Ue;e.Solve(r,t,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=r.solveInit,this.m_profile.solveVelocity+=r.solveVelocity,this.m_profile.solvePosition+=r.solvePosition;for(let t=0;t<e.m_bodyCount;++t){const i=e.m_bodies[t];i.GetType()===Wt.b2_staticBody&&(i.m_islandFlag=!1)}}for(let t=0;t<i.length&&i[t];++t)i[t]=null;const s=new l;for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag&&t.GetType()!==Wt.b2_staticBody&&t.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=s.GetMilliseconds()}SolveTOI(t){const e=this.m_island;if(e.Initialize(2*n.H,n.H,0,null,this.m_contactManager.m_contactListener),this.m_stepComplete){for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1,t.m_sweep.alpha0=0;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_toiFlag=!1,t.m_islandFlag=!1,t.m_toiCount=0,t.m_toi=1}for(;;){let i=null,s=1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next){if(!t.IsEnabled())continue;if(t.m_toiCount>n.G)continue;let e=1;if(t.m_toiFlag)e=t.m_toi;else{const i=t.GetFixtureA(),s=t.GetFixtureB();if(i.IsSensor()||s.IsSensor())continue;const n=i.GetBody(),o=s.GetBody(),a=n.m_type,l=o.m_type,h=n.IsAwake()&&a!==Wt.b2_staticBody,_=o.IsAwake()&&l!==Wt.b2_staticBody;if(!h&&!_)continue;const c=n.IsBullet()||a!==Wt.b2_dynamicBody,m=o.IsBullet()||l!==Wt.b2_dynamicBody;if(!c&&!m)continue;let u=n.m_sweep.alpha0;n.m_sweep.alpha0<o.m_sweep.alpha0?(u=o.m_sweep.alpha0,n.m_sweep.Advance(u)):o.m_sweep.alpha0<n.m_sweep.alpha0&&(u=n.m_sweep.alpha0,o.m_sweep.Advance(u));const d=t.GetChildIndexA(),p=t.GetChildIndexB(),f=Ii.SolveTOI_s_toi_input;f.proxyA.SetShape(i.GetShape(),d),f.proxyB.SetShape(s.GetShape(),p),f.sweepA.Copy(n.m_sweep),f.sweepB.Copy(o.m_sweep),f.tMax=1;const y=Ii.SolveTOI_s_toi_output;Z(y,f);const A=y.t;e=y.state===T.e_touching?Object(r.n)(u+(1-u)*A,1):1,t.m_toi=e,t.m_toiFlag=!0}e<s&&(i=t,s=e)}if(null===i||1-10*n.r<s){this.m_stepComplete=!0;break}const o=i.GetFixtureA(),a=i.GetFixtureB(),l=o.GetBody(),h=a.GetBody(),_=Ii.SolveTOI_s_backup1.Copy(l.m_sweep),c=Ii.SolveTOI_s_backup2.Copy(h.m_sweep);if(l.Advance(s),h.Advance(s),i.Update(this.m_contactManager.m_contactListener),i.m_toiFlag=!1,++i.m_toiCount,!i.IsEnabled()||!i.IsTouching()){i.SetEnabled(!1),l.m_sweep.Copy(_),h.m_sweep.Copy(c),l.SynchronizeTransform(),h.SynchronizeTransform();continue}l.SetAwake(!0),h.SetAwake(!0),e.Clear(),e.AddBody(l),e.AddBody(h),e.AddContact(i),l.m_islandFlag=!0,h.m_islandFlag=!0,i.m_islandFlag=!0;for(let t=0;t<2;++t){const i=0===t?l:h;if(i.m_type===Wt.b2_dynamicBody)for(let t=i.m_contactList;t&&e.m_bodyCount!==e.m_bodyCapacity&&e.m_contactCount!==e.m_contactCapacity;t=t.next){const n=t.contact;if(n.m_islandFlag)continue;const r=t.other;if(r.m_type===Wt.b2_dynamicBody&&!i.IsBullet()&&!r.IsBullet())continue;const o=n.m_fixtureA.m_isSensor,a=n.m_fixtureB.m_isSensor;if(o||a)continue;const l=Ii.SolveTOI_s_backup.Copy(r.m_sweep);r.m_islandFlag||r.Advance(s),n.Update(this.m_contactManager.m_contactListener),n.IsEnabled()&&n.IsTouching()?(n.m_islandFlag=!0,e.AddContact(n),r.m_islandFlag||(r.m_islandFlag=!0,r.m_type!==Wt.b2_staticBody&&r.SetAwake(!0),e.AddBody(r))):(r.m_sweep.Copy(l),r.SynchronizeTransform())}}const m=Ii.SolveTOI_s_subStep;m.dt=(1-s)*t.dt,m.inv_dt=1/m.dt,m.dtRatio=1,m.positionIterations=20,m.velocityIterations=t.velocityIterations,m.particleIterations=t.particleIterations,m.warmStarting=!1,e.SolveTOI(m,l.m_islandIndex,h.m_islandIndex);for(let t=0;t<e.m_bodyCount;++t){const i=e.m_bodies[t];if(i.m_islandFlag=!1,i.m_type===Wt.b2_dynamicBody){i.SynchronizeFixtures();for(let t=i.m_contactList;t;t=t.next)t.contact.m_toiFlag=!1,t.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}}AddController(t){return t.m_world=this,t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t}RemoveController(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t.m_world=null,t}}Ii.Step_s_step=new Xe,Ii.Step_s_stepTimer=new l,Ii.Step_s_timer=new l,Ii.DrawDebugData_s_color=new o(0,0,0),Ii.DrawDebugData_s_vs=r.A.MakeArray(4),Ii.DrawDebugData_s_xf=new r.z,Ii.QueryShape_s_aabb=new u.a,Ii.QueryPoint_s_aabb=new u.a,Ii.RayCast_s_input=new u.l,Ii.RayCast_s_output=new u.m,Ii.RayCast_s_point=new r.A,Ii.DrawJoint_s_p1=new r.A,Ii.DrawJoint_s_p2=new r.A,Ii.DrawJoint_s_color=new o(.5,.8,.8),Ii.SolveTOI_s_subStep=new Xe,Ii.SolveTOI_s_backup=new r.y,Ii.SolveTOI_s_backup1=new r.y,Ii.SolveTOI_s_backup2=new r.y,Ii.SolveTOI_s_toi_input=new $,Ii.SolveTOI_s_toi_output=new E;class Di{constructor(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new r.A(0,0),this.damping=.1,this.k2=.9,this.k3=.1}}class ki{constructor(){this.m_count=0,this.m_ps=null,this.m_p0s=null,this.m_vs=null,this.m_ims=null,this.m_Ls=null,this.m_as=null,this.m_gravity=new r.A,this.m_damping=0,this.m_k2=1,this.m_k3=.1}GetVertexCount(){return this.m_count}GetVertices(){return this.m_ps}Initialize(t){this.m_count=t.count,this.m_ps=r.A.MakeArray(this.m_count),this.m_p0s=r.A.MakeArray(this.m_count),this.m_vs=r.A.MakeArray(this.m_count),this.m_ims=Object(n.g)(this.m_count);for(let e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();const i=t.masses[e];this.m_ims[e]=i>0?1/i:0}const e=this.m_count-1,i=this.m_count-2;this.m_Ls=Object(n.g)(e),this.m_as=Object(n.g)(i);for(let t=0;t<e;++t){const e=this.m_ps[t],i=this.m_ps[t+1];this.m_Ls[t]=r.A.DistanceVV(e,i)}for(let t=0;t<i;++t){const e=this.m_ps[t],i=this.m_ps[t+1],s=this.m_ps[t+2],n=r.A.SubVV(i,e,r.A.s_t0),o=r.A.SubVV(s,i,r.A.s_t1),a=r.A.CrossVV(n,o),l=r.A.DotVV(n,o);this.m_as[t]=Object(r.d)(a,l)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3}Step(t,e){if(0===t)return;const i=Math.exp(-t*this.m_damping);for(let e=0;e<this.m_count;++e)this.m_p0s[e].Copy(this.m_ps[e]),this.m_ims[e]>0&&this.m_vs[e].SelfMulAdd(t,this.m_gravity),this.m_vs[e].SelfMul(i),this.m_ps[e].SelfMulAdd(t,this.m_vs[e]);for(let t=0;t<e;++t)this.SolveC2(),this.SolveC3(),this.SolveC2();const s=1/t;for(let t=0;t<this.m_count;++t)r.A.MulSV(s,r.A.SubVV(this.m_ps[t],this.m_p0s[t],r.A.s_t0),this.m_vs[t])}SolveC2(){const t=this.m_count-1;for(let e=0;e<t;++e){const t=this.m_ps[e],i=this.m_ps[e+1],s=r.A.SubVV(i,t,ki.s_d),n=s.Normalize(),o=this.m_ims[e],a=this.m_ims[e+1];if(o+a===0)continue;const l=o/(o+a),h=a/(o+a);t.SelfMulSub(this.m_k2*l*(this.m_Ls[e]-n),s),i.SelfMulAdd(this.m_k2*h*(this.m_Ls[e]-n),s)}}SetAngle(t){const e=this.m_count-2;for(let i=0;i<e;++i)this.m_as[i]=t}SolveC3(){const t=this.m_count-2;for(let e=0;e<t;++e){const t=this.m_ps[e],i=this.m_ps[e+1],s=this.m_ps[e+2],o=this.m_ims[e],a=this.m_ims[e+1],l=this.m_ims[e+2],h=r.A.SubVV(i,t,ki.s_d1),_=r.A.SubVV(s,i,ki.s_d2),c=h.LengthSquared(),m=_.LengthSquared();if(c*m==0)continue;const u=r.A.CrossVV(h,_),d=r.A.DotVV(h,_);let p=Object(r.d)(u,d);const f=r.A.MulSV(-1/c,h.SelfSkew(),ki.s_Jd1),y=r.A.MulSV(1/m,_.SelfSkew(),ki.s_Jd2),A=r.A.NegV(f,ki.s_J1),g=r.A.SubVV(f,y,ki.s_J2),x=y;let w=o*r.A.DotVV(A,A)+a*r.A.DotVV(g,g)+l*r.A.DotVV(x,x);if(0===w)continue;w=1/w;let b=p-this.m_as[e];for(;b>n.P;)b=(p-=2*n.P)-this.m_as[e];for(;b<-n.P;)b=(p+=2*n.P)-this.m_as[e];const S=-this.m_k3*w*b;t.SelfMulAdd(o*S,A),i.SelfMulAdd(a*S,g),s.SelfMulAdd(l*S,x)}}Draw(t){const e=new o(.4,.5,.7);for(let i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)}}ki.s_d=new r.A,ki.s_d1=new r.A,ki.s_d2=new r.A,ki.s_Jd1=new r.A,ki.s_Jd2=new r.A,ki.s_J1=new r.A,ki.s_J2=new r.A,i.d(e,"b2Assert",function(){return n.b}),i.d(e,"b2_maxFloat",function(){return n.x}),i.d(e,"b2_epsilon",function(){return n.r}),i.d(e,"b2_epsilon_sq",function(){return n.s}),i.d(e,"b2_pi",function(){return n.P}),i.d(e,"b2_maxManifoldPoints",function(){return n.z}),i.d(e,"b2_maxPolygonVertices",function(){return n.D}),i.d(e,"b2_aabbExtension",function(){return n.k}),i.d(e,"b2_aabbMultiplier",function(){return n.l}),i.d(e,"b2_linearSlop",function(){return n.v}),i.d(e,"b2_angularSlop",function(){return n.n}),i.d(e,"b2_polygonRadius",function(){return n.Q}),i.d(e,"b2_maxSubSteps",function(){return n.G}),i.d(e,"b2_maxTOIContacts",function(){return n.H}),i.d(e,"b2_velocityThreshold",function(){return n.T}),i.d(e,"b2_maxLinearCorrection",function(){return n.y}),i.d(e,"b2_maxAngularCorrection",function(){return n.w}),i.d(e,"b2_maxTranslation",function(){return n.I}),i.d(e,"b2_maxTranslationSquared",function(){return n.J}),i.d(e,"b2_maxRotation",function(){return n.E}),i.d(e,"b2_maxRotationSquared",function(){return n.F}),i.d(e,"b2_baumgarte",function(){return n.p}),i.d(e,"b2_toiBaumgarte",function(){return n.S}),i.d(e,"b2_invalidParticleIndex",function(){return n.t}),i.d(e,"b2_maxParticleIndex",function(){return n.B}),i.d(e,"b2_particleStride",function(){return n.O}),i.d(e,"b2_minParticleWeight",function(){return n.N}),i.d(e,"b2_maxParticlePressure",function(){return n.C}),i.d(e,"b2_maxParticleForce",function(){return n.A}),i.d(e,"b2_maxTriadDistance",function(){return n.K}),i.d(e,"b2_maxTriadDistanceSquared",function(){return n.L}),i.d(e,"b2_minParticleSystemBufferCapacity",function(){return n.M}),i.d(e,"b2_barrierCollisionTime",function(){return n.o}),i.d(e,"b2_timeToSleep",function(){return n.R}),i.d(e,"b2_linearSleepTolerance",function(){return n.u}),i.d(e,"b2_angularSleepTolerance",function(){return n.m}),i.d(e,"b2Alloc",function(){return n.a}),i.d(e,"b2Free",function(){return n.c}),i.d(e,"b2Log",function(){return n.d}),i.d(e,"b2Version",function(){return n.j}),i.d(e,"b2_version",function(){return n.U}),i.d(e,"b2_changelist",function(){return n.q}),i.d(e,"b2ParseInt",function(){return n.h}),i.d(e,"b2ParseUInt",function(){return n.i}),i.d(e,"b2MakeArray",function(){return n.e}),i.d(e,"b2MakeNullArray",function(){return n.f}),i.d(e,"b2MakeNumberArray",function(){return n.g}),i.d(e,"b2_pi_over_180",function(){return r.E}),i.d(e,"b2_180_over_pi",function(){return r.D}),i.d(e,"b2_two_pi",function(){return r.F}),i.d(e,"b2Abs",function(){return r.a}),i.d(e,"b2Min",function(){return r.n}),i.d(e,"b2Max",function(){return r.m}),i.d(e,"b2Clamp",function(){return r.e}),i.d(e,"b2Swap",function(){return r.x}),i.d(e,"b2IsValid",function(){return r.j}),i.d(e,"b2Sq",function(){return r.v}),i.d(e,"b2InvSqrt",function(){return r.h}),i.d(e,"b2Sqrt",function(){return r.w}),i.d(e,"b2Pow",function(){return r.p}),i.d(e,"b2DegToRad",function(){return r.g}),i.d(e,"b2RadToDeg",function(){return r.q}),i.d(e,"b2Cos",function(){return r.f}),i.d(e,"b2Sin",function(){return r.u}),i.d(e,"b2Acos",function(){return r.b}),i.d(e,"b2Asin",function(){return r.c}),i.d(e,"b2Atan2",function(){return r.d}),i.d(e,"b2NextPowerOfTwo",function(){return r.o}),i.d(e,"b2IsPowerOfTwo",function(){return r.i}),i.d(e,"b2Random",function(){return r.r}),i.d(e,"b2RandomRange",function(){return r.s}),i.d(e,"b2Vec2",function(){return r.A}),i.d(e,"b2Vec2_zero",function(){return r.B}),i.d(e,"b2Vec3",function(){return r.C}),i.d(e,"b2Mat22",function(){return r.k}),i.d(e,"b2Mat33",function(){return r.l}),i.d(e,"b2Rot",function(){return r.t}),i.d(e,"b2Transform",function(){return r.z}),i.d(e,"b2Sweep",function(){return r.y}),i.d(e,"b2Color",function(){return o}),i.d(e,"b2DrawFlags",function(){return s}),i.d(e,"b2Draw",function(){return a}),i.d(e,"b2Timer",function(){return l}),i.d(e,"b2Counter",function(){return h}),i.d(e,"b2GrowableStack",function(){return _}),i.d(e,"b2BlockAllocator",function(){return c}),i.d(e,"b2StackAllocator",function(){return m}),i.d(e,"b2ContactFeatureType",function(){return u.e}),i.d(e,"b2ContactFeature",function(){return u.d}),i.d(e,"b2ContactID",function(){return u.f}),i.d(e,"b2ManifoldPoint",function(){return u.i}),i.d(e,"b2ManifoldType",function(){return u.j}),i.d(e,"b2Manifold",function(){return u.h}),i.d(e,"b2WorldManifold",function(){return u.p}),i.d(e,"b2PointState",function(){return u.k}),i.d(e,"b2GetPointStates",function(){return u.g}),i.d(e,"b2ClipVertex",function(){return u.c}),i.d(e,"b2RayCastInput",function(){return u.l}),i.d(e,"b2RayCastOutput",function(){return u.m}),i.d(e,"b2AABB",function(){return u.a}),i.d(e,"b2TestOverlapAABB",function(){return u.n}),i.d(e,"b2ClipSegmentToLine",function(){return u.b}),i.d(e,"b2TestOverlapShape",function(){return u.o}),i.d(e,"b2DistanceProxy",function(){return d.d}),i.d(e,"b2SimplexCache",function(){return d.f}),i.d(e,"b2DistanceInput",function(){return d.b}),i.d(e,"b2DistanceOutput",function(){return d.c}),i.d(e,"b2_gjkCalls",function(){return d.h}),i.d(e,"b2_gjkIters",function(){return d.i}),i.d(e,"b2_gjkMaxIters",function(){return d.j}),i.d(e,"b2_gjk_reset",function(){return d.k}),i.d(e,"b2SimplexVertex",function(){return d.g}),i.d(e,"b2Simplex",function(){return d.e}),i.d(e,"b2Distance",function(){return d.a}),i.d(e,"b2Pair",function(){return A}),i.d(e,"b2BroadPhase",function(){return g}),i.d(e,"b2PairLessThan",function(){return x}),i.d(e,"b2TreeNode",function(){return f}),i.d(e,"b2DynamicTree",function(){return y}),i.d(e,"b2_toiTime",function(){return w}),i.d(e,"b2_toiMaxTime",function(){return b}),i.d(e,"b2_toiCalls",function(){return S}),i.d(e,"b2_toiIters",function(){return v}),i.d(e,"b2_toiMaxIters",function(){return C}),i.d(e,"b2_toiRootIters",function(){return B}),i.d(e,"b2_toiMaxRootIters",function(){return V}),i.d(e,"b2_toi_reset",function(){return M}),i.d(e,"b2TOIInput",function(){return $}),i.d(e,"b2TOIOutputState",function(){return T}),i.d(e,"b2TOIOutput",function(){return E}),i.d(e,"b2SeparationFunctionType",function(){return F}),i.d(e,"b2SeparationFunction",function(){return j}),i.d(e,"b2TimeOfImpact",function(){return Z}),i.d(e,"b2CollideCircles",function(){return K}),i.d(e,"b2CollidePolygonAndCircle",function(){return st}),i.d(e,"b2CollidePolygons",function(){return Bt}),i.d(e,"b2CollideEdgeAndCircle",function(){return Lt}),i.d(e,"b2CollideEdgeAndPolygon",function(){return jt}),i.d(e,"b2MassData",function(){return Ot.a}),i.d(e,"b2ShapeType",function(){return Ot.c}),i.d(e,"b2Shape",function(){return Ot.b}),i.d(e,"b2CircleShape",function(){return Nt}),i.d(e,"b2PolygonShape",function(){return zt}),i.d(e,"b2EdgeShape",function(){return qt}),i.d(e,"b2ChainShape",function(){return Jt}),i.d(e,"b2Filter",function(){return Ht.a}),i.d(e,"b2FixtureDef",function(){return Ht.c}),i.d(e,"b2FixtureProxy",function(){return Ht.d}),i.d(e,"b2Fixture",function(){return Ht.b}),i.d(e,"b2BodyType",function(){return Wt}),i.d(e,"b2BodyDef",function(){return Zt}),i.d(e,"b2Body",function(){return Yt}),i.d(e,"b2World",function(){return Ii}),i.d(e,"b2DestructionListener",function(){return je}),i.d(e,"b2ContactFilter",function(){return Oe}),i.d(e,"b2ContactImpulse",function(){return Ne}),i.d(e,"b2ContactListener",function(){return ze}),i.d(e,"b2QueryCallback",function(){return qe}),i.d(e,"b2RayCastCallback",function(){return Je}),i.d(e,"b2Island",function(){return ni}),i.d(e,"b2Profile",function(){return Ue}),i.d(e,"b2TimeStep",function(){return Xe}),i.d(e,"b2Position",function(){return He}),i.d(e,"b2Velocity",function(){return Ze}),i.d(e,"b2SolverData",function(){return Ye}),i.d(e,"b2ContactManager",function(){return We}),i.d(e,"b2MixFriction",function(){return Ve}),i.d(e,"b2MixRestitution",function(){return Me}),i.d(e,"b2ContactEdge",function(){return Pe}),i.d(e,"b2Contact",function(){return Ie}),i.d(e,"b2ContactRegister",function(){return Fe}),i.d(e,"b2ContactFactory",function(){return Ee}),i.d(e,"b2VelocityConstraintPoint",function(){return Qe}),i.d(e,"b2ContactVelocityConstraint",function(){return Ke}),i.d(e,"b2ContactPositionConstraint",function(){return ti}),i.d(e,"b2ContactSolverDef",function(){return ei}),i.d(e,"b2PositionSolverManifold",function(){return ii}),i.d(e,"b2ContactSolver",function(){return si}),i.d(e,"b2CircleContact",function(){return De}),i.d(e,"b2PolygonContact",function(){return ke}),i.d(e,"b2PolygonAndCircleContact",function(){return Ge}),i.d(e,"b2EdgeAndCircleContact",function(){return Re}),i.d(e,"b2EdgeAndPolygonContact",function(){return Le}),i.d(e,"b2ChainAndCircleContact",function(){return $e}),i.d(e,"b2ChainAndPolygonContact",function(){return Te}),i.d(e,"b2JointType",function(){return Ut}),i.d(e,"b2LimitState",function(){return Xt}),i.d(e,"b2Jacobian",function(){return Qt}),i.d(e,"b2JointEdge",function(){return Kt}),i.d(e,"b2JointDef",function(){return te}),i.d(e,"b2Joint",function(){return ee}),i.d(e,"b2JointFactory",function(){return Be}),i.d(e,"b2AreaJointDef",function(){return ne}),i.d(e,"b2AreaJoint",function(){return re}),i.d(e,"b2DistanceJointDef",function(){return ie}),i.d(e,"b2DistanceJoint",function(){return se}),i.d(e,"b2FrictionJointDef",function(){return oe}),i.d(e,"b2FrictionJoint",function(){return ae}),i.d(e,"b2GearJointDef",function(){return le}),i.d(e,"b2GearJoint",function(){return he}),i.d(e,"b2MotorJointDef",function(){return _e}),i.d(e,"b2MotorJoint",function(){return ce}),i.d(e,"b2MouseJointDef",function(){return me}),i.d(e,"b2MouseJoint",function(){return ue}),i.d(e,"b2PrismaticJointDef",function(){return de}),i.d(e,"b2PrismaticJoint",function(){return pe}),i.d(e,"b2_minPulleyLength",function(){return 2}),i.d(e,"b2PulleyJointDef",function(){return fe}),i.d(e,"b2PulleyJoint",function(){return ye}),i.d(e,"b2RevoluteJointDef",function(){return Ae}),i.d(e,"b2RevoluteJoint",function(){return ge}),i.d(e,"b2RopeJointDef",function(){return xe}),i.d(e,"b2RopeJoint",function(){return we}),i.d(e,"b2WeldJointDef",function(){return be}),i.d(e,"b2WeldJoint",function(){return Se}),i.d(e,"b2WheelJointDef",function(){return ve}),i.d(e,"b2WheelJoint",function(){return Ce}),i.d(e,"b2ParticleFlag",function(){return ri}),i.d(e,"b2ParticleDef",function(){return ai}),i.d(e,"b2CalculateParticleIterations",function(){return li}),i.d(e,"b2ParticleHandle",function(){return hi}),i.d(e,"b2ParticleGroupFlag",function(){return oi}),i.d(e,"b2ParticleGroupDef",function(){return _i}),i.d(e,"b2ParticleGroup",function(){return ci}),i.d(e,"b2GrowableBuffer",function(){return bi}),i.d(e,"b2FixtureParticleQueryCallback",function(){return Si}),i.d(e,"b2ParticleContact",function(){return vi}),i.d(e,"b2ParticleBodyContact",function(){return Ci}),i.d(e,"b2ParticlePair",function(){return Bi}),i.d(e,"b2ParticleTriad",function(){return Vi}),i.d(e,"b2ParticleSystemDef",function(){return Mi}),i.d(e,"b2ParticleSystem",function(){return Pi}),i.d(e,"b2RopeDef",function(){return Di}),i.d(e,"b2Rope",function(){return ki})},368:function(t,e,i){"use strict";var s=i(355),n=i(332);i(358),i(333);class r{constructor(t){this.id=t,this.footholds=[],this.bound=new n.Rectangle,this.loop=!1}init(t,e,i){let n,r,l,h;n=t.x1,r=t.y1,l=t.x2,h=t.y2;for(let i=t,s=0;null!=i;i=e[i.next],++s)if(n=Math.min(n,i.x1,i.x2),r=Math.min(r,i.y1,i.y2),l=Math.max(l,i.x1,i.x2),h=Math.max(h,i.y1,i.y2),this.footholds.push(i),i.next==t.id){this.loop=!0;break}if(this.bound.parse(n,r,l,h),this.FootholdType=i,i==o)this.footholds.forEach((t,e)=>{t.init(this,e)});else if(i==a){let t=this.bound.center,e=new s.b2Transform;e.SetPositionXY(t.x,t.y),this.footholds.forEach((t,i)=>{t.init(this,i,e)})}}getFootholdFromContact(t){return this.footholds[t]}}class o{constructor(t,e,i,s){this._raw=t,this.layer=0|i,this.group=0|s,this.id=e,this.prev=t.prev?t.prev-1:null,this.next=t.next?t.next-1:null,this.chain=null,this.childIndex=null,this.body=null,this.m_angle=0,this.m_length=0,this.next_a=void 0,this.next_a_deg=void 0,this.$showDebugInfo=!1}getFootholdFromContact(){return this}init(t,e,i){let s,n,r,o;this.chain=this,this.childIndex=e,s=this.x1/$gv.CANVAS_SCALE,n=this.y1/$gv.CANVAS_SCALE;const a=(r=this.x2/$gv.CANVAS_SCALE)-s,l=(o=this.y2/$gv.CANVAS_SCALE)-n;0==l?(this.m_angle=a<0?Math.PI:0,this.m_length=a):0==a?(this.m_angle=l<0?.5*-Math.PI:.5*Math.PI,this.m_length=l):(this.m_angle=Math.atan2(l,a),this.m_length=Math.sqrt(l**2+a**2))}GetVertex1(){return new s.b2Vec2(this.x1/$gv.CANVAS_SCALE,this.y1/$gv.CANVAS_SCALE)}GetVertex2(){return new s.b2Vec2(this.x2/$gv.CANVAS_SCALE,this.y2/$gv.CANVAS_SCALE)}GetWorldCenter(){return this.body.GetWorldCenter()}GetLocalPoint(t,e){return this.body.GetLocalPoint(t,e)}GetLinearVelocityFromWorldPoint(t,e){return this.body.GetLinearVelocityFromWorldPoint(t,e)}GetLocalVector(t,e){return this.body.GetLocalVector(t,e)}get next_fh(){return this.body.m_world.ground.footholds[this.next]}get prev_fh(){return this.body.m_world.ground.footholds[this.prev]}get x1(){return this._raw.x1}get y1(){return this._raw.y1}get x2(){return this._raw.x2}get y2(){return this._raw.y2}get is_empty(){return this.is_first&&this.is_last}get is_first(){return 0==this._raw.prev}get is_last(){return 0==this._raw.next}get is_wall(){return this.x1==this.x2}get _is_horizontal_floor(){return this.y1==this.y2}_drawLine(t){t.beginPath(),t.moveTo(this.x1,this.y1),t.lineTo(this.x2,this.y2),t.stroke()}_drawLineV01(t){this.m_hasVertex0&&(t.beginPath(),t.moveTo(this.x0,this.y0),t.lineTo(this.x1,this.y1),t.stroke())}_drawLineV23(t){this.m_hasVertex3&&(t.beginPath(),t.moveTo(this.x2,this.y2),t.lineTo(this.x3,this.y3),t.stroke())}$_text_pos(t,e,i,s){return{x:(i+t)/2,y:Math.max(s,e)}}$drawDebugInfo(t){const e=t.ctx,i=this,s=`[${i.id}](${i.x1}, ${i.y1})[${i.group}]{${i._raw.piece}}∠${i.next_a_deg}`,n=e.textAlign,r=e.textBaseline,o=this.$_text_pos(i.x1,i.y1,i.x2,i.y2);e.textAlign="center",e.textBaseline="top",e.lineWidth=5,e.strokeStyle="#000",i._drawLine(e),e.lineWidth=2.5,e.strokeStyle="#FF00FF",i._drawLine(e),e.lineWidth=2.5,e.strokeStyle="#000",e.strokeText(s,o.x,o.y),e.fillStyle="#FFF",e.fillText(s,o.x,o.y),e.textAlign=n,e.textBaseline=r}$drawDebugInfo2(t,e){const i=t.ctx,s=this,n=`${s.prev}<${s.id}>${s.next} C{${s.chain.id}} (${s.x1}, ${s.y1})(${s.x2}, ${s.y2}) L[${s.layer}] G[${s.group}] P{${s._raw.piece}}∠${s.next_a_deg}`;let r=i.textAlign,o=i.textBaseline;const a=this.$_text_pos(s.x1,s.y1,s.x2,s.y2);i.textAlign="center",i.textBaseline="top",i.lineWidth=5,i.strokeStyle="#000",s._drawLine(i),i.lineWidth=2.5,i.strokeStyle=e||"#FF00FF",s._drawLine(i),i.lineWidth=2.5,i.strokeStyle="#000",i.strokeText(n,a.x,a.y),i.fillStyle="#FFF",i.fillText(n,a.x,a.y),i.textAlign=r,i.textBaseline=o}}class a extends o{constructor(t,e,i,n){super(t,e,i,n),this.m_xf=new s.b2Transform}init(t,e,i){super.init(t,e,i),s.b2Vec2.AddVV(this.GetVertex1(),this.GetVertex2(),this.m_xf.p),s.b2Vec2.MulVS(this.m_xf.p,.5,this.m_xf.p),this.m_xf.SetRotationAngle(this.m_angle),s.b2Transform.MulTXX(this.m_xf,i,this.m_xf)}GetWorldCenter(){const t=new s.b2Transform;return s.b2Transform.MulXX(this.m_xf,this.body.m_xf,t),t.p}GetLocalPoint(t,e){const i=new s.b2Transform;return s.b2Transform.MulXX(this.m_xf,this.body.m_xf,i),s.b2Transform.MulTXV(i,t,e)}GetLinearVelocityFromWorldPoint(t,e){const i=this.body;return s.b2Vec2.AddVCrossSV(i.m_linearVelocity,i.m_angularVelocity,s.b2Vec2.SubVV(t,this.GetWorldCenter(),s.b2Vec2.s_t0),e)}GetLocalVector(t,e){const i=new s.b2Transform;return s.b2Transform.MulXX(this.m_xf,this.body.m_xf,i),s.b2Rot.MulTRV(i.q,t,e)}}i(352);var l=i(356);i.d(e,"a",function(){return _});const h=o;window.CREATE_SOLID_FOOTHOLD=!1,window.CREATE_SOLID_AND_EDGE_FOOTHOLD=!1,window.USE_GHOST_VERTEX=!0,window.FOOTHOLD_IS_BULLET=!0;class _{constructor(){this.bodies=null,this.footholds=null,this.rectChains=null,this.init()}init(){this.footholds=[],this.bodies=[]}load(t,e){if(!("foothold"in t))return;for(let e in t.foothold){let i=t.foothold[e];for(let t in i){let s=i[t];for(let i in s){const n=i-1;let r=new h(s[i],n,e,t);this.footholds[n]=r}}}let i=[],s=0,n=this.rectChains=[];for(let t=0;t<this.footholds.length;++t){const l=this.footholds[t];if(null==l.chain){let t;for(let e=l;null!=e;e=this.footholds[e.prev])if(null!=e.prev&&e.prev==l.id){t=e;break}t||(t=l);let _=new r(s);_.init(t,this.footholds,h),h==o?window.CREATE_SOLID_AND_EDGE_FOOTHOLD?(this._create_foothold(e,_,!1),this._create_foothold(e,_,!0)):this._create_foothold(e,_,window.CREATE_SOLID_FOOTHOLD):h==a&&this._create_chain(e,_),i.push(_),n[s]=_.bound,s++}}}_create_chain(t,e){let i,n;{let n=new s.b2BodyDef;const r=e.bound.center;n.type=s.b2BodyType.b2_kinematicBody,n.position.Set(r.x/$gv.CANVAS_SCALE,r.y/$gv.CANVAS_SCALE),n.angle=0,n.gravityScale=0,n.linearDamping=1,n.bullet=!0,n.userData=this,(i=t.CreateBody(n)).$type="ground",this.bodies.push(i)}{n=new s.b2ChainShape;let t=[i.GetLocalPoint(e.footholds[0].GetVertex1(),new s.b2Vec2)];for(let n=0;n<e.footholds.length;++n){const r=e.footholds[n];t.push(i.GetLocalPoint(r.GetVertex2(),new s.b2Vec2)),r.body=i,r._chain=e}e.loop?n.CreateLoop(t):n.CreateChain(t)}{let t=new s.b2FixtureDef;t.shape=n,t.density=1,t.filter.Copy(l.FilterHelper.get("foothold")),t.friction=1,t.restitution=0,t.userData=e;let r=i.CreateFixture(t);r.endContact=this.endContact_bodyBase_oneway,r.preSolve=this.preSolveGround_bodyBase_oneway}}_create_foothold(t,e,i){let n,r=new s.b2BodyDef,o=new s.b2FixtureDef;n=i?new s.b2PolygonShape:new s.b2EdgeShape,r.type=s.b2BodyType.b2_kinematicBody,r.linearDamping=1,r.gravityScale=0,r.userData=this,r.bullet=window.FOOTHOLD_IS_BULLET,o.shape=n,o.density=1,o.filter.Copy(l.FilterHelper.get("foothold")),o.friction=1,o.restitution=0;for(let t=0;t<e.footholds.length;++t){const i=e.footholds[t];let n,r,o,l;n=i.x1/$gv.CANVAS_SCALE,r=i.y1/$gv.CANVAS_SCALE,o=i.x2/$gv.CANVAS_SCALE,l=i.y2/$gv.CANVAS_SCALE,a.call(this,i);const h=this.footholds[i.next];if(h){let t,e,a,_;t=h.x1/$gv.CANVAS_SCALE,e=h.y1/$gv.CANVAS_SCALE,a=h.x2/$gv.CANVAS_SCALE,_=h.y2/$gv.CANVAS_SCALE;let c=new s.b2Vec2(n-o,r-l),m=new s.b2Vec2(a-t,_-e),u=Math.atan2(s.b2Vec2.CrossVV(c,m),s.b2Vec2.DotVV(c,m));i.next_a=u,i.next_a_deg=Math.abs(Math.trunc(180*u/Math.PI))%180}}function a(e){s.b2Vec2.AddVV(e.GetVertex1(),e.GetVertex2(),r.position),s.b2Vec2.MulVS(r.position,.5,r.position);let a=.5*e.m_length;r.angle=e.m_angle;let l=t.CreateBody(r);if(l.$type="ground",i)n.SetAsBox(a,s.b2_polygonRadius);else if(n.m_vertex1.Set(-a,0),n.m_vertex2.Set(a,0),window.USE_GHOST_VERTEX){if(null!=e.prev){const t=this.footholds[e.prev];n.m_hasVertex0=!0,n.m_vertex0.Copy(t.GetVertex2())}if(null!=e.next){const t=this.footholds[e.next];n.m_hasVertex3=!0,n.m_vertex3.Copy(t.GetVertex1())}}o.userData=e;let h=l.CreateFixture(o);h.endContact=this.endContact_bodyBase_oneway,h.preSolve=this.preSolveGround_bodyBase_oneway,e.body=l,this.bodies.push(l)}}_compute_left_right_border(){let t=null,e=null;for(let i=0;i<this.footholds.length;++i){let s,n,r=this.footholds[i];r.x1<r.x2?(s=r.x1,n=r.x2):(s=r.x2,n=r.x1),(null==t||s<t)&&(t=s),(null==e||n>e)&&(e=n)}return{left:t,right:e}}beginContact_bodyBase_oneway(t,e,i,n,r){let o,a;i.$type;const l=i.GetBody(),h=this.getFootholdFromContact(n),_=i.GetUserData();if(!_||!_.body||"player"!=_.body.$type)return;if(_.state.ladder)return void t.SetEnabled(!1);t.IsTouching()||console.log("J: "+_.state.jump);const c=_.$foothold,m=_.foot_walk.GetWorldCenter(),u=h.GetLocalPoint(m,new s.b2Vec2),d=(s.b2_polygonRadius,_.chara_profile.foot_width-s.b2_polygonRadius);null==o&&(o=t.GetManifold().pointCount,a=new s.b2WorldManifold,t.GetWorldManifold(a));for(let t=0;t<o;++t){const e=a.points[t],i=h.GetLinearVelocityFromWorldPoint(e,new s.b2Vec2),n=l.GetLinearVelocityFromWorldPoint(e,new s.b2Vec2),r=new s.b2Vec2(n.x-i.x,n.y-i.y),o=h.GetLocalVector(r,new s.b2Vec2);if(u.y<=-d)if(o.y>1){if(h.is_wall||_._which_foothold_contact(h,e))return void p(e)}else if(o.y>-1&&(h.is_wall||_._which_foothold_contact(h,e)))return _.$foothold&&(_.$foothold.id,h.id),void p(e)}function p(e){if(h.is_wall){if(t.SetFriction(0),_.prev_$fh&&_.prev_$fh.chain!=h.chain&&_.prev_$fh.layer!=h.layer)return void t.SetEnabled(!1);if(_.$foothold&&_.$foothold.chain!=h.chain&&_.$foothold.layer!=h.layer)return void t.SetEnabled(!1)}if(_.state.dropDown&&null!=_.leave_$fh){if(_.leave_$fh==_.$foothold&&_.$foothold!=h)return void t.SetEnabled(!1);if("pl_ft_walk"!=l.$type||_.leave_$fh.id==h.id||_.leave_$fh.chain.id==h.chain.id||null!=_.leave_$fh.prev&&_.leave_$fh.prev==h.id||null!=_.leave_$fh.next&&_.leave_$fh.next==h.id)return void t.SetEnabled(!1);{const t=_.foot_walk.GetPosition();e.y>t.y&&(_.leave_$fh=null,_.state.dropDown=!1)}}else _.state.dropDown=!1;if(_.leave_$fh&&_.leave_$fh==h)return void t.SetEnabled(!1);return!c||!(h.is_wall||h==_._foothold&&(h.y1<c.y1||h.y2<c.y2)||h!=_._foothold&&(h.y1>c.y1||h.y2>c.y2))||c==h||_._$fallEdge&&_._$fallEdge==c||h.chain.id==c.chain.id||c.prev&&c.y1==h.y2||c.next&&c.y2==h.y1?_._$fallEdge&&_._$fallEdge==h?void t.SetEnabled(!1):null==h.prev&&e.x*$gv.CANVAS_SCALE<h.x1||null==h.next&&e.x*$gv.CANVAS_SCALE>h.x2?(_.state.jump=!0,_._$fallEdge=h,_._foothold=null,_._foot_at=null,_.$foothold=null,void t.SetEnabled(!1)):void 0:(_.leave_$fh=h,void t.SetEnabled(!1))}t.SetEnabled(!1)}endContact_bodyBase_oneway(t,e,i,s,n){const r=i.GetUserData();if(!r)return;const o=this.getFootholdFromContact(s);if(r._foot_contact_list.length&&r._foot_contact_list.forEach((t,e)=>{t.foothold==o&&r._foot_contact_list.splice(e,1)}),r._$fallEdge&&o==r._$fallEdge)r._$fallEdge=null;else if(r._foothold&&o==r._foothold)if(r._foot_contact_list.length){r.prev_$fh=r.$foothold;let t=r._foot_contact_list.pop();r.$foothold=t.foothold,r._foothold=t.foothold,r._foot_at=t.position,r._foothold_priority=t.priority}else r._foothold=null,r._foot_at=null,r.prev_$fh=null;else if(r.$foothold&&o==r.$foothold)if(r._foot_contact_list.length){r.prev_$fh=r.$foothold;let t=r._foot_contact_list.pop();r.$foothold=t.foothold,r._foothold=t.foothold,r._foot_at=t.position,r._foothold_priority=t.priority}else r._foothold?(r.prev_$fh=r.$foothold,r.$foothold=r._foothold):(r.$foothold=null,r._foot_at=null,r.prev_$fh=null);r.leave_$fh&&r.leave_$fh==o&&(r.leave_$fh=null)}preSolveGround_bodyBase_oneway(t,e,i,s,n,r){i.GetBody().GetUserData().beginContact_bodyBase_oneway.call(this,t,i,s,n,r)}unload(t){for(let e=0;e<this.bodies.length;++e)t.DestroyBody(this.bodies[e]);this.init()}addFoothold(t){this.footholds.push(new h(t))}$drawDebugInfo(t){if($gv.m_display_foothold){const e=t.ctx;e.lineJoin="round",e.lineCap="round";for(let e=0;e<this.footholds.length;++e){let i=this.footholds[e];null!=i&&(i.$showDebugInfo&&i.$drawDebugInfo(t))}}}$showDebugInfo(t,e,i,s){null==i&&(i=!0),null==s&&(s=!1);for(let n of this.footholds)n.layer==t&&n.group==e?n.$showDebugInfo=i:n.$showDebugInfo=s}$showDebugInfoByLayer(t,e,i){null==e&&(e=!0),null==i&&(i=!1);for(let s of this.footholds)s.layer==t?s.$showDebugInfo=e:s.$showDebugInfo=i}$hideAllDebugInfo(){for(let t of this.footholds)t.$showDebugInfo=!1}}_.Foothold=h},369:function(t,e,i){"use strict";i.d(e,"a",function(){return r});var s=i(332);class n{constructor(){this.delay=0,this.move=null,this.action=0,this.frame=0}_load(t,e,i){this._raw=t,this.delay=t.delay,t.move?this.move=new s.Vec2(t.move.x,t.move.y):this.move=new s.Vec2(0,0),this.action=t.action||e,this.frame=t.frame||i}}class r{constructor(t){this.frames=null,this._action=null,this.time=0,this.frame=0,this.delay=0,this.loop=!1,this._is_end=!1}_load(t){this._action=t,this.frames=r.Adef[t]}reload(t){this.reset(),this._load(t)}reset(){this.time=0,this.frame=0,this._is_end=!1}update(t,e){if(!this.frames)return;const i=this.fdat;let s=0;i&&(this.time=this.time+t,i.delay<0&&(i.delay=-i.delay),i.delay>0?(s=i.delay,this.delay=0):(s=-i.delay,this.delay=s),this.time>s&&(this.frame=++this.frame,this.time=0),i.move?(e.tx=-i.move.x*e.front,e.ty=i.move.y):(e.tx=0,e.ty=0),this.isEnd()&&(e.tx=0,e.ty=0),e._action=i.action,e._action_frame=i.frame,this.frames&&null!=this.fdat?this.loop||(this._is_end=!1):this._is_end=!0,this.frames.length<=1&&(this._is_end=!0))}isEnd(){return this._is_end}getTotalTime(){return this.frames.reduce((t,e)=>t+e.delay,0)}get fdat(){return this.frames[this.frame]}static async Init(){let t=await $get.data(r._base_path),e=Object.assign({},t);delete e.info;for(let t in e){let i=e[t];e[t]=Object.values(i).map((e,i)=>{let s=new n;return s._load(e,t,i),s})}r.Adef=e,window.CharacterActionAnimationDefinition=e}static get _base_path(){return"/Character/00002000"}}r.Adef=null},370:function(t,e,i){"use strict";i.d(e,"a",function(){return l}),i.d(e,"b",function(){return h});var s=i(353),n=(i(351),i(379));let r={};window.$loadedItem=r;class o{constructor(t,e){this._raw=null,this.id=null,Object.defineProperties(this,{_raw:{value:e},id:{value:t}}),this._raw.info,this._raw.info.id=t,this._raw.info.name="<loading>",this._raw.info.desc="<loading>",this._raw.info.__v=window.DATA_TAG+window.DATA_VERSION;let i=s.c.isItem(t);i||(this._raw.info.icon={},this._raw.info.iconRaw={}),this._raw.info.icon[""]=s.c.getIconUrl(t),this._raw.info.iconRaw[""]=s.c.getIconRawUrl(t),i?this._load():(this._raw.info.name=t,this._raw.info.desc="<not item>")}async _load(){let t=await s.c.loadString(this.id);this._raw.info.name=t.name,this._raw.info.desc=t.desc}}class a extends o{}a.prototype.$test_proto_prop=123;async function l(t,...e){let i,n;switch(t[0]){case"0":n=a;break;default:throw new Error("未完成")}i=s.c.getDataPath(t);let o=await $get.data(i);if(!o)return console.warn("item not exist: "+t),null;r[t]=o;let l=new n(t,o);return e&&e.length&&Object.assign(l,...e),l}class h extends n.a{constructor(t,e,i,s){super(),this.SN=e,this.slot=t,this.amount=s,this.data=i}assign(t,e,i,s){this.SN=e,this.slot=t,this.amount=s,this.data=i}_clear(){this.data=null,this.amount=0}isEmpty(){return!this.data&&!this.amount}getData(){return this.data}setData(t){this.data=t}static parse(t){if(t.__proto__==String.prototype){let e=new h,i=JSON.parse(t);return Object.assign(e,i),e}throw new TypeError}}},371:function(t,e){class i{constructor(){this.hp=8855,this.mp=5246,this.mhp=28855,this.mmp=25246,this.exp=55,this.str=123,this.luk=4,this.dex=999,this.int=4}}Symbol("job");const s=Symbol("onJobChange");class n{constructor(){this.id=void 0,this.equips_code=null}}t.exports={CharacterStat:class extends i{constructor(t){super(),this._$sceneChara=t,this.level=150,this.critRate=50,this.critDamage=80}get job(){return this[symbolStatJob]}set job(t){this[symbolStatJob]=t,this[s],_onJobChange&&_onJobChange()}onJobChange(t){this[s]=t}_getTotalAttack(){return 100}getCurrentMaxBaseDamage(){return 1.3*(4*this.dex+this.str)*(this._getTotalAttack()/100)}getCurrentMinBaseDamage(){return 1.3*(this.dex+this.str)*(this._getTotalAttack()/100)}getCritRate(){return this.critRate}getCritDamage(){return this.critDamage}getHpPercentS(){return(100*this.hp/this.mhp).toFixed(0)}getMpPercentS(){return(100*this.mp/this.mmp).toFixed(0)}getExpPercentS(){return(100*this.exp/this.getNextExp()).toFixed(2)}getNextExp(){return 100}},$RemotePlayerData:n,$PlayerData:class extends n{constructor(){super(),this.stat=void 0}getRemoteData(){return{id:this.id,mapId:this.mapId,equips_code:this.equips_code}}}}},372:function(t,e){window.DownloadData=function(){let t=document.createElement("a");return document.body.appendChild(t),t.style="display: none",t.target="_blank",function(e,i,s){let n=new Blob([e],{type:i||"octet/stream"}),r=window.URL.createObjectURL(n);s&&""!=s?(t.href=r,t.download=s,t.click()):window.open(r,"_blank"),window.URL.revokeObjectURL(r)}}(),window.SelectText=function(t){var e,i;document.body.createTextRange?((e=document.body.createTextRange()).moveToElementText(t),e.select()):window.getSelection&&(i=window.getSelection(),(e=document.createRange()).selectNodeContents(t),i.removeAllRanges(),i.addRange(e))},window.copyToClipboard=function(t){var e=$("<input>");$("body").append(e),e.val(t).select(),document.execCommand("copy"),e.remove()}},374:function(t,e,i){"use strict";i(333);var s=i(351),n=i(334),r=(i(354),i(369),i(337),i(352),i(364),i(358),i(332),i(355)),o=i(362),a=i(356);class l{constructor(t,e,i){t&&e&&i||alert("new PBullet(owner, skill)"),this.owner=t,this.body=null,this.skill=e,this.bulletRenderer=i,this.bulletMoveFunc=null,this.front=1}_create(t){const e=this.owner.body.GetWorld();let i=new r.b2BodyDef,s=new r.b2FixtureDef,n=new r.b2PolygonShape;const o=.5*this.bulletRenderer.textures[0]._raw.__w/$gv.CANVAS_SCALE,l=.5*this.bulletRenderer.textures[0]._raw.__h/$gv.CANVAS_SCALE;let{x:_,y:c}=this.owner.body.GetWorldCenter();const m=this.owner.state.front;i.type=r.b2BodyType.b2_kinematicBody,m>0?i.position.Set(_+o,c):m<0?i.position.Set(_-o,c):i.position.Set(_,c),i.angle=0,i.gravityScale=0,i.allowSleep=!1,i.bullet=!0,i.fixedRotation=!0,i.userData=this,this.body=e.CreateBody(i),n.SetAsBox(o,l),s.shape=n,s.filter.Copy(a.FilterHelper.get("bullet")),s.userData=this;let u=this.body.CreateFixture(s);return t?Object.keys(r.FixtureContactListener.prototype).forEach(e=>u[e]=t[e]):u.preSolve=h,this}getPosition(){return this.body.GetPosition()}launch(t,e,i){t?(this.bulletMoveFunc=t,this.body.addStep(t.Step.bind(t,this)),this.body.addAfterStep(t.AfterStep.bind(t,this))):this.body.m_linearVelocity.Set(e,i)}destroy(){this.body&&(this.body.m_world.DestroyBody(this.body),this.body=null)}}function h(t,e,i,s){const n=s.m_userData;if(!n)return;const r=n.chara;if(!r)return;const o=i.m_userData;o.owner!=n&&(o.skill.addAttack(r),t.SetEnabled(!1),o.bulletRenderer.destroy(),o.destroy())}i.d(e,"a",function(){return m}),i.d(e,"b",function(){return y});class _ extends n.Animation{constructor(t,e){super(t,e),this.x=0,this.y=0,this.targetRenderer=null,this.$physics=null,this.is_loop=!1,this.opacity=1}load(t){if(!this._raw)throw new Error("Not implement. skill data is loaded");Array.isArray(this._raw[0])?this.textures=this._raw[t]:this.textures=this._raw}destroy(){super.destroy(),this.$physics=null}update(t){this.$physics?this.update_p(t):this.targetRenderer&&this.update_r(t)}render(t){this.$physics?this.render_p(t):this.targetRenderer&&this.render_r(t)}update_p(t){super.update(t)}render_p(t){const e=this.$physics.getPosition(),i=this.$physics.front,s=e.x*$gv.CANVAS_SCALE,n=e.y*$gv.CANVAS_SCALE;this.x=s,this.y=n,t.globalAlpha=this.opacity,this.draw(t,s,n,0,i>0)}update_r(t){t*=this.targetRenderer.getSpeed(),super.update(t)}render_r(t){this.x=this.targetRenderer.x+this.targetRenderer.tx,this.y=this.targetRenderer.y+this.targetRenderer.ty,t.globalAlpha=this.opacity,this.draw(t,this.x,this.y,0,this.targetRenderer.front>0)}}class c extends _{constructor(t,e){super(t,e)}}class m{constructor(){}static AddEffect(t){t.update(0),m._effects.push(t)}static Update(t){const e=m._effects;m._effects=e.filter(function(e){return e.isEnd()||e.update(t),!e.isEnd()||(e.destroy(),!1)})}static Render(t){t.pushGlobalAlpha();const e=m._effects;for(let i=0;i<e.length;++i)e[i].render(t);t.popGlobalAlpha()}}m._effects=[],window.$EffectManager=m;class u{constructor(){this.data=null,this.url=null,this.skillId=null,this.actType=0,this._owner=null,this._crr=null,this._actani=null,this.type=0,this._$is_end=!1,this.is_launch=!1,this.state=null}_init(){this._applyDefaultAction()}get is_end(){return this._$is_end}set is_end(t){this._$is_end=t,t&&(this.owner.$physics.state.invokeSkill=!1)}get owner(){return this._owner}set owner(t){t&&(this._owner=t,this._crr=t.renderer,this._crr&&(this._actani=this._crr.actani,this._actani))}get _owner_player(){return this._owner}set _owner_player(t){this.owner=t}_applyAction(t){if(this._actani&&this.data){this.data.action;this._actani.reload(t),this._actani.loop=!1,this.owner.$physics.state.invokeSkill=!0}}_applyDefaultAction(){const t=this.data.action;this._applyAction(t[this.actType])}async _load(t){const e=/^(\d+)\d{4}$/.exec(t)[1],i=`${this.constructor._base_path}/${e}/skill/${t}`,s=await $get.data(i);s?(this.data=s,this.url=i,this.skillId=t,this.type=this.data.info&&this.data.info.type||0,this.__proto__=this._decide_type().prototype,this._loadTexture(s),this._init()):alert("SkillAnimationBase")}_assign(t,e){this.data=t.data,this.url=t.url,this.skillId=t.skillId,this.type=t.type,this.__proto__=this._decide_type().prototype,this._init()}_loadTexture(){for(let e of this._effect_names){let i=this.data[e];i&&(this.data[e]=t(i,[this.url,e].join("/")))}function t(t){return"0"in t[0]?function(t){let e=[];for(let i=0;i in t;++i){let n=t[i];e[i]=[];for(let t=0;t in n;++t){let r=n[t],o=new s.a(r);e[i][t]=o}e[i].action=n.action}return e}(t):function(t){let e=[];for(let i=0;i in t;++i){let n=t[i],r=new s.a(n);e[i]=r}return e.action=t.action,e}(t)}}reset(){this._actani.reset(),this.is_launch=!1}control(t,e,i){}update(t){this.$promise||(this.is_launch=!0,this.is_end=!0,console.warn("Skill not implement: "+this.skillId))}_default_update(t){if(this._actani){if(this._actani.delay)return;this.is_launch||(this._addEffect(),this.is_launch=!0),this._actani.isEnd()&&(this.is_end=!0)}else this.is_launch=!0,this.is_end=!0}isEnd(){return this.is_end}addAttack(t){this._owner;let e=new o.b;e.setTargetObject(t),e.allDamage.length=this.data.common.attackCount,this.attackInfo.allAttack.push(e)}createBullet(t){let e,i;return(e=this._addEffect(t)).is_loop=!0,(i=new l(this.owner.$physics,this,e))._create(),i.launch(null,this.owner.$physics.state.front*(32|window.$BULLET_SPEED),0),e.$physics=i,i}_addDefaultEffect(t){this._applyDefaultAction(),this._addEffect("effect",t)}_addEffect(t="effect",e){let i=this.data[t].action;i&&this._applyAction(i);try{const i=this.actType;let s=new _(this.data[t],[this.url,t].join("/"));return e||(s.targetRenderer=this._crr),s.load(i),m.AddEffect(s),s}catch(t){}}_addHitEffect(t,e,i,s){let n=new c;n.target=i,n.load(this.url+"/hit/"+s,this.data.hit,s),m.AddEffect(n)}_decide_type(){const t=this.data.info;switch(this.type){case 1:case 2:if(t.rapidAttack)return p;break;case 40:if(t.casterMove&&t.avaliableInJumpingState)return f}return d}get _effect_names(){return["effect","hit"]}static get _base_path(){return"/Skill"}}class d extends u{constructor(){throw super(),new TypeError("constructor")}_init(){this._applyDefaultAction()}update(t){this._default_update(t)}}class p extends u{constructor(){throw super(),new TypeError("constructor")}_init(){this._applyDefaultAction(),this.state="prepare",this._state_func=this._prepare,this.current_effect=this._addEffect(this.state),this.time=0,this.tick=0,this.fadeTotalTime=this._actani.getTotalTime(),this._crr.fixed_speed=!0}_prepare(){this.current_effect.opacity=this.time/this.fadeTotalTime,this.current_effect.opacity>1&&(this.current_effect.opacity=1),this._actani.isEnd()&&(this.current_effect.opacity=0,this.current_effect.destroy(),this.state="keydown",this._state_func=this._keydown,this.current_effect=this._addEffect(this.state),this._actani.loop=!0,this.current_effect.is_loop=!0,this.time=0)}_keydown(){this._actani.isEnd()&&(this.time=0)}_keydownend(){this.current_effect.opacity=1-this.time/this.fadeTotalTime,this.current_effect.opacity<0&&(this.current_effect.opacity=0),this._actani.isEnd()&&(this.current_effect.opacity=0,this.current_effect.destroy(),this._crr.fixed_speed=!1,this.is_launch=!0,this.is_end=!0)}control(t,e,i){switch(this.state){case"prepare":case"keydown":e&&!i||(this.current_effect.opacity=0,this.current_effect.destroy(),this.state="keydownend",this._state_func=this._keydownend,this.current_effect=this._addEffect(this.state),this.fadeTotalTime=this._actani.getTotalTime(),this._actani.loop=!1,this.time=0)}}update(t){t*=this._crr.getSpeed(),this.time+=t,++this.tick,this._state_func(),this.tick%(3|window.$FIRE_BULLET_T)==(2|window.$FIRE_BULLET_T2)&&"keydownend"!=this.state&&this.createBullet("ball")}get _effect_names(){return["prepare","keydown","keydownend","hit","ball"]}}class f extends u{constructor(){throw super(),new TypeError("constructor")}_init(){this.jump_max_count=window.jump_max_count||2}jump2(){const t=this._crr,e=this._owner_player.$physics.foot_walk,i=this._owner_player.$physics.getPosition();console.log("pos: { x: %o, y: %o }",i.x,i.y),e.ConstantVelocityWorldCenter2((window.$NJmpX||40)*t.front,window.$NJmpY||0),this._addDefaultEffect()}control(t,e,i){if(!this._owner)return;const s=this._owner.$physics;if(0==s.state.jump_count){if(1!=e||!s.state.jump)return t.jump=t.jump?Math.max(e,t.jump):e,!1;this.jump2(),s.state.jump_count+=2}else s.state.jump&&1==e&&s.state.jump_count<this.jump_max_count&&(this.jump2(),s.state.jump_count+=1)}update(t){const e=this._owner.$physics;e.state.jump_count>1?(e.$foothold||this._actani.isEnd())&&(this.is_end=!0):e.$foothold?//!$physics._isCanJump()
this._actani.isEnd()?this.is_end=!0:$gv.m_editor_mode&&(this.is_end=!0):this._actani.isEnd()&&(this.is_end=!0)}}class y extends u{constructor(){super(),this.attackInfo=new o.a}load(t,e){if(this.owner=e,!t)throw new Error("1 argument required");if(String(t).length<=4)throw new Error("skill ID format");this.attackInfo.skill=t;let i=y.__loaded_skill[t];if(!i||!i.data){let i=this._load(t,e);return this.$promise=i,y.__loaded_skill[t]=this,i.then(()=>{delete this.$promise}),i}this._assign(i)}}y.__loaded_skill={},window.$SceneSkill=y},375:function(t,e,i){"use strict";var s=i(355);i(332);function n(t,e,i){return i?t|e:t&~e}class r extends s.b2Draw{constructor(t){super(...arguments),this.m_ctx=t,this.axis_length=1,this.viewRotation=new s.b2Rot(Object(s.b2DegToRad)(0)),this.viewZoom=1,this.flag_drawShape=!0,this.flag_drawJoint=!0,this.flag_drawAabb=!1,this.flag_drawCenterOfMass=!0,this.flag_drawController=!0,this.flag_drawParticle=!0}get canvasScale(){return $gv.CANVAS_SCALE}set canvasScale(t){$gv.CANVAS_SCALE=t}get viewRect(){return $gv.m_viewRect}set flag_drawAll(t){this.m_drawFlags=t?s.b2DrawFlags.e_all:s.b2DrawFlags.e_none}set flag_drawShape(t){this.m_drawFlags=n(this.m_drawFlags,s.b2DrawFlags.e_shapeBit,t)}set flag_drawJoint(t){this.m_drawFlags=n(this.m_drawFlags,s.b2DrawFlags.e_jointBit,t)}set flag_drawAabb(t){this.m_drawFlags=n(this.m_drawFlags,s.b2DrawFlags.e_aabbBit,t)}set flag_drawPair(t){this.m_drawFlags=n(this.m_drawFlags,s.b2DrawFlags.e_pairBit,t)}set flag_drawCenterOfMass(t){this.m_drawFlags=n(this.m_drawFlags,s.b2DrawFlags.e_centerOfMassBit,t)}set flag_drawParticle(t){this.m_drawFlags=n(this.m_drawFlags,s.b2DrawFlags.e_particleBit,t)}set flag_drawController(t){this.m_drawFlags=n(this.m_drawFlags,s.b2DrawFlags.e_controllerBit,t)}get flag_drawAll(){this.m_drawFlags}get flag_drawShape(){return this.m_drawFlags&s.b2DrawFlags.e_shapeBit}get flag_drawJoint(){return this.m_drawFlags&s.b2DrawFlags.e_jointBit}get flag_drawAabb(){return this.m_drawFlags&s.b2DrawFlags.e_aabbBit}get flag_drawPair(){return this.m_drawFlags&s.b2DrawFlags.e_pairBit}get flag_drawCenterOfMass(){return this.m_drawFlags&s.b2DrawFlags.e_centerOfMassBit}get flag_drawParticle(){return this.m_drawFlags&s.b2DrawFlags.e_particleBit}get flag_drawController(){return this.m_drawFlags&s.b2DrawFlags.e_controllerBit}get flagNames(){return["flag_drawAll","flag_drawShape","flag_drawJoint","flag_drawAabb","flag_drawPair","flag_drawCenterOfMass","flag_drawParticle","flag_drawController"]}}r.prototype.PushTransform=function(t){let e=this.m_ctx;e.save(),e.transform(t.q.c,t.q.s,-t.q.s,t.q.c,t.p.x,t.p.y)},r.prototype.PopTransform=function(t){this.m_ctx.restore()},r.prototype.DrawPolygon=function(t,e,i){if(!e)return;let s=this.m_ctx;s.beginPath(),s.moveTo(t[0].x,t[0].y);for(let i=1;i<e;i++)s.lineTo(t[i].x,t[i].y);s.closePath(),s.strokeStyle=i.MakeStyleString(1),s.stroke()},r.prototype.DrawSolidPolygon=function(t,e,i){if(!e)return;let s=this.m_ctx;s.beginPath(),s.moveTo(t[0].x,t[0].y);for(let i=1;i<e;i++)s.lineTo(t[i].x,t[i].y);s.closePath(),s.fillStyle=i.MakeStyleString(.5),s.fill(),s.strokeStyle=i.MakeStyleString(1),s.stroke()},r.prototype.DrawCircle=function(t,e,i){if(!e)return;let n=this.m_ctx;n.beginPath(),n.arc(t.x,t.y,e,0,2*s.b2_pi,!0),n.strokeStyle=i.MakeStyleString(1),n.stroke()},r.prototype.DrawSolidCircle=function(t,e,i,n){if(!e)return;let r=this.m_ctx,o=t.x,a=t.y;r.beginPath(),r.arc(o,a,e,0,2*s.b2_pi,!0),r.moveTo(o,a),r.lineTo(o+i.x*e,a+i.y*e),r.fillStyle=n.MakeStyleString(.5),r.fill(),r.strokeStyle=n.MakeStyleString(1),r.stroke()},r.prototype.DrawParticles=function(t,e,i,s){const n=this.m_ctx;if(n)if(null!==i)for(let r=0;r<s;++r){let s=t[r],o=i[r];n.fillStyle=o.MakeStyleString(.5),n.fillRect(s.x-e,s.y-e,2*e,2*e)}else{n.fillStyle="rgba(255,255,255,0.5)",n.beginPath();for(let i=0;i<s;++i){let s=t[i];n.rect(s.x-e,s.y-e,2*e,2*e)}n.fill()}},r.prototype.DrawSegment=function(t,e,i){let s=this.m_ctx;s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(e.x,e.y),s.strokeStyle=i.MakeStyleString(1),s.stroke()},r.prototype.DrawTransform=function(t){if(0==this.axis_length)return;let e=this.canvasScale;if(!this.viewRect.collide4f2(t.p.x*e,t.p.y*e,this.axis_length*e,this.axis_length*e))return;let i=this.m_ctx;this.PushTransform(t),i.beginPath(),i.moveTo(0,0),i.lineTo(this.axis_length,0),i.strokeStyle=s.b2Color.RED.MakeStyleString(1),i.stroke(),i.beginPath(),i.moveTo(0,0),i.lineTo(0,this.axis_length),i.strokeStyle=s.b2Color.GREEN.MakeStyleString(1),i.stroke(),this.PopTransform(t)},r.prototype.DrawPoint=function(t,e,i){let s=this.m_ctx;s.fillStyle=i.MakeStyleString(),e/=this.viewZoom;let n=(e/=this.canvasScale)/2;s.fillRect(t.x-n,t.y-n,e,e)},r.prototype.DrawString=function(t,e,i,s){let n=this.m_ctx;const o=n.font;let a=Array.prototype.slice.call(arguments),l=goog.string.format.apply(null,a.slice(2));n.save(),n.setTransform(1,0,0,1,0,0),n.font="18pt helvetica";let h=r.prototype.DrawString.s_color;n.fillStyle=h.MakeStyleString(),n.fillText(l,t,e),n.restore(),n.font=o},r.prototype.DrawString.s_color=new s.b2Color(.9,.6,.6),r.prototype.DrawStringWorld=function(t,e,i,n){let o=r.prototype.DrawStringWorld.s_p.Set(t,e),a=this.viewCenter;s.b2Vec2.SubVV(o,a,o);let l=this.viewRotation;s.b2Rot.MulTRV(l,o,o);let h=this.viewZoom;s.b2Vec2.MulSV(h,o,o);let _=this.canvasScale;s.b2Vec2.MulSV(_,o,o),o.y*=-1;let c=r.prototype.DrawStringWorld.s_cc.Set(.5*this.m_canvas.width,.5*this.m_canvas.height);s.b2Vec2.AddVV(o,c,o);let m=this.m_ctx;const u=m.font;let d=Array.prototype.slice.call(arguments),p=goog.string.format.apply(null,d.slice(2));m.save(),m.setTransform(1,0,0,1,0,0),m.font="18pt helvetica";let f=r.prototype.DrawStringWorld.s_color;m.fillStyle=f.MakeStyleString(),m.fillText(p,o.x,o.y),m.restore(),m.font=u},r.prototype.DrawStringWorld.s_p=new s.b2Vec2,r.prototype.DrawStringWorld.s_cc=new s.b2Vec2,r.prototype.DrawStringWorld.s_color=new s.b2Color(.5,.9,.5),r.prototype.DrawAABB=function(t,e){let i=this.m_ctx;i.strokeStyle=e.MakeStyleString();let s=t.lowerBound.x,n=t.lowerBound.y,r=t.upperBound.x-t.lowerBound.x,o=t.upperBound.y-t.lowerBound.y;i.strokeRect(s,n,r,o)},e.a=r},376:function(t,e,i){"use strict";i.d(e,"a",function(){return a});var s=i(355),n=(i(358),i(352),i(356));class r{constructor(t){this.l=null,this.uf=null,this.x=null,this.y1=null,this.y2=null,this.page=null,this.piece=null,Object.assign(this,t)}isLadder(){return!!this.l}}class o extends r{constructor(t){super(t),this.body=null}calcHeight(){return this.y2-this.y1}calcHalfHeight(){return.5*(this.y2-this.y1)}calcWidth(){return this.isLadder()?16:4}calcHalfWidth(){return.5*(this.isLadder()?16:4)}calcLength(){return(this.y2-this.y1)/$gv.CANVAS_SCALE}_create(t){let e=new s.b2BodyDef,i=new s.b2FixtureDef,r=new s.b2PolygonShape;const o=this.x/$gv.CANVAS_SCALE,a=this.y1/$gv.CANVAS_SCALE,l=this.y2/$gv.CANVAS_SCALE,h=this.calcHalfWidth()/$gv.CANVAS_SCALE,_=.5*(l-a);e.type=s.b2BodyType.b2_kinematicBody,e.position.Set(o,a),e.angle=0,e.gravityScale=0,e.fixedRotation=!0,e.userData=this,this.body=t.CreateBody(e),r.SetAsBox(h,_+.5,new s.b2Vec2(0,_-.5),0),i.shape=r,i.filter.Copy(n.FilterHelper.get("ladder")),i.isSensor=!0,i.userData=this;let c=this.body.CreateFixture(i);return c.beginContact=this.beginContact.bind(this),c.endContact=this.endContact.bind(this),this}beginContact(t,e,i){const s=i.m_userData;s&&(s.state.ladder||s.contactLadder(this))}endContact(t,e,i){const s=i.m_userData;s&&s.leaveLadder()}}class a{static load(t,e){let i=[];for(let s in t.ladderRope){let n=t.ladderRope[s],r=parseInt(s,10)-1;r>=0&&Number.isSafeInteger(r);let a=new o(n);a._$index=s,a._create(e),i.push(a)}return i}}},377:function(t,e,i){"use strict";i.d(e,"a",function(){return _});var s=i(352);i(334);window.$MobAction_Move_Priority=2,window.$MobAction_Jump_Priority=1;class n{constructor(t){this._name=null,this._ani=t}get priority(){return 1}init(){}isValid(t){return!0}update(t){}isEnd(t){return!!this._ani.isEnd()&&(this.onEnd(t),!0)}onEnd(t){}}class r extends n{constructor(t){super(t),this._name="stand"}update(t){t.ikey.left=0,t.ikey.right=0}}class o extends n{constructor(t){super(t),this._name="move",this.front=0}get priority(){return window.$MobAction_Move_Priority}isValid(t){return!t.action._name.startsWith("attack")}}class a extends o{constructor(t){super(t),this.front=-1}isValid(t){return super.isValid(t)&&(!t.state.jump||this.front==t.state.front)}update(t){t.ikey.left=1,t.ikey.right=0}}class l extends o{constructor(t){super(t),this.front=1}isValid(t){return super.isValid(t)&&(!t.state.jump||this.front==t.state.front)}update(t){t.ikey.left=0,t.ikey.right=1}}class h extends n{constructor(t){super(t),this._name="jump"}get priority(){return window.$MobAction_Jump_Priority}init(){}isValid(t){let e=t.action._name;switch(t.action._name){case"attack":return!1;default:if(e.startsWith("attack"))return!1}return!t.state.jump}update(t){t.state.walk&&(t.state.front<0?t.ikey.left=1:t.state.front>0&&(t.ikey.right=1)),t.ikey.jump=1}onEnd(t){t.ikey.jump=0}}class _ extends s.b{constructor(t){super(),this.attackTarget=!0,this._enable_rx=!1,this.chara=t,t&&(t.renderer.isFlyMob()?this.setMovementSpeed(this._info.flySpeed):this.setMovementSpeed(this._info.speed)),this.activityRegion=null,this.$debugControl=!1,this.ikey={},this.actions=[],this.action=null}_registerAction(t){this.actions.push(t)}_loadAction(t,e){e=e||{stand:[r],move:[a,l],jump:[h]},Object.keys(t).forEach(i=>{if(t[i]&&e[i]){const s=e[i];for(let e of s){let s=new e(t[i]),n=s.priority;0;for(let t=0;t<n;++t)this._registerAction(s)}}else console.warn("未完成 MobActionController: "+i)}),this.action=this.actions[0],this.action}get _info(){return this.chara.renderer._raw.info}get hasBodyDamage(){return 0!=this._info.bodyAttack&&1!=this._info.bodyAttack&&alert("bodyAttack:"+this._info.bodyAttack),0!=this._info.bodyAttack}get _speed(){return this._info.speed}get _pushed(){return this._info.pushed}get _fs(){return this._info.fs}get _category(){return this._info.category}get _body_category(){return"mob"}_create(t){super._create(t),this.setPosition(this.chara.x/$gv.CANVAS_SCALE,this.chara.y/$gv.CANVAS_SCALE,!0),this._appleMobCategory(this._category)}_appleMobCategory(t){switch(t){case 1:case 6:this.__setAsWalkOnlyMob();break;case 8:this.__setAsJumpDropMob();break;default:this.__setAsWalkOnlyMob()}this.chara.front=this.chara.spawn.f?1:-1}__setAsWalkOnlyMob(){const t=this.body.GetWorld().ground,e=this.chara.spawn.fh;if(e>=0){let i=t.footholds[e];this.activityRegion=t.rectChains[i.chain]}}__setAsJumpDropMob(){}isCanMove(){return!(this._info.ignoreMoveImpact||0==this._walker_omega||this._info.noFlip)}control(){if(this.isCanMove()){switch(this._category){case 1:case 6:this._control_basic(!1);break;case 8:this._control_basic(!0);break;default:this._control_basic(!1)}super.control(this.ikey)}}_control_basic(t){if(this.action){if(this.action.isEnd(this)){let t=this.actions.filter(t=>t.isValid(this)),e=Math.trunc(100*Math.random())%t.length;this.action=t[e],this.action,this.action.init()}this.action.update(this)}}stop(){const t={};this.ikey=t,super.control(t)}Step(){let t,e,i;if(super.Step(),this.control(),this.attackTarget&&this.activityRegion?(t=this.activityRegion.left,e=this.activityRegion.right,i=!0):this._enable_rx||(t=this.chara.spawn.rx0,e=this.chara.spawn.rx1,i=!1),i){const i=this.body.GetPosition(),s=i.x*$gv.CANVAS_SCALE,n=(i.y,$gv.CANVAS_SCALE,s-e);if(t-s>0){const e=this.foot_walk.GetPosition();this.body.SetPositionXY(t/$gv.CANVAS_SCALE,i.y),this.foot_walk.SetPositionXY(t/$gv.CANVAS_SCALE,e.y)}else if(n>0){const t=this.foot_walk.GetPosition();this.body.SetPositionXY(e/$gv.CANVAS_SCALE,i.y),this.foot_walk.SetPositionXY(e/$gv.CANVAS_SCALE,t.y),this.attackTarget||(this.state.front*=-1)}}}AfterStep(){super.AfterStep();const t=this.getPosition(),e=t.x*$gv.CANVAS_SCALE,i=t.y*$gv.CANVAS_SCALE;this.chara.x=e,this.chara.y=i,this._info.noFlip||(this.chara.front=-this.state.front)}}},378:function(t,e,i){"use strict";i.d(e,"b",function(){return r}),i.d(e,"a",function(){return o}),i.d(e,"c",function(){return a});i(332);var s=i(334),n=i(354);class r{constructor(){this.createDelay=0,this.collisionDelay=0,this.duration=0,this.moveSpeed=0,this.angle=0,this.flip=!1,this.x=0,this.y=0,this._speed_x=0,this._speed_y=0}}class o extends n.a{constructor(t,e){super(),t=Object.assign(new this._BallDefinition,t),this.createDelay=t.createDelay,this.collisionDelay=t.collisionDelay,this.duration=t.duration,this.moveSpeed=t.moveSpeed,this.angle=t.angle*Math.PI/180,this.x=t.x,this.y=t.y,this.moveSpeed?(this._speed_x=Math.cos(this.angle+Math.PI)*this.moveSpeed,this._speed_y=Math.sin(this.angle+Math.PI)*this.moveSpeed):(this._speed_x=0,this._speed_y=0),this.state=this.E_BEFORE_CREATE}get E_BEFORE_CREATE(){return 0}get E_CREATED(){return 1}get E_BEGIN_COLLISION(){return 2}get E_ENG_COLLISION(){return 3}create(t){this.state=this.E_CREATED,this.collisionDelay>0&&(this.enablePhysics=!1)}begin_collision(){this.enablePhysics=!0,this.state=this.E_BEGIN_COLLISION}end_collision(){this.enablePhysics=!1,this.state=this.E_ENG_COLLISION}update(t,e){this.state==this.E_BEFORE_CREATE?(this.createDelay-=t,this.createDelay<=0&&this.create()):(this.state==this.E_CREATED?(this.collisionDelay-=t,this.collisionDelay<=0&&this.begin_collision()):this.state==this.E_BEGIN_COLLISION&&this.duration>0&&(this.duration-=t,this.duration&&this.end_collision()),window.$stop||(this.x+=this._speed_x*t/1e3,this.y+=this._speed_y*t/1e3),this.renderer.update(t))}render(t){if(this.state!=this.E_BEFORE_CREATE){const e=this.flip;this.renderer.draw(t,this.x,this.y,this.angle,e)}}get _BallDefinition(){throw new Error("Not implement")}}class a{constructor(t,e){this._raw=t,this._url=e,this.level=null,this.animations={}}async load(t){this.level=t,this._raw||this._url||(this._url=[this._base_path,t].join("/"),this._raw=await $get.data(this._url));for(let t of this._anima_name_list){let e=new s.Animation(this._raw[t],[this._url,t].join("/"));e.is_loop=!0,e.load(),this.animations[t]=e}}invoke(){throw new Error("Not implement")}get _anima_name_list(){throw new Error("Not implement")}get _base_path(){throw new Error("Not implement")}}},379:function(t,e,i){"use strict";i.d(e,"a",function(){return s});class s{}},394:function(t,e,i){"use strict";i.r(e),i.d(e,"FairyDustBall",function(){return a}),i.d(e,"FairyDustBallHit",function(){return l}),i.d(e,"FairyDust",function(){return h}),i.d(e,"_FairyDust",function(){return _});var s=i(332),n=(i(334),i(354)),r=i(378);class o extends r.b{constructor(){super(),this.scale=0}}class a extends r.a{constructor(t,e){super(t,e),this.x=1e3,this.y=-80,this.renderer=e["ball"+t.scale].clone()}create(t){this.$physics={state:{}},super.create(t)}get _BallDefinition(){return o}}class l extends n.a{constructor(t,e){super()}}class h extends r.c{constructor(t,e){super(t,e)}invoke(){const t=this._raw.s,e=this._raw.s2,i=this._raw.v,n=this._raw.v2,r=this._raw.w,o=this._raw.w2,l=this._raw.u;let h=this._raw.x;for(let _=0,c=s.Randomizer.randInt(r,r+o);_<c;_++){h+=s.Randomizer.nextInt(h);let r=new a({scale:s.Randomizer.nextInt(3),createDelay:l,moveSpeed:i+s.Randomizer.nextInt(n),angle:h+s.Randomizer.randInt(t,e)},this.animations);$gv.SceneObjectMgr.addToScene(10,r)}}get _anima_name_list(){return["ball0","ball1","ball2"]}get _base_path(){return"/Skill/MobSkill/238/level"}}class _ extends h{constructor(t,e){super(t,e)}load(t){this._raw||this._url||(this._raw=window.MOB_SKILL_RAW[238].level[t],this._url=[this._base_path,t].join("/")),super.load(t)}}},395:function(t,e,i){let s=i(410),n=i(411),r=i(412),o=Object.assign({},s,n,r);t.exports=o},396:function(t,e,i){"use strict";i(333);var s=i(351);i(334);class n{constructor(){this.opacity=1}destroy(){}isEnd(){}update(t){throw new Error}render(t){throw new Error}}class r{constructor(){this.objects=[],this.opacity=1}add(t){this.objects.push(t)}update(t){this.objects=this.objects.filter(function(e){return e.isEnd()?(e.destroy(),!1):(e.update(t),!0)})}render(t){if(this.opacity>0){const e=this.opacity;t.pushGlobalAlpha(),this.objects.forEach(function(i){t.globalAlpha=i.opacity*e,i.render(t)}),t.popGlobalAlpha()}}}var o=i(362);i.d(e,"a",function(){return d});const a={};class l{constructor(){for(let t=0;t<=9;++t)this[t]=null;this.addedCanvasH=0}async _load(t){const e=await $get.data(t);Object.keys(e).forEach(i=>{let n=new s.a(e[i]);n._url=[t,i].join("/"),this[i]=n}),this.addedCanvasH=0|e.addedCanvasH}}function h(t){return 3*t.width/4}function _(t,e,i){t.strokeStyle="#F00",t.beginPath(),t.moveTo(e,i),t.lineTo(e,i+10),t.stroke(),t.strokeStyle="#0F0",t.beginPath(),t.moveTo(e,i),t.lineTo(e+10,i),t.stroke()}l.prototype.Miss=null,l.prototype.guard=null,l.prototype.shot=null,l.prototype.effect=null;class c{constructor(){this._url=null,this.style=null,this.skin=null,this.textures=[],this.rand_y=[0];for(let t=1,e=Math.random()>.5?-1:1;t<c.max_display_digit;++t)this.rand_y[t]=Math.random()*c.max_rand_y*e,e*=-1}_copy(t){this._url=t._url,this.skin=t.skin,this.style=t.style,this.textures=t.textures,this._$promise&&(this._$promise=t._$promise)}async _load(t,e){let i,s=[];i="default"==t?this._default_base_path+e:this._skin_base_path+[t,e].join("/"),a[t]||(a[t]={}),a[t][e]=this,this._url=i,this.skin=t,this.style=e;for(let t=0;t<=1;++t){const e=i+t;this.textures[t]=new l,s[t]=this.textures[t]._load(e)}return await Promise.all(s),this}async load(t,e){let i;return a[t]&&(i=a[t][e]),i?this._copy(t,i):(this._$promise=this._load(t,e),await this._$promise,delete this._$promise),this}draw(t,e,i,s,n){let r,o=e.toFixed(0),a=0;a+=-(r=this.textures[1][o[0]]).x,a+=h(r);for(let t=1;t<o.length-1;++t)a+=h(r=this.textures[0][o[t]]);{let t=s-a/2;(r=this.textures[1][o[0]]).draw2(t,n),t+=h(r);for(let e=1;e<o.length;++e)(r=this.textures[0][o[e]]).draw2(t,n+this.rand_y[e]),t+=h(r)}if(this._display_axis){const e=t.ctx;let i=s-a/2;r=this.textures[1][o[0]],_(e,i,n),i+=h(r);for(let t=1;t<o.length;++t)r=this.textures[0][o[t]],_(e,i,n+this.rand_y[t]),i+=h(r)}}get _default_base_path(){return"/Effect/BasicEff"}get _skin_base_path(){return"/Effect/BasicEff/damageSkin/"}}c.loaded_skin=a,c.max_display_digit=Math.trunc(Math.log10(Number.MAX_SAFE_INTEGER)+1),c.max_rand_y=5;class m extends n{constructor(t,e,i,s,n,r){super(),this.x=s,this.y=n,this.vy=m.move_y/m.time_tt,this.delay=r,this.time=0,this.state=0,this.damagePair=i,this.renderer,this._load(t,e)}_load(t,e,i){let s;a[t]&&(s=a[t][e]),s?(this.renderer=s,this._$promise=this.renderer._$promise):(this.renderer=new c,this._$promise=this.renderer.load(t,e)),this._$promise&&(this.render=this.$noRender,this._$promise.then(()=>{delete this.render,delete this._$promise}).catch(()=>{if(delete this._$promise,console.error(`Can't load damageSkin[${t}][${e}]`),i)throw Error();console.log(`try load damageSkin["default"][${e}]`),this._load("default",e,1)}))}$noRender(){}destroy(){this.state=2}isEnd(){return this.state>=1&&this.time>1e3}update(t){this.time+=t,this.delay&&this.time>=this.delay?(this.time=0,this.delay=0):(this.y+=this.vy*t,0==this.state?(this.vy=this.vy*m.move_avy,this.time>m.time_d1&&(this.time=0,this.state=1)):1==this.state&&(this.vy=this.vy*m.move_avy2,this.time<m.time_d2?this.opacity=1-this.time/m.time_d2:this.opacity=0))}render(t){this.renderer.draw(t,this.damagePair.realDamage,this.damagePair.critical,this.x,this.y)}}m.time_d1=1e3,m.time_d2=1e3,m.time_tt=m.time_d1+m.time_d2,m.move_y=-300,m.move_avy=1.001,m.move_avy2=.99;class u extends m{update(t){}isEnd(){return this.is_end}}const d=new class extends r{_addTest(t=9876543210,e=!1,i=0,s=0,n=0,r=null,a="NoRed"){this.objects.push(new m(r,a,new o.c(t,e),i,s,n))}_addTest2(t=9876543210,e=!1,i=0,s=0,n=0,r=null,a="NoRed"){this.objects.push(new u(r,a,new o.c(t,e),i,s,n))}_addAttack(t,e,i){i.allAttack.forEach(i=>{let s=i.getTargetObject();if(s){const n=s.$physics.getPosition();let r,o;r=n.x*$gv.CANVAS_SCALE,o=n.y*$gv.CANVAS_SCALE-70,i.allDamage.forEach(i=>{this.addDamagePair(t,e,i,r,o)})}})}addDamagePair(t,e,i,s,n,r=0){this.objects.push(new m(t,e,i,s,n,r))}};window.$damageNumberLayer=d,window.$DamageNumber=m,window.$DamageNumberTest=u,window.$DamageNumberRenderer=c},409:function(t,e,i){"use strict";i.r(e),i.d(e,"FlowerTrapBall",function(){return o}),i.d(e,"FlowerTrap",function(){return a});var s=i(332),n=(i(334),i(354),i(378));class r extends n.b{constructor(){super(),this.size=0}}class o extends n.a{constructor(t,e){super(t,e),this.renderer=e[t.size].clone()}create(t){this.$physics={state:{}},super.create(t)}get _BallDefinition(){return r}}class a extends n.c{constructor(t,e){super(t,e),this.patterns={}}_invoke(t,e,i,s){const n=this._raw["pattern"+t];for(let t=0;t in n;++t){const r=n[t];let a,l,h;a=e+(s?-r.pos.x:r.pos.x),l=i+r.pos.y,h=r.angle-90;let _=new o({x:a,y:l,angle:h,size:r.size,createDelay:r.createDelay,collisionDelay:r.collisionDelay,duration:r.duration},this.animations);$gv.SceneObjectMgr.addToScene(10,_)}}invoke(){this._invoke(s.Randomizer.nextInt(3),1e3,48,s.Randomizer.nextBoolean())}get _anima_name_list(){return["XL","L","M","S"]}get _base_path(){return"/Skill/MobSkill/238/level"}}},410:function(t,e,i){"use strict";i.r(e),i.d(e,"$RequestPacket_SelectChara",function(){return s}),i.d(e,"$ResponsePacket_SelectChara",function(){return n});i(371);class s{constructor(){this.charaId=void 0}}class n{constructor(){this.charaData=null,this.remoteCharacters=null}}},411:function(t,e,i){"use strict";i.r(e),i.d(e,"$Packet_CharacterChat",function(){return s});class s{constructor(){this.type=null,this.$style=null,this.text=null}}},412:function(t,e,i){"use strict";i.r(e),i.d(e,"$Packet_CharacterMove",function(){return n});var s=i(365);class n{constructor(){this.id=void 0,this.path=[],this.stamp=(new Date).getTime()}capture(t){const e=t.$physics,i=e.body;let n=new s.a;{const e=t.renderer;n.action=e.action,n.emotion=e.emotion}if(n.isAwake=i.IsAwake(),n.isAwake){let t=e.getPosition(),s=i.GetLinearVelocity();n.x=t.x,n.y=t.y,n.vx=s.x,n.vy=s.y,n.pState=e.state,n.elapsed=(new Date).getTime()-this.stamp}this.path.push(n)}}}}]);
//# sourceMappingURL=9.js.map